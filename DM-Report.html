<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DM Report System</title>
    <!-- Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for star icons and other icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-color: #f5f7fa;
            color: #333;
        }
        label, input, select, textarea, button {
            font-size: 0.875rem;
        }
        th, td {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .form-border-visits { border-left: 4px solid #ECFAE5; }
        .form-border-events { border-left: 4px solid #E8F9FF; }
        .form-border-leaves { border-left: 4px solid #FFE6E1; }

        /* Truncate comment text */
        .comment-truncate {
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        /* --- Notification Styles --- */
        .notification {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            pointer-events: none;
            opacity: 0;
        }
        .notification.show {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(-50%) translateY(0);
        }
        .notification.success { background-color: #4CAF50; color: white; }
        .notification.error { background-color: #F44336; color: white; }
        .notification.info { background-color: #2196F3; color: white; }

        /* Star rating styles */
        .star-rating .fa-star {
            color: #e4e5e9;
            cursor: pointer;
            transition: color 0.2s;
        }
        .star-rating.read-only .fa-star { cursor: default; }
        .star-rating .fa-star.selected { color: #ffc107; }
        .star-rating:not(.read-only):hover .fa-star { color: #ffc107; }
        .star-rating:not(.read-only) .fa-star:hover ~ .fa-star { color: #e4e5e9; }
        
        /* Error message & star styling */
        .error-message, .error-star {
            color: #EF4444; /* red-500 */
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: none; /* Hidden by default */
        }
        .error-star {
            margin-left: 0.25rem;
            font-weight: bold;
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .print-hidden { display: none !important; }

            /* New report styling for print */
            #monthly-details-print-area {
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 auto;
                max-width: 8.5in;
                height: 11in;
            }
        }

        /* --- New Layout Styles --- */
        html, body {
            height: 100%;
            overflow: hidden; /* Prevent body scroll on desktop */
            padding: 0; /* Remove body padding on desktop */
        }
        .main-container {
            width: 100%;
            max-width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: row;
            padding: 0;
            border-radius: 0;
        }
        .desktop-layout-wrapper {
            flex-direction: row;
            flex-grow: 1;
            overflow: hidden;
            width: 100%;
        }
        .side-navigation {
            flex-basis: 240px;
            flex-shrink: 0;
            background-color: white;
            border-right: 1px solid #e9ecef;
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            transition: flex-basis 0.3s ease;
        }
        .side-navigation.collapsed {
            flex-basis: 60px;
            overflow: hidden;
        }
        .side-navigation.collapsed .tab-button {
            justify-content: center;
        }
        .side-navigation.collapsed .tab-button > span:not(#coaching-badge) {
            display: none;
        }
        .side-navigation.collapsed #sidebar-title {
            display: none;
        }
        .side-navigation.collapsed #coaching-badge {
            top: 12px;
            right: 12px;
        }
        .main-tab-group {
            flex-direction: column;
            gap: 8px;
            background-color: transparent;
            padding: 0;
            margin-top: 1rem;
        }
        .side-navigation .tab-button {
            flex: none;
            justify-content: flex-start;
            width: 100%;
            padding: 12px 16px;
            font-size: 14px;
            border-radius: 0.5rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }
        .side-navigation .tab-button i {
            font-size: 16px;
            width: 20px;
            text-align: center;
            margin-right: 12px;
        }
        .side-navigation.collapsed .tab-button i {
            margin-right: 0;
        }
        .side-navigation .tab-button.active {
            background-color: #4361ee;
            color: white;
            box-shadow: 0 2px 4px rgba(67, 97, 238, 0.2);
        }
        .side-navigation .tab-button:not(.active) {
            color: #495057;
            background-color: transparent;
        }
        .side-navigation .tab-button:hover:not(.active) {
            background-color: #f3f4f6;
        }
        .main-content-scrollable {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #f5f7fa;
            width: calc(100% - 240px);
            transition: width 0.3s ease;
        }
        .main-content-scrollable.full-width {
            width: calc(100% - 60px);
        }
        .mobile-only-header { display: none; }
        .dynamic-mobile-title {
            display: none;
        }
        
        /* Mobile View Fixes & Enhancements */
        @media (max-width: 1023px) {
            body {
                overflow-x: hidden;
                display: block;
                background-color: #f5f7fa;
                padding: 0;
            }
            .main-container {
                height: auto;
                flex-direction: column;
                padding: 12px;
                border-radius: 0;
                box-shadow: none;
                background-color: transparent;
            }
            .side-navigation { display: none; }
            .mobile-only-header {
                display: block;
                background-color: transparent;
                margin-bottom: 12px;
            }
            .dynamic-mobile-title {
                display: block;
                font-size: 1.25rem;
                font-weight: 700;
                color: #212b36;
                text-align: center;
                margin-bottom: 12px;
            }
            .main-content-scrollable {
                padding: 0;
                width: 100%;
            }
            #top-nav {
                display: flex;
                flex-direction: row;
                justify-content: center;
                border-bottom: 1px solid #e9ecef;
            }
            #top-nav .tab-button {
                flex: 1;
                justify-content: center;
                padding: 12px 0;
                border-radius: 0;
                background-color: transparent;
                color: #495057;
                border-bottom: 2px solid transparent;
            }
            /* MODIFICATION: Hide text span but not the badge span */
            #top-nav .tab-button span:not(#coaching-badge-mobile) {
                display: none;
            }
            #top-nav .tab-button i {
                margin-right: 0;
            }
            #top-nav .tab-button.active {
                color: #4361ee;
                border-bottom-color: #4361ee;
            }
        }

        /* Specific styles for forms */
        .form-section {
            padding: 16px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            border: 1px solid #e9ecef;
            background-color: white;
        }
        .form-header {
            display: flex;
            align-items: center;
            margin-bottom: 14px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e9ecef;
        }
        .form-title {
            color: #212b36;
            font-size: 18px;
            font-weight: 600;
            flex: 1;
        }
        .form-logo {
            width: 36px;
            height: 36px;
            background-color: #4361ee;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            color: white;
            font-size: 18px;
        }
        .action-button {
            padding: 10px;
            border-radius: 18px;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .submit-btn {
            background-color: #4361ee;
            color: white;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
        }
        .submit-btn:hover:not(:disabled) {
            background-color: #3a56d4;
            transform: translateY(-1px);
        }
        .reset-btn {
            background-color: #fff;
            color: red;
            border: 1px solid #dce0e5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .reset-btn:hover:not(:disabled) {
            background-color: #f8f9fa;
        }
        .retrieve-btn {
            background-color: #2e8540;
            color: white;
            box-shadow: 0 4px 12px rgba(46, 133, 64, 0.2);
        }
        .retrieve-btn:hover:not(:disabled) {
            background-color: #267438;
            transform: translateY(-1px);
        }
        .disabled-button {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Specific adjustments for monthly details page */
        #monthly-details-tab-content {
            background-color: #f5f7fa;
            overflow-y: auto;
            border-radius: 0;
            box-shadow: none;
            padding: 12px;
        }
        
        #monthly-report-title {
            font-size: 1.25rem;
        }
        .analysis-summary-box h3 {
            font-size: 1rem;
        }
        .analysis-summary-box .text-3xl {
            font-size: 2rem;
        }
        .analysis-summary-box {
            padding: 0.75rem;
        }

        /* Table responsiveness on mobile */
        @media (max-width: 767px) {
            #report-details-section .overflow-x-auto {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            #report-details-section .min-w-[700px] {
                min-width: 700px;
            }
            #reports-table {
                width: 100%;
            }
        }
        .download-btn {
            background-color: #0d9488;
            color: white;
        }
        .download-btn:hover {
            background-color: #0f766e;
        }
    </style>
</head>
<body class="flex min-h-screen">

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <!-- Main Container to hold everything, matching the layout -->
    <div id="main-app-container" class="main-container">

        <!-- Sidebar Navigation for PC -->
        <nav class="side-navigation print-hidden">
            <div class="flex justify-between items-center mb-4">
                 <h2 id="sidebar-title" class="text-lg font-bold text-gray-800">DM Portal</h2>
                 <button id="toggle-sidebar" class="text-gray-500 hover:text-gray-700 transition hidden md:block">
                     <i class="fas fa-bars"></i>
                 </button>
            </div>

            <div class="main-tab-group">
                <button id="dm-report-tab" class="tab-button active">
                    <i class="fas fa-file-alt fa-fw"></i> <span>DM Report</span>
                </button>
                <button id="coaching-report-tab" class="tab-button relative">
                    <i class="fas fa-chalkboard-teacher fa-fw"></i> 
                    <span>Coaching Report</span>
                    <span id="coaching-badge" class="absolute top-3 right-3 w-4 h-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center hidden">0</span>
                </button>
                <button id="monthly-details-tab" class="tab-button">
                    <i class="fas fa-chart-pie fa-fw"></i> <span>Monthly Details</span>
                </button>
            </div>
        </nav>

        <!-- Main Content Wrapper with Tabs -->
        <div id="main-app" class="main-content-scrollable flex flex-col flex-grow">

            <!-- Mobile View Dynamic Title -->
            <div id="mobile-header-title" class="dynamic-mobile-title md:hidden">DM Report</div>

            <!-- Top Navigation for Mobile (adapted from the new layout) -->
            <div id="top-nav" class="flex border-b border-gray-200 print-hidden bg-white shadow-sm p-2 mb-4 rounded-xl md:hidden">
                <button id="dm-report-tab-mobile" class="tab-button active flex-1 px-4 py-2 text-sm font-medium"><i class="fas fa-file-alt fa-fw"></i> <span class="mobile-tab-text">DM Report</span></button>
                <button id="coaching-report-tab-mobile" class="tab-button relative flex-1 px-4 py-2 text-sm font-medium">
                    <i class="fas fa-chalkboard-teacher fa-fw"></i> <span class="mobile-tab-text">Coaching Report</span>
                    <span id="coaching-badge-mobile" class="absolute top-1 right-1 w-4 h-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center hidden">0</span>
                </button>
                <button id="monthly-details-tab-mobile" class="tab-button flex-1 px-4 py-2 text-sm font-medium"><i class="fas fa-chart-pie fa-fw"></i> <span class="mobile-tab-text">Monthly Details</span></button>
            </div>

            <!-- Tab Content Containers -->
            <div id="dm-report-tab-content" class="p-4 md:p-8 space-y-4 md:space-y-6 form-section">
                <div class="form-header">
                    <div class="form-logo"><i class="fas fa-file-alt"></i></div>
                    <h1 class="form-title">DM Report System</h1>
                </div>

                <form id="report-form" class="space-y-4">

                    <!-- District Manager Name and Live Date -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-700">District Manager Name</label>
                            <select id="dm-name-select" name="dm-name-select" class="pl-3 block w-full p-1 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option value="" disabled selected>Loading...</option>
                            </select>
                            <p id="dm-name-error" class="error-message">Please select a District Manager.</p>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700">Date and Time</label>
                            <div id="live-time" class="mt-1 p-1 bg-gray-50 border border-gray-300 rounded-md shadow-sm text-center font-semibold text-gray-600">
                                Loading...
                            </div>
                        </div>
                    </div>

                    <!-- Activity Type Radio Buttons -->
                    <div class="mt-4">
                        <label class="block text-xs font-medium text-gray-700">Activity Type</label>
                        <div class="mt-1 grid grid-cols-3 gap-2 md:gap-4">
                            <label class="flex items-center p-2 bg-white border border-gray-300 rounded-md cursor-pointer hover:bg-blue-50 transition duration-150 ease-in-out">
                                <input type="radio" name="activity-type" value="Visits" class="form-radio h-3 w-3 text-blue-600 focus:ring-blue-500">
                                <span class="ml-1 text-gray-700 text-xs">Visits</span>
                            </label>
                            <label class="flex items-center p-2 bg-white border border-gray-300 rounded-md cursor-pointer hover:bg-blue-50 transition duration-150 ease-in-out">
                                <input type="radio" name="activity-type" value="Event" class="form-radio h-3 w-3 text-blue-600 focus:ring-blue-500">
                                <span class="ml-1 text-gray-700 text-xs">Event</span>
                            </label>
                            <label class="flex items-center p-2 bg-white border border-gray-300 rounded-md cursor-pointer hover:bg-blue-50 transition duration-150 ease-in-out">
                                <input type="radio" name="activity-type" value="Leave" class="form-radio h-3 w-3 text-blue-600 focus:ring-blue-500">
                                <span class="ml-1 text-gray-700 text-xs">Leave</span>
                            </label>
                        </div>
                        <p id="activity-type-error" class="error-message">Please select an activity type.</p>
                    </div>

                    <!-- Conditional Forms -->
                    <div id="conditional-forms">

                        <!-- Visits Form -->
                        <div id="visits-form" class="p-4 rounded-md shadow-inner space-y-4 hidden form-border-visits" >
                            <h3 class="text-sm font-semibold text-gray-800">Visits Details</h3>
                            <div>
                                <label for="visit-type" class="block text-xs font-medium text-gray-700">Visit Type</label>
                                <select id="visit-type" name="visit-type" class="mt-1 block w-full p-1 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Double Visit">Double Visit</option>
                                    <option value="Single Visit">Single Visit</option>
                                </select>
                            </div>

                            <!-- Double Visit Form -->
                            <div id="double-visit-form" class="space-y-2">
                                <div id="double-visit-options" class="space-y-2">
                                    <div>
                                        <label for="med-rep-name" class="block text-xs font-medium text-gray-700">Medical Rep Name</label>
                                        <select id="med-rep-name" name="med-rep-name" class="mt-1 block w-full p-1 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <option value="" disabled selected>Select DM first</option>
                                        </select>
                                        <p id="med-rep-name-error" class="error-message">Please select a Medical Rep.</p>
                                    </div>
                                    <div id="double-visit-mode" class="hidden space-y-2">
                                        <label class="block text-xs font-medium text-gray-700">Select Report Mode</label>
                                        <div class="flex items-center space-x-4">
                                            <label class="flex items-center">
                                                <input type="radio" name="double-visit-mode" value="manual" class="form-radio h-3 w-3 text-blue-600 focus:ring-blue-500">
                                                <span class="ml-1 text-gray-700 text-xs">Add Manually</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="radio" name="double-visit-mode" value="visits" class="form-radio h-3 w-3 text-blue-600 focus:ring-blue-500">
                                                <span class="ml-1 text-gray-700 text-xs">Select from Today's Visits</span>
                                            </label>
                                        </div>
                                        <p id="double-visit-mode-error" class="error-message">Please select a report mode.</p>
                                    </div>
                                </div>

                                <!-- Manual Double Visit Form (hidden by default) -->
                                <div id="manual-double-visit-form" class="space-y-2 hidden">
                                    <div>
                                        <label for="period-double" class="block text-xs font-medium text-gray-700">Period</label>
                                        <select id="period-double" name="period-double" class="mt-1 block w-full p-1 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <option value="AM">AM</option>
                                            <option value="PM">PM</option>
                                            <option value="Full Day" selected>Full Day</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="brick-double" class="block text-xs font-medium text-gray-700">Brick</label>
                                        <select id="brick-double" name="brick-double" class="mt-1 block w-full p-1 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <option value="" disabled selected>Select Medical Rep first</option>
                                        </select>
                                        <p id="brick-double-error" class="error-message">Please select a Brick.</p>
                                    </div>
                                    <div>
                                        <label for="details-double-manual" class="block text-xs font-medium text-gray-700">Comment</label>
                                        <textarea id="details-double-manual" name="details-double-manual" rows="2" class="mt-1 block w-full shadow-sm border border-gray-400 rounded-md focus:ring-blue-500 focus:border-blue-500 p-2"></textarea>
                                        <p id="details-double-manual-error" class="error-message">Please provide a comment.</p>
                                    </div>
                                </div>

                                <!-- Visits Modal Trigger (hidden by default) -->
                                <div id="visits-modal-trigger" class="space-y-2 hidden">
                                    <div>
                                        <label for="period-double-visits" class="block text-xs font-medium text-gray-700">Period</label>
                                        <select id="period-double-visits" name="period-double-visits" class="mt-1 block w-full p-1 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <option value="AM">AM</option>
                                            <option value="PM">PM</option>
                                            <option value="Full Day" selected>Full Day</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="brick-double-visits" class="block text-xs font-medium text-gray-700">Brick</label>
                                        <select id="brick-double-visits" name="brick-double-visits" class="mt-1 block w-full p-1 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <option value="" disabled selected>Select Medical Rep first</option>
                                        </select>
                                    </div>
                                    <button type="button" id="open-visits-modal" class="w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-xs font-medium rounded-md shadow-sm transition duration-150 ease-in-out">
                                        Select Today's Visits
                                    </button>
                                </div>
                                <input type="hidden" id="selected-visits-double" name="selected-visits-double">
                            </div>

                            <!-- Single Visit Form -->
                            <div id="single-visit-form" class="space-y-2 hidden">
                                <div>
                                    <label for="period-single" class="block text-xs font-medium text-gray-700">Period</label>
                                    <select id="period-single" name="period-single" class="mt-1 block w-full p-1 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="AM">AM</option>
                                        <option value="PM">PM</option>
                                        <option value="Full Day" selected>Full Day</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="brick-single" class="block text-xs font-medium text-gray-700">Brick</label>
                                    <select id="brick-single" name="brick-single" class="mt-1 block w-full p-1 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="" disabled selected>Select DM first</option>
                                    </select>
                                    <p id="brick-single-error" class="error-message">Please select a Brick.</p>
                                </div>
                                <div>
                                    <label for="details-single" class="block text-xs font-medium text-gray-700">Comment</label>
                                    <textarea id="details-single" name="details-single" rows="2" class="mt-1 block w-full shadow-sm border border-gray-400 rounded-md focus:ring-blue-500 focus:border-blue-500 p-2"></textarea>
                                    <p id="details-single-error" class="error-message">Please provide a comment.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Event Form -->
                        <div id="event-form" class="p-4 rounded-md shadow-inner space-y-2 hidden form-border-events">
                            <h3 class="text-sm font-semibold text-gray-800">Event Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                <div>
                                    <label for="event-type" class="block text-xs font-medium text-gray-700">Event Type</label>
                                    <select id="event-type" name="event-type" class="mt-1 block w-full p-1 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="Meeting">Meeting</option>
                                        <option value="Event">Event</option>
                                        <option value="Admin Work">Admin Work</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="period-event" class="block text-xs font-medium text-gray-700">Period</label>
                                    <select id="period-event" name="period-event" class="mt-1 block w-full p-1 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="AM">AM</option>
                                        <option value="PM">PM</option>
                                        <option value="Full Day" selected>Full Day</option>
                                    </select>
                                </div>
                            </div>
                            <!-- NEW: Meeting Place Dropdown -->
                            <div id="meeting-place-div" class="hidden">
                                <label for="meeting-place-select" class="block text-xs font-medium text-gray-700">Meeting Place</label>
                                <select id="meeting-place-select" name="meeting-place-select" class="mt-1 block w-full p-1 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="" disabled selected>Select place</option>
                                    <option value="OFFICE">OFFICE</option>
                                    <option value="Online">Online</option>
                                    <option value="Phone Call">Phone Call</option>
                                </select>
                                <p id="meeting-place-error" class="error-message">Please select a meeting place.</p>
                            </div>
                             <!-- NEW: Event Brick Dropdown -->
                            <div id="event-brick-div" class="hidden">
                                <label for="event-brick-select" class="block text-xs font-medium text-gray-700">Brick</label>
                                <select id="event-brick-select" name="event-brick-select" class="mt-1 block w-full p-1 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="" disabled selected>Select DM first</option>
                                </select>
                                <p id="event-brick-error" class="error-message">Please select a brick for the event.</p>
                            </div>
                            <div id="admin-work-type-div" class="hidden">
                                <label for="admin-work-type" class="block text-xs font-medium text-gray-700">Admin Work Type</label>
                                <select id="admin-work-type" name="admin-work-type" class="mt-1 block w-full p-1 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="" disabled selected>Select type</option>
                                    <option value="Online">Online</option>
                                    <option value="Office">Office</option>
                                </select>
                                <p id="admin-work-type-error" class="error-message">Please select an Admin Work type.</p>
                            </div>
                            <div>
                                <label for="details-event" class="block text-xs font-medium text-gray-700">Comment</label>
                                <textarea id="details-event" name="details-event" rows="2" class="mt-1 block w-full shadow-sm border border-gray-400 rounded-md focus:ring-blue-500 focus:border-blue-500 p-2"></textarea>
                                <p id="details-event-error" class="error-message">Please provide a comment.</p>
                            </div>
                        </div>

                        <!-- Leave Form -->
                        <div id="leave-form" class="p-4 rounded-md shadow-inner space-y-2 hidden form-border-leaves">
                            <h3 class="text-sm font-semibold text-gray-800">Leave Details</h3>
                            <div>
                                <label for="leave-type" class="block text-xs font-medium text-gray-700">Leave Type</label>
                                <select id="leave-type" name="leave-type" class="mt-1 block w-full p-1 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Annual Leave">Annual Leave</option>
                                    <option value="Sick Leave">Sick Leave</option>
                                    <option value="Casual Leave">Casual Leave</option>
                                    <option value="Official Leave">Official Leave</option>
                                </select>
                            </div>
                            <div>
                                <label for="period-leave" class="block text-xs font-medium text-gray-700">Period</label>
                                <select id="period-leave" name="period-leave" class="mt-1 block w-full p-1 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="AM">AM</option>
                                    <option value="PM">PM</option>
                                    <option value="Full Day" selected>Full Day</option>
                                </select>
                            </div>
                            <div>
                                <label for="details-leave" class="block text-xs font-medium text-gray-700">Comment</label>
                                <textarea id="details-leave" name="details-leave" rows="2" class="mt-1 block w-full shadow-sm border border-gray-400 rounded-md focus:ring-blue-500 focus:border-blue-500 p-2"></textarea>
                                <p id="details-leave-error" class="error-message">Please provide a comment.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="flex flex-row justify-center space-x-2 md:space-x-4 mt-4 print-hidden">
                        <button type="submit" class="flex-1 md:flex-initial md:w-auto px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-xs font-medium rounded-md text-white shadow-lg transition duration-150 ease-in-out">
                            Submit
                        </button>
                        <button type="button" id="reset-button" class="flex-1 md:flex-initial md:w-auto px-4 py-2 border-2 border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-150 ease-in-out">
                            Reset
                        </button>
                        <button type="button" id="retrieve-button" class="flex-1 md:flex-initial md:w-auto px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-xs font-medium rounded-md shadow-sm transition duration-150 ease-in-out">
                            Retrieve
                        </button>
                    </div>
                </form>

                <!-- Submitted Data Table -->
                <div id="report-details-section" class="mt-8 hidden form-section">
                    <div class="flex flex-col md:flex-row items-center justify-between mb-4 space-y-2 md:space-y-0 md:space-x-4 print-hidden">
                        <h2 class="text-xl font-bold text-gray-800 text-center md:text-left">Report Details</h2>
                        <div class="flex space-x-2 w-full md:w-auto">
                            <input type="text" id="search-box" placeholder="Search reports..." class="flex-grow w-full md:w-64 p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                        </div>
                    </div>

                    <div class="w-full overflow-x-auto bg-gray-50 p-2 rounded-md shadow-inner">
                        <div>
                            <table id="reports-table" class="w-full divide-y divide-gray-200">
                                <thead id="reports-table-head" class="bg-gray-100">
                                </thead>
                                <tbody id="reports-table-body" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                        <div id="no-reports-message" class="hidden text-center text-gray-500 p-4">No reports to display.</div>
                    </div>
                </div>
            </div>

            <!-- Coaching Report Tab Content -->
            <div id="coaching-report-tab-content" class="p-4 md:p-8 space-y-4 md:space-y-6 hidden form-section">
                <div class="form-header">
                    <div class="form-logo"><i class="fas fa-chalkboard-teacher"></i></div>
                    <h1 class="form-title">Coaching Report</h1>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="coaching-med-rep-name" class="block text-xs font-medium text-gray-700">Medical Representative</label>
                        <select id="coaching-med-rep-name" name="coaching-med-rep-name" class="mt-1 block w-full p-1 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="" disabled selected>Select DM first</option>
                        </select>
                    </div>
                    <div>
                        <label for="coaching-status-filter" class="block text-xs font-medium text-gray-700">Filter by Status</label>
                        <select id="coaching-status-filter" name="coaching-status-filter" class="mt-1 block w-full p-1 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="All">All</option>
                            <option value="Pending">Pending</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                </div>

                <div id="coaching-report-table-container" class="mt-8 hidden form-section">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Double Visits This Month</h2>
                    <div class="overflow-x-auto bg-gray-50 p-2 rounded-md shadow-inner">
                        <table id="coaching-reports-table" class="min-w-full divide-y divide-gray-200">
                            <thead id="coaching-reports-table-head" class="bg-gray-100">
                                <!-- Headers will be populated by JS -->
                            </thead>
                            <tbody id="coaching-reports-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                        <div id="no-coaching-reports-message" class="hidden text-center text-gray-500 p-4">No double visits to display for this representative this month.</div>
                    </div>
                </div>
            </div>

            <!-- Monthly Details Tab Content -->
            <div id="monthly-details-tab-content" class="p-4 md:p-8 space-y-4 md:space-y-6 hidden">
                <div id="monthly-details-print-area" class="container mx-auto bg-white rounded-2xl shadow-2xl p-4 md:p-8 space-y-4 md:space-y-6">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 space-y-2 md:space-y-0">
                        <h2 id="monthly-report-title" class="text-xl md:text-2xl font-bold text-gray-800"></h2>
                        <div class="flex space-x-2 print-hidden">
                             <button id="details-btn" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded-md transition duration-150 ease-in-out flex items-center">
                                 <i class="fas fa-info-circle mr-1"></i> Details
                             </button>
                            <button id="download-xlsx-btn" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-xs font-medium rounded-md transition duration-150 ease-in-out flex items-center">
                                <i class="fas fa-file-excel mr-1"></i> XLSX
                            </button>
                            <button id="print-monthly-btn" class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white text-xs font-medium rounded-md transition duration-150 ease-in-out flex items-center">
                                <i class="fas fa-print mr-1"></i> Print
                            </button>
                        </div>
                    </div>

                    <div id="analysis-content" class="space-y-6">
                        <!-- Three Summary Boxes -->
                        <div id="analysis-summary-boxes" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Filed Visits Box -->
                            <div id="filed-visits-box" class="analysis-summary-box bg-blue-500 text-white p-3 rounded-md shadow-lg cursor-pointer transition hover:bg-blue-600">
                                <h3 class="font-semibold text-lg mb-1">Filed Visits</h3>
                                <div class="text-2xl font-bold"><span id="filed-visits-count">0</span></div>
                                <div class="text-sm">Total Filed Days</div>
                            </div>
                            <!-- Events Box -->
                            <div id="events-box" class="analysis-summary-box bg-purple-500 text-white p-3 rounded-md shadow-lg cursor-pointer transition hover:bg-purple-600">
                                <h3 class="font-semibold text-lg mb-1">Events</h3>
                                <div class="text-2xl font-bold"><span id="events-count">0</span></div>
                                <div class="text-sm">Total Event Days</div>
                            </div>
                            <!-- Leaves Box -->
                            <div id="leaves-box" class="analysis-summary-box bg-red-500 text-white p-3 rounded-md shadow-lg cursor-pointer transition hover:bg-red-600">
                                <h3 class="font-semibold text-lg mb-1">Leaves</h3>
                                <div class="text-2xl font-bold"><span id="leaves-count">0</span></div>
                                <div class="text-sm">Total Leave Days</div>
                            </div>
                        </div>
                        
                        <!-- Details Sections (Now hidden by default, shown in modal) -->
                        <div id="filed-visits-details-section" class="mt-8 hidden">
                            <h3 id="filed-visits-details-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
                            <div id="double-visits-details" class="space-y-2">
                            </div>
                            <div id="single-visits-details" class="space-y-2 mt-4">
                            </div>
                        </div>

                        <div id="events-details-section" class="mt-8 hidden">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Event Details</h3>
                            <div id="events-details" class="space-y-2">
                            </div>
                        </div>

                        <div id="leaves-details-section" class="mt-8 hidden">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Leave Details</h3>
                            <div id="leaves-details" class="space-y-2">
                            </div>
                        </div>

                        <div id="analysis-summary-section" class="hidden max-md:hidden md:flex items-center justify-center gap-8">
							<div id="activity-chart-container" class="w-full md:w-1/2 max-w-[400px] aspect-square flex items-center justify-center">
								<canvas id="activity-chart"></canvas>
							</div>
							<div id="chart-legend-container" class="w-full md:w-1/2">
							</div>
						</div>
						<div id="analysis-summary-section-mobile" class="hidden md:hidden flex-col items-center">
							<div class="w-full flex items-center justify-center">
								<div id="activity-chart-container-mobile" class="w-full max-w-[400px] aspect-square flex items-center justify-center">
									<canvas id="activity-chart-mobile"></canvas>
								</div>
							</div>
							<!-- FIX: Added container for mobile legend -->
							<div id="chart-legend-container-mobile" class="w-full mt-4">
							</div>
						</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Double Visit -->
    <div id="visit-modal" class="modal fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:w-1/2 lg:w-1/3 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center pb-3 border-b mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Select Today's Visits</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div id="modal-content" class="overflow-y-auto space-y-2 flex-grow mb-4 pr-2">
            </div>
            <div class="flex justify-end space-x-2 border-t pt-4">
                <button id="save-visits" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md shadow-sm transition">Save</button>
                <button id="cancel-visits" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md shadow-sm transition">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for full row details -->
    <div id="row-details-modal" class="modal fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:w-1/2 lg:w-1/3 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center pb-3 border-b mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Full Report Details</h3>
                <button id="close-row-details-modal" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div id="row-details-content" class="overflow-y-auto space-y-2 flex-grow mb-4 pr-2">
            </div>
            <div class="flex justify-end border-t pt-4">
                <button id="ok-row-details-modal" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md shadow-sm transition">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for displaying visit dates -->
    <div id="dates-modal" class="modal fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:w-1/2 lg:w-1/3 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center pb-3 border-b mb-4">
                <h3 id="dates-modal-title" class="text-lg font-semibold text-gray-800">Visit Dates</h3>
                <button id="close-dates-modal" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div id="dates-modal-content" class="overflow-y-auto space-y-2 flex-grow mb-4 pr-2">
            </div>
            <div class="flex justify-end border-t pt-4">
                <button id="ok-dates-modal" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md shadow-sm transition">OK</button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Modal for Monthly Report Details -->
    <div id="details-modal" class="modal fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:w-3/4 lg:w-2/3 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center pb-3 border-b mb-4">
                <h3 id="details-modal-title" class="text-lg font-semibold text-gray-800">Monthly Details</h3>
                <button id="close-details-modal" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div id="details-modal-content" class="overflow-y-auto space-y-4 flex-grow mb-4 pr-2">
                <!-- Content will be populated by JS -->
            </div>
            <div class="flex justify-end border-t pt-4">
                <button id="ok-details-modal" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md shadow-sm transition">OK</button>
            </div>
        </div>
    </div>


    <!-- Coaching Evaluation Modal -->
    <div id="coaching-modal" class="modal fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:w-2/3 lg:w-1/2 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center pb-3 border-b mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Coaching Evaluation</h3>
                <button id="close-coaching-modal" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div id="coaching-modal-content" class="overflow-y-auto space-y-4 flex-grow mb-4 pr-2">
                <div id="coaching-modal-header-info" class="space-y-2 mb-4 border-b pb-2">
                </div>
                <form id="coaching-evaluation-form">
                    <input type="hidden" id="coaching-report-id">
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-700">Feedback<span class="error-star" data-for="feedback_score">*</span></label>
                            <div class="star-rating" data-field="feedback_score">
                                <i class="fas fa-star" data-value="1"></i><i class="fas fa-star" data-value="2"></i><i class="fas fa-star" data-value="3"></i><i class="fas fa-star" data-value="4"></i><i class="fas fa-star" data-value="5"></i>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-700">Opening<span class="error-star" data-for="opening_score">*</span></label>
                            <div class="star-rating" data-field="opening_score">
                                <i class="fas fa-star" data-value="1"></i><i class="fas fa-star" data-value="2"></i><i class="fas fa-star" data-value="3"></i><i class="fas fa-star" data-value="4"></i><i class="fas fa-star" data-value="5"></i>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-700">Asking for commitment<span class="error-star" data-for="asking_for_commitment_score">*</span></label>
                            <div class="star-rating" data-field="asking_for_commitment_score">
                                <i class="fas fa-star" data-value="1"></i><i class="fas fa-star" data-value="2"></i><i class="fas fa-star" data-value="3"></i><i class="fas fa-star" data-value="4"></i><i class="fas fa-star" data-value="5"></i>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-700">Handling objection<span class="error-star" data-for="handling_objection_score">*</span></label>
                            <div class="star-rating" data-field="handling_objection_score">
                                <i class="fas fa-star" data-value="1"></i><i class="fas fa-star" data-value="2"></i><i class="fas fa-star" data-value="3"></i><i class="fas fa-star" data-value="4"></i><i class="fas fa-star" data-value="5"></i>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-700">Planning<span class="error-star" data-for="planning_score">*</span></label>
                            <div class="star-rating" data-field="planning_score">
                                <i class="fas fa-star" data-value="1"></i><i class="fas fa-star" data-value="2"></i><i class="fas fa-star" data-value="3"></i><i class="fas fa-star" data-value="4"></i><i class="fas fa-star" data-value="5"></i>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-700">Time Management<span class="error-star" data-for="time_management_score">*</span></label>
                            <div class="star-rating" data-field="time_management_score">
                                <i class="fas fa-star" data-value="1"></i><i class="fas fa-star" data-value="2"></i><i class="fas fa-star" data-value="3"></i><i class="fas fa-star" data-value="4"></i><i class="fas fa-star" data-value="5"></i>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-700">Medical & Product Knowledge<span class="error-star" data-for="medical_product_knowledge_score">*</span></label>
                            <div class="star-rating" data-field="medical_product_knowledge_score">
                                <i class="fas fa-star" data-value="1"></i><i class="fas fa-star" data-value="2"></i><i class="fas fa-star" data-value="3"></i><i class="fas fa-star" data-value="4"></i><i class="fas fa-star" data-value="5"></i>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <label for="coaching-conclusions" class="block text-sm font-medium text-gray-700">Conclusions<span class="error-star" data-for="coaching-conclusions">*</span></label>
                        <textarea id="coaching-conclusions" name="coaching-conclusions" rows="3" class="mt-1 block w-full shadow-sm border border-gray-400 rounded-md focus:ring-blue-500 focus:border-blue-500 p-2"></textarea>
                    </div>
                </form>
            </div>
            <div class="flex justify-end space-x-2 border-t pt-4">
                <button id="submit-coaching-report" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md shadow-sm transition">Submit</button>
                <button id="reset-coaching-form" type="button" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md shadow-sm transition">Reset</button>
            </div>
        </div>
    </div>
    
    <!-- Read-only Coaching Report View Modal -->
    <div id="coaching-view-modal" class="modal fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 md:w-2/3 lg:w-1/2 max-h-[90vh] flex flex-col">
            <div id="coaching-view-print-area" class="p-6 flex-grow overflow-y-auto">
                <div class="flex justify-between items-center pb-3 border-b mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Coaching Report</h3>
                    <button id="close-coaching-view-modal" class="text-gray-400 hover:text-gray-600 print-hidden">&times;</button>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="font-semibold">Medical Rep:</span>
                            <span id="view-med-rep-name"></span>
                        </div>
                        <div>
                            <span class="font-semibold">Double Visit Date:</span>
                            <span id="view-visit-date"></span>
                        </div>
                    </div>
                    <div class="text-sm p-2 bg-gray-50 rounded-md border">
                        <p class="font-semibold">Visit Details:</p>
                        <p id="view-visit-details"></p>
                    </div>
                    
                    <div class="space-y-3 border-t pt-4">
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-700">Feedback</label>
                            <div class="star-rating read-only" data-field="view_feedback_score">
                                <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-700">Opening</label>
                            <div class="star-rating read-only" data-field="view_opening_score">
                                <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-700">Asking for commitment</label>
                            <div class="star-rating read-only" data-field="view_asking_for_commitment_score">
                                <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-700">Handling objection</label>
                            <div class="star-rating read-only" data-field="view_handling_objection_score">
                                <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-700">Planning</label>
                            <div class="star-rating read-only" data-field="view_planning_score">
                                <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-700">Time Management</label>
                            <div class="star-rating read-only" data-field="view_time_management_score">
                                <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-700">Medical & Product Knowledge</label>
                            <div class="star-rating read-only" data-field="view_medical_product_knowledge_score">
                                <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 border-t pt-4">
                        <p class="font-semibold text-sm">Conclusions:</p>
                        <p id="view-conclusions" class="text-sm p-2 bg-gray-50 rounded-md border mt-1"></p>
                    </div>
                </div>
                 <div class="flex justify-end space-x-2 border-t pt-4 print-hidden">
                     <button id="print-coaching-btn" class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white text-xs font-medium rounded-md transition duration-150 ease-in-out flex items-center">
                         <i class="fas fa-print mr-1"></i> Print
                     </button>
                     <button id="close-coaching-view-modal-2" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md shadow-sm transition">OK</button>
                 </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:w-1/3">
            <h3 id="confirm-modal-title" class="text-lg font-semibold text-gray-800 mb-4">Confirm Deletion</h3>
            <p id="confirm-modal-text" class="text-sm text-gray-600 mb-6"></p>
            <div class="flex justify-end space-x-2">
                <button id="confirm-modal-cancel" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md shadow-sm transition">Cancel</button>
                <button id="confirm-modal-confirm" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md shadow-sm transition">Delete</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
        // Global variable to store logged-in user data
        let loggedInUser = null;
        let allDmNames = [];
        let allMonthlyReports = []; // Store the fetched monthly reports
        let myChart = null; // To store the chart instance
        let myChartMobile = null; // To store the mobile chart instance
        let allSupabaseData = []; // Store the fetched masterlist data

        document.addEventListener('DOMContentLoaded', async () => {
            // Supabase configuration
            const SUPABASE_URL = "https://plmevfyxpngzymvzvkzn.supabase.co";
            const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBsbWV2Znl4cG5nenltdnp2a3puIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NjM5NDEsImV4cCI6MjA2NjMzOTk0MX0.lUm3efHFCL3aAB-PL7H54BpnvcpbXxp1BeUzw0yjp5c";
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            const TABLE_NAME = 'healthcarepro_visits';
            const REPORTS_TABLE = 'dm_report';
            const COACHING_REPORTS_TABLE = 'coaching_reports';
            const MASTERLIST_TABLE = 'masterlist'; // New table name

            let submittedReports = [];
            
            // Get form and modal elements
            const mainAppDiv = document.getElementById('main-app-container');
            const sideNav = document.querySelector('.side-navigation');
            const toggleSidebarBtn = document.getElementById('toggle-sidebar');
            const mainContent = document.getElementById('main-app');
            const dmReportTabContent = document.getElementById('dm-report-tab-content');
            const monthlyDetailsTabContent = document.getElementById('monthly-details-tab-content');
            const coachingReportTabContent = document.getElementById('coaching-report-tab-content');

            const dmReportTabButton = document.getElementById('dm-report-tab');
            const monthlyDetailsTabButton = document.getElementById('monthly-details-tab');
            const coachingReportTabButton = document.getElementById('coaching-report-tab');
            const dmReportTabButtonMobile = document.getElementById('dm-report-tab-mobile');
            const monthlyDetailsTabButtonMobile = document.getElementById('monthly-details-tab-mobile');
            const coachingReportTabButtonMobile = document.getElementById('coaching-report-tab-mobile');
            
            const mobileHeaderTitle = document.getElementById('mobile-header-title');

            const reportDetailsSection = document.getElementById('report-details-section');

            const form = document.getElementById('report-form');
            const dmNameSelect = document.getElementById('dm-name-select');
            const liveTimeDiv = document.getElementById('live-time');
            const activityRadios = document.getElementsByName('activity-type');
            const visitsForm = document.getElementById('visits-form');
            const eventForm = document.getElementById('event-form');
            const leaveForm = document.getElementById('leave-form');
            const visitTypeSelect = document.getElementById('visit-type');

            const doubleVisitForm = document.getElementById('double-visit-form');
            const doubleVisitModeRadios = document.getElementsByName('double-visit-mode');
            const doubleVisitModeDiv = document.getElementById('double-visit-mode');
            const manualDoubleVisitForm = document.getElementById('manual-double-visit-form');
            const visitsModalTriggerDiv = document.getElementById('visits-modal-trigger');
            const openVisitsModalBtn = document.getElementById('open-visits-modal');
            const singleVisitForm = document.getElementById('single-visit-form');

            const medRepNameSelect = document.getElementById('med-rep-name');
            const brickDoubleSelect = document.getElementById('brick-double');
            const brickDoubleVisitsSelect = document.getElementById('brick-double-visits');
            const brickSingleSelect = document.getElementById('brick-single');
            const reportsTableHeader = document.getElementById('reports-table-head');
            const reportsTableBody = document.getElementById('reports-table-body');
            const coachingReportsTableHead = document.getElementById('coaching-reports-table-head');
            const noReportsMessage = document.getElementById('no-reports-message');
            const resetButton = document.getElementById('reset-button');
            const retrieveButton = document.getElementById('retrieve-button');
            const searchBox = document.getElementById('search-box');
            const leaveTypeSelect = document.getElementById('leave-type');
            const eventTypeSelect = document.getElementById('event-type');
            const adminWorkTypeDiv = document.getElementById('admin-work-type-div');
            const adminWorkTypeSelect = document.getElementById('admin-work-type');
            // NEW: Event form dropdowns
            const meetingPlaceDiv = document.getElementById('meeting-place-div');
            const meetingPlaceSelect = document.getElementById('meeting-place-select');
            const eventBrickDiv = document.getElementById('event-brick-div');
            const eventBrickSelect = document.getElementById('event-brick-select');


            // Modal elements
            const visitModal = document.getElementById('visit-modal');
            const modalContent = document.getElementById('modal-content');
            const closeModalBtn = document.getElementById('close-modal');
            const saveVisitsBtn = document.getElementById('save-visits');
            const cancelVisitsBtn = document.getElementById('cancel-visits');
            const selectedVisitsInput = document.getElementById('selected-visits-double');

            const rowDetailsModal = document.getElementById('row-details-modal');
            const closeRowDetailsModalBtn = document.getElementById('close-row-details-modal');
            const okRowDetailsModalBtn = document.getElementById('ok-row-details-modal');
            const rowDetailsContent = document.getElementById('row-details-content');
            
            const datesModal = document.getElementById('dates-modal');
            const datesModalTitle = document.getElementById('dates-modal-title');
            const datesModalContent = document.getElementById('dates-modal-content');
            const closeDatesModalBtn = document.getElementById('close-dates-modal');
            const okDatesModalBtn = document.getElementById('ok-dates-modal');
            
            const detailsModal = document.getElementById('details-modal');
            const detailsModalTitle = document.getElementById('details-modal-title');
            const detailsModalContent = document.getElementById('details-modal-content');
            const closeDetailsModalBtn = document.getElementById('close-details-modal');
            const okDetailsModalBtn = document.getElementById('ok-details-modal');


            const confirmModal = document.getElementById('confirm-modal');
            const confirmModalText = document.getElementById('confirm-modal-text');
            const confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm');
            const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel');

            const monthlyDetailsPrintArea = document.getElementById('monthly-details-print-area');
            const analysisSummarySection = document.getElementById('analysis-summary-section');
            const analysisSummarySectionMobile = document.getElementById('analysis-summary-section-mobile');
            const monthlyReportTitle = document.getElementById('monthly-report-title');
            
            const filedVisitsBox = document.getElementById('filed-visits-box');
            const filedVisitsCountSpan = document.getElementById('filed-visits-count');
            const eventsBox = document.getElementById('events-box');
            const eventsCountSpan = document.getElementById('events-count');
            const leavesBox = document.getElementById('leaves-box');
            const leavesCountSpan = document.getElementById('leaves-count');
            
            const filedVisitsDetailsSection = document.getElementById('filed-visits-details-section');
            const filedVisitsDetailsTitle = document.getElementById('filed-visits-details-title');
            const doubleVisitsDetailsDiv = document.getElementById('double-visits-details');
            const singleVisitsDetailsDiv = document.getElementById('single-visits-details');
            const eventsDetailsSection = document.getElementById('events-details-section');
            const eventsDetailsDiv = document.getElementById('events-details');
            const leavesDetailsSection = document.getElementById('leaves-details-section');
            const leavesDetailsDiv = document.getElementById('leaves-details');
            const activityChartContainer = document.getElementById('activity-chart-container');
            const chartLegendContainer = document.getElementById('chart-legend-container');
            const activityChartCtx = document.getElementById('activity-chart').getContext('2d');
            const activityChartMobileCtx = document.getElementById('activity-chart-mobile').getContext('2d');
            
            const coachingMedRepNameSelect = document.getElementById('coaching-med-rep-name');
            const coachingStatusFilter = document.getElementById('coaching-status-filter');
            const coachingReportTableContainer = document.getElementById('coaching-report-table-container');
            const coachingReportsTableBody = document.getElementById('coaching-reports-table-body');
            const noCoachingReportsMessage = document.getElementById('no-coaching-reports-message');
            const coachingModal = document.getElementById('coaching-modal');
            const closeCoachingModalBtn = document.getElementById('close-coaching-modal');
            const coachingEvaluationForm = document.getElementById('coaching-evaluation-form');
            const submitCoachingReportBtn = document.getElementById('submit-coaching-report');
            const resetCoachingFormBtn = document.getElementById('reset-coaching-form');
            const starRatings = document.querySelectorAll('.star-rating');
            const coachingReportIdInput = document.getElementById('coaching-report-id');
            
            const coachingViewModal = document.getElementById('coaching-view-modal');
            const closeCoachingViewModalBtn = document.getElementById('close-coaching-view-modal');
            const closeCoachingViewModalBtn2 = document.getElementById('close-coaching-view-modal-2');
            const coachingViewPrintArea = document.getElementById('coaching-view-print-area');
            const printMonthlyBtn = document.getElementById('print-monthly-btn');
            const printCoachingBtn = document.getElementById('print-coaching-btn');
            const downloadXLSXBtn = document.getElementById('download-xlsx-btn');
            const detailsBtn = document.getElementById('details-btn');
            
            // --- NEW: Toggle Sidebar functionality for PC ---
            toggleSidebarBtn.addEventListener('click', () => {
                sideNav.classList.toggle('collapsed');
                mainContent.classList.toggle('full-width');
            });
            // --- END NEW ---

            // --- FUNCTION DEFINITIONS ---

            function updateFormVisibility() {
                const selectedActivity = document.querySelector('input[name="activity-type"]:checked')?.value;
                visitsForm.classList.add('hidden');
                eventForm.classList.add('hidden');
                leaveForm.classList.add('hidden');

                if (selectedActivity === 'Visits') {
                    visitsForm.classList.remove('hidden');
                    updateVisitTypeVisibility();
                } else if (selectedActivity === 'Event') {
                    eventForm.classList.remove('hidden');
                    updateEventTypeVisibility();
                } else if (selectedActivity === 'Leave') {
                    leaveForm.classList.remove('hidden');
                }
            }

            function updateVisitTypeVisibility() {
                const selectedVisitType = visitTypeSelect.value;
                doubleVisitForm.classList.add('hidden');
                singleVisitForm.classList.add('hidden');

                if (selectedVisitType === 'Double Visit') {
                    doubleVisitForm.classList.remove('hidden');
                    const selectedMedRep = medRepNameSelect.value;
                    if(selectedMedRep) {
                       doubleVisitModeDiv.classList.remove('hidden');
                       manualDoubleVisitForm.classList.add('hidden');
                       visitsModalTriggerDiv.classList.add('hidden');
                       doubleVisitModeRadios.forEach(radio => radio.checked = false); // Reset radio buttons
                    } else {
                       doubleVisitModeDiv.classList.add('hidden');
                    }
                } else if (selectedVisitType === 'Single Visit') {
                    singleVisitForm.classList.remove('hidden');
                }
            }
            
            function updateEventTypeVisibility() {
                const selectedEventType = eventTypeSelect.value;
                const selectedDm = dmNameSelect.value;

                // Hide all conditional divs first
                adminWorkTypeDiv.classList.add('hidden');
                meetingPlaceDiv.classList.add('hidden');
                eventBrickDiv.classList.add('hidden');

                if (selectedEventType === 'Admin Work') {
                    adminWorkTypeDiv.classList.remove('hidden');
                } else if (selectedEventType === 'Meeting') {
                    meetingPlaceDiv.classList.remove('hidden');
                } else if (selectedEventType === 'Event') {
                    eventBrickDiv.classList.remove('hidden');
                    // Populate bricks if DM is selected
                    if (selectedDm) {
                         const filteredData = allSupabaseData.filter(row => row['District Manager'] === selectedDm);
                         const dmBricks = [...new Set(filteredData.map(item => item['Brick']).filter(Boolean))];
                         const allDmBricksOptions = dmBricks.map(brick => `<option value="${brick}">${brick}</option>`).join('');
                         eventBrickSelect.innerHTML = `<option value="" disabled selected>Select Brick</option>` + allDmBricksOptions;
                    }
                }
            }


            let confirmCallback = null;
            const showConfirmModal = (text, onConfirm) => {
                confirmModalText.textContent = text;
                confirmCallback = onConfirm;
                confirmModal.classList.remove('hidden');
            };
            const hideConfirmModal = () => {
                confirmModal.classList.add('hidden');
                confirmCallback = null;
            };
            confirmModalCancelBtn.addEventListener('click', hideConfirmModal);
            confirmModalConfirmBtn.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                hideConfirmModal();
            });

            let notificationTimeout;
            const showNotification = (message, type = 'info') => {
                const container = document.getElementById('notification-container');
                let notification = container.querySelector('.notification');
                
                if (!notification) {
                    notification = document.createElement('div');
                    notification.className = 'notification';
                    container.appendChild(notification);
                }
                
                notification.className = 'notification';
                notification.classList.add(type);
                notification.textContent = message;
                notification.classList.add('show');
                
                clearTimeout(notificationTimeout);
                notificationTimeout = setTimeout(() => {
                    notification.classList.remove('show');
                }, 5000);
            };

            const showDatesModal = (title, items) => {
                datesModalTitle.textContent = title;
                datesModalContent.innerHTML = items.map(item => 
                    `<div class="flex justify-between text-sm text-gray-700 p-2 border-b last:border-b-0">
                        <span>${item.date}</span>
                        <span class="font-semibold bg-gray-100 px-2 py-0.5 rounded-full text-xs">${item.period}</span>
                    </div>`
                ).join('');
                datesModal.classList.remove('hidden');
            };

            const hideDatesModal = () => {
                datesModal.classList.add('hidden');
            };

            closeDatesModalBtn.addEventListener('click', hideDatesModal);
            okDatesModalBtn.addEventListener('click', hideDatesModal);
            
            // NEW: Details Modal Functions
            const showDetailsModal = () => {
                const dmName = dmNameSelect.value;
                if (!dmName || allMonthlyReports.length === 0) {
                    showNotification('No data available to display.', 'error');
                    return;
                }
                
                let modalHtml = '';
                const reportGroups = {
                    'Visits': { reports: allMonthlyReports.filter(r => r.activity_type.includes('Visits')), headers: ['activity_type', 'created_at', 'period', 'brick', 'med_rep'] },
                    'Events': { reports: allMonthlyReports.filter(r => r.activity_type.includes('Event')), headers: ['activity_type', 'created_at', 'period', 'brick', 'comment'] },
                    'Leaves': { reports: allMonthlyReports.filter(r => r.activity_type.includes('Leave')), headers: ['activity_type', 'created_at', 'period', 'comment'] },
                };

                for (const groupName in reportGroups) {
                    const group = reportGroups[groupName];
                    if (group.reports.length > 0) {
                        modalHtml += `<h3 class="text-lg font-semibold text-gray-800 mt-4">${groupName} Details</h3>`;
                        modalHtml += `<div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500">`;
                        modalHtml += `<thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr>`;
                        group.headers.forEach(h => modalHtml += `<th scope="col" class="px-4 py-2">${formatHeader(h)}</th>`);
                        modalHtml += `</tr></thead><tbody>`;
                        group.reports.forEach(report => {
                            modalHtml += `<tr class="bg-white border-b">`;
                            group.headers.forEach(h => {
                                let value = report[h] || 'N/A';
                                if (h === 'created_at') value = new Date(report[h]).toLocaleDateString();
                                modalHtml += `<td class="px-4 py-2">${value}</td>`;
                            });
                            modalHtml += `</tr>`;
                        });
                        modalHtml += `</tbody></table></div>`;
                    }
                }
                
                detailsModalContent.innerHTML = modalHtml;
                detailsModal.classList.remove('hidden');
            };

            const hideDetailsModal = () => {
                detailsModal.classList.add('hidden');
            };

            detailsBtn.addEventListener('click', showDetailsModal);
            closeDetailsModalBtn.addEventListener('click', hideDetailsModal);
            okDetailsModalBtn.addEventListener('click', hideDetailsModal);


            const showRowDetailsModal = (report) => {
                rowDetailsContent.innerHTML = '';
                const detailsHtml = Object.entries(report).map(([key, value]) => {
                    if (key === 'id' || key === 'dm_name') return '';
                    let formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                    if (key === 'created_at') formattedKey = 'Date & Time';
                    let formattedValue = value;
                    if (key === 'created_at') formattedValue = new Date(value).toLocaleString();

                    return `
                        <div class="p-2 border-b last:border-b-0">
                            <p class="font-semibold text-gray-800">${formattedKey}:</p>
                            <p class="text-sm text-gray-600 break-words">${formattedValue}</p>
                        </div>
                    `;
                }).join('');
                rowDetailsContent.innerHTML = detailsHtml;
                rowDetailsModal.classList.remove('hidden');
            };

            const hideRowDetailsModal = () => {
                rowDetailsModal.classList.add('hidden');
            };

            closeRowDetailsModalBtn.addEventListener('click', hideRowDetailsModal);
            okRowDetailsModalBtn.addEventListener('click', hideRowDetailsModal);

            const updateLiveTime = () => {
                const now = new Date();
                const options = {
                    day: 'numeric', month: 'long', year: 'numeric',
                    hour: '2-digit', minute: '2-digit', second: '2-digit',
                    hour12: true
                };
                const formatter = new Intl.DateTimeFormat('en-US', {
                    ...options,
                    timeZone: 'Africa/Cairo'
                });
                liveTimeDiv.textContent = formatter.format(now);
            };

            updateLiveTime();
            setInterval(updateLiveTime, 1000);
            
            const populateDmDropdown = (dmNames) => {
                const dmSelect = dmNameSelect;
                dmSelect.innerHTML = `<option value="" disabled selected>Select DM</option>`;
                dmNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    dmSelect.appendChild(option);
                });
            };
            
            // Replaced the Google Sheets fetching function with a Supabase one
            const fetchDataFromSupabase = async () => {
                try {
                    const limit = 1000;
                    let offset = 0;
                    let allData = [];
                    let hasMore = true;

                    while (hasMore) {
                        const { data, error } = await supabase
                            .from(MASTERLIST_TABLE)
                            .select('"District Manager", "medical rep", "Brick"')
                            .range(offset, offset + limit - 1);

                        if (error) throw error;
                        
                        if (data.length > 0) {
                            allData = allData.concat(data);
                            offset += data.length;
                        } else {
                            hasMore = false;
                        }

                        if (data.length < limit) {
                             hasMore = false;
                        }
                    }

                    allSupabaseData = allData;
                    allDmNames = [...new Set(allSupabaseData.map(item => item['District Manager']).filter(Boolean))];
                } catch (error) {
                    console.error('Error fetching data from Supabase:', error);
                    dmNameSelect.innerHTML = `<option value="" disabled selected>Failed to load data</option>`;
                }
            };

            const handleDeleteReport = (reportId) => {
                showConfirmModal('Are you sure you want to delete this report? This action cannot be undone.', async () => {
                    const { error } = await supabase.from(REPORTS_TABLE).delete().eq('id', reportId);
                    if (error) {
                        showNotification('Failed to delete report.', 'error');
                        console.error('Delete error:', error);
                    } else {
                        showNotification('Report deleted successfully.', 'success');
                        fetchReportsFromSupabase(dmNameSelect.value);
                    }
                });
            };

            const handleDeleteCoachingReport = (reportId) => {
                showConfirmModal('Are you sure you want to delete this coaching evaluation? This action cannot be undone.', async () => {
                    const { error } = await supabase.from(COACHING_REPORTS_TABLE).delete().eq('id', reportId);
                    if (error) {
                        showNotification('Failed to delete coaching report.', 'error');
                        console.error('Delete error:', error);
                    } else {
                        showNotification('Coaching report deleted successfully.', 'success');
                        fetchAndRenderCoachingReports(dmNameSelect.value, coachingMedRepNameSelect.value);
                        updateCoachingBadge();
                    }
                });
            };

            const fetchReportsFromSupabase = async (dmName = '') => {
                let query = supabase.from(REPORTS_TABLE).select('*').order('created_at', { ascending: false });
                if (dmName) {
                    query = query.eq('dm_name', dmName);
                }

                const { data, error } = await query;
                if (error) {
                    console.error('Error fetching reports:', error);
                    showNotification('Failed to retrieve reports from the database.', 'error');
                    return;
                }
                submittedReports = data || [];
                renderReports(submittedReports, dmName);
            };
            
            const formatHeader = (key) => {
                return key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
            };
            
            const formatUTCTime = (dateString) => {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                // The DB stores UTC time, so we need to get UTC values to display the correct time
                const hours = date.getUTCHours();
                const minutes = date.getUTCMinutes();
                const seconds = date.getUTCSeconds();
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const formattedHours = hours % 12 || 12; // Convert to 12-hour format
                const formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
                const formattedSeconds = seconds < 10 ? '0' + seconds : seconds;
                return `${formattedHours}:${formattedMinutes}:${formattedSeconds} ${ampm}`;
            };

            const renderReports = (reports, dmName = '', searchTerm = '') => {
                reportsTableHeader.innerHTML = '';
                reportsTableBody.innerHTML = '';
                let filteredReports = dmName ? reports.filter(report => report.dm_name === dmName) : [];

                if (searchTerm) {
                    const lowerCaseSearch = searchTerm.toLowerCase();
                    filteredReports = filteredReports.filter(report =>
                        Object.values(report).some(value =>
                            String(value).toLowerCase().includes(lowerCaseSearch)
                        )
                    );
                }

                if (filteredReports.length === 0) {
                    noReportsMessage.classList.remove('hidden');
                    return;
                }
                noReportsMessage.classList.add('hidden');

                const headers = Object.keys(filteredReports[0]).filter(key => key !== 'dm_name' && key !== 'id');
                const allHeaders = ['activity_type', 'day_date', ...headers.filter(h => h !== 'activity_type' && h !== 'day_date')];
                
                if (loggedInUser?.title?.toLowerCase() === 'admin') {
                    allHeaders.push('actions');
                }

                const headerRow = document.createElement('tr');
                headerRow.innerHTML = allHeaders.map(header => {
                    let headerText = formatHeader(header);
                    if (header === 'day_date') headerText = 'Day & Date';
                    if (header === 'activity_type') headerText = 'Activity Type';
                    if (header === 'created_at') headerText = 'Time';
                    if (header === 'med_rep') headerText = 'Med Rep';
                    if (header === 'actions') headerText = 'Actions';
                    return `<th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${headerText}</th>`;
                }).join('');
                reportsTableHeader.appendChild(headerRow);

                filteredReports.forEach(report => {
                    const newRow = document.createElement('tr');
                    newRow.className = 'hover:bg-gray-100 transition duration-150 ease-in-out border-l-4 cursor-pointer';
                    newRow.dataset.id = report.id;

                    if (report.activity_type.includes('Visits')) newRow.style.borderColor = '#ECFAE5';
                    else if (report.activity_type.includes('Event')) newRow.style.borderColor = '#E8F9FF';
                    else if (report.activity_type.includes('Leave')) newRow.style.borderColor = '#FFE6E1';

                    allHeaders.forEach(key => {
                        const newCell = document.createElement('td');
                        newCell.className = 'px-3 py-2 whitespace-nowrap text-gray-500';

                        if (key === 'actions') {
                            newCell.innerHTML = `<button class="delete-report-btn text-red-500 hover:text-red-700" data-id="${report.id}"><i class="fas fa-trash-alt"></i></button>`;
                        } else if (key === 'day_date') {
                            const date = new Date(report.created_at);
                            const dayName = date.toLocaleDateString('en-US', { weekday: 'long', timeZone: 'UTC' });
                            const formattedDateWithoutYear = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'UTC' });
                            newCell.textContent = `${dayName} - ${formattedDateWithoutYear}`;
                        } else if (key === 'created_at') {
                            newCell.textContent = formatUTCTime(report.created_at);
                        } else if (key === 'comment') {
                            const originalComment = report[key] || 'N/A';
                            const truncatedComment = originalComment.length > 30 ? originalComment.substring(0, 30) + '...' : originalComment;
                            newCell.innerHTML = `<span>${truncatedComment}</span> ${originalComment.length > 30 ? `<a href="#" class="view-more text-blue-500 font-semibold" data-id="${report.id}">etc</a>` : ''}`;
                            newCell.className = 'px-3 py-2 text-gray-500';
                        } else {
                            newCell.textContent = report[key] || 'N/A';
                        }
                        newRow.appendChild(newCell);
                    });
                    
                    reportsTableBody.appendChild(newRow);
                });
            };

            reportsTableBody.addEventListener('click', (event) => {
                const target = event.target;
                const row = target.closest('tr');
                if (!row) return;

                const reportId = row.dataset.id;
                const report = submittedReports.find(r => r.id.toString() === reportId);

                if (report) {
                    if (target.closest('.delete-report-btn')) {
                        event.stopPropagation(); // Prevent modal from opening
                        handleDeleteReport(report.id);
                    } else if (target.closest('.view-more')) {
                        event.preventDefault();
                        event.stopPropagation(); // Prevent modal from opening twice
                        showRowDetailsModal(report);
                    } else {
                        showRowDetailsModal(report);
                    }
                }
            });

            coachingReportsTableBody.addEventListener('click', (event) => {
                const target = event.target;
                const row = target.closest('tr');
                if (!row) return;
                
                const visitId = row.dataset.visitId;
                const coachingId = row.dataset.coachingId;
                
                if (target.closest('.delete-coaching-btn')) {
                    event.stopPropagation();
                    if (coachingId) {
                        handleDeleteCoachingReport(coachingId);
                    }
                } else {
                    const status = row.querySelector('.status-badge').textContent.trim();
                    openCoachingModal(visitId, status);
                }
            });


            const fetchTodaysVisits = async (medRepName) => {
                const now = new Date();
                const year = now.getFullYear();
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const todayString = `${year}-${month}-${day}`;

                const { data, error } = await supabase
                    .from(TABLE_NAME)
                    .select('hcp_name, specialty, visit_place, visit_date, comments')
                    .eq('medical_rep', medRepName)
                    .gte('visit_date', todayString + 'T00:00:00.000Z')
                    .lte('visit_date', todayString + 'T23:59:59.999Z');

                if (error) {
                    console.error('Error fetching data:', error);
                    return null;
                }
                return data;
            };

            openVisitsModalBtn.addEventListener('click', async () => {
                const selectedMedRep = medRepNameSelect.value;
                if (selectedMedRep) {
                    const visits = await fetchTodaysVisits(selectedMedRep);
                    if (visits && visits.length > 0) {
                        modalContent.innerHTML = '';
                        const selectAllItem = document.createElement('div');
                        selectAllItem.className = 'flex items-center space-x-2 p-2 border rounded-md bg-gray-100';
                        selectAllItem.innerHTML = `
                            <input type="checkbox" id="select-all-visits" class="form-checkbox h-4 w-4 text-blue-600 rounded">
                            <label for="select-all-visits" class="text-sm font-bold text-gray-800 flex-grow">Select All</label>
                        `;
                        modalContent.appendChild(selectAllItem);

                        visits.forEach(visit => {
                            const visitItem = document.createElement('div');
                            visitItem.className = 'flex items-center space-x-2 p-2 border rounded-md hover:bg-gray-50 transition';
                            visitItem.innerHTML = `
                                <input type="checkbox" data-visit='${JSON.stringify(visit)}' class="form-checkbox h-4 w-4 text-blue-600 rounded visit-checkbox">
                                <label class="text-sm font-medium text-gray-700 flex-grow">
                                    <span class="font-bold">${visit.hcp_name}</span> - ${visit.specialty} (${visit.visit_place})
                                </label>
                            `;
                            modalContent.appendChild(visitItem);
                        });
                        visitModal.classList.remove('hidden');

                        document.getElementById('select-all-visits').addEventListener('change', (e) => {
                            const isChecked = e.target.checked;
                            modalContent.querySelectorAll('.visit-checkbox').forEach(checkbox => {
                                checkbox.checked = isChecked;
                            });
                        });
                    } else {
                        showNotification('No visits found for this medical rep today.', 'info');
                    }
                }
            });

            const hideModal = () => {
                visitModal.classList.add('hidden');
                modalContent.innerHTML = '';
            };

            closeModalBtn.addEventListener('click', hideModal);
            cancelVisitsBtn.addEventListener('click', hideModal);

            saveVisitsBtn.addEventListener('click', async () => {
                const selectedCheckboxes = modalContent.querySelectorAll('input[type="checkbox"].visit-checkbox:checked');
                const selectedVisitsData = Array.from(selectedCheckboxes).map(cb => JSON.parse(cb.dataset.visit));

                selectedVisitsInput.value = JSON.stringify(selectedVisitsData);

                const summaryComment = selectedVisitsData.length > 0
                    ? `Double Visit with ${medRepNameSelect.value}. Visited: ${selectedVisitsData.map(v => v.hcp_name).join(', ')}`
                    : `Double Visit with ${medRepNameSelect.value}. No specific visits selected.`;

                const dmName = dmNameSelect.value;
                const newReport = {
                    dm_name: dmName,
                    activity_type: `Visits (Double Visit)`,
                    period: document.getElementById('period-double-visits').value,
                    brick: brickDoubleVisitsSelect.value,
                    med_rep: medRepNameSelect.value,
                    comment: summaryComment
                };

                const { error } = await supabase.from(REPORTS_TABLE).insert([newReport]);
                if (error) {
                    showNotification('Failed to submit report.', 'error');
                    console.error('Submission error:', error);
                    return;
                }

                showNotification('Report submitted successfully!', 'success');
                await fetchReportsFromSupabase(dmName);
                await updateCoachingBadge();
                hideModal();
                form.reset();
                dmNameSelect.value = dmName;
                updateAssociatedDropdowns(dmNameSelect, medRepNameSelect, [brickSingleSelect, brickDoubleSelect, brickDoubleVisitsSelect, eventBrickSelect]);
                updateAssociatedDropdowns(dmNameSelect, coachingMedRepNameSelect);
                selectedVisitsInput.value = '';
                updateFormVisibility();
                activityRadios.forEach(radio => radio.disabled = false);
            });

            const clearErrorMessages = () => {
                document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            };

            const showError = (id, message) => {
                const errorEl = document.getElementById(id);
                if (errorEl) {
                    errorEl.textContent = message;
                    errorEl.style.display = 'block';
                }
            };
            
            // --- FORM & EVENT LISTENERS ---
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                clearErrorMessages();
                let isValid = true;

                const dmName = dmNameSelect.value;
                if (!dmName) {
                    showError('dm-name-error', 'Please select a District Manager.');
                    isValid = false;
                }

                const activityType = document.querySelector('input[name="activity-type"]:checked')?.value;
                if (!activityType) {
                    showError('activity-type-error', 'Please select an activity type.');
                    isValid = false;
                }

                let newReport = null;

                if (activityType === 'Visits') {
                    const visitType = visitTypeSelect.value;
                    if (visitType === 'Double Visit') {
                        const selectedMedRep = medRepNameSelect.value;
                        if (!selectedMedRep) {
                            showError('med-rep-name-error', 'Please select a Medical Rep.');
                            isValid = false;
                        }
                        const selectedMode = document.querySelector('input[name="double-visit-mode"]:checked')?.value;
                        if (!selectedMode) {
                            showError('double-visit-mode-error', 'Please select a report mode.');
                            isValid = false;
                        } else if (selectedMode === 'manual') {
                            if (!brickDoubleSelect.value) {
                                showError('brick-double-error', 'Please select a Brick.');
                                isValid = false;
                            }
                            if (!document.getElementById('details-double-manual').value.trim()) {
                                showError('details-double-manual-error', 'Please provide a comment.');
                                isValid = false;
                            }
                            if(isValid) {
                                newReport = {
                                    dm_name: dmName,
                                    activity_type: `Visits (Double Visit)`,
                                    period: document.getElementById('period-double').value,
                                    brick: brickDoubleSelect.value,
                                    med_rep: medRepNameSelect.value,
                                    comment: document.getElementById('details-double-manual').value,
                                };
                            }
                        }
                    } else if (visitType === 'Single Visit') {
                        if (!brickSingleSelect.value) {
                            showError('brick-single-error', 'Please select a Brick.');
                            isValid = false;
                        }
                        if (!document.getElementById('details-single').value.trim()) {
                            showError('details-single-error', 'Please provide a comment.');
                            isValid = false;
                        }
                        if(isValid) {
                            newReport = {
                                dm_name: dmName,
                                activity_type: `Visits (Single Visit)`,
                                period: document.getElementById('period-single').value,
                                brick: brickSingleSelect.value,
                                med_rep: 'N/A',
                                comment: document.getElementById('details-single').value,
                            };
                        }
                    }
                } else if (activityType === 'Event') {
                    const eventType = eventTypeSelect.value;
                    let brickValue = 'N/A';
                    if (eventType === 'Admin Work') {
                        brickValue = adminWorkTypeSelect.value;
                        if (!brickValue) {
                            showError('admin-work-type-error', 'Please select a type for Admin Work.');
                            isValid = false;
                        }
                    } else if (eventType === 'Meeting') {
                        brickValue = meetingPlaceSelect.value;
                        if (!brickValue) {
                            showError('meeting-place-error', 'Please select a meeting place.');
                            isValid = false;
                        }
                    } else if (eventType === 'Event') {
                        brickValue = eventBrickSelect.value;
                         if (!brickValue) {
                            showError('event-brick-error', 'Please select a brick for the event.');
                            isValid = false;
                        }
                    }

                    if (!document.getElementById('details-event').value.trim()) {
                        showError('details-event-error', 'Please provide a comment.');
                        isValid = false;
                    }
                    if(isValid) {
                        newReport = {
                            dm_name: dmName,
                            activity_type: `Event (${eventType})`,
                            period: document.getElementById('period-event').value,
                            brick: brickValue,
                            med_rep: 'N/A',
                            comment: document.getElementById('details-event').value,
                        };
                    }
                } else if (activityType === 'Leave') {
                    if (!document.getElementById('details-leave').value.trim()) {
                        showError('details-leave-error', 'Please provide a comment.');
                        isValid = false;
                    }
                    if(isValid) {
                        newReport = {
                            dm_name: dmName,
                            activity_type: `Leave (${leaveTypeSelect.value})`,
                            period: document.getElementById('period-leave').value,
                            brick: 'N/A',
                            med_rep: 'N/A',
                            comment: document.getElementById('details-leave').value,
                        };
                    }
                }

                if (!isValid) {
                    return;
                }

                if (newReport) {
                    const { error } = await supabase.from(REPORTS_TABLE).insert([newReport]);
                    if (error) {
                        showNotification('Failed to submit report.', 'error');
                        console.error('Submission error:', error);
                        return;
                    }

                    showNotification('Report submitted successfully!', 'success');
                    await fetchReportsFromSupabase(dmName);
                    if (newReport.activity_type.includes('Double Visit')) {
                        await updateCoachingBadge();
                    }

                    form.reset();
                    activityRadios.forEach(radio => radio.checked = false);
                    updateFormVisibility();
                    dmNameSelect.value = dmName;
                    updateAssociatedDropdowns(dmNameSelect, medRepNameSelect, [brickSingleSelect, brickDoubleSelect, brickDoubleVisitsSelect, eventBrickSelect]);
                    updateAssociatedDropdowns(dmNameSelect, coachingMedRepNameSelect);
                    selectedVisitsInput.value = '';
                    activityRadios.forEach(radio => radio.disabled = false);
                }
            });

            resetButton.addEventListener('click', () => {
                const dmName = dmNameSelect.value;
                
                form.reset();
                clearErrorMessages();
                activityRadios.forEach(radio => {
                    radio.checked = false;
                });

                updateFormVisibility();
                reportDetailsSection.classList.add('hidden');
                reportsTableBody.innerHTML = '';
                reportsTableHeader.innerHTML = '';
                noReportsMessage.classList.remove('hidden');

                dmNameSelect.value = dmName;
                if (dmName) {
                    activityRadios.forEach(radio => radio.disabled = false);
                    updateAssociatedDropdowns(dmNameSelect, medRepNameSelect, [brickSingleSelect, brickDoubleSelect, brickDoubleVisitsSelect, eventBrickSelect]);
                    updateAssociatedDropdowns(dmNameSelect, coachingMedRepNameSelect);
                }
                
                selectedVisitsInput.value = '';
            });

            retrieveButton.addEventListener('click', async () => {
                const dmName = dmNameSelect.value;
                if (dmName) {
                    reportDetailsSection.classList.remove('hidden');
                    await fetchReportsFromSupabase(dmName);
                    showNotification(`Displaying all reports for ${dmName}.`, 'info');
                } else {
                    showNotification('Please select a District Manager to retrieve reports.', 'info');
                }
            });

            searchBox.addEventListener('keyup', (event) => {
                const dmName = dmNameSelect.value;
                if (dmName) {
                    const searchTerm = event.target.value;
                    renderReports(submittedReports, dmName, searchTerm);
                }
            });

            // --- TAB NAVIGATION AND MONTHLY ANALYSIS LOGIC ---

            const setupTabListeners = (reportTabId, coachingTabId, detailsTabId) => {
                const reportTab = document.getElementById(reportTabId);
                const coachingTab = document.getElementById(coachingTabId);
                const detailsTab = document.getElementById(detailsTabId);

                const allTabs = [reportTab, coachingTab, detailsTab];
                const allContent = [dmReportTabContent, coachingReportTabContent, monthlyDetailsTabContent];

                const tabNames = {
                    'dm-report-tab': 'DM Report',
                    'coaching-report-tab': 'Coaching Report',
                    'monthly-details-tab': 'Monthly Details',
                    'dm-report-tab-mobile': 'DM Report',
                    'coaching-report-tab-mobile': 'Coaching Report',
                    'monthly-details-tab-mobile': 'Monthly Details'
                };

                const switchTab = (activeIndex, tabId) => {
                    allTabs.forEach((tab, index) => {
                        tab.classList.toggle('active', index === activeIndex);
                    });
                    
                    allContent.forEach((content, index) => {
                        content.classList.toggle('hidden', index !== activeIndex);
                    });

                    if (window.innerWidth < 1023) {
                        mobileHeaderTitle.textContent = tabNames[tabId];
                    }
                };

                reportTab.addEventListener('click', () => switchTab(0, reportTabId));
                coachingTab.addEventListener('click', () => {
                    const selectedDm = dmNameSelect.value;
                    if (!selectedDm) {
                        showNotification('Please select a District Manager from the DM Report tab first.', 'error');
                        switchTab(0, reportTabId);
                        return;
                    }
                    switchTab(1, coachingTabId);
                    // FIX: Populate dropdown and fetch reports on tab click
                    updateAssociatedDropdowns(dmNameSelect, coachingMedRepNameSelect);
                    fetchAndRenderCoachingReports(selectedDm, coachingMedRepNameSelect.value || '');
                });

                detailsTab.addEventListener('click', () => {
                    const selectedDm = dmNameSelect.value;
                    if (!selectedDm) {
                        showNotification('Please select a District Manager from the DM Report tab first.', 'error');
                        switchTab(0, reportTabId);
                        return;
                    }
                    switchTab(2, detailsTabId);
                    renderAnalysisPage();
                });
            };

            setupTabListeners('dm-report-tab', 'coaching-report-tab', 'monthly-details-tab');
            setupTabListeners('dm-report-tab-mobile', 'coaching-report-tab-mobile', 'monthly-details-tab-mobile');
            
            filedVisitsBox.addEventListener('click', () => {
                eventsDetailsSection.classList.add('hidden');
                leavesDetailsSection.classList.add('hidden');
                filedVisitsDetailsSection.classList.toggle('hidden');
            });

            eventsBox.addEventListener('click', () => {
                filedVisitsDetailsSection.classList.add('hidden');
                leavesDetailsSection.classList.add('hidden');
                eventsDetailsSection.classList.toggle('hidden');
            });

            leavesBox.addEventListener('click', () => {
                filedVisitsDetailsSection.classList.add('hidden');
                eventsDetailsSection.classList.add('hidden');
                leavesDetailsSection.classList.toggle('hidden');
            });

            // UPDATED: Day counting function
            const calculateTotalDays = (reports) => {
                const dailyTotals = new Map();
                reports.forEach(report => {
                    const date = report.created_at.substring(0, 10);
                    
                    if (!dailyTotals.has(date)) {
                        dailyTotals.set(date, new Set());
                    }
                    dailyTotals.get(date).add(report.period);
                });

                let totalDays = 0;
                for (const periods of dailyTotals.values()) {
                    if (periods.has('Full Day')) {
                        totalDays += 1;
                    } else if (periods.has('AM') && periods.has('PM')) {
                        totalDays += 1;
                    } else if (periods.has('AM') || periods.has('PM')) {
                        totalDays += 0.5;
                    }
                }
                return totalDays;
            };


            const renderAnalysisPage = async () => {
                const selectedDm = dmNameSelect.value;
                if (!selectedDm) {
                    showNotification('Please select a District Manager to analyze the reports.', 'error');
                    return;
                }

                const now = new Date();
                const monthName = now.toLocaleString('en-US', { month: 'long' });
                const yearShort = now.getFullYear().toString();
                monthlyReportTitle.textContent = `Month Report Details for ${monthName} ${yearShort}`;

                const startOfMonth = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1)).toISOString();
                const endOfMonth = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth() + 1, 0, 23, 59, 59, 999)).toISOString();
                
                const { data: monthlyReports, error } = await supabase
                    .from(REPORTS_TABLE)
                    .select('*')
                    .eq('dm_name', selectedDm)
                    .gte('created_at', startOfMonth)
                    .lte('created_at', endOfMonth);

                if (error) {
                    showNotification('Failed to fetch data for analysis.', 'error');
                    console.error('Analysis fetch error:', error);
                    return;
                }
                
                allMonthlyReports = monthlyReports || [];

                if (allMonthlyReports.length === 0) {
                        showNotification(`No reports found for ${selectedDm} this month.`, 'info');
                        analysisSummarySection.classList.add('hidden');
                        analysisSummarySectionMobile.classList.add('hidden');
                        if (myChart) myChart.destroy();
                        if (myChartMobile) myChartMobile.destroy();
                        return;
                }
                
                const analysis = {
                    visits: { single: [], double: [] },
                    events: [],
                    leaves: []
                };
                
                allMonthlyReports.forEach(report => {
                    const activity = report.activity_type;
                    if (activity.includes('Visits')) {
                        if (activity.includes('Single Visit')) {
                            analysis.visits.single.push(report);
                        }
                        if (activity.includes('Double Visit')) {
                            analysis.visits.double.push(report);
                        }
                    } else if (activity.includes('Event')) {
                        analysis.events.push(report);
                    } else if (activity.includes('Leave')) {
                        analysis.leaves.push(report);
                    }
                });
                
                const totalFiledVisits = calculateTotalDays([...analysis.visits.single, ...analysis.visits.double]);
                const totalEvents = calculateTotalDays(analysis.events);
                const totalLeaves = calculateTotalDays(analysis.leaves);
                
                filedVisitsCountSpan.textContent = totalFiledVisits;
                eventsCountSpan.textContent = totalEvents;
                leavesCountSpan.textContent = totalLeaves;
                
                // --- Render Details Sections ---
                
                // Double Visits
                doubleVisitsDetailsDiv.innerHTML = `<h4 class="text-md font-semibold text-gray-700 mt-4 mb-2">Double Visits</h4>`;
                const doubleVisitsByRep = analysis.visits.double.reduce((acc, visit) => {
                    if (!acc[visit.med_rep]) acc[visit.med_rep] = [];
                    acc[visit.med_rep].push(visit);
                    return acc;
                }, {});

                if (Object.keys(doubleVisitsByRep).length > 0) {
                    for (const medRep in doubleVisitsByRep) {
                        const visitDetails = doubleVisitsByRep[medRep];
                        const doubleVisitItem = document.createElement('div');
                        doubleVisitItem.className = 'cursor-pointer p-2 bg-gray-100 hover:bg-gray-200 rounded-md transition';
                        doubleVisitItem.innerHTML = `<span class="font-bold">${medRep}:</span> ${calculateTotalDays(visitDetails)} day(s)`;
                        doubleVisitItem.addEventListener('click', () => {
                                showDatesModal(`Double Visits with ${medRep}`, visitDetails.map(v => ({date: v.created_at.substring(0,10), period: v.period})));
                            });
                        doubleVisitsDetailsDiv.appendChild(doubleVisitItem);
                    }
                } else {
                    doubleVisitsDetailsDiv.innerHTML += `<p class="text-sm text-gray-500">No double visits recorded this month.</p>`;
                }
                
                // Single Visits
                singleVisitsDetailsDiv.innerHTML = `<h4 class="text-md font-semibold text-gray-700 mt-4 mb-2">Single Visits</h4>`;
                if (analysis.visits.single.length > 0) {
                        const singleVisitItem = document.createElement('div');
                        singleVisitItem.className = 'cursor-pointer p-2 bg-gray-100 hover:bg-gray-200 rounded-md transition';
                        singleVisitItem.innerHTML = `<span>Total Single Visits:</span> ${calculateTotalDays(analysis.visits.single)} day(s)`;
                        singleVisitItem.addEventListener('click', () => {
                            showDatesModal(`Single Visit Dates`, analysis.visits.single.map(v => ({date: v.created_at.substring(0,10), period: v.period})));
                            });
                        singleVisitsDetailsDiv.appendChild(singleVisitItem);
                } else {
                    singleVisitsDetailsDiv.innerHTML += `<p class="text-sm text-gray-500">No single visits recorded this month.</p>`;
                }
                
                // Events
                eventsDetailsDiv.innerHTML = '';
                const eventsByType = analysis.events.reduce((acc, event) => {
                    const eventType = event.activity_type.match(/\(([^)]+)\)/)[1];
                    if (!acc[eventType]) acc[eventType] = [];
                    acc[eventType].push(event);
                    return acc;
                }, {});
                if (Object.keys(eventsByType).length > 0) {
                    for (const type in eventsByType) {
                        const eventDetails = eventsByType[type];
                        const eventItem = document.createElement('div');
                        eventItem.className = 'cursor-pointer p-2 bg-gray-100 hover:bg-gray-200 rounded-md transition';
                        eventItem.innerHTML = `<span class="font-bold">${type}:</span> ${calculateTotalDays(eventDetails)} day(s)`;
                        eventItem.addEventListener('click', () => {
                            showDatesModal(`${type} Dates`, eventDetails.map(e => ({date: e.created_at.substring(0,10), period: e.period})));
                        });
                        eventsDetailsDiv.appendChild(eventItem);
                    }
                } else {
                    eventsDetailsDiv.innerHTML += `<p class="text-sm text-gray-500">No events recorded this month.</p>`;
                }
                
                // Leaves
                leavesDetailsDiv.innerHTML = '';
                const leavesByType = analysis.leaves.reduce((acc, leave) => {
                    const leaveType = leave.activity_type.match(/\(([^)]+)\)/)[1];
                    if (!acc[leaveType]) acc[leaveType] = [];
                    acc[leaveType].push(leave);
                    return acc;
                }, {});
                if (Object.keys(leavesByType).length > 0) {
                    for (const type in leavesByType) {
                        const leaveDetails = leavesByType[type];
                        const leaveItem = document.createElement('div');
                        leaveItem.className = 'cursor-pointer p-2 bg-gray-100 hover:bg-gray-200 rounded-md transition';
                        leaveItem.innerHTML = `<span class="font-bold">${type}:</span> ${calculateTotalDays(leaveDetails)} day(s)`;
                        leaveItem.addEventListener('click', () => {
                            showDatesModal(`${type} Dates`, leaveDetails.map(l => ({date: l.created_at.substring(0,10), period: l.period})));
                        });
                        leavesDetailsDiv.appendChild(leaveItem);
                    }
                } else {
                    leavesDetailsDiv.innerHTML += `<p class="text-sm text-gray-500">No leaves recorded this month.</p>`;
                }

                // --- Chart Logic ---
                const activityCounts = {
                    'Single Visits': calculateTotalDays(analysis.visits.single),
                    'Double Visits': calculateTotalDays(analysis.visits.double),
                    ...Object.keys(eventsByType).reduce((acc, type) => ({...acc, [type]: calculateTotalDays(eventsByType[type])}), {}),
                    ...Object.keys(leavesByType).reduce((acc, type) => ({...acc, [type]: calculateTotalDays(leavesByType[type])}), {}),
                };
                
                const filteredChartLabels = Object.keys(activityCounts).filter(key => activityCounts[key] > 0);
                const filteredChartData = filteredChartLabels.map(key => activityCounts[key]);
                const chartColors = ['#3B82F6', '#6366F1', '#8B5CF6', '#EC4899', '#F43F5E', '#EF4444', '#F97316', '#EAB308', '#22C55E'];

                if (myChart) myChart.destroy();
                if (myChartMobile) myChartMobile.destroy();

                const chartConfig = {
                    type: 'pie',
                    data: {
                        labels: filteredChartLabels,
                        datasets: [{
                            label: 'Monthly Activity Report',
                            data: filteredChartData,
                            backgroundColor: chartColors,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { 
                                display: false // We will create a custom legend
                            },
                            title: { 
                                display: true, 
                                text: 'Monthly Activity Breakdown (Days)',
                                font: { size: 14 }
                            }
                        }
                    }
                };
                
                myChart = new Chart(activityChartCtx, chartConfig);
                myChartMobile = new Chart(activityChartMobileCtx, chartConfig);
                
                // Create and populate custom legend
                const totalDays = filteredChartData.reduce((a, b) => a + b, 0);
                let legendHtml = '<ul class="space-y-2">';
                filteredChartLabels.forEach((label, index) => {
                    const value = filteredChartData[index];
                    const percentage = totalDays > 0 ? ((value / totalDays) * 100).toFixed(1) : 0;
                    const color = chartColors[index % chartColors.length];
                    legendHtml += `
                        <li class="flex items-center text-sm">
                            <span class="w-4 h-4 rounded-full mr-2" style="background-color:${color}"></span>
                            <span>${label}: <strong>${value} day(s)</strong> (${percentage}%)</span>
                        </li>
                    `;
                });
                legendHtml += '</ul>';
                chartLegendContainer.innerHTML = legendHtml;
                // FIX: Populate mobile legend container
                const chartLegendContainerMobile = document.getElementById('chart-legend-container-mobile');
                if (chartLegendContainerMobile) {
                    chartLegendContainerMobile.innerHTML = legendHtml;
                }

                analysisSummarySection.classList.remove('hidden');
                analysisSummarySectionMobile.classList.remove('hidden');
            };

            // Download XLSX function
            downloadXLSXBtn.addEventListener('click', () => {
                if (allMonthlyReports.length === 0) {
                    showNotification('No data to download.', 'info');
                    return;
                }
                const filename = `DM-Report-${dmNameSelect.value}-${new Date().toISOString().slice(0, 10)}.xlsx`;
                const ws = XLSX.utils.json_to_sheet(allMonthlyReports);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Monthly Report");
                XLSX.writeFile(wb, filename);
            });
            
            // REVAMPED Print function
            printMonthlyBtn.addEventListener('click', () => {
                const dmName = dmNameSelect.value;
                if (!dmName || allMonthlyReports.length === 0) {
                    showNotification('No data available to generate a report.', 'error');
                    return;
                }

                // 1. Create a container for the PDF content
                const reportElement = document.createElement('div');
                reportElement.style.padding = '0.5in';
                reportElement.style.fontFamily = 'Arial, sans-serif';
                reportElement.style.width = '8.5in';
                reportElement.style.boxSizing = 'border-box';


                // 2. Build the HTML string for the report
                let reportHtml = `
                    <style>
                        body { font-family: Arial, sans-serif; font-size: 10pt; }
                        h1, h2, h3 { color: #333; margin: 0; padding: 0;}
                        h1 { font-size: 18pt; text-align: center; margin-bottom: 0.25in; }
                        h2 { font-size: 14pt; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 0.5in; }
                        .summary-container { display: flex; justify-content: space-between; gap: 20px; margin: 0.25in 0; width: 100%; }
                        .summary-box { padding: 15px; border-radius: 8px; color: white; text-align: center; flex: 1; }
                        .summary-box h3 { margin: 0 0 5px 0; font-size: 12pt; color: white; }
                        .summary-box .count { font-size: 24pt; font-weight: bold; }
                        .details-table { width: 100%; border-collapse: collapse; margin-top: 0.25in; page-break-inside: auto; }
                        .details-table tr { page-break-inside: avoid; page-break-after: auto; }
                        .details-table th, .details-table td { border: 1px solid #ddd; padding: 6px; text-align: left; font-size: 9pt; }
                        .details-table th { background-color: #f2f2f2; }
                        .chart-legend { list-style: none; padding: 0; margin: 0; font-size: 9pt; }
                        .chart-legend li { display: flex; align-items: center; margin-bottom: 5px; }
                        .legend-color-box { width: 12px; height: 12px; margin-right: 8px; }
                    </style>
                `;

                // Add Title
                reportHtml += `<h1>Monthly Report for ${dmName}</h1>`;
                reportHtml += `<h2>${monthlyReportTitle.textContent.replace('Month Report Details for ', '')}</h2>`;

                // Add Summary Boxes
                const summaryBoxes = document.getElementById('analysis-summary-boxes').cloneNode(true);
                summaryBoxes.style.display = 'flex';
                summaryBoxes.style.justifyContent = 'space-between';
                summaryBoxes.style.gap = '20px';
                summaryBoxes.style.margin = '0.25in 0';
                summaryBoxes.querySelectorAll('.analysis-summary-box').forEach(box => {
                    box.style.flex = '1';
                    box.style.padding = '15px';
                    box.style.borderRadius = '8px';
                    box.style.textAlign = 'center';
                    box.style.color = 'white';
                    if (box.id === 'filed-visits-box') box.style.backgroundColor = '#3B82F6';
                    if (box.id === 'events-box') box.style.backgroundColor = '#8B5CF6';
                    if (box.id === 'leaves-box') box.style.backgroundColor = '#EF4444';
                });
                reportHtml += `<div class="summary-container">${summaryBoxes.innerHTML}</div>`;
                
                // Add Details Tables (with updated columns)
                const reportGroups = {
                    'Visits': { reports: allMonthlyReports.filter(r => r.activity_type.includes('Visits')), headers: ['activity_type', 'created_at', 'period', 'brick', 'med_rep'] },
                    'Events': { reports: allMonthlyReports.filter(r => r.activity_type.includes('Event')), headers: ['activity_type', 'created_at', 'period', 'brick', 'comment'] },
                    'Leaves': { reports: allMonthlyReports.filter(r => r.activity_type.includes('Leave')), headers: ['activity_type', 'created_at', 'period', 'comment'] },
                };
                
                for (const groupName in reportGroups) {
                    const group = reportGroups[groupName];
                    if (group.reports.length > 0) {
                        reportHtml += `<h2>${groupName} Details</h2>`;
                        reportHtml += `<table class="details-table"><thead><tr>`;
                        group.headers.forEach(h => reportHtml += `<th>${formatHeader(h)}</th>`);
                        reportHtml += `</tr></thead><tbody>`;
                        group.reports.forEach(report => {
                            reportHtml += `<tr>`;
                            group.headers.forEach(h => {
                                let value = report[h] || 'N/A';
                                if (h === 'created_at') value = new Date(report[h]).toLocaleDateString();
                                reportHtml += `<td>${value}</td>`;
                            });
                            reportHtml += `</tr>`;
                        });
                        reportHtml += `</tbody></table>`;
                    }
                }

                // FIX: Add Chart and Legend for PDF
                if (myChart && myChart.data.labels.length > 0) {
                    const chartImage = myChart.toBase64Image();
                    const totalDays = myChart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                    
                    let legendHtml = '<ul class="chart-legend">';
                    myChart.data.labels.forEach((label, index) => {
                        const value = myChart.data.datasets[0].data[index];
                        const percentage = totalDays > 0 ? ((value / totalDays) * 100).toFixed(1) : 0;
                        const color = myChart.data.datasets[0].backgroundColor[index];
                        legendHtml += `
                            <li>
                                <span class="legend-color-box" style="background-color:${color}"></span>
                                <span>${label}: ${value} day(s) (${percentage}%)</span>
                            </li>
                        `;
                    });
                    legendHtml += '</ul>';

                    reportHtml += `
                        <div style="text-align: center; page-break-inside: avoid; margin-top: 0.5in;">
                            <h2>Activity Breakdown</h2>
                            <img src="${chartImage}" alt="Activity Chart" style="max-width: 400px; height: auto; margin: 20px auto; display: block;">
                            <div style="display: inline-block; text-align: left; margin-top: 20px;">
                                ${legendHtml}
                            </div>
                        </div>
                    `;
                }

                reportElement.innerHTML = reportHtml;

                // 3. Generate PDF from the constructed element
                const opt = {
                    margin: 0.5,
                    filename: `Monthly-Report-${dmName}-${new Date().toISOString().slice(0,10)}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };
                html2pdf().from(reportElement).set(opt).save();
            });

            // --- COACHING REPORT LOGIC ---
            const updateCoachingBadge = async () => {
                const dmName = dmNameSelect.value;
                const badge = document.getElementById('coaching-badge');
                const badgeMobile = document.getElementById('coaching-badge-mobile');

                if (!dmName) {
                    badge.classList.add('hidden');
                    badgeMobile.classList.add('hidden');
                    return;
                }

                const now = new Date();
                const startOfMonth = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1)).toISOString();

                const { data: doubleVisits, error } = await supabase
                    .from(REPORTS_TABLE).select('id').eq('dm_name', dmName)
                    .eq('activity_type', 'Visits (Double Visit)').gte('created_at', startOfMonth);

                if (error || !doubleVisits || doubleVisits.length === 0) {
                    badge.classList.add('hidden');
                    badgeMobile.classList.add('hidden');
                    return;
                }

                const visitIds = doubleVisits.map(v => v.id);
                const { data: coachingData } = await supabase
                    .from(COACHING_REPORTS_TABLE).select('id, dm_report_id').in('dm_report_id', visitIds);
                    
                const completedIds = new Set((coachingData || []).map(item => item.dm_report_id));
                const pendingCount = doubleVisits.filter(v => !completedIds.has(v.id)).length;

                if (pendingCount > 0) {
                    badge.textContent = pendingCount;
                    badgeMobile.textContent = pendingCount;
                    badge.classList.remove('hidden');
                    badgeMobile.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                    badgeMobile.classList.add('hidden');
                }
            };
            
            const fetchAndRenderCoachingReports = async (dmName, medRepName) => {
                coachingReportTableContainer.classList.remove('hidden');
                coachingReportsTableBody.innerHTML = '';
                coachingReportsTableHead.innerHTML = '';
                
                const now = new Date();
                const startOfMonth = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1)).toISOString();
                
                let query = supabase
                    .from(REPORTS_TABLE)
                    .select('id, created_at, brick, comment, med_rep')
                    .eq('dm_name', dmName)
                    .eq('activity_type', 'Visits (Double Visit)')
                    .gte('created_at', startOfMonth)
                    .order('created_at', { ascending: false });

                if (medRepName) {
                    query = query.eq('med_rep', medRepName);
                }

                const { data: doubleVisits, error } = await query;
                                
                if (error) {
                    showNotification('Could not fetch double visits.', 'error');
                    console.error('Coaching fetch error:', error);
                    return;
                }
                
                if (doubleVisits.length === 0) {
                    noCoachingReportsMessage.classList.remove('hidden');
                    return;
                }
                noCoachingReportsMessage.classList.add('hidden');

                const visitIds = doubleVisits.map(v => v.id);
                const { data: coachingData } = await supabase
                    .from(COACHING_REPORTS_TABLE)
                    .select('id, dm_report_id, status')
                    .in('dm_report_id', visitIds);

                const coachingStatusMap = new Map((coachingData || []).map(item => [item.dm_report_id, { status: item.status, id: item.id }]));
                
                let reportsToRender = doubleVisits.map(visit => ({
                    ...visit,
                    status: coachingStatusMap.get(visit.id)?.status || 'Pending',
                    coaching_id: coachingStatusMap.get(visit.id)?.id
                }));

                const filterValue = coachingStatusFilter.value;
                if (filterValue !== 'All') {
                    reportsToRender = reportsToRender.filter(report => report.status === filterValue);
                }

                if (reportsToRender.length === 0) {
                    noCoachingReportsMessage.classList.remove('hidden');
                    return;
                }
                noCoachingReportsMessage.classList.add('hidden');

                let headers = '<tr><th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th><th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Brick</th><th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Med Rep</th><th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comment</th><th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>';
                if (loggedInUser?.title?.toLowerCase() === 'admin') {
                    headers += '<th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>';
                }
                headers += '</tr>';
                coachingReportsTableHead.innerHTML = headers;

                reportsToRender.forEach(visit => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-100 cursor-pointer';
                    row.dataset.visitId = visit.id;
                    if(visit.coaching_id) {
                        row.dataset.coachingId = visit.coaching_id;
                    }
                    
                    const truncatedComment = visit.comment.length > 50 ? visit.comment.substring(0, 50) + '...' : visit.comment;
                    
                    let rowHtml = `
                        <td class="px-3 py-2 whitespace-nowrap text-gray-500">${visit.created_at.substring(0, 10)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-gray-500">${visit.brick}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-gray-500">${visit.med_rep}</td>
                        <td class="px-3 py-2 comment-truncate text-gray-500">${truncatedComment} ${visit.comment.length > 50 ? `<a href="#" class="view-more-coaching text-blue-500 font-semibold">View</a>` : ''}</td>
                        <td class="px-3 py-2 whitespace-nowrap">
                            <span class="status-badge ${visit.status === 'Completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'} text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">
                                ${visit.status}
                            </span>
                        </td>
                    `;
                    if (loggedInUser?.title?.toLowerCase() === 'admin') {
                        rowHtml += `<td class="px-3 py-2 whitespace-nowrap">${visit.status === 'Completed' ? `<button class="delete-coaching-btn text-red-500 hover:text-red-700" data-id="${visit.coaching_id}"><i class="fas fa-trash-alt"></i></button>` : ''}</td>`;
                    }
                    row.innerHTML = rowHtml;
                    
                    coachingReportsTableBody.appendChild(row);
                });
            };
            
            const openCoachingModal = async (visitId, status) => {
                const { data: visitReport, error: visitError } = await supabase
                    .from(REPORTS_TABLE)
                    .select('created_at, comment, med_rep')
                    .eq('id', visitId)
                    .single();

                if (visitError || !visitReport) {
                    showNotification('Could not retrieve visit details.', 'error');
                    return;
                }

                if (status === 'Completed') {
                    const { data: coachingReport, error: coachingError } = await supabase
                        .from(COACHING_REPORTS_TABLE)
                        .select('*')
                        .eq('dm_report_id', visitId)
                        .single();

                    if (coachingError || !coachingReport) {
                        showNotification('Could not retrieve the completed report details.', 'error');
                        return;
                    }
                    populateAndShowReadOnlyCoachingModal(coachingReport, visitReport);
                } else { // Status is 'Pending'
                    const headerInfo = document.getElementById('coaching-modal-header-info');
                    headerInfo.innerHTML = `
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><span class="font-semibold">Medical Rep:</span> ${visitReport.med_rep}</div>
                            <div><span class="font-semibold">Visit Date:</span> ${visitReport.created_at.substring(0, 10)}</div>
                        </div>
                        <div class="text-sm"><p class="font-semibold">Visit Details:</p><p class="p-1 bg-gray-50 rounded">${visitReport.comment}</p></div>
                    `;
                    coachingReportIdInput.value = visitId;
                    coachingEvaluationForm.reset();
                    starRatings.forEach(resetStars);
                    submitCoachingReportBtn.classList.remove('hidden');
                    resetCoachingFormBtn.classList.remove('hidden');
                    starRatings.forEach(r => r.classList.remove('read-only'));
                    document.getElementById('coaching-conclusions').readOnly = false;
                    coachingModal.classList.remove('hidden');
                }
            };

            const populateAndShowReadOnlyCoachingModal = (coachingReport, visitReport) => {
                document.getElementById('view-med-rep-name').textContent = coachingReport.med_rep_name;
                document.getElementById('view-visit-date').textContent = visitReport.created_at.substring(0, 10);
                document.getElementById('view-visit-details').textContent = visitReport.comment;
                
                displayStars('view_feedback_score', coachingReport.feedback_score);
                displayStars('view_opening_score', coachingReport.opening_score);
                displayStars('view_asking_for_commitment_score', coachingReport.asking_for_commitment_score);
                displayStars('view_handling_objection_score', coachingReport.handling_objection_score);
                displayStars('view_planning_score', coachingReport.planning_score);
                displayStars('view_time_management_score', coachingReport.time_management_score);
                displayStars('view_medical_product_knowledge_score', coachingReport.medical_product_knowledge_score);
                
                document.getElementById('view-conclusions').textContent = coachingReport.conclusions || '';

                coachingViewModal.classList.remove('hidden');
            };

            const displayStars = (field, score) => {
                const ratingDiv = document.querySelector(`.star-rating[data-field="${field}"]`);
                if (!ratingDiv) return;
                const stars = ratingDiv.querySelectorAll('.fa-star');
                stars.forEach(s => s.classList.remove('selected'));
                for (let i = 0; i < score; i++) {
                    stars[i].classList.add('selected');
                }
            };
            
            const closeCoachingModal = () => {
                coachingModal.classList.add('hidden');
            };
            const closeCoachingViewModal = () => {
                coachingViewModal.classList.add('hidden');
            };
            
            closeCoachingModalBtn.addEventListener('click', closeCoachingModal);
            closeCoachingViewModalBtn.addEventListener('click', closeCoachingViewModal);
            closeCoachingViewModalBtn2.addEventListener('click', closeCoachingViewModal);
            
            starRatings.forEach(rating => {
                const stars = rating.querySelectorAll('.fa-star');
                stars.forEach(star => {
                    star.addEventListener('click', () => {
                        if (rating.classList.contains('read-only')) return;
                        const value = star.dataset.value;
                        resetStars(rating);
                        for (let i = 0; i < value; i++) {
                            stars[i].classList.add('selected');
                        }
                        rating.dataset.score = value;
                    });
                });
            });

            function resetStars(rating) {
                const stars = rating ? rating.querySelectorAll('.fa-star') : document.querySelectorAll('.star-rating .fa-star');
                stars.forEach(star => star.classList.remove('selected'));
                if (rating) rating.dataset.score = 0;
            }
            
            resetCoachingFormBtn.addEventListener('click', () => {
                coachingEvaluationForm.reset();
                starRatings.forEach(resetStars);
            });
            
            submitCoachingReportBtn.addEventListener('click', async () => {
                let isValid = true;
                document.querySelectorAll('.error-star').forEach(star => star.style.display = 'none');

                const evaluationData = {
                    dm_report_id: coachingReportIdInput.value,
                    dm_name: dmNameSelect.value,
                    med_rep_name: coachingMedRepNameSelect.value,
                    feedback_score: parseInt(document.querySelector('.star-rating[data-field="feedback_score"]').dataset.score || 0),
                    opening_score: parseInt(document.querySelector('.star-rating[data-field="opening_score"]').dataset.score || 0),
                    asking_for_commitment_score: parseInt(document.querySelector('.star-rating[data-field="asking_for_commitment_score"]').dataset.score || 0),
                    handling_objection_score: parseInt(document.querySelector('.star-rating[data-field="handling_objection_score"]').dataset.score || 0),
                    planning_score: parseInt(document.querySelector('.star-rating[data-field="planning_score"]').dataset.score || 0),
                    time_management_score: parseInt(document.querySelector('.star-rating[data-field="time_management_score"]').dataset.score || 0),
                    medical_product_knowledge_score: parseInt(document.querySelector('.star-rating[data-field="medical_product_knowledge_score"]').dataset.score || 0),
                    conclusions: document.getElementById('coaching-conclusions').value,
                    status: 'Completed'
                };

                for(const key in evaluationData) {
                    if (key.endsWith('_score') && evaluationData[key] === 0) {
                        document.querySelector(`.error-star[data-for="${key}"]`).style.display = 'inline';
                        isValid = false;
                    }
                }

                if (!evaluationData.conclusions.trim()) {
                    document.querySelector('.error-star[data-for="coaching-conclusions"]').style.display = 'inline';
                    isValid = false;
                }

                if(!isValid) return;
                
                const { error } = await supabase.from(COACHING_REPORTS_TABLE).insert([evaluationData]);
                
                if (error) {
                    showNotification('Failed to submit coaching report.', 'error');
                    console.error('Coaching submission error:', error);
                } else {
                    showNotification('Coaching report submitted successfully.', 'success');
                    closeCoachingModal();
                    await updateCoachingBadge();
                    await fetchAndRenderCoachingReports(dmNameSelect.value, coachingMedRepNameSelect.value);
                }
            });
            
            printCoachingBtn.addEventListener('click', () => {
                const element = document.getElementById('coaching-view-print-area').cloneNode(true);
                // Remove buttons from the cloned element before printing
                element.querySelector('.print-hidden').remove();
                
                const medRepName = document.getElementById('view-med-rep-name').textContent || 'CoachingReport';
                const opt = {
                    margin:       0.5,
                    filename:     `Coaching-Report-${medRepName}-${new Date().toISOString().slice(0,10)}.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2, useCORS: true },
                    jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
                };
                html2pdf().from(element).set(opt).save();
            });
            
            window.addEventListener('message', async function(event) {
                if (event.data && event.data.type === 'dmReportUserPermissions') {
                    loggedInUser = event.data.user;
                    await initializeReportSystem(loggedInUser);
                }
            });

            async function initializeReportSystem(user) {
                await fetchDataFromSupabase(); // Use the new Supabase fetch function
                
                dmNameSelect.innerHTML = `<option value="" disabled selected>Select DM</option>`;

                if (user && user.title && user.title.toLowerCase() === 'admin') {
                    dmNameSelect.disabled = false;
                    allDmNames.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        dmNameSelect.appendChild(option);
                    });
                } else if (user && user.title && user.title.toLowerCase() === 'district manager') {
                    dmNameSelect.disabled = true;
                    const option = document.createElement('option');
                    option.value = user.username;
                    option.textContent = user.username;
                    option.selected = true;
                    dmNameSelect.appendChild(option);

                    activityRadios.forEach(radio => radio.disabled = false);
                    updateAssociatedDropdowns(dmNameSelect, medRepNameSelect, [brickSingleSelect, brickDoubleSelect, brickDoubleVisitsSelect, eventBrickSelect]);
                    updateAssociatedDropdowns(dmNameSelect, coachingMedRepNameSelect);
                }
                updateCoachingBadge();
            }
            
            // --- NEW/FIXED EVENT LISTENERS ---

            // Function to populate Med Rep and Brick dropdowns based on selected DM
            const updateAssociatedDropdowns = (sourceDmSelect, targetMedRepSelect, targetBrickSelects = []) => {
                const selectedDm = sourceDmSelect.value;
                
                activityRadios.forEach(radio => radio.disabled = !selectedDm);

                if (!selectedDm) {
                    targetMedRepSelect.innerHTML = `<option value="" disabled selected>Select DM first</option>`;
                    targetBrickSelects.forEach(sel => sel.innerHTML = `<option value="" disabled selected>Select DM first</option>`);
                    return;
                }
                
                // Filter data from the fetched Supabase masterlist
                const filteredData = allSupabaseData.filter(row => row['District Manager'] === selectedDm);
                const medRepNames = [...new Set(filteredData.map(item => item['medical rep']).filter(Boolean))];
                const dmBricks = [...new Set(filteredData.map(item => item['Brick']).filter(Boolean))];

                targetMedRepSelect.innerHTML = `<option value="" disabled selected>Select Med Rep</option>`;
                medRepNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    targetMedRepSelect.appendChild(option);
                });
                
                if (targetBrickSelects && targetBrickSelects.length > 0) {
                    const allDmBricksOptions = dmBricks.map(brick => `<option value="${brick}">${brick}</option>`).join('');
                    targetBrickSelects.forEach(sel => {
                        if(sel) sel.innerHTML = `<option value="" disabled selected>Select Brick</option>` + allDmBricksOptions;
                    });
                }
            };
            
            const updateBricksForMedRep = (medRepName, targetBrickSelects) => {
                const filteredData = allSupabaseData.filter(row => row['medical rep'] === medRepName);
                const medRepBricks = [...new Set(filteredData.map(item => item['Brick']).filter(Boolean))];
                const allMedRepBricksOptions = medRepBricks.map(brick => `<option value="${brick}">${brick}</option>`).join('');
                targetBrickSelects.forEach(sel => {
                    if (sel) sel.innerHTML = `<option value="" disabled selected>Select Brick</option>` + allMedRepBricksOptions;
                });
            }

            // Single, comprehensive event listener for the main DM dropdown
            dmNameSelect.addEventListener('change', (event) => {
                const dmName = event.target.value;
                
                updateAssociatedDropdowns(event.target, medRepNameSelect, [brickSingleSelect, brickDoubleSelect, brickDoubleVisitsSelect, eventBrickSelect]);
                updateAssociatedDropdowns(event.target, coachingMedRepNameSelect);

                coachingMedRepNameSelect.value = '';
                coachingStatusFilter.value = 'All';
                coachingReportTableContainer.classList.add('hidden');
                coachingReportsTableBody.innerHTML = '';
                noCoachingReportsMessage.classList.add('hidden');

                reportDetailsSection.classList.add('hidden');
                submittedReports = [];
                renderReports(submittedReports, dmName);
                
                updateCoachingBadge();
            });
            
            // Double Visit Logic
            medRepNameSelect.addEventListener('change', (event) => {
                const selectedMedRep = event.target.value;
                if (visitTypeSelect.value === 'Double Visit' && selectedMedRep) {
                    doubleVisitModeDiv.classList.remove('hidden');
                    updateBricksForMedRep(selectedMedRep, [brickDoubleSelect, brickDoubleVisitsSelect]);
                } else {
                    doubleVisitModeDiv.classList.add('hidden');
                    manualDoubleVisitForm.classList.add('hidden');
                    visitsModalTriggerDiv.classList.add('hidden');
                }
            });
            
            doubleVisitModeRadios.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'manual') {
                        manualDoubleVisitForm.classList.remove('hidden');
                        visitsModalTriggerDiv.classList.add('hidden');
                    } else if (event.target.value === 'visits') {
                        manualDoubleVisitForm.classList.add('hidden');
                        visitsModalTriggerDiv.classList.remove('hidden');
                    }
                });
            });
            
            // Single Visit Logic
            visitTypeSelect.addEventListener('change', (event) => {
                updateVisitTypeVisibility();
                if(event.target.value === 'Single Visit') {
                    const selectedDm = dmNameSelect.value;
                    if(selectedDm) {
                        const filteredData = allSupabaseData.filter(row => row['District Manager'] === selectedDm);
                        const dmBricks = [...new Set(filteredData.map(item => item['Brick']).filter(Boolean))];
                        const allDmBricksOptions = dmBricks.map(brick => `<option value="${brick}">${brick}</option>`).join('');
                        brickSingleSelect.innerHTML = `<option value="" disabled selected>Select Brick</option>` + allDmBricksOptions;
                    }
                }
            });

            // Event Form Logic
            eventTypeSelect.addEventListener('change', (event) => {
                updateEventTypeVisibility();
            });

            // Add listeners for the coaching tab dropdowns
            coachingMedRepNameSelect.addEventListener('change', () => {
                const dmName = dmNameSelect.value;
                const medRepName = coachingMedRepNameSelect.value;
                if (dmName) {
                    fetchAndRenderCoachingReports(dmName, medRepName);
                }
            });

            coachingStatusFilter.addEventListener('change', () => {
                const dmName = dmNameSelect.value;
                const medRepName = coachingMedRepNameSelect.value;
                if(dmName) {
                    fetchAndRenderCoachingReports(dmName, medRepName);
                }
            });

            activityRadios.forEach(radio => radio.addEventListener('change', updateFormVisibility));
            
            document.getElementById('coaching-reports-table-body').addEventListener('click', (e) => {
                const target = e.target;
                if (target.matches('.view-more-coaching')) {
                    e.preventDefault();
                    const row = target.closest('tr');
                    const visitId = row.dataset.visitId;
                    const report = submittedReports.find(r => r.id === parseInt(visitId));
                    if (report) {
                        showRowDetailsModal(report);
                    }
                }
            });
            
            window.parent.postMessage({ type: 'getDMReportUserPermissions' }, '*');
        });
    </script>

</body>
</html>
