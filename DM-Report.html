<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>District Manager Reporting System</title>
    <!-- Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for star icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        label, input, select, textarea, button {
            font-size: 0.875rem;
        }
        th, td {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .container {
            max-width: 900px;
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .form-border-visits { border-left: 4px solid #ECFAE5; }
        .form-border-events { border-left: 4px solid #E8F9FF; }
        .form-border-leaves { border-left: 4px solid #FFE6E1; }

        /* --- Notification Styles --- */
        .notification {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            pointer-events: none;
            opacity: 0;
        }
        .notification.show {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(-50%) translateY(0);
        }
        .notification.success { background-color: #4CAF50; color: white; }
        .notification.error { background-color: #F44336; color: white; }
        .notification.info { background-color: #2196F3; color: white; }

        /* --- Navigation Tabs Styling --- */
        .tab-button {
            border-radius: 0.5rem 0.5rem 0 0;
            transition: background-color 0.2s, color 0.2s;
            position: relative;
        }
        .tab-button.active {
            background-color: #ffffff;
            color: #1f2937;
            font-weight: 600;
        }
        .tab-button:not(.active) {
            background-color: #e5e7eb;
            color: #6b7280;
        }
        .notification-badge {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background-color: #EF4444; /* red-500 */
            color: white;
            border-radius: 9999px;
            font-size: 0.625rem;
            width: 1rem;
            height: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        #side-nav { display: none; }
        #top-nav { display: flex; }

        /* --- Desktop Navigation --- */
        @media (min-width: 768px) {
            #top-nav { display: none; }
            #side-nav {
                display: flex;
                flex-direction: column;
                width: 15rem;
                min-height: 100vh;
                background-color: #f3f4f6;
                padding: 1rem;
                transition: width 0.3s ease-in-out;
            }
            #side-nav .tab-button {
                border-radius: 0.5rem;
                margin-bottom: 0.5rem;
                width: 100%;
                text-align: left;
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }
            #main-app {
                width: calc(100vw - 15rem);
                min-height: 100vh;
                border-radius: 0;
                transition: width 0.3s ease-in-out;
            }
            /* Collapsed Sidebar Styles */
            #side-nav.collapsed {
                width: 5rem;
            }
            #side-nav.collapsed .tab-button-text, #side-nav.collapsed #nav-header-text {
                display: none;
            }
            #side-nav.collapsed .tab-button {
                justify-content: center;
            }
            #main-app.sidebar-collapsed {
                width: calc(100vw - 5rem);
            }
        }
        
        #monthly-details-tab-content {
            background-color: #f3f4f6;
            overflow-y: auto;
        }
        #dm-name {
            min-height: 2.5rem;
            border-width: 1px;
            border-color: #d1d5db;
        }
        
        /* Star rating styles */
        .star-rating .fa-star {
            color: #e4e5e9;
            cursor: pointer;
            transition: color 0.2s;
        }
        .star-rating.read-only .fa-star { cursor: default; }
        .star-rating .fa-star.selected { color: #ffc107; }
        .star-rating:not(.read-only):hover .fa-star { color: #ffc107; }
        .star-rating:not(.read-only) .fa-star:hover ~ .fa-star { color: #e4e5e9; }
        
        /* Error message & star styling */
        .error-message, .error-star {
            color: #EF4444; /* red-500 */
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: none; /* Hidden by default */
        }
        .error-star {
            margin-left: 0.25rem;
            font-weight: bold;
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .print-hidden { display: none !important; }
        }
        
        /* Fix for mobile layout stretching */
        .overflow-x-auto {
            -webkit-overflow-scrolling: touch; /* for smooth scrolling on iOS */
            overflow-x: auto;
        }

        /* Set min-width for the table to prevent collapsing on mobile */
        #reports-table th,
        #reports-table td {
            min-width: 100px; /* Adjust as needed */
        }

        #reports-table th:nth-child(1),
        #reports-table td:nth-child(1) {
            min-width: 150px;
        }

        #reports-table th:nth-child(3),
        #reports-table td:nth-child(3) {
            min-width: 150px;
        }
        
        #reports-table th:nth-child(4),
        #reports-table td:nth-child(4) {
            min-width: 100px;
        }
    </style>
</head>
<body class="bg-gray-100 flex min-h-screen">

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <!-- Sidebar Navigation for PC -->
    <nav id="side-nav" class="bg-white shadow-lg p-4 print-hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 id="nav-header-text" class="text-xl font-bold text-gray-800">DM System</h2>
            <button id="nav-toggle-btn" class="p-2 rounded-md hover:bg-gray-200">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <button id="dm-report-tab" class="tab-button active px-4 py-2 text-sm md:text-base font-medium">
            <i class="fas fa-file-alt fa-fw"></i> <span class="tab-button-text">DM Report</span>
        </button>
        <button id="coaching-report-tab" class="tab-button px-4 py-2 text-sm md:text-base font-medium">
            <i class="fas fa-chalkboard-teacher fa-fw"></i> <span class="tab-button-text">Coaching Report</span>
            <span id="coaching-badge-side" class="notification-badge hidden">0</span>
        </button>
        <button id="monthly-details-tab" class="tab-button px-4 py-2 text-sm md:text-base font-medium">
            <i class="fas fa-chart-pie fa-fw"></i> <span class="tab-button-text">Monthly Details</span>
        </button>
    </nav>
    

    <!-- Main Content Container with Tabs -->
    <div id="main-app" class="flex flex-col flex-grow bg-white md:rounded-2xl md:shadow-2xl md:space-y-4">

        <!-- Top Navigation for Mobile -->
        <div id="top-nav" class="flex border-b border-gray-200 print-hidden">
            <button id="dm-report-tab-mobile" class="tab-button active flex-1 px-4 py-2 text-sm md:text-base font-medium">DM Report</button>
            <button id="coaching-report-tab-mobile" class="tab-button flex-1 px-4 py-2 text-sm md:text-base font-medium">Coaching Report
                <span id="coaching-badge-top" class="notification-badge hidden">0</span>
            </button>
            <button id="monthly-details-tab-mobile" class="tab-button flex-1 px-4 py-2 text-sm md:text-base font-medium">Monthly Details</button>
        </div>


        <!-- Tab Content Containers -->
        <div id="dm-report-tab-content" class="p-4 md:p-8 space-y-4 md:space-y-6">
            <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800">District Manager Reporting</h1>

            <form id="report-form" class="space-y-4">

                <!-- District Manager Name and Live Date -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="dm-name" class="block text-xs font-medium text-gray-700">District Manager Name</label>
                        <select id="dm-name" name="dm-name" class="mt-1 block w-full p-1 border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm">
                            <option value="" disabled selected>Loading...</option>
                        </select>
                        <p id="dm-name-error" class="error-message">Please select a District Manager.</p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700">Date and Time</label>
                        <div id="live-time" class="mt-1 p-1 bg-gray-50 border border-gray-300 rounded-md shadow-sm text-center font-semibold text-gray-600">
                            Loading...
                        </div>
                    </div>
                </div>

                <!-- Activity Type Radio Buttons -->
                <div class="mt-4">
                    <label class="block text-xs font-medium text-gray-700">Activity Type</label>
                    <div class="mt-1 grid grid-cols-3 gap-2 md:gap-4">
                        <label class="flex items-center p-2 bg-white border border-gray-300 rounded-md cursor-pointer hover:bg-blue-50 transition duration-150 ease-in-out">
                            <input type="radio" name="activity-type" value="Visits" class="form-radio h-3 w-3 text-blue-600 focus:ring-blue-500">
                            <span class="ml-1 text-gray-700 text-xs">Visits</span>
                        </label>
                        <label class="flex items-center p-2 bg-white border border-gray-300 rounded-md cursor-pointer hover:bg-blue-50 transition duration-150 ease-in-out">
                            <input type="radio" name="activity-type" value="Event" class="form-radio h-3 w-3 text-blue-600 focus:ring-blue-500">
                            <span class="ml-1 text-gray-700 text-xs">Event</span>
                        </label>
                        <label class="flex items-center p-2 bg-white border border-gray-300 rounded-md cursor-pointer hover:bg-blue-50 transition duration-150 ease-in-out">
                            <input type="radio" name="activity-type" value="Leave" class="form-radio h-3 w-3 text-blue-600 focus:ring-blue-500">
                            <span class="ml-1 text-gray-700 text-xs">Leave</span>
                        </label>
                    </div>
                    <p id="activity-type-error" class="error-message">Please select an activity type.</p>
                </div>

                <!-- Conditional Forms -->
                <div id="conditional-forms">

                    <!-- Visits Form -->
                    <div id="visits-form" class="p-4 rounded-md shadow-inner space-y-4 hidden form-border-visits" >
                        <h3 class="text-sm font-semibold text-gray-800">Visits Details</h3>
                        <div>
                            <label for="visit-type" class="block text-xs font-medium text-gray-700">Visit Type</label>
                            <select id="visit-type" name="visit-type" class="mt-1 block w-full p-1 border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm">
                                <option value="Double Visit">Double Visit</option>
                                <option value="Single Visit">Single Visit</option>
                            </select>
                        </div>

                        <!-- Double Visit Form -->
                        <div id="double-visit-form" class="space-y-2">
                            <!-- Option to choose between manual entry or today's visits -->
                            <div id="double-visit-options" class="space-y-2">
                                <div>
                                    <label for="med-rep-name" class="block text-xs font-medium text-gray-700">Medical Rep Name</label>
                                    <select id="med-rep-name" name="med-rep-name" class="mt-1 block w-full p-1 border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm">
                                        <option value="" disabled selected>Select DM first</option>
                                    </select>
                                    <p id="med-rep-name-error" class="error-message">Please select a Medical Rep.</p>
                                </div>
                                <div id="double-visit-mode" class="hidden space-y-2">
                                    <label class="block text-xs font-medium text-gray-700">Select Report Mode</label>
                                    <div class="flex items-center space-x-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="double-visit-mode" value="manual" class="form-radio h-3 w-3 text-blue-600 focus:ring-blue-500">
                                            <span class="ml-1 text-gray-700 text-xs">Add Manually</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="double-visit-mode" value="visits" class="form-radio h-3 w-3 text-blue-600 focus:ring-blue-500">
                                            <span class="ml-1 text-gray-700 text-xs">Select from Today's Visits</span>
                                        </label>
                                    </div>
                                    <p id="double-visit-mode-error" class="error-message">Please select a report mode.</p>
                                </div>
                            </div>

                            <!-- Manual Double Visit Form (hidden by default) -->
                            <div id="manual-double-visit-form" class="space-y-2 hidden">
                                <div>
                                    <label for="period-double" class="block text-xs font-medium text-gray-700">Period</label>
                                    <select id="period-double" name="period-double" class="mt-1 block w-full p-1 border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm">
                                        <option value="AM">AM</option>
                                        <option value="PM">PM</option>
                                        <option value="Full Day" selected>Full Day</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="brick-double" class="block text-xs font-medium text-gray-700">Brick</label>
                                    <select id="brick-double" name="brick-double" class="mt-1 block w-full p-1 border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm">
                                        <option value="" disabled selected>Select Medical Rep first</option>
                                    </select>
                                    <p id="brick-double-error" class="error-message">Please select a Brick.</p>
                                </div>
                                <div>
                                    <label for="details-double-manual" class="block text-xs font-medium text-gray-700">Comment</label>
                                    <textarea id="details-double-manual" name="details-double-manual" rows="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                                    <p id="details-double-manual-error" class="error-message">Please provide a comment.</p>
                                </div>
                            </div>

                            <!-- Visits Modal Trigger (hidden by default) -->
                            <div id="visits-modal-trigger" class="space-y-2 hidden">
                                <div>
                                    <label for="period-double-visits" class="block text-xs font-medium text-gray-700">Period</label>
                                    <select id="period-double-visits" name="period-double-visits" class="mt-1 block w-full p-1 border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm">
                                        <option value="AM">AM</option>
                                        <option value="PM">PM</option>
                                        <option value="Full Day" selected>Full Day</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="brick-double-visits" class="block text-xs font-medium text-gray-700">Brick</label>
                                    <select id="brick-double-visits" name="brick-double-visits" class="mt-1 block w-full p-1 border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm">
                                        <option value="" disabled selected>Select Medical Rep first</option>
                                    </select>
                                </div>
                                <button type="button" id="open-visits-modal" class="w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-xs font-medium rounded-md shadow-sm transition duration-150 ease-in-out">
                                    Select Today's Visits
                                </button>
                            </div>
                            <input type="hidden" id="selected-visits-double" name="selected-visits-double">
                        </div>

                        <!-- Single Visit Form -->
                        <div id="single-visit-form" class="space-y-2 hidden">
                            <div>
                                <label for="period-single" class="block text-xs font-medium text-gray-700">Period</label>
                                <select id="period-single" name="period-single" class="mt-1 block w-full p-1 border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm">
                                    <option value="AM">AM</option>
                                    <option value="PM">PM</option>
                                    <option value="Full Day" selected>Full Day</option>
                                </select>
                            </div>
                            <div>
                                <label for="brick-single" class="block text-xs font-medium text-gray-700">Brick</label>
                                <select id="brick-single" name="brick-single" class="mt-1 block w-full p-1 border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm">
                                    <option value="" disabled selected>Select DM first</option>
                                </select>
                                <p id="brick-single-error" class="error-message">Please select a Brick.</p>
                            </div>
                            <div>
                                <label for="details-single" class="block text-xs font-medium text-gray-700">Comment</label>
                                <textarea id="details-single" name="details-single" rows="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                                <p id="details-single-error" class="error-message">Please provide a comment.</p>
                                </div>
                        </div>
                    </div>

                    <!-- Event Form -->
                    <div id="event-form" class="p-4 rounded-md shadow-inner space-y-2 hidden form-border-events">
                        <h3 class="text-sm font-semibold text-gray-800">Event Details</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <div>
                                <label for="event-type" class="block text-xs font-medium text-gray-700">Event Type</label>
                                <select id="event-type" name="event-type" class="mt-1 block w-full p-1 border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm">
                                    <option value="Meeting">Meeting</option>
                                    <option value="Event">Event</option>
                                    <option value="Admin Work">Admin Work</option>
                                </select>
                            </div>
                            <div>
                                <label for="period-event" class="block text-xs font-medium text-gray-700">Period</label>
                                <select id="period-event" name="period-event" class="mt-1 block w-full p-1 border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm">
                                    <option value="AM">AM</option>
                                    <option value="PM">PM</option>
                                    <option value="Full Day" selected>Full Day</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="details-event" class="block text-xs font-medium text-gray-700">Comment</label>
                            <textarea id="details-event" name="details-event" rows="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            <p id="details-event-error" class="error-message">Please provide a comment.</p>
                        </div>
                    </div>

                    <!-- Leave Form -->
                    <div id="leave-form" class="p-4 rounded-md shadow-inner space-y-2 hidden form-border-leaves">
                        <h3 class="text-sm font-semibold text-gray-800">Leave Details</h3>
                        <div>
                            <label for="leave-type" class="block text-xs font-medium text-gray-700">Leave Type</label>
                            <select id="leave-type" name="leave-type" class="mt-1 block w-full p-1 border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm">
                                <option value="Annual Leave">Annual Leave</option>
                                <option value="Sick Leave">Sick Leave</option>
                                <option value="Casual Leave">Casual Leave</option>
                                <option value="Official Leave">Official Leave</option>
                            </select>
                        </div>
                        <div>
                            <label for="period-leave" class="block text-xs font-medium text-gray-700">Period</label>
                            <select id="period-leave" name="period-leave" class="mt-1 block w-full p-1 border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm">
                                <option value="AM">AM</option>
                                <option value="PM">PM</option>
                                <option value="Full Day" selected>Full Day</option>
                            </select>
                        </div>
                        <!-- New comment box for leave form -->
                        <div>
                            <label for="details-leave" class="block text-xs font-medium text-gray-700">Comment</label>
                            <textarea id="details-leave" name="details-leave" rows="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            <p id="details-leave-error" class="error-message">Please provide a comment.</p>
                        </div>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="flex flex-col md:flex-row justify-center space-y-2 md:space-y-0 md:space-x-4 mt-4 print-hidden">
                    <button type="submit" class="w-full md:w-auto px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-xs font-medium rounded-md text-white shadow-lg transition duration-150 ease-in-out">
                        Submit
                    </button>
                    <button type="button" id="reset-button" class="w-full md:w-auto px-4 py-2 border-2 border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-150 ease-in-out">
                        Reset
                    </button>
                    <button type="button" id="retrieve-button" class="w-full md:w-auto px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-xs font-medium rounded-md shadow-sm transition duration-150 ease-in-out">
                        Retrieve
                    </button>
                </div>
            </form>

            <!-- Submitted Data Table -->
            <div id="report-details-section" class="mt-8 hidden">
                <div class="flex flex-col md:flex-row items-center justify-between mb-4 space-y-2 md:space-y-0 md:space-x-4 print-hidden">
                    <h2 class="text-xl font-bold text-gray-800 text-center md:text-left">Report Details</h2>
                    <div class="flex space-x-2 w-full md:w-auto">
                        <input type="text" id="search-box" placeholder="Search reports..." class="flex-grow w-full md:w-64 p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                    </div>
                </div>
                <div class="overflow-x-auto bg-gray-50 p-2 rounded-md shadow-inner">
                    <table id="reports-table" class="min-w-full divide-y divide-gray-200">
                        <thead id="reports-table-head" class="bg-gray-100">
                            <!-- Headers will be dynamically generated here -->
                        </thead>
                        <tbody id="reports-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Submitted data will be appended here -->
                        </tbody>
                    </table>
                    <div id="no-reports-message" class="hidden text-center text-gray-500 p-4">No reports to display.</div>
                </div>
            </div>
        </div>
        
        <!-- Coaching Report Tab Content -->
        <div id="coaching-report-tab-content" class="p-4 md:p-8 space-y-4 md:space-y-6 hidden">
            <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800">Coaching Report</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="coaching-med-rep-name" class="block text-xs font-medium text-gray-700">Medical Representative</label>
                    <select id="coaching-med-rep-name" name="coaching-med-rep-name" class="mt-1 block w-full p-1 border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm">
                        <option value="" disabled selected>Select DM first</option>
                    </select>
                </div>
                <div>
                    <label for="coaching-status-filter" class="block text-xs font-medium text-gray-700">Filter by Status</label>
                    <select id="coaching-status-filter" name="coaching-status-filter" class="mt-1 block w-full p-1 border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm">
                        <option value="All">All</option>
                        <option value="Pending">Pending</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>
            </div>

            <div id="coaching-report-table-container" class="mt-8 hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Double Visits This Month</h2>
                <div class="overflow-x-auto bg-gray-50 p-2 rounded-md shadow-inner">
                    <table id="coaching-reports-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Brick</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comment</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider print-hidden">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="coaching-reports-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Double visit data will be appended here -->
                        </tbody>
                    </table>
                    <div id="no-coaching-reports-message" class="hidden text-center text-gray-500 p-4">No double visits to display for this representative this month.</div>
                </div>
            </div>
        </div>

        <!-- Monthly Details Tab Content -->
        <div id="monthly-details-tab-content" class="p-4 md:p-8 space-y-4 md:space-y-6 hidden">
            <div id="monthly-details-print-area" class="container mx-auto bg-white rounded-2xl shadow-2xl p-4 md:p-8 space-y-4 md:space-y-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="monthly-report-title" class="text-xl md:text-3xl font-bold text-gray-800"></h2>
                </div>

                <div id="analysis-content" class="space-y-6">
                    <!-- Three Summary Boxes -->
                    <div id="analysis-summary-boxes" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Filed Visits Box -->
                        <div id="filed-visits-box" class="bg-blue-500 text-white p-4 rounded-md shadow-lg cursor-pointer transition hover:bg-blue-600">
                            <h3 class="font-semibold text-lg mb-1">Filed Visits</h3>
                            <div class="text-3xl font-bold"><span id="filed-visits-count">0</span></div>
                            <div class="text-sm">Total Filed Days</div>
                        </div>
                        <!-- Events Box -->
                        <div id="events-box" class="bg-purple-500 text-white p-4 rounded-md shadow-lg cursor-pointer transition hover:bg-purple-600">
                            <h3 class="font-semibold text-lg mb-1">Events</h3>
                            <div class="text-3xl font-bold"><span id="events-count">0</span></div>
                            <div class="text-sm">Total Event Days</div>
                        </div>
                        <!-- Leaves Box -->
                        <div id="leaves-box" class="bg-red-500 text-white p-4 rounded-md shadow-lg cursor-pointer transition hover:bg-red-600">
                            <h3 class="font-semibold text-lg mb-1">Leaves</h3>
                            <div class="text-3xl font-bold"><span id="leaves-count">0</span></div>
                            <div class="text-sm">Total Leave Days</div>
                        </div>
                    </div>
                    
                    <!-- Details Sections -->
                    <div id="filed-visits-details-section" class="mt-8 hidden">
                        <h3 id="filed-visits-details-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
                        <div id="double-visits-details" class="space-y-2">
                            <!-- Double visits per med rep will be loaded here -->
                        </div>
                        <div id="single-visits-details" class="space-y-2 mt-4">
                            <!-- Single visits will be loaded here -->
                        </div>
                    </div>

                    <div id="events-details-section" class="mt-8 hidden">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Event Details</h3>
                        <div id="events-details" class="space-y-2">
                            <!-- Events will be loaded here -->
                        </div>
                    </div>

                    <div id="leaves-details-section" class="mt-8 hidden">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Leave Details</h3>
                        <div id="leaves-details" class="space-y-2">
                            <!-- Leaves will be loaded here -->
                        </div>
                    </div>

                    <div id="analysis-summary-section" class="hidden">
                        <div class="w-full h-80 flex items-center justify-center">
                            <div id="activity-chart-container" class="w-full h-80 flex items-center justify-center">
                                <canvas id="activity-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal for Double Visit -->
    <div id="visit-modal" class="modal fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:w-1/2 lg:w-1/3 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center pb-3 border-b mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Select Today's Visits</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div id="modal-content" class="overflow-y-auto space-y-2 flex-grow mb-4 pr-2">
                <!-- Visits will be dynamically loaded here -->
            </div>
            <div class="flex justify-end space-x-2 border-t pt-4">
                <button id="save-visits" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md shadow-sm transition">Save</button>
                <button id="cancel-visits" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md shadow-sm transition">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for full row details -->
    <div id="row-details-modal" class="modal fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:w-1/2 lg:w-1/3 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center pb-3 border-b mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Full Report Details</h3>
                <button id="close-row-details-modal" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div id="row-details-content" class="overflow-y-auto space-y-2 flex-grow mb-4 pr-2">
                <!-- Details will be dynamically loaded here -->
            </div>
            <div class="flex justify-end border-t pt-4">
                <button id="ok-row-details-modal" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md shadow-sm transition">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for displaying visit dates -->
    <div id="dates-modal" class="modal fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:w-1/2 lg:w-1/3 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center pb-3 border-b mb-4">
                <h3 id="dates-modal-title" class="text-lg font-semibold text-gray-800">Visit Dates</h3>
                <button id="close-dates-modal" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div id="dates-modal-content" class="overflow-y-auto space-y-2 flex-grow mb-4 pr-2">
                <!-- Dates will be dynamically loaded here -->
            </div>
            <div class="flex justify-end border-t pt-4">
                <button id="ok-dates-modal" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md shadow-sm transition">OK</button>
            </div>
        </div>
    </div>

    <!-- Coaching Evaluation Modal -->
    <div id="coaching-modal" class="modal fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:w-2/3 lg:w-1/2 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center pb-3 border-b mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Coaching Evaluation</h3>
                <button id="close-coaching-modal" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div id="coaching-modal-content" class="overflow-y-auto space-y-4 flex-grow mb-4 pr-2">
                <div id="coaching-modal-header-info" class="space-y-2 mb-4 border-b pb-2">
                    <!-- Dynamic content here -->
                </div>
                <form id="coaching-evaluation-form">
                    <input type="hidden" id="coaching-report-id">
                    <!-- Evaluation Fields -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex flex-col space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Feedback<span class="error-star" data-for="feedback_score">*</span></label>
                                <div class="star-rating mt-1" data-field="feedback_score">
                                    <i class="fas fa-star" data-value="1"></i><i class="fas fa-star" data-value="2"></i><i class="fas fa-star" data-value="3"></i><i class="fas fa-star" data-value="4"></i><i class="fas fa-star" data-value="5"></i>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Opening<span class="error-star" data-for="opening_score">*</span></label>
                                <div class="star-rating mt-1" data-field="opening_score">
                                    <i class="fas fa-star" data-value="1"></i><i class="fas fa-star" data-value="2"></i><i class="fas fa-star" data-value="3"></i><i class="fas fa-star" data-value="4"></i><i class="fas fa-star" data-value="5"></i>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Asking for commitment<span class="error-star" data-for="asking_for_commitment_score">*</span></label>
                                <div class="star-rating mt-1" data-field="asking_for_commitment_score">
                                    <i class="fas fa-star" data-value="1"></i><i class="fas fa-star" data-value="2"></i><i class="fas fa-star" data-value="3"></i><i class="fas fa-star" data-value="4"></i><i class="fas fa-star" data-value="5"></i>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Handling objection<span class="error-star" data-for="handling_objection_score">*</span></label>
                                <div class="star-rating mt-1" data-field="handling_objection_score">
                                    <i class="fas fa-star" data-value="1"></i><i class="fas fa-star" data-value="2"></i><i class="fas fa-star" data-value="3"></i><i class="fas fa-star" data-value="4"></i><i class="fas fa-star" data-value="5"></i>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Planning<span class="error-star" data-for="planning_score">*</span></label>
                                <div class="star-rating mt-1" data-field="planning_score">
                                    <i class="fas fa-star" data-value="1"></i><i class="fas fa-star" data-value="2"></i><i class="fas fa-star" data-value="3"></i><i class="fas fa-star" data-value="4"></i><i class="fas fa-star" data-value="5"></i>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Time Management<span class="error-star" data-for="time_management_score">*</span></label>
                                <div class="star-rating mt-1" data-field="time_management_score">
                                    <i class="fas fa-star" data-value="1"></i><i class="fas fa-star" data-value="2"></i><i class="fas fa-star" data-value="3"></i><i class="fas fa-star" data-value="4"></i><i class="fas fa-star" data-value="5"></i>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Medical & Product Knowledge<span class="error-star" data-for="medical_product_knowledge_score">*</span></label>
                                <div class="star-rating mt-1" data-field="medical_product_knowledge_score">
                                    <i class="fas fa-star" data-value="1"></i><i class="fas fa-star" data-value="2"></i><i class="fas fa-star" data-value="3"></i><i class="fas fa-star" data-value="4"></i><i class="fas fa-star" data-value="5"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Conclusions Box -->
                    <div class="mt-6">
                        <label for="coaching-conclusions" class="block text-sm font-medium text-gray-700">Conclusions<span class="error-star" data-for="coaching-conclusions">*</span></label>
                        <textarea id="coaching-conclusions" name="coaching-conclusions" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                </form>
            </div>
            <div class="flex justify-end space-x-2 border-t pt-4">
                <button id="submit-coaching-report" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md shadow-sm transition">Submit</button>
                <button id="reset-coaching-form" type="button" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md shadow-sm transition">Reset</button>
            </div>
        </div>
    </div>
    
    <!-- Read-only Coaching Report View Modal -->
    <div id="coaching-view-modal" class="modal fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 md:w-2/3 lg:w-1/2 max-h-[90vh] flex flex-col">
            <div id="coaching-view-print-area" class="p-6 flex-grow overflow-y-auto">
                <div class="flex justify-between items-center pb-3 border-b mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Coaching Report</h3>
                    <button id="close-coaching-view-modal" class="text-gray-400 hover:text-gray-600 print-hidden">&times;</button>
                </div>
                <div class="space-y-4">
                    <!-- Report Header -->
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="font-semibold">Medical Rep:</span>
                            <span id="view-med-rep-name"></span>
                        </div>
                        <div>
                            <span class="font-semibold">Double Visit Date:</span>
                            <span id="view-visit-date"></span>
                        </div>
                    </div>
                    <div class="text-sm p-2 bg-gray-50 rounded-md border">
                        <p class="font-semibold">Visit Details:</p>
                        <p id="view-visit-details"></p>
                    </div>
                    
                    <!-- Evaluation Section -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4">
                        <div class="flex flex-col space-y-3">
                            <div class="flex justify-between items-center">
                                <label class="block text-sm font-medium text-gray-700">Feedback</label>
                                <div class="star-rating read-only" data-field="view_feedback_score">
                                    <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <label class="block text-sm font-medium text-gray-700">Opening</label>
                                <div class="star-rating read-only" data-field="view_opening_score">
                                    <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <label class="block text-sm font-medium text-gray-700">Asking for commitment</label>
                                <div class="star-rating read-only" data-field="view_asking_for_commitment_score">
                                    <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <label class="block text-sm font-medium text-gray-700">Handling objection</label>
                                <div class="star-rating read-only" data-field="view_handling_objection_score">
                                    <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col space-y-3">
                            <div class="flex justify-between items-center">
                                <label class="block text-sm font-medium text-gray-700">Planning</label>
                                <div class="star-rating read-only" data-field="view_planning_score">
                                    <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <label class="block text-sm font-medium text-gray-700">Time Management</label>
                                <div class="star-rating read-only" data-field="view_time_management_score">
                                    <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <label class="block text-sm font-medium text-gray-700">Medical & Product Knowledge</label>
                                <div class="star-rating read-only" data-field="view_medical_product_knowledge_score">
                                    <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Conclusions Box -->
                    <div class="mt-4 border-t pt-4">
                        <p class="font-semibold text-sm">Conclusions:</p>
                        <p id="view-conclusions" class="text-sm p-2 bg-gray-50 rounded-md border mt-1"></p>
                    </div>
                </div>
            </div>
            <!-- Print button removed from here -->
        </div>
    </div>


    <!-- PapaParse and html2pdf CDNs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Chart.js CDN for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- SheetJS for XLSX download -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
        // Global variable to store logged-in user data
        let loggedInUser = null;
        let allDmNames = [];
        let allMonthlyReports = []; // Store the fetched monthly reports
        let myChart = null; // To store the chart instance

        document.addEventListener('DOMContentLoaded', async () => {
            // Supabase configuration
            const SUPABASE_URL = "https://plmevfyxpngzymvzvkzn.supabase.co";
            const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBsbWV2Znl4cG5nenltdnp2a3puIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NjM5NDEsImV4cCI6MjA2NjMzOTk0MX0.lUm3efHFCL3aAB-PL7H54BpnvcpbXxp1BeUzw0yjp5c";
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            const TABLE_NAME = 'healthcarepro_visits'; // Name of the Google Sheet data table
            const REPORTS_TABLE = 'dm_report'; // Name of the new Supabase table
            const COACHING_REPORTS_TABLE = 'coaching_reports'; // Name for coaching reports

            const googleSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRcnOTUUiyczqtn1s8zhVfYGARkjx-xfT621A9AX7jw3TxmvnBbdc-BZ_EjuOk1uahqY7s5FcdFvQKm/pub?output=csv";
            let allSheetData = []; // To store the raw data from the Google Sheet
            let submittedReports = []; // To store all reports fetched from Supabase
            
            // Get form and modal elements
            const mainAppDiv = document.getElementById('main-app');
            const sideNav = document.getElementById('side-nav');
            const navToggleBtn = document.getElementById('nav-toggle-btn');
            const dmReportTabContent = document.getElementById('dm-report-tab-content');
            const monthlyDetailsTabContent = document.getElementById('monthly-details-tab-content');
            const coachingReportTabContent = document.getElementById('coaching-report-tab-content');

            const dmReportTabButton = document.getElementById('dm-report-tab');
            const monthlyDetailsTabButton = document.getElementById('monthly-details-tab');
            const coachingReportTabButton = document.getElementById('coaching-report-tab');
            const dmReportTabButtonMobile = document.getElementById('dm-report-tab-mobile');
            const monthlyDetailsTabButtonMobile = document.getElementById('monthly-details-tab-mobile');
            const coachingReportTabButtonMobile = document.getElementById('coaching-report-tab-mobile');
            
            const reportsTableHeader = document.getElementById('reports-table-head');
            const reportsTableBody = document.getElementById('reports-table-body');
            const reportDetailsSection = document.getElementById('report-details-section');
            const noReportsMessage = document.getElementById('no-reports-message');

            const form = document.getElementById('report-form');
            const dmNameSelect = document.getElementById('dm-name');
            const liveTimeDiv = document.getElementById('live-time');
            const activityRadios = document.getElementsByName('activity-type');
            const visitsForm = document.getElementById('visits-form');
            const eventForm = document.getElementById('event-form');
            const leaveForm = document.getElementById('leave-form');
            const visitTypeSelect = document.getElementById('visit-type');

            const doubleVisitForm = document.getElementById('double-visit-form');
            const doubleVisitModeRadios = document.getElementsByName('double-visit-mode');
            const doubleVisitModeDiv = document.getElementById('double-visit-mode');
            const manualDoubleVisitForm = document.getElementById('manual-double-visit-form');
            const visitsModalTriggerDiv = document.getElementById('visits-modal-trigger');
            const openVisitsModalBtn = document.getElementById('open-visits-modal');
            const singleVisitForm = document.getElementById('single-visit-form');

            const medRepNameSelect = document.getElementById('med-rep-name');
            const brickDoubleSelect = document.getElementById('brick-double');
            const brickDoubleVisitsSelect = document.getElementById('brick-double-visits');
            const brickSingleSelect = document.getElementById('brick-single');
            const resetButton = document.getElementById('reset-button');
            const retrieveButton = document.getElementById('retrieve-button');
            const searchBox = document.getElementById('search-box');
            const leaveTypeSelect = document.getElementById('leave-type');

            // Modal elements
            const visitModal = document.getElementById('visit-modal');
            const modalContent = document.getElementById('modal-content');
            const closeModalBtn = document.getElementById('close-modal');
            const saveVisitsBtn = document.getElementById('save-visits');
            const cancelVisitsBtn = document.getElementById('cancel-visits');
            const selectedVisitsInput = document.getElementById('selected-visits-double');

            // New modal for full row details
            const rowDetailsModal = document.getElementById('row-details-modal');
            const closeRowDetailsModalBtn = document.getElementById('close-row-details-modal');
            const okRowDetailsModalBtn = document.getElementById('ok-row-details-modal');
            const rowDetailsContent = document.getElementById('row-details-content');
            
            // New modal for visit dates
            const datesModal = document.getElementById('dates-modal');
            const datesModalTitle = document.getElementById('dates-modal-title');
            const datesModalContent = document.getElementById('dates-modal-content');
            const closeDatesModalBtn = document.getElementById('close-dates-modal');
            const okDatesModalBtn = document.getElementById('ok-dates-modal');

            // Analysis Page elements
            const monthlyDetailsPrintArea = document.getElementById('monthly-details-print-area');
            const analysisSummarySection = document.getElementById('analysis-summary-section');
            const monthlyReportTitle = document.getElementById('monthly-report-title');
            
            const filedVisitsBox = document.getElementById('filed-visits-box');
            const filedVisitsCountSpan = document.getElementById('filed-visits-count');
            const eventsBox = document.getElementById('events-box');
            const eventsCountSpan = document.getElementById('events-count');
            const leavesBox = document.getElementById('leaves-box');
            const leavesCountSpan = document.getElementById('leaves-count');
            
            const filedVisitsDetailsSection = document.getElementById('filed-visits-details-section');
            const filedVisitsDetailsTitle = document.getElementById('filed-visits-details-title');
            const doubleVisitsDetailsDiv = document.getElementById('double-visits-details');
            const singleVisitsDetailsDiv = document.getElementById('single-visits-details');
            const eventsDetailsSection = document.getElementById('events-details-section');
            const eventsDetailsDiv = document.getElementById('events-details');
            const leavesDetailsSection = document.getElementById('leaves-details-section');
            const leavesDetailsDiv = document.getElementById('leaves-details');
            const activityChartContainer = document.getElementById('activity-chart-container');
            const activityChartCtx = document.getElementById('activity-chart').getContext('2d');
            
            // Coaching Report elements
            const coachingMedRepNameSelect = document.getElementById('coaching-med-rep-name');
            const coachingStatusFilter = document.getElementById('coaching-status-filter');
            const coachingReportTableContainer = document.getElementById('coaching-report-table-container');
            const coachingReportsTableBody = document.getElementById('coaching-reports-table-body');
            const noCoachingReportsMessage = document.getElementById('no-coaching-reports-message');
            const coachingModal = document.getElementById('coaching-modal');
            const closeCoachingModalBtn = document.getElementById('close-coaching-modal');
            const coachingEvaluationForm = document.getElementById('coaching-evaluation-form');
            const submitCoachingReportBtn = document.getElementById('submit-coaching-report');
            const resetCoachingFormBtn = document.getElementById('reset-coaching-form');
            const starRatings = document.querySelectorAll('.star-rating');
            const coachingReportIdInput = document.getElementById('coaching-report-id');
            const coachingBadgeSide = document.getElementById('coaching-badge-side');
            const coachingBadgeTop = document.getElementById('coaching-badge-top');
            
            // Coaching View Modal elements
            const coachingViewModal = document.getElementById('coaching-view-modal');
            const closeCoachingViewModalBtn = document.getElementById('close-coaching-view-modal');
            const coachingViewPrintArea = document.getElementById('coaching-view-print-area');

            // --- Sidebar Toggle Logic ---
            navToggleBtn.addEventListener('click', () => {
                sideNav.classList.toggle('collapsed');
                mainAppDiv.classList.toggle('sidebar-collapsed');
            });

            // Function to show custom message notification
            let notificationTimeout;
            const showNotification = (message, type = 'info') => {
                const container = document.getElementById('notification-container');
                let notification = container.querySelector('.notification');
                
                if (!notification) {
                    notification = document.createElement('div');
                    notification.className = 'notification';
                    container.appendChild(notification);
                }
                
                // Clear previous classes and set new ones
                notification.className = 'notification'; // Reset classes
                notification.classList.add(type);
                notification.textContent = message;
                
                // Show the notification
                notification.classList.add('show');
                
                // Clear any existing timeout and set a new one
                clearTimeout(notificationTimeout);
                notificationTimeout = setTimeout(() => {
                    notification.classList.remove('show');
                }, 5000); // 5 seconds
            };

            // New modal functions
            const showDatesModal = (title, dates) => {
                datesModalTitle.textContent = title;
                datesModalContent.innerHTML = dates.map(date => `<p class="text-sm text-gray-700 p-1 border-b">${date}</p>`).join('');
                datesModal.classList.remove('hidden');
            };

            const hideDatesModal = () => {
                datesModal.classList.add('hidden');
            };

            closeDatesModalBtn.addEventListener('click', hideDatesModal);
            okDatesModalBtn.addEventListener('click', hideDatesModal);

            const showRowDetailsModal = (report) => {
                rowDetailsContent.innerHTML = '';
                const detailsHtml = Object.entries(report).map(([key, value]) => {
                    if (key === 'id' || key === 'dm_name') return ''; // Skip ID and DM Name
                    let formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                    if (key === 'created_at') formattedKey = 'Date & Time';
                    let formattedValue = value;
                    if (key === 'created_at') formattedValue = new Date(value).toLocaleString();

                    return `
                        <div class="p-2 border-b last:border-b-0">
                            <p class="font-semibold text-gray-800">${formattedKey}:</p>
                            <p class="text-sm text-gray-600">${formattedValue}</p>
                        </div>
                    `;
                }).join('');
                rowDetailsContent.innerHTML = detailsHtml;
                rowDetailsModal.classList.remove('hidden');
            };

            const hideRowDetailsModal = () => {
                rowDetailsModal.classList.add('hidden');
            };

            closeRowDetailsModalBtn.addEventListener('click', hideRowDetailsModal);
            okRowDetailsModalBtn.addEventListener('click', hideRowDetailsModal);


            // Function to update live Cairo time
            const updateLiveTime = () => {
                const now = new Date();
                const options = {
                    day: 'numeric', month: 'long', year: 'numeric',
                    hour: '2-digit', minute: '2-digit', second: '2-digit',
                    hour12: true
                };
                const formatter = new Intl.DateTimeFormat('en-US', {
                    ...options,
                    timeZone: 'Africa/Cairo'
                });
                liveTimeDiv.textContent = formatter.format(now);
            };

            // Initial call and set interval for live time
            updateLiveTime();
            setInterval(updateLiveTime, 1000);
            
            // Function to populate DM dropdown after data is fetched
            const populateDmDropdown = (dmNames) => {
                dmNameSelect.innerHTML = `<option value="" disabled selected>Select DM</option>`;
                dmNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    dmNameSelect.appendChild(option);
                });
            };

            // Function to fetch and parse CSV data
            const fetchData = async () => {
                try {
                    const response = await fetch(googleSheetUrl);
                    if (!response.ok) throw new Error('Network response was not ok.');
                    const csvText = await response.text();

                    Papa.parse(csvText, {
                        header: false, // Set to false to access data by index
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            // Slice to remove the header row, then store the data
                            allSheetData = results.data.slice(1);

                            // Map to specified column indices: B (index 1)
                            allDmNames = [...new Set(allSheetData.map(item => item[1]).filter(Boolean))];
                        }
                    });
                } catch (error) {
                    console.error('Error fetching data:', error);
                    dmNameSelect.innerHTML = `<option value="" disabled selected>Failed to load data</option>`;
                }
            };

            // Function to fetch all reports from Supabase and render them
            const fetchReportsFromSupabase = async (dmName = '') => {
                let query = supabase.from(REPORTS_TABLE).select('*').order('created_at', { ascending: false });
                if (dmName) {
                    query = query.eq('dm_name', dmName);
                }

                const { data, error } = await query;
                if (error) {
                    console.error('Error fetching reports:', error);
                    showNotification('Failed to retrieve reports from the database.', 'error');
                    return;
                }
                submittedReports = data || [];
                renderReports(submittedReports, dmName);
            };

            // Function to delete a report
            const deleteReport = async (reportId) => {
                const isConfirmed = window.confirm("Are you sure you want to delete this report?");
                if (!isConfirmed) return;

                const { error } = await supabase.from(REPORTS_TABLE).delete().eq('id', reportId);
                if (error) {
                    showNotification('Failed to delete report.', 'error');
                    console.error('Delete error:', error);
                } else {
                    showNotification('Report deleted successfully!', 'success');
                    await fetchReportsFromSupabase(dmNameSelect.value);
                }
            };
            
            // Function to delete a coaching report
            const deleteCoachingReport = async (reportId) => {
                const isConfirmed = window.confirm("Are you sure you want to delete this coaching report?");
                if (!isConfirmed) return;

                const { error } = await supabase.from(COACHING_REPORTS_TABLE).delete().eq('dm_report_id', reportId);
                if (error) {
                    showNotification('Failed to delete coaching report.', 'error');
                    console.error('Delete error:', error);
                } else {
                    showNotification('Coaching report deleted successfully!', 'success');
                    await fetchAndRenderCoachingReports(dmNameSelect.value, coachingMedRepNameSelect.value);
                }
            };

            // Function to populate Med Rep and Brick dropdowns based on selected DM
            const updateAssociatedDropdowns = (sourceDmSelect, targetMedRepSelect, targetBrickSelects = []) => {
                const selectedDm = sourceDmSelect.value;
                if (!selectedDm) {
                    targetMedRepSelect.innerHTML = `<option value="" disabled selected>Select DM first</option>`;
                    targetBrickSelects.forEach(sel => sel.innerHTML = `<option value="" disabled selected>Select DM first</option>`);
                    return;
                }

                const filteredData = allSheetData.filter(row => row[1] === selectedDm);
                const medRepNames = [...new Set(filteredData.map(item => item[3]).filter(Boolean))];
                const dmBricks = [...new Set(filteredData.map(item => item[9]).filter(Boolean))];

                targetMedRepSelect.innerHTML = `<option value="" disabled selected>Select Med Rep</option>`;
                medRepNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    targetMedRepSelect.appendChild(option);
                });
                
                if (targetBrickSelects.length > 0) {
                    const allDmBricksOptions = dmBricks.map(brick => `<option value="${brick}">${brick}</option>`).join('');
                    targetBrickSelects.forEach(sel => sel.innerHTML = `<option value="" disabled selected>Select Brick</option>` + allDmBricksOptions);
                }
            };
            
            // Event listener for Med Rep dropdown to populate brick dropdowns
            medRepNameSelect.addEventListener('change', (e) => {
                const selectedMedRep = e.target.value;
                const filteredBricks = allSheetData.filter(row => row[3] === selectedMedRep).map(item => item[9]).filter(Boolean);
                const uniqueBricks = [...new Set(filteredBricks)];

                const brickOptions = uniqueBricks.map(brick => `<option value="${brick}">${brick}</option>`).join('');
                brickDoubleSelect.innerHTML = `<option value="" disabled selected>Select Brick</option>` + brickOptions;
                brickDoubleVisitsSelect.innerHTML = `<option value="" disabled selected>Select Brick</option>` + brickOptions;

                doubleVisitModeDiv.classList.remove('hidden');
                manualDoubleVisitForm.classList.add('hidden');
                visitsModalTriggerDiv.classList.add('hidden');
                doubleVisitModeRadios.forEach(radio => radio.checked = false);
            });

            // Event listener for DM name dropdown
            dmNameSelect.addEventListener('change', () => {
                const dmName = dmNameSelect.value;
                if (dmName) {
                    activityRadios.forEach(radio => radio.disabled = false);
                    updateAssociatedDropdowns(dmNameSelect, medRepNameSelect, [brickSingleSelect]);
                    updateAssociatedDropdowns(dmNameSelect, coachingMedRepNameSelect); // Also update coaching tab
                    reportDetailsSection.classList.add('hidden');
                    coachingReportTableContainer.classList.add('hidden');
                    submittedReports = [];
                    renderReports(submittedReports);
                    
                    // Reset Monthly Details Tab
                    monthlyReportTitle.textContent = '';
                    filedVisitsCountSpan.textContent = '0';
                    eventsCountSpan.textContent = '0';
                    leavesCountSpan.textContent = '0';
                    filedVisitsDetailsSection.classList.add('hidden');
                    eventsDetailsSection.classList.add('hidden');
                    leavesDetailsSection.classList.add('hidden');
                    if (myChart) {
                        myChart.destroy();
                        myChart = null;
                    }
                    analysisSummarySection.classList.add('hidden');

                    // Reset Coaching Report Tab
                    coachingMedRepNameSelect.value = '';
                    coachingStatusFilter.value = 'All';
                    coachingReportsTableBody.innerHTML = '';
                    noCoachingReportsMessage.classList.add('hidden');

                } else {
                    activityRadios.forEach(radio => radio.disabled = true);
                    updateFormVisibility();
                    reportDetailsSection.classList.add('hidden');
                }
            });
            
            const coachingFilterChanged = async () => {
                const dmName = dmNameSelect.value;
                const medRepName = coachingMedRepNameSelect.value;
                if (dmName && medRepName) {
                    await fetchAndRenderCoachingReports(dmName, medRepName);
                    await updatePendingCoachingBadge(dmName, medRepName);
                }
            };

            coachingMedRepNameSelect.addEventListener('change', coachingFilterChanged);
            coachingStatusFilter.addEventListener('change', coachingFilterChanged);


            const updateFormVisibility = () => {
                const selectedActivity = document.querySelector('input[name="activity-type"]:checked')?.value;
                visitsForm.classList.add('hidden');
                eventForm.classList.add('hidden');
                leaveForm.classList.add('hidden');

                if (selectedActivity === 'Visits') {
                    visitsForm.classList.remove('hidden');
                    updateVisitTypeVisibility();
                } else if (selectedActivity === 'Event') {
                    eventForm.classList.remove('hidden');
                } else if (selectedActivity === 'Leave') {
                    leaveForm.classList.remove('hidden');
                }
            };

            const updateVisitTypeVisibility = () => {
                const selectedVisitType = visitTypeSelect.value;
                doubleVisitForm.classList.add('hidden');
                singleVisitForm.classList.add('hidden');

                if (selectedVisitType === 'Double Visit') {
                    doubleVisitForm.classList.remove('hidden');
                    manualDoubleVisitForm.classList.add('hidden');
                    visitsModalTriggerDiv.classList.add('hidden');
                } else if (selectedVisitType === 'Single Visit') {
                    singleVisitForm.classList.remove('hidden');
                }
            };

            doubleVisitModeRadios.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'manual') {
                        manualDoubleVisitForm.classList.remove('hidden');
                        visitsModalTriggerDiv.classList.add('hidden');
                    } else if (event.target.value === 'visits') {
                        manualDoubleVisitForm.classList.add('hidden');
                        visitsModalTriggerDiv.classList.remove('hidden');
                    }
                });
            });

            activityRadios.forEach(radio => {
                radio.addEventListener('change', updateFormVisibility);
            });
            visitTypeSelect.addEventListener('change', updateVisitTypeVisibility);

            visitsForm.classList.add('hidden');
            eventForm.classList.add('hidden');
            leaveForm.classList.add('hidden');

            const formatHeader = (key) => {
                return key.replace(/([A-Z])/g, ' $1')
                             .replace(/^./, str => str.toUpperCase());
            };
            
            // Helper function to format UTC time string to 12-hour format
            const formatUTCTime = (dateString) => {
                if (!dateString) return 'N/A';
                const timePart = dateString.substring(11, 19);
                let [hours, minutes, seconds] = timePart.split(':');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12 || 12;
                return `${hours}:${minutes}:${seconds} ${ampm}`;
            };

            // Function to render the reports table with corrected date/time formatting
            const renderReports = (reports, dmName = '', searchTerm = '') => {
                reportsTableHeader.innerHTML = '';
                reportsTableBody.innerHTML = '';
                let filteredReports = dmName ? reports.filter(report => report.dm_name === dmName) : [];

                if (searchTerm) {
                    const lowerCaseSearch = searchTerm.toLowerCase();
                    filteredReports = filteredReports.filter(report =>
                        Object.values(report).some(value =>
                            String(value).toLowerCase().includes(lowerCaseSearch)
                        )
                    );
                }

                if (filteredReports.length === 0) {
                    noReportsMessage.classList.remove('hidden');
                    return;
                }
                noReportsMessage.classList.add('hidden');

                const headers = Object.keys(filteredReports[0]).filter(key => key !== 'dm_name' && key !== 'id');
                const allHeaders = ['day_date', ...headers];
                if (loggedInUser && loggedInUser.title === 'admin') {
                    allHeaders.push('actions');
                }

                const headerRow = document.createElement('tr');
                headerRow.innerHTML = allHeaders.map(header => {
                    let headerText = formatHeader(header);
                    if (header === 'day_date') {
                        headerText = 'Day & Date';
                    } else if (header === 'activity_type') {
                        headerText = 'Activity Type';
                    } else if (header === 'created_at') {
                        headerText = 'Time'; // Changed to just "Time" for clarity
                    } else if (header === 'med_rep') {
                        headerText = 'Med Rep';
                    } else if (header === 'comment') {
                        headerText = 'Comment';
                    } else if (header === 'actions') {
                        headerText = 'Actions';
                    }
                    return `<th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${headerText}</th>`;
                }).join('');
                reportsTableHeader.appendChild(headerRow);

                filteredReports.forEach(report => {
                    const newRow = document.createElement('tr');
                    newRow.className = 'hover:bg-gray-100 transition duration-150 ease-in-out border-l-4';
                    newRow.dataset.id = report.id; // Store the report ID on the row
                    newRow.dataset.isMobile = window.innerWidth < 768; // Add a data attribute for mobile check

                    if (report.activity_type.includes('Visits')) {
                        newRow.style.borderColor = '#ECFAE5';
                    } else if (report.activity_type.includes('Event')) {
                        newRow.style.borderColor = '#E8F9FF';
                    } else if (report.activity_type.includes('Leave')) {
                        newRow.style.borderColor = '#FFE6E1';
                    }

                    allHeaders.forEach(key => {
                        const newCell = document.createElement('td');
                        newCell.className = 'px-3 py-2 whitespace-nowrap text-gray-500';

                        if (key === 'day_date') {
                            const date = new Date(report.created_at);
                            const dayName = date.toLocaleDateString('en-US', { weekday: 'long', timeZone: 'UTC' });
                            const formattedDate = report.created_at.substring(0, 10);
                            newCell.textContent = `${dayName} - ${formattedDate}`;
                        } else if (key === 'created_at') {
                            newCell.textContent = formatUTCTime(report.created_at);
                        } else if (key === 'comment') {
                            const originalComment = report[key] || 'N/A';
                            const truncatedComment = originalComment.length > 30 ? originalComment.substring(0, 30) + '...' : originalComment;
                            newCell.textContent = truncatedComment;
                            newCell.className = 'px-3 py-2 text-gray-500'; 
                        } else if (key === 'actions') {
                            newCell.className = 'px-3 py-2 whitespace-nowrap text-right text-sm font-medium print-hidden';
                            const deleteBtn = document.createElement('button');
                            deleteBtn.textContent = 'Delete';
                            deleteBtn.className = 'text-red-600 hover:text-red-900 font-bold';
                            deleteBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                deleteReport(report.id);
                            });
                            newCell.appendChild(deleteBtn);
                        } else {
                            newCell.textContent = report[key] || 'N/A';
                        }
                        
                        newRow.appendChild(newCell);
                    });
                    reportsTableBody.appendChild(newRow);
                });

                // Add event listener for the whole row on mobile
                reportsTableBody.querySelectorAll('tr').forEach(row => {
                    row.addEventListener('click', (event) => {
                        // Check if the click originated from the delete button
                        if (event.target.tagName === 'BUTTON' && event.target.textContent === 'Delete') {
                            return;
                        }
                        if (window.innerWidth < 768) {
                            const reportId = row.dataset.id;
                            const report = submittedReports.find(r => r.id.toString() === reportId);
                            if (report) {
                                showRowDetailsModal(report);
                            }
                        }
                    });
                });
            };

            const fetchTodaysVisits = async (medRepName) => {
                const now = new Date();
                const year = now.getFullYear();
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const todayString = `${year}-${month}-${day}`;

                const { data, error } = await supabase
                    .from(TABLE_NAME)
                    .select('hcp_name, specialty, visit_place, visit_date, comments')
                    .eq('medical_rep', medRepName)
                    .gte('visit_date', todayString + 'T00:00:00.000Z')
                    .lte('visit_date', todayString + 'T23:59:59.999Z');

                if (error) {
                    console.error('Error fetching data:', error);
                    return null;
                }
                return data;
            };

            openVisitsModalBtn.addEventListener('click', async () => {
                const selectedMedRep = medRepNameSelect.value;
                if (selectedMedRep) {
                    const visits = await fetchTodaysVisits(selectedMedRep);
                    if (visits && visits.length > 0) {
                        modalContent.innerHTML = '';
                        const selectAllItem = document.createElement('div');
                        selectAllItem.className = 'flex items-center space-x-2 p-2 border rounded-md bg-gray-100';
                        selectAllItem.innerHTML = `
                            <input type="checkbox" id="select-all-visits" class="form-checkbox h-4 w-4 text-blue-600 rounded">
                            <label for="select-all-visits" class="text-sm font-bold text-gray-800 flex-grow">Select All</label>
                        `;
                        modalContent.appendChild(selectAllItem);

                        visits.forEach(visit => {
                            const visitItem = document.createElement('div');
                            visitItem.className = 'flex items-center space-x-2 p-2 border rounded-md hover:bg-gray-50 transition';
                            visitItem.innerHTML = `
                                <input type="checkbox" data-visit='${JSON.stringify(visit)}' class="form-checkbox h-4 w-4 text-blue-600 rounded visit-checkbox">
                                <label class="text-sm font-medium text-gray-700 flex-grow">
                                    <span class="font-bold">${visit.hcp_name}</span> - ${visit.specialty} (${visit.visit_place})
                                </label>
                            `;
                            modalContent.appendChild(visitItem);
                        });
                        visitModal.classList.remove('hidden');

                        document.getElementById('select-all-visits').addEventListener('change', (e) => {
                            const isChecked = e.target.checked;
                            modalContent.querySelectorAll('.visit-checkbox').forEach(checkbox => {
                                checkbox.checked = isChecked;
                            });
                        });
                    } else {
                        showNotification('No visits found for this medical rep today.', 'info');
                    }
                }
            });

            const hideModal = () => {
                visitModal.classList.add('hidden');
                modalContent.innerHTML = '';
            };

            closeModalBtn.addEventListener('click', hideModal);
            cancelVisitsBtn.addEventListener('click', hideModal);

            saveVisitsBtn.addEventListener('click', async () => {
                const selectedCheckboxes = modalContent.querySelectorAll('input[type="checkbox"].visit-checkbox:checked');
                const selectedVisitsData = Array.from(selectedCheckboxes).map(cb => JSON.parse(cb.dataset.visit));

                selectedVisitsInput.value = JSON.stringify(selectedVisitsData);

                const summaryComment = selectedVisitsData.length > 0
                    ? `Double Visit with ${medRepNameSelect.value}. Visited: ${selectedVisitsData.map(v => v.hcp_name).join(', ')}`
                    : `Double Visit with ${medRepNameSelect.value}. No specific visits selected.`;

                const dmName = dmNameSelect.value;
                const newReport = {
                    dm_name: dmName,
                    activity_type: `Visits (Double Visit)`,
                    period: document.getElementById('period-double-visits').value,
                    brick: brickDoubleVisitsSelect.value,
                    med_rep: medRepNameSelect.value,
                    comment: summaryComment
                };

                const { error } = await supabase.from(REPORTS_TABLE).insert([newReport]);
                if (error) {
                    showNotification('Failed to submit report.', 'error');
                    console.error('Submission error:', error);
                    return;
                }

                showNotification('Report submitted successfully!', 'success');
                await fetchReportsFromSupabase(dmName);

                form.reset();
                dmNameSelect.value = dmName;
                updateAssociatedDropdowns(dmNameSelect, medRepNameSelect, [brickSingleSelect]);
                selectedVisitsInput.value = '';
                updateFormVisibility();
                activityRadios.forEach(radio => radio.disabled = false);
            });

            const clearErrorMessages = () => {
                document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            };

            const showError = (id, message) => {
                const errorEl = document.getElementById(id);
                if (errorEl) {
                    errorEl.textContent = message;
                    errorEl.style.display = 'block';
                }
            };
            
            // UPDATED submit button logic with individual field validation
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                clearErrorMessages();
                let isValid = true;

                const dmName = dmNameSelect.value;
                if (!dmName) {
                    showError('dm-name-error', 'Please select a District Manager.');
                    isValid = false;
                }

                const activityType = document.querySelector('input[name="activity-type"]:checked')?.value;
                if (!activityType) {
                    showError('activity-type-error', 'Please select an activity type.');
                    isValid = false;
                }

                let newReport = null;

                if (activityType === 'Visits') {
                    const visitType = visitTypeSelect.value;
                    if (visitType === 'Double Visit') {
                        const selectedMedRep = medRepNameSelect.value;
                        if (!selectedMedRep) {
                            showError('med-rep-name-error', 'Please select a Medical Rep.');
                            isValid = false;
                        }
                        const selectedMode = document.querySelector('input[name="double-visit-mode"]:checked')?.value;
                        if (!selectedMode) {
                             showError('double-visit-mode-error', 'Please select a report mode.');
                             isValid = false;
                        } else if (selectedMode === 'manual') {
                            if (!brickDoubleSelect.value) {
                                showError('brick-double-error', 'Please select a Brick.');
                                isValid = false;
                            }
                            if (!document.getElementById('details-double-manual').value.trim()) {
                                showError('details-double-manual-error', 'Please provide a comment.');
                                isValid = false;
                            }
                            if(isValid) {
                                newReport = {
                                    dm_name: dmName,
                                    activity_type: `Visits (Double Visit)`,
                                    period: document.getElementById('period-double').value,
                                    brick: brickDoubleSelect.value,
                                    med_rep: medRepNameSelect.value,
                                    comment: document.getElementById('details-double-manual').value,
                                };
                            }
                        }
                    } else if (visitType === 'Single Visit') {
                        if (!brickSingleSelect.value) {
                            showError('brick-single-error', 'Please select a Brick.');
                            isValid = false;
                        }
                        if (!document.getElementById('details-single').value.trim()) {
                            showError('details-single-error', 'Please provide a comment.');
                            isValid = false;
                        }
                        if(isValid) {
                            newReport = {
                                dm_name: dmName,
                                activity_type: `Visits (Single Visit)`,
                                period: document.getElementById('period-single').value,
                                brick: brickSingleSelect.value,
                                med_rep: 'N/A',
                                comment: document.getElementById('details-single').value,
                            };
                        }
                    }
                } else if (activityType === 'Event') {
                    if (!document.getElementById('details-event').value.trim()) {
                        showError('details-event-error', 'Please provide a comment.');
                        isValid = false;
                    }
                    if(isValid) {
                             newReport = {
                                 dm_name: dmName,
                                 activity_type: `Event (${document.getElementById('event-type').value})`,
                                 period: document.getElementById('period-event').value,
                                 brick: 'N/A',
                                 med_rep: 'N/A',
                                 comment: document.getElementById('details-event').value,
                             };
                    }
                } else if (activityType === 'Leave') {
                     if (!document.getElementById('details-leave').value.trim()) {
                         showError('details-leave-error', 'Please provide a comment.');
                         isValid = false;
                     }
                     if(isValid) {
                         newReport = {
                             dm_name: dmName,
                             activity_type: `Leave (${leaveTypeSelect.value})`,
                             period: document.getElementById('period-leave').value,
                             brick: 'N/A',
                             med_rep: 'N/A',
                             comment: document.getElementById('details-leave').value,
                         };
                     }
                }

                if (!isValid) {
                    return;
                }

                if (newReport) {
                    const { error } = await supabase.from(REPORTS_TABLE).insert([newReport]);
                    if (error) {
                        showNotification('Failed to submit report.', 'error');
                        console.error('Submission error:', error);
                        return;
                    }

                    showNotification('Report submitted successfully!', 'success');
                    await fetchReportsFromSupabase(dmName);

                    form.reset();
                    activityRadios.forEach(radio => radio.checked = false);
                    updateFormVisibility();
                    dmNameSelect.value = dmName;
                    updateAssociatedDropdowns(dmNameSelect, medRepNameSelect, [brickSingleSelect]);
                    selectedVisitsInput.value = '';
                    activityRadios.forEach(radio => radio.disabled = false);
                }
            });

            // Reset button functionality
            resetButton.addEventListener('click', () => {
                const dmName = dmNameSelect.value; // Store the current DM name
                
                form.reset();
                clearErrorMessages();
                activityRadios.forEach(radio => {
                    radio.checked = false;
                });

                // Reset conditional forms and table
                updateFormVisibility();
                reportDetailsSection.classList.add('hidden');
                reportsTableBody.innerHTML = '';
                reportsTableHeader.innerHTML = '';
                noReportsMessage.classList.remove('hidden');

                // Restore the DM selection and re-enable radios
                dmNameSelect.value = dmName;
                if (dmName) {
                    activityRadios.forEach(radio => radio.disabled = false);
                    updateAssociatedDropdowns(dmNameSelect, medRepNameSelect, [brickSingleSelect]);
                }
                
                selectedVisitsInput.value = '';
            });

            // Retrieve button functionality
            retrieveButton.addEventListener('click', async () => {
                const dmName = dmNameSelect.value;
                if (dmName) {
                    reportDetailsSection.classList.remove('hidden');
                    await fetchReportsFromSupabase(dmName);
                    showNotification(`Displaying all reports for ${dmName}.`, 'info');
                } else {
                    showNotification('Please select a District Manager to retrieve reports.', 'info');
                }
            });

            // Search functionality
            searchBox.addEventListener('keyup', (event) => {
                const dmName = dmNameSelect.value;
                if (dmName) {
                    const searchTerm = event.target.value;
                    renderReports(submittedReports, dmName, searchTerm);
                }
            });

            // --- TAB NAVIGATION AND MONTHLY ANALYSIS LOGIC ---

            const setupTabListeners = (reportTabId, coachingTabId, detailsTabId) => {
                const reportTab = document.getElementById(reportTabId);
                const coachingTab = document.getElementById(coachingTabId);
                const detailsTab = document.getElementById(detailsTabId);

                const allTabs = [reportTab, coachingTab, detailsTab];
                const allContent = [dmReportTabContent, coachingReportTabContent, monthlyDetailsTabContent];

                const switchTab = (activeIndex) => {
                    allTabs.forEach((tab, index) => {
                        tab.classList.toggle('active', index === activeIndex);
                    });
                    allContent.forEach((content, index) => {
                        content.classList.toggle('hidden', index !== activeIndex);
                    });
                };

                reportTab.addEventListener('click', () => switchTab(0));

                coachingTab.addEventListener('click', () => {
                    const selectedDm = dmNameSelect.value;
                    if (!selectedDm) {
                        showNotification('Please select a District Manager from the DM Report tab first.', 'error');
                        switchTab(0);
                        return;
                    }
                    switchTab(1);
                });

                detailsTab.addEventListener('click', () => {
                    const selectedDm = dmNameSelect.value;
                    if (!selectedDm) {
                        showNotification('Please select a District Manager from the DM Report tab first.', 'error');
                        switchTab(0);
                        return;
                    }
                    switchTab(2);
                    renderAnalysisPage();
                });
            };

            setupTabListeners('dm-report-tab', 'coaching-report-tab', 'monthly-details-tab');
            setupTabListeners('dm-report-tab-mobile', 'coaching-report-tab-mobile', 'monthly-details-tab-mobile');
            
            filedVisitsBox.addEventListener('click', () => {
                eventsDetailsSection.classList.add('hidden');
                leavesDetailsSection.classList.add('hidden');
                filedVisitsDetailsSection.classList.toggle('hidden');
            });

            eventsBox.addEventListener('click', () => {
                filedVisitsDetailsSection.classList.add('hidden');
                leavesDetailsSection.classList.add('hidden');
                eventsDetailsSection.classList.toggle('hidden');
            });

            leavesBox.addEventListener('click', () => {
                filedVisitsDetailsSection.classList.add('hidden');
                eventsDetailsSection.classList.add('hidden');
                leavesDetailsSection.classList.toggle('hidden');
            });


            const renderAnalysisPage = async () => {
                const selectedDm = dmNameSelect.value;
                if (!selectedDm) {
                    showNotification('Please select a District Manager to analyze the reports.', 'error');
                    return;
                }

                const now = new Date();
                const month = now.toLocaleString('en-US', { month: 'long', year: 'numeric' });
                monthlyReportTitle.textContent = `Current Month Report Details for ${month}`;

                const startOfMonth = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1)).toISOString();
                const endOfMonth = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth() + 1, 0, 23, 59, 59, 999)).toISOString();
                
                const { data: monthlyReports, error } = await supabase
                    .from(REPORTS_TABLE)
                    .select('*')
                    .eq('dm_name', selectedDm)
                    .gte('created_at', startOfMonth)
                    .lte('created_at', endOfMonth);

                if (error) {
                    showNotification('Failed to fetch data for analysis.', 'error');
                    console.error('Analysis fetch error:', error);
                    return;
                }
                
                allMonthlyReports = monthlyReports || [];

                if (allMonthlyReports.length === 0) {
                     showNotification(`No reports found for ${selectedDm} this month.`, 'info');
                     analysisSummarySection.classList.add('hidden');
                     if (myChart) myChart.destroy();
                     return;
                }
                
                const analysis = {
                    visits: { single: {}, double: {} },
                    events: {},
                    leaves: {}
                };
                
                const activityCounts = {
                    'Visits (Single Visit)': 0,
                    'Visits (Double Visit)': 0,
                    'Event (Meeting)': 0,
                    'Event (Event)': 0,
                    'Event (Admin Work)': 0,
                    'Leave (Annual Leave)': 0,
                    'Leave (Sick Leave)': 0,
                    'Leave (Casual Leave)': 0,
                    'Leave (Official Leave)': 0,
                };
                
                allMonthlyReports.forEach(report => {
                    const activity = report.activity_type;
                    const date = report.created_at.substring(0, 10);

                    if (activity.includes('Visits')) {
                        if (activity.includes('Single Visit')) {
                            if (!analysis.visits.single[date]) {
                                analysis.visits.single[date] = 1;
                                activityCounts['Visits (Single Visit)']++;
                            }
                        }
                        if (activity.includes('Double Visit')) {
                            const medRep = report.med_rep;
                            if (medRep && medRep !== 'N/A') {
                                if (!analysis.visits.double[date]) {
                                    analysis.visits.double[date] = {};
                                }
                                if (!analysis.visits.double[date][medRep]) {
                                    analysis.visits.double[date][medRep] = { count: 1, dates: [date] };
                                    activityCounts['Visits (Double Visit)']++;
                                } else {
                                    if (!analysis.visits.double[date][medRep].dates.includes(date)) {
                                        analysis.visits.double[date][medRep].dates.push(date);
                                    }
                                }
                            }
                        }
                    } else if (activity.includes('Event')) {
                        const eventType = activity.split('(')[1].replace(')', '');
                        const fullEventType = `Event (${eventType})`;
                        if (!analysis.events[fullEventType]) {
                            analysis.events[fullEventType] = {};
                        }
                         if (!analysis.events[fullEventType][date]) {
                            analysis.events[fullEventType][date] = 1;
                            activityCounts[fullEventType]++;
                        }
                    } else if (activity.includes('Leave')) {
                        const leaveType = activity.split('(')[1].replace(')', '');
                        const fullLeaveType = `Leave (${leaveType})`;
                        if (!analysis.leaves[fullLeaveType]) {
                            analysis.leaves[fullLeaveType] = {};
                        }
                        if (!analysis.leaves[fullLeaveType][date]) {
                            analysis.leaves[fullLeaveType][date] = 1;
                            activityCounts[fullLeaveType]++;
                        }
                    }
                });
                
                const totalSingleVisits = Object.keys(analysis.visits.single).length;
                let totalDoubleVisits = 0;
                let totalDoubleVisitDates = {};
                for (const date in analysis.visits.double) {
                    for (const medRep in analysis.visits.double[date]) {
                        totalDoubleVisits++;
                        if(!totalDoubleVisitDates[medRep]) {
                            totalDoubleVisitDates[medRep] = [];
                        }
                        if (!totalDoubleVisitDates[medRep].includes(date)) {
                            totalDoubleVisitDates[medRep].push(date);
                        }
                    }
                }
                const totalEvents = Object.values(analysis.events).reduce((sum, dates) => sum + Object.keys(dates).length, 0);
                const totalLeaves = Object.values(analysis.leaves).reduce((sum, dates) => sum + Object.keys(dates).length, 0);
                const totalFiledVisits = totalSingleVisits + totalDoubleVisits;
                
                filedVisitsCountSpan.textContent = totalFiledVisits;
                eventsCountSpan.textContent = totalEvents;
                leavesCountSpan.textContent = totalLeaves;
                
                filedVisitsBox.title = `Single Visits: ${totalSingleVisits}, Double Visits: ${totalDoubleVisits}`;

                filedVisitsDetailsTitle.textContent = `Filed Visits for ${month}`;
                doubleVisitsDetailsDiv.innerHTML = `<h4 class="text-md font-semibold text-gray-700 mt-4 mb-2">Double Visits</h4>`;
                const doubleVisitsByRep = {};
                
                for(const date in analysis.visits.double) {
                    for(const medRep in analysis.visits.double[date]) {
                        if (!doubleVisitsByRep[medRep]) {
                            doubleVisitsByRep[medRep] = [];
                        }
                        doubleVisitsByRep[medRep].push(date);
                    }
                }

                if (Object.keys(doubleVisitsByRep).length > 0) {
                    for (const medRep in doubleVisitsByRep) {
                            const uniqueDates = [...new Set(doubleVisitsByRep[medRep])];
                            const doubleVisitItem = document.createElement('div');
                            doubleVisitItem.className = 'cursor-pointer p-2 bg-gray-100 hover:bg-gray-200 rounded-md transition';
                            doubleVisitItem.innerHTML = `<span class="font-bold">${medRep}:</span> ${uniqueDates.length} double visit(s)`;
                            doubleVisitItem.addEventListener('click', () => {
                                 showDatesModal(`Double Visits with ${medRep}`, uniqueDates);
                             });
                            doubleVisitsDetailsDiv.appendChild(doubleVisitItem);
                        }
                } else {
                    doubleVisitsDetailsDiv.innerHTML += `<p class="text-sm text-gray-500">No double visits recorded this month.</p>`;
                }
                
                singleVisitsDetailsDiv.innerHTML = `<h4 class="text-md font-semibold text-gray-700 mt-4 mb-2">Single Visits</h4>`;
                const singleVisitDates = Object.keys(analysis.visits.single);
                if (singleVisitDates.length > 0) {
                     const singleVisitItem = document.createElement('div');
                     singleVisitItem.className = 'cursor-pointer p-2 bg-gray-100 hover:bg-gray-200 rounded-md transition';
                     singleVisitItem.innerHTML = `<span>Total Single Visits:</span> ${singleVisitDates.length} day(s)`;
                     singleVisitItem.addEventListener('click', () => {
                         showDatesModal(`Single Visit Dates`, singleVisitDates);
                     });
                     singleVisitsDetailsDiv.appendChild(singleVisitItem);
                } else {
                    singleVisitsDetailsDiv.innerHTML += `<p class="text-sm text-gray-500">No single visits recorded this month.</p>`;
                }
                
                eventsDetailsDiv.innerHTML = '';
                const eventTypes = Object.keys(analysis.events);
                if (eventTypes.length > 0) {
                    eventTypes.forEach(eventType => {
                        const eventDates = Object.keys(analysis.events[eventType]);
                        const eventItem = document.createElement('div');
                        eventItem.className = 'cursor-pointer p-2 bg-gray-100 hover:bg-gray-200 rounded-md transition';
                        eventItem.innerHTML = `<span class="font-bold">${eventType.replace('Event (', '').replace(')', '')}:</span> ${eventDates.length} day(s)`;
                        eventItem.addEventListener('click', () => {
                            showDatesModal(`${eventType.replace('Event (', '').replace(')', '')} Dates`, eventDates);
                        });
                        eventsDetailsDiv.appendChild(eventItem);
                    });
                } else {
                    eventsDetailsDiv.innerHTML += `<p class="text-sm text-gray-500">No events recorded this month.</p>`;
                }
                
                leavesDetailsDiv.innerHTML = '';
                const leaveTypes = Object.keys(analysis.leaves);
                if (leaveTypes.length > 0) {
                    leaveTypes.forEach(leaveType => {
                        const leaveDates = Object.keys(analysis.leaves[leaveType]);
                        const leaveItem = document.createElement('div');
                        leaveItem.className = 'cursor-pointer p-2 bg-gray-100 hover:bg-gray-200 rounded-md transition';
                        leaveItem.innerHTML = `<span class="font-bold">${leaveType.replace('Leave (', '').replace(')', '')}:</span> ${leaveDates.length} day(s)`;
                        leaveItem.addEventListener('click', () => {
                            showDatesModal(`${leaveType.replace('Leave (', '').replace(')', '')} Dates`, leaveDates);
                        });
                        leavesDetailsDiv.appendChild(leaveItem);
                    });
                } else {
                    leavesDetailsDiv.innerHTML += `<p class="text-sm text-gray-500">No leaves recorded this month.</p>`;
                }

                const chartLabels = Object.keys(activityCounts);
                const chartData = Object.values(activityCounts);
                
                const filteredChartData = [];
                const filteredChartLabels = [];
                for (let i = 0; i < chartData.length; i++) {
                    if (chartData[i] > 0) {
                        filteredChartData.push(chartData[i]);
                        filteredChartLabels.push(chartLabels[i]);
                    }
                }


                if (myChart) {
                    myChart.destroy();
                }

                myChart = new Chart(activityChartCtx, {
                    type: 'pie',
                    data: {
                        labels: filteredChartLabels,
                        datasets: [{
                            label: 'Monthly Activity Report',
                            data: filteredChartData,
                            backgroundColor: [
                                '#3B82F6', '#6366F1', '#8B5CF6', '#EC4899', '#F43F5E',
                                '#EF4444', '#F97316', '#EAB308', '#22C55E',
                            ],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'right' },
                            title: { display: true, text: 'Monthly Activity Breakdown' }
                        },
                        maintainAspectRatio: false,
                    }
                });

                analysisSummarySection.classList.remove('hidden');
            };

            // --- COACHING REPORT LOGIC ---
            
            const getPendingCoachingReportsCount = async (dmName, medRepName) => {
                const { count, error } = await supabase
                    .from(COACHING_REPORTS_TABLE)
                    .select('id', { count: 'exact', head: true })
                    .eq('dm_name', dmName)
                    .eq('med_rep_name', medRepName)
                    .eq('status', 'Pending');
                
                if (error) {
                    console.error('Error fetching pending count:', error);
                    return 0;
                }
                return count;
            };

            const updatePendingCoachingBadge = async (dmName, medRepName) => {
                if (loggedInUser.title !== 'admin') {
                    coachingBadgeSide.classList.add('hidden');
                    coachingBadgeTop.classList.add('hidden');
                    return;
                }
                const count = await getPendingCoachingReportsCount(dmName, medRepName);
                if (count > 0) {
                    coachingBadgeSide.textContent = count;
                    coachingBadgeSide.classList.remove('hidden');
                    coachingBadgeTop.textContent = count;
                    coachingBadgeTop.classList.remove('hidden');
                } else {
                    coachingBadgeSide.classList.add('hidden');
                    coachingBadgeTop.classList.add('hidden');
                }
            };

            const fetchAndRenderCoachingReports = async (dmName, medRepName) => {
                coachingReportTableContainer.classList.remove('hidden');
                coachingReportsTableBody.innerHTML = '';
                
                const now = new Date();
                const startOfMonth = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1)).toISOString();
                
                const { data: doubleVisits, error } = await supabase
                    .from(REPORTS_TABLE)
                    .select('id, created_at, brick, comment')
                    .eq('dm_name', dmName)
                    .eq('med_rep', medRepName)
                    .eq('activity_type', 'Visits (Double Visit)')
                    .gte('created_at', startOfMonth);
                    
                if (error) {
                    showNotification('Could not fetch double visits.', 'error');
                    console.error('Coaching fetch error:', error);
                    return;
                }
                
                if (doubleVisits.length === 0) {
                    noCoachingReportsMessage.classList.remove('hidden');
                    return;
                }
                
                // Fetch existing coaching reports to check status
                const visitIds = doubleVisits.map(v => v.id);
                const { data: coachingData } = await supabase
                    .from(COACHING_REPORTS_TABLE)
                    .select('dm_report_id, status')
                    .in('dm_report_id', visitIds);

                const coachingStatusMap = new Map((coachingData || []).map(item => [item.dm_report_id, item.status]));
                
                let reportsToRender = doubleVisits.map(visit => ({
                    ...visit,
                    status: coachingStatusMap.get(visit.id) || 'Pending'
                }));
                
                // Sort by date in descending order
                reportsToRender.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                const filterValue = coachingStatusFilter.value;
                if (filterValue !== 'All') {
                    reportsToRender = reportsToRender.filter(report => report.status === filterValue);
                }

                if (reportsToRender.length === 0) {
                    noCoachingReportsMessage.classList.remove('hidden');
                    return;
                }
                noCoachingReportsMessage.classList.add('hidden');

                reportsToRender.forEach(visit => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-100 cursor-pointer';
                    row.dataset.visitId = visit.id;
                    
                    row.innerHTML = `
                        <td class="px-3 py-2 whitespace-nowrap text-gray-500">${visit.created_at.substring(0, 10)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-gray-500">${visit.brick}</td>
                        <td class="px-3 py-2 whitespace-normal text-gray-500">${visit.comment}</td>
                        <td class="px-3 py-2 whitespace-nowrap">
                            <span class="status-badge ${visit.status === 'Completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'} text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">
                                ${visit.status}
                            </span>
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-right text-sm font-medium print-hidden">
                            ${loggedInUser && loggedInUser.title === 'admin' ? `
                                <button class="text-red-600 hover:text-red-900 font-bold" onclick="event.stopPropagation(); deleteCoachingReport(${visit.id});">
                                    Delete
                                </button>
                            ` : ''}
                        </td>
                    `;
                    
                    row.addEventListener('click', () => openCoachingModal(visit.id, visit.status));
                    coachingReportsTableBody.appendChild(row);
                });
            };
            
            const openCoachingModal = async (visitId, status) => {
                const { data: visitReport, error: visitError } = await supabase
                    .from(REPORTS_TABLE)
                    .select('created_at, comment, med_rep')
                    .eq('id', visitId)
                    .single();

                if (visitError || !visitReport) {
                    showNotification('Could not retrieve visit details.', 'error');
                    return;
                }

                if (status === 'Completed') {
                    const { data: coachingReport, error: coachingError } = await supabase
                        .from(COACHING_REPORTS_TABLE)
                        .select('*')
                        .eq('dm_report_id', visitId)
                        .single();

                    if (coachingError || !coachingReport) {
                        showNotification('Could not retrieve the completed report details.', 'error');
                        return;
                    }
                    populateAndShowReadOnlyCoachingModal(coachingReport, visitReport);
                } else { // Status is 'Pending'
                    const headerInfo = document.getElementById('coaching-modal-header-info');
                    headerInfo.innerHTML = `
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><span class="font-semibold">Medical Rep:</span> ${visitReport.med_rep}</div>
                            <div><span class="font-semibold">Visit Date:</span> ${visitReport.created_at.substring(0, 10)}</div>
                        </div>
                        <div class="text-sm"><p class="font-semibold">Visit Details:</p><p class="p-1 bg-gray-50 rounded">${visitReport.comment}</p></div>
                    `;
                    coachingReportIdInput.value = visitId;
                    coachingEvaluationForm.reset();
                    resetStars();
                    submitCoachingReportBtn.classList.remove('hidden');
                    resetCoachingFormBtn.classList.remove('hidden');
                    starRatings.forEach(r => r.classList.remove('read-only'));
                    document.getElementById('coaching-conclusions').readOnly = false;
                    coachingModal.classList.remove('hidden');
                }
            };

            const populateAndShowReadOnlyCoachingModal = (coachingReport, visitReport) => {
                document.getElementById('view-med-rep-name').textContent = coachingReport.med_rep_name;
                document.getElementById('view-visit-date').textContent = visitReport.created_at.substring(0, 10);
                document.getElementById('view-visit-details').textContent = visitReport.comment;
                
                displayStars('view_feedback_score', coachingReport.feedback_score);
                displayStars('view_opening_score', coachingReport.opening_score);
                displayStars('view_asking_for_commitment_score', coachingReport.asking_for_commitment_score);
                displayStars('view_handling_objection_score', coachingReport.handling_objection_score);
                displayStars('view_planning_score', coachingReport.planning_score);
                displayStars('view_time_management_score', coachingReport.time_management_score);
                displayStars('view_medical_product_knowledge_score', coachingReport.medical_product_knowledge_score);
                
                document.getElementById('view-conclusions').textContent = coachingReport.conclusions || '';

                coachingViewModal.classList.remove('hidden');
            };

            const displayStars = (field, score) => {
                const ratingDiv = document.querySelector(`.star-rating[data-field="${field}"]`);
                if (!ratingDiv) return;
                const stars = ratingDiv.querySelectorAll('.fa-star');
                // Reset stars before setting new score
                stars.forEach(s => s.classList.remove('selected'));
                for (let i = 0; i < score; i++) {
                    stars[i].classList.add('selected');
                }
            };
            
            const closeCoachingModal = () => {
                coachingModal.classList.add('hidden');
            };
            const closeCoachingViewModal = () => {
                coachingViewModal.classList.add('hidden');
            };
            
            closeCoachingModalBtn.addEventListener('click', closeCoachingModal);
            closeCoachingViewModalBtn.addEventListener('click', closeCoachingViewModal);
            
            starRatings.forEach(rating => {
                const stars = rating.querySelectorAll('.fa-star');
                stars.forEach(star => {
                    star.addEventListener('click', () => {
                        if (rating.classList.contains('read-only')) return;
                        const value = star.dataset.value;
                        resetStars(rating);
                        for (let i = 0; i < value; i++) {
                            stars[i].classList.add('selected');
                        }
                        rating.dataset.score = value;
                    });
                });
            });

            function resetStars(rating) {
                const stars = rating ? rating.querySelectorAll('.fa-star') : document.querySelectorAll('.star-rating .fa-star');
                stars.forEach(star => star.classList.remove('selected'));
                if (rating) rating.dataset.score = 0;
            }
            
            resetCoachingFormBtn.addEventListener('click', () => {
                coachingEvaluationForm.reset();
                starRatings.forEach(resetStars);
            });
            
            submitCoachingReportBtn.addEventListener('click', async () => {
                let isValid = true;
                document.querySelectorAll('.error-star').forEach(star => star.style.display = 'none');

                const evaluationData = {
                    dm_report_id: coachingReportIdInput.value,
                    dm_name: dmNameSelect.value,
                    med_rep_name: coachingMedRepNameSelect.value,
                    feedback_score: document.querySelector('.star-rating[data-field="feedback_score"]').dataset.score || 0,
                    opening_score: document.querySelector('.star-rating[data-field="opening_score"]').dataset.score || 0,
                    asking_for_commitment_score: document.querySelector('.star-rating[data-field="asking_for_commitment_score"]').dataset.score || 0,
                    handling_objection_score: document.querySelector('.star-rating[data-field="handling_objection_score"]').dataset.score || 0,
                    planning_score: document.querySelector('.star-rating[data-field="planning_score"]').dataset.score || 0,
                    time_management_score: document.querySelector('.star-rating[data-field="time_management_score"]').dataset.score || 0,
                    medical_product_knowledge_score: document.querySelector('.star-rating[data-field="medical_product_knowledge_score"]').dataset.score || 0,
                    conclusions: document.getElementById('coaching-conclusions').value,
                    status: 'Completed'
                };

                // Validation
                for(const key in evaluationData) {
                    if (key.endsWith('_score') && evaluationData[key] == 0) {
                        document.querySelector(`.error-star[data-for="${key}"]`).style.display = 'inline';
                        isValid = false;
                    }
                }

                if (!evaluationData.conclusions.trim()) {
                    document.querySelector('.error-star[data-for="coaching-conclusions"]').style.display = 'inline';
                    isValid = false;
                }

                if(!isValid) return;
                
                const { error } = await supabase.from(COACHING_REPORTS_TABLE).insert([evaluationData]);
                
                if (error) {
                    showNotification('Failed to submit coaching report.', 'error');
                    console.error('Coaching submission error:', error);
                } else {
                    showNotification('Coaching report submitted successfully.', 'success');
                    closeCoachingModal();
                    // Refresh the table to show the 'Completed' status
                    await fetchAndRenderCoachingReports(dmNameSelect.value, coachingMedRepNameSelect.value);
                    await updatePendingCoachingBadge(dmNameSelect.value, coachingMedRepNameSelect.value);
                }
            });
            
            window.addEventListener('message', async function(event) {
                if (event.data && event.data.type === 'dmReportUserPermissions') {
                    console.log('DM Report received user data:', event.data.user);
                    loggedInUser = event.data.user;
                    await initializeReportSystem(loggedInUser);
                }
            });

            async function initializeReportSystem(user) {
                await fetchData();
                
                dmNameSelect.innerHTML = `<option value="" disabled selected>Select DM</option>`;

                if (user && user.title && user.title.toLowerCase() === 'admin') {
                    dmNameSelect.disabled = false;
                    allDmNames.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        dmNameSelect.appendChild(option);
                    });
                } else if (user && user.title && user.title.toLowerCase() === 'district manager') {
                    dmNameSelect.disabled = true;
                    const option = document.createElement('option');
                    option.value = user.username;
                    option.textContent = user.username;
                    option.selected = true;
                    dmNameSelect.appendChild(option);

                    activityRadios.forEach(radio => radio.disabled = false);
                    updateAssociatedDropdowns(dmNameSelect, medRepNameSelect, [brickSingleSelect]);
                    updateAssociatedDropdowns(dmNameSelect, coachingMedRepNameSelect);
                }
            }
            
            dmNameSelect.disabled = true;
            activityRadios.forEach(radio => radio.disabled = true);
            updateFormVisibility();
        });
    </script>
</body>
</html>
