<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Plan Submission</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #212529;
            line-height: 1.4;
        }

        .container {
            max-width: 1200px;
            margin: 10px auto;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: 600;
        }

        /* Simplified form controls */
        input, select, textarea {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            background: #fff;
            transition: border-color 0.15s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #007bff;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            font-size: 13px;
            color: #495057;
        }

        /* Grid layout for form rows */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .full-width-form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        /* Button styles */
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .btn-primary {
            background: #007bff;
            color: #fff;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-danger {
            background: #dc3545;
            color: #fff;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        /* Form sections */
        .form-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .form-section h2 {
            font-size: 1.1rem;
            color: #495057;
            margin-bottom: 15px;
            font-weight: 600;
        }

        /* Entry type containers */
        .entry-container {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
        }

        .visit-container { border-left: 4px solid #28a745; }
        .event-container { border-left: 4px solid #007bff; }
        .leave-container { border-left: 4px solid #dc3545; }

        /* Table styles */
        .table-container {
            overflow-x: auto;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin: 20px 0;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .scrollable-table-container {
            position: relative;
            overflow-x: auto;
            overflow-y: auto;
            max-height: 500px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th, td {
            padding: 8px 10px;
            border-bottom: 1px solid #dee2e6;
            text-align: left;
            font-size: 13px;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .time-cell {
            background: #f8f9fa;
            font-weight: 500;
            position: sticky;
            left: 0;
            z-index: 5;
            min-width: 70px;
        }
        
        .table-cell-hour {
            height: 35px; /* Fixed height for each time slot */
            position: relative;
            vertical-align: top;
        }
        
        /* Sticky headers and columns */
        .scrollable-table-container thead th,
        .scrollable-table-container tbody td:first-child {
            position: sticky;
            left: 0;
            z-index: 30; /* Higher z-index to prevent overlap */
            background-color: #f8f9fa;
        }
        
        .scrollable-table-container thead th {
             z-index: 31; /* Header row should be on top of the fixed time column too */
        }

        .scrollable-table-container tbody td:first-child {
            background-color: #fff;
            z-index: 30;
            min-width: 60px; /* Reduced width for a more compact timeline */
        }
        
        .scrollable-table-container thead th:first-child {
            min-width: 60px; /* Match the width of the time column cells */
        }
        
        /* The header row's cells need to be sticky as well */
        .scrollable-table-container thead th {
            z-index: 31;
        }

        /* Plan entry boxes */
        .plan-box {
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 4px 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s;
            overflow: hidden;
            z-index: 20; /* Lower z-index than sticky headers */
        }

        .plan-box:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }
        
        .plan-box.selected {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        .visit-box { background: #d4edda; border-color: #28a745; }
        .event-box { background: #d1ecf1; border-color: #007bff; }
        .leave-box { background: #f8d7da; border-color: #dc3545; }

        /* Resizing handle */
        .resize-handle {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 8px;
            cursor: ns-resize;
            background-color: rgba(0, 0, 0, 0.1);
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            z-index: 25; /* Higher than box content, but lower than sticky headers */
            transition: background-color 0.2s;
        }
        .plan-box:hover .resize-handle {
            background-color: rgba(0, 0, 0, 0.2);
        }


        /* Loading overlay */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            flex-direction: column;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        
        .box-loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: absolute;
            right: 5px;
            top: 5px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Utility classes */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-end { justify-content: flex-end; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
        .mb-1 { margin-bottom: 4px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        .mt-3 { margin-top: 12px; }
        .p-2 { padding: 8px; }
        .font-semibold { font-weight: 600; }

        /* Navigation */
        .nav-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
        }

        /* Popover */
        .popover {
            position: fixed;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            font-size: 13px;
            max-width: 250px;
        }
        
        .modal-box {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .modal-content h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #007bff;
        }

        .modal-content p {
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .popover p {
            margin-bottom: 6px;
        }

        .popover p:last-child {
            margin-bottom: 0;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                margin: 5px;
                padding: 10px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            h1 {
                font-size: 1.3rem;
            }

            .btn {
                font-size: 12px;
                padding: 5px 10px;
            }
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading hidden">
        <div class="spinner"></div>
        <p>Loading data...</p>
    </div>
    <div class="container">
        <h1>Weekly Plan Submission</h1>
        <div class="form-row">
            <div class="flex-col">
                <label for="districtManager">District Manager:</label>
                <select id="districtManager">
                    <option value="">Select District Manager</option>
                </select>
            </div>
            <div class="flex-col">
                <label for="startDate">Week Start Date (Saturday):</label>
                <input type="date" id="startDate">
            </div>
            <div class="flex-col">
                <label for="endDate">Week End Date (Friday):</label>
                <input type="date" id="endDate" readonly>
            </div>
        </div>
        <div class="form-section">
            <h2>Add Daily Plan Entry</h2>
            <div class="form-row">
                <div class="flex-col">
                    <label for="selectedDay">Select Day:</label>
                    <select id="selectedDay">
                        <option value="">Select a Day</option>
                    </select>
                </div>
                <div class="flex-col">
                    <label for="entryTypeSelect">Entry Type:</label>
                    <select id="entryTypeSelect" onchange="handleEntryTypeChange()">
                        <option value="">Select Type</option>
                        <option value="Visit">Visit</option>
                        <option value="Event">Event</option>
                        <option value="Leave">Leave</option>
                    </select>
                </div>
            </div>
            <div id="visitInputsContainer" class="hidden entry-container visit-container">
                <div class="form-row">
                    <div class="flex-col">
                        <label for="visitTypeSelect">Visit Type:</label>
                        <select id="visitTypeSelect" onchange="handleVisitTypeChange()">
                            <option value="">Select Visit Type</option>
                            <option value="Single Visit">Single Visit</option>
                            <option value="Double Visit">Double Visit</option>
                        </select>
                    </div>
                    <div class="flex-col">
                        <label for="visitTimeChoice">Time Option:</label>
                        <select id="visitTimeChoice" onchange="handleVisitTimeChoiceChange()">
                            <option value="">Select Time Option</option>
                            <option value="Pick a Time">Pick a Time</option>
                            <option value="AM">AM</option>
                            <option value="PM">PM</option>
                            <option value="Full Day">Full Day</option>
                        </select>
                    </div>
                    <div id="visitTimeInputContainer" class="flex-col hidden">
                        <label for="visitTimeInput">Specific Time:</label>
                        <input type="time" id="visitTimeInput">
                    </div>
                </div>
                <div id="mrBrickContainer" class="form-row hidden">
                    <div class="flex-col">
                        <label for="medicalRepSelect">Medical Rep:</label>
                        <select id="medicalRepSelect" onchange="handleMedicalRepChange()">
                            <option value="">Select MR</option>
                        </select>
                    </div>
                    <div class="flex-col">
                        <label for="brickSelect">Brick:</label>
                        <select id="brickSelect">
                            <option value="">Select Brick</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="flex-col col-span-full">
                        <label for="visitDetails">Visit Details:</label>
                        <textarea id="visitDetails" rows="2" placeholder="Add specific details about the visit..."></textarea>
                    </div>
                </div>
            </div>
            <div id="eventInputsContainer" class="hidden entry-container event-container">
                <div class="form-row">
                    <div class="flex-col">
                        <label for="eventSelect">Event Type:</label>
                        <select id="eventSelect" onchange="handleEventChange()">
                            <option value="">Select Event</option>
                            <option value="Meeting">Meeting</option>
                            <option value="Training">Training</option>
                            <option value="Event">Event</option>
                            <option value="Admin Work">Admin Work</option>
                        </select>
                    </div>
                    <div id="adminWorkTypeContainer" class="flex-col hidden">
                        <label for="adminWorkTypeSelect">Admin Work Type:</label>
                        <select id="adminWorkTypeSelect">
                            <option value="">Select Type</option>
                            <option value="Office">Office</option>
                            <option value="Online">Online</option>
                        </select>
                    </div>
                    <div class="flex-col">
                        <label for="eventTimeChoice">Time Option:</label>
                        <select id="eventTimeChoice" onchange="handleEventTimeChoiceChange()">
                            <option value="">Select Time Option</option>
                            <option value="Pick a Time">Pick a Time</option>
                            <option value="AM">AM</option>
                            <option value="PM">PM</option>
                            <option value="Full Day">Full Day</option>
                        </select>
                    </div>
                    <div id="eventTimeInputContainer" class="flex-col hidden">
                        <label for="eventTimeInput">Specific Time:</label>
                        <input type="time" id="eventTimeInput">
                    </div>
                </div>
                <div class="form-row">
                    <div class="flex-col col-span-full">
                        <label for="eventDetails">Event Details:</label>
                        <textarea id="eventDetails" rows="2" placeholder="Add specific details about the event..."></textarea>
                    </div>
                </div>
            </div>
            <div id="leavesInputsContainer" class="hidden entry-container leave-container">
                <div class="form-row">
                    <div class="flex-col">
                        <label for="leaveSelect">Leave Type:</label>
                        <select id="leaveSelect" onchange="handleLeaveChange()">
                            <option value="">Select Leave Type</option>
                            <option value="Annual Leave">Annual Leave</option>
                            <option value="Official Leave">Official Leave</option>
                            <option value="Sick Leave">Sick Leave</option>
                        </select>
                    </div>
                    <div class="flex-col">
                        <label for="leaveTimeChoice">Time Option:</label>
                        <select id="leaveTimeChoice" onchange="handleLeaveTimeChoiceChange()">
                            <option value="">Select Time Option</option>
                            <option value="Pick a Time">Pick a Time</option>
                            <option value="AM">AM</option>
                            <option value="PM">PM</option>
                            <option value="Full Day">Full Day</option>
                        </select>
                    </div>
                    <div id="leaveTimeInputContainer" class="flex-col hidden">
                        <label for="leaveTimeInput">Specific Time:</label>
                        <input type="time" id="leaveTimeInput">
                    </div>
                </div>
                <div class="form-row">
                    <div class="flex-col col-span-full">
                        <label for="leaveDetails">Leave Details:</label>
                        <textarea id="leaveDetails" rows="2" placeholder="Add specific details about the leave..."></textarea>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-3">
                <button type="button" class="btn btn-primary" onclick="addPlanEntry()">Add Entry to Plan</button>
                <button type="button" class="btn btn-danger" id="deleteEntryButton" style="display:none;">Delete Selected Entries</button>
            </div>
        </div>

        <div class="nav-controls">
            <button id="prevWeekBtn" class="btn btn-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                <span class="hidden sm:inline">Previous Week</span>
            </button>
            <button id="nextWeekBtn" class="btn btn-secondary">
                <span class="hidden sm:inline">Next Week</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>

        <div class="scrollable-table-container">
            <table>
                <thead>
                    <tr id="table-header-row">
                        <th class="time-cell">Time</th>
                    </tr>
                </thead>
                <tbody id="plan-table-body">
                </tbody>
            </table>
        </div>
        <div class="flex justify-end gap-3 mt-3">
            <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
            <button type="submit" class="btn btn-primary" onclick="submitPlan()">Submit Plan</button>
        </div>
    </div>
    <div id="global-popover-container" class="popover-container"></div>
    <script>
        let allData = [];
        let districtManagers = [];
        let loggedInUser = null;
        let multiSelectMode = false;
        let longPressTimer;

        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRcnOTUUiyczqtn1s8zhVfYGARkjx-xfT621A9AX7jw3TxmvnBbdc-BZ_EjuOk1uahqY7s5FcdFvQKm/pub?output=csv';
        const daysOfWeek = ['Saturday', 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
        const startHour = 9;
        const endHour = 23;
        const totalHours = endHour - startHour + 1;
        let isResizing = false;
        let currentResizingBox = null;
        let initialY = 0;
        let initialHeight = 0;
        let cellHeight = 0;

        const supabaseUrl = 'https://plmevfyxpngzymvzvkzn.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBsbWV2Znl4cG5nenltdnp2a3puIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NjM5NDEsImV4cCI6MjA2NjMzOTk0MX0.lUm3efHFCL3aAB-PL7H54BpnvcpbXxp1BeUzw0yjp5c';
        const _supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);

        function toggleLoading(show) {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        }

        function parseCSV(csv) {
            const lines = csv.split('\n');
            const nonEmptyLines = lines.filter(line => line.trim() !== '');
            if (nonEmptyLines.length === 0) return [];
            const headers = nonEmptyLines[0].split(',').map(header => header.trim());
            const data = [];
            for (let i = 1; i < nonEmptyLines.length; i++) {
                const currentLine = nonEmptyLines[i].split(',');
                if (currentLine.length === headers.length) {
                    const row = {};
                    for (let j = 0; j < headers.length; j++) {
                        row[headers[j]] = currentLine[j].trim();
                    }
                    data.push(row);
                }
            }
            return data;
        }

        async function fetchData() {
            toggleLoading(true);
            const maxRetries = 5;
            let retries = 0;
            let delay = 1000;
            while (retries < maxRetries) {
                try {
                    const response = await fetch(CSV_URL, { mode: 'cors' });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const csvText = await response.text();
                    allData = parseCSV(csvText);
                    const managerSet = new Set();
                    allData.forEach(row => {
                        if (row['District Manager']) {
                            managerSet.add(row['District Manager']);
                        }
                    });
                    districtManagers = Array.from(managerSet).sort();
                    return;
                } catch (error) {
                    console.error(`Error fetching or parsing data (attempt ${retries + 1}):`, error);
                    retries++;
                    if (retries < maxRetries) {
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    } else {
                        showMessageBox(`Failed to load data after multiple attempts. Error: ${error.message}`, 'Error');
                    }
                } finally {
                    if (retries >= maxRetries || allData.length > 0) {
                        toggleLoading(false);
                    }
                }
            }
        }
        
        async function initializeApp(user) {
            loggedInUser = user;
            await fetchData();
            filterAndPopulateDMs(user);
            setDefaultStartDate();
            updateDatesAndDaySelector();
            handleEntryTypeChange();
        }

        function filterAndPopulateDMs(user) {
            const select = document.getElementById('districtManager');
            select.innerHTML = '<option value="">Select District Manager</option>';
            select.disabled = false;

            if (user && user.title === 'admin') {
                districtManagers.forEach(manager => {
                    const option = document.createElement('option');
                    option.value = manager;
                    option.textContent = manager;
                    select.appendChild(option);
                });
            } else if (user && user.title === 'District Manager') {
                const option = document.createElement('option');
                option.value = user.username;
                option.textContent = user.username;
                select.appendChild(option);
                select.value = user.username;
                select.disabled = true;
            } else {
                 districtManagers.forEach(manager => {
                    const option = document.createElement('option');
                    option.value = manager;
                    option.textContent = manager;
                    select.appendChild(option);
                });
            }
        }

        function showMessageBox(message, title = 'Notification') {
            // New modal styling to match the new CSS
            const modalBox = document.createElement('div');
            modalBox.className = 'modal-box';
            modalBox.innerHTML = `
                <div class="modal-content">
                    <h3>${title}</h3>
                    <p>${message}</p>
                    <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-box').remove()">Close</button>
                </div>
            `;
            document.body.appendChild(modalBox);
        }

        function calculateEndDate(startDateStr) {
            if (!startDateStr) return '';
            const startDate = new Date(startDateStr);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            return endDate.toISOString().split('T')[0];
        }
        
        function setDefaultStartDate() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday, 6 = Saturday
            let daysSinceSaturday = (dayOfWeek + 1) % 7; // 0=Sat, 1=Sun, ..., 6=Fri
            
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - daysSinceSaturday);

            if (dayOfWeek === 5) { // If today is Friday, go to the next week's Saturday
                startOfWeek.setDate(startOfWeek.getDate() + 7);
            }

            document.getElementById('startDate').value = startOfWeek.toISOString().split('T')[0];
        }

        function updateDatesAndDaySelector() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const selectedStartDate = startDateInput.value;
            endDateInput.value = calculateEndDate(selectedStartDate);
            populateDaySelector(selectedStartDate);
            updateTableHeader(selectedStartDate);
            populateTimeSlotTable(selectedStartDate);
            fetchExistingPlanData(selectedStartDate);
        }

        async function fetchExistingPlanData(startDate) {
            const districtManager = document.getElementById('districtManager').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate || !districtManager) {
                console.log('Missing required filters.');
                return;
            }

            clearPlanTableBody();
            toggleLoading(true);

            try {
                const { data: entries, error: entriesError } = await _supabase
                    .from('dms_weekly_plans')
                    .select('*')
                    .eq('district_manager_name', districtManager)
                    .gte('start_date', startDate)
                    .lte('end_date', endDate);

                if (entriesError) throw entriesError;

                populatePlanTable(entries || []);

            } catch (error) {
                console.error('Error fetching plan data:', error);
                showMessageBox(`Failed to load plan data. Error: ${error.message}`, 'Error');
            } finally {
                toggleLoading(false);
            }
        }

        document.getElementById('districtManager').addEventListener('change', updateDatesAndDaySelector);
        document.getElementById('startDate').addEventListener('change', updateDatesAndDaySelector);
        
        document.getElementById('prevWeekBtn').addEventListener('click', () => {
            const startDateInput = document.getElementById('startDate');
            const currentDate = new Date(startDateInput.value);
            currentDate.setDate(currentDate.getDate() - 7);
            startDateInput.value = currentDate.toISOString().split('T')[0];
            updateDatesAndDaySelector();
        });

        document.getElementById('nextWeekBtn').addEventListener('click', () => {
            const startDateInput = document.getElementById('startDate');
            const currentDate = new Date(startDateInput.value);
            currentDate.setDate(currentDate.getDate() + 7);
            startDateInput.value = currentDate.toISOString().split('T')[0];
            updateDatesAndDaySelector();
        });


        function populatePlanTable(entries) {
            clearPlanTableBody();

            if (!entries || entries.length === 0) {
                console.log('No entries to populate.');
                return;
            }

            entries.forEach(entry => {
                const dayIndex = daysOfWeek.indexOf(entry.entry_day);
                if (dayIndex === -1) {
                    console.log('Day not found for entry:', entry);
                    return;
                }

                let planDetailsHtml = '';
                let entryData = {
                    id: entry.id,
                    day: entry.entry_day,
                    date: entry.entry_day,
                    type: entry.entry_type,
                    details: entry.details || '',
                    startHour: entry.start_hour,
                    endHour: entry.end_hour
                };

                let isFullDay = false;
                let timeDisplay = getTimeDisplay(entry.start_hour, entry.end_hour, entry.start_time_option, entry.end_time_option);

                if (entry.entry_type === 'Event') {
                    entryData.event = entry.event_type;
                    entryData.eventTime = timeDisplay;
                    entryData.isLeave = false;
                    entryData.startTimeOption = entry.start_time_option;
                    if (entry.start_time_option === 'Full Day') isFullDay = true;

                    let adminWorkSubType = '';
                    if (entry.event_type === 'Admin Work' && entry.details) {
                        const detailsParts = entry.details.split(' - ');
                        if (detailsParts.length > 1 && (detailsParts[0] === 'Office' || detailsParts[0] === 'Online')) {
                            adminWorkSubType = detailsParts[0];
                            entryData.adminWorkType = adminWorkSubType;
                        }
                    }

                    planDetailsHtml = `
                        <div class="plan-box event-box"
                             data-type="Event"
                             data-event="${entry.event_type}"
                             data-time="${timeDisplay}"
                             data-details="${entry.details || ''}"
                             data-start-hour="${entry.start_hour}"
                             data-end-hour="${entry.end_hour}"
                             data-is-leave="false"
                             data-entry-id="${entry.id}"
                             data-start-time-option="${entry.start_time_option}">
                            <p>${entry.event_type}</p>
                            ${entry.event_type === 'Admin Work' && adminWorkSubType ? `<p><span class="font-semibold">Type:</span> ${adminWorkSubType}</p>` : ''}
                            ${!isFullDay ? '<div class="resize-handle"></div>' : ''}
                        </div>
                    `;
                } else if (entry.entry_type === 'Visit') {
                    entryData.visitType = entry.visit_type;
                    entryData.visitTime = timeDisplay;
                    entryData.medicalRep = entry.medical_rep_name || '';
                    entryData.brick = entry.brick || '';
                    entryData.isLeave = false;
                    entryData.startTimeOption = entry.start_time_option;
                    if (entry.start_time_option === 'Full Day') isFullDay = true;


                    planDetailsHtml = `
                        <div class="plan-box visit-box"
                             data-type="Visit"
                             data-visit-type="${entry.visit_type}"
                             data-time="${timeDisplay}"
                             data-mr="${entry.medical_rep_name || ''}"
                             data-brick="${entry.brick || ''}"
                             data-details="${entry.details || ''}"
                             data-start-hour="${entry.start_hour}"
                             data-end-hour="${entry.end_hour}"
                             data-is-leave="false"
                             data-entry-id="${entry.id}"
                             data-start-time-option="${entry.start_time_option}">
                            <p>${entry.visit_type}</p>
                            ${entry.visit_type === 'Double Visit' ? `<p><span class="font-semibold">Brick:</span> ${entry.brick || ''}</p>` : ''}
                            ${!isFullDay ? '<div class="resize-handle"></div>' : ''}
                        </div>
                    `;
                } else if (entry.entry_type === 'Leave') {
                    entryData.leaveType = entry.leave_type;
                    entryData.leaveTime = timeDisplay;
                    entryData.isLeave = true;
                    entryData.startTimeOption = entry.start_time_option;
                    if (entry.start_time_option === 'Full Day') isFullDay = true;


                    planDetailsHtml = `
                        <div class="plan-box leave-box"
                             data-type="Leave"
                             data-leave-type="${entry.leave_type}"
                             data-time="${timeDisplay}"
                             data-details="${entry.details || ''}"
                             data-start-hour="${entry.start_hour}"
                             data-end-hour="${entry.end_hour}"
                             data-is-leave="${isLeave}"
                             data-start-time-option="${entry.start_time_option}">
                            <p>${entry.leave_type}</p>
                            ${!isFullDay ? '<div class="resize-handle"></div>' : ''}
                        </div>
                    `;
                }

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = planDetailsHtml.trim();
                const planBoxElement = tempDiv.firstChild;

                const targetCell = document.getElementById(`day-${dayIndex}-hour-${entry.start_hour}`);
                if (!targetCell) {
                    console.log('Target cell not found for entry:', entry);
                    return;
                }

                const existingBoxesInCell = Array.from(targetCell.querySelectorAll('.plan-box'));
                const hasFullDayEntry = existingBoxesInCell.some(box => box.dataset.startTimeOption === 'Full Day');

                if (isFullDay) {
                    // Remove any existing non-full-day entries before adding a full-day one
                    if (!hasFullDayEntry) {
                        existingBoxesInCell.forEach(box => box.remove());
                    }
                    
                    const durationHours = endHour - startHour + 1;
                    planBoxElement.style.height = `${cellHeight * durationHours + (durationHours - 1) * 1}px`;
                    planBoxElement.style.top = '0px';
                    planBoxElement.setAttribute('data-entry-details', JSON.stringify(entryData));
                    targetCell.appendChild(planBoxElement);
                } else {
                    // Check for overlap with other entries on the same day and adjust position
                    const existingBoxesOnDay = [];
                    for(let h = startHour; h <= endHour; h++) {
                        const dayCell = document.getElementById(`day-${dayIndex}-hour-${h}`);
                        if(dayCell) {
                           existingBoxesOnDay.push(...dayCell.querySelectorAll('.plan-box:not(.full-day-entry)'));
                        }
                    }
                    
                    const newEntryDurationHours = entry.end_hour - entry.start_hour + 1;
                    
                    let proposedStartHour = entry.start_hour;
                    let isOverlapping = true;
                    
                    while(isOverlapping && proposedStartHour <= endHour) {
                        isOverlapping = false;
                        let proposedEndHour = proposedStartHour + newEntryDurationHours - 1;
                        for(const existingBox of existingBoxesOnDay) {
                            const existingStartHour = parseInt(existingBox.dataset.startHour);
                            const existingEndHour = parseInt(existingBox.dataset.endHour);
                            if( (proposedStartHour <= existingEndHour && proposedEndHour >= existingStartHour) && (existingBox.getAttribute('data-entry-id') !== entry.id) ) {
                                isOverlapping = true;
                                proposedStartHour = existingEndHour + 1;
                                break;
                            }
                        }
                    }

                    if (proposedStartHour + newEntryDurationHours - 1 <= endHour) {
                        entryData.startHour = proposedStartHour;
                        entryData.endHour = proposedStartHour + newEntryDurationHours - 1;
                    }
                    
                    planBoxElement.setAttribute('data-entry-details', JSON.stringify(entryData));
                    const newTargetCell = document.getElementById(`day-${dayIndex}-hour-${entryData.startHour}`);

                    if(newTargetCell) {
                       const durationHours = entryData.endHour - entryData.startHour + 1;
                       planBoxElement.style.height = `${cellHeight * durationHours + (durationHours - 1) * 1}px`;
                       planBoxElement.style.top = '0px';
                       newTargetCell.appendChild(planBoxElement);
                    } else {
                        console.error('Could not find a non-overlapping cell for entry:', entry);
                    }

                    const resizeHandle = planBoxElement.querySelector('.resize-handle');
                    if (resizeHandle) {
                        resizeHandle.addEventListener('mousedown', startResize);
                        resizeHandle.addEventListener('touchstart', startResize, { passive: false });
                    }
                }
            });
        }


        function getTimeDisplay(startHour, endHour, startTimeOption, endTimeOption) {
            if (startTimeOption === 'Full Day') {
                return 'Full Day (9 AM - 11 PM)';
            } else if (startTimeOption === 'AM') {
                return `AM (9 AM - 2 PM)`;
            } else if (startTimeOption === 'PM') {
                return `PM (2 PM - 11 PM)`;
            } else {
                return `${formatHourForDisplay(startHour)} - ${formatHourForDisplay(endHour)}`;
            }
        }

        function formatHourForDisplay(hour) {
            if (hour === 0) return '12 AM';
            if (hour === 12) return '12 PM';
            if (hour < 12) return `${hour} AM`;
            return `${hour - 12} PM`;
        }

        function clearPlanTableBody() {
            const planTableBody = document.getElementById('plan-table-body');
            const allCells = planTableBody.querySelectorAll('.table-cell-hour');
            allCells.forEach(cell => {
                cell.innerHTML = '';
            });

            const startDateInput = document.getElementById('startDate').value;
            if (!startDateInput) {
                planTableBody.innerHTML = `
                    <tr>
                        <td colspan="${daysOfWeek.length + 1}" class="text-center py-4 text-gray-500" data-empty-message="true">No plan entries yet. Select a day and add an entry.</td>
                    </tr>
                `;
            }
        }

        async function submitPlan() {
            const planData = {
                districtManager: document.getElementById('districtManager').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                weeklyEntries: []
            };

            if (!planData.districtManager || !planData.startDate) {
                showMessageBox('Please fill in the District Manager and Week Start Date before submitting.');
                return;
            }

            for (let dayIndex = 0; dayIndex < daysOfWeek.length; dayIndex++) {
                for (let hour = startHour; hour <= endHour; hour++) {
                    const cell = document.getElementById(`day-${dayIndex}-hour-${hour}`);
                    if (cell) {
                        const planBoxes = cell.querySelectorAll('.plan-box');
                        planBoxes.forEach(planBox => {
                            if (planBox.hasAttribute('data-entry-details')) {
                                const entry = JSON.parse(planBox.getAttribute('data-entry-details'));
                                if (!entry.id || entry.id.startsWith('entry-')) {
                                    planData.weeklyEntries.push(entry);
                                }
                            }
                        });
                    }
                }
            }

            if (planData.weeklyEntries.length === 0) {
                showMessageBox('No new entries to submit. Please add at least one entry to your weekly plan.');
                return;
            }

            toggleLoading(true);

            try {
                const entriesToInsert = planData.weeklyEntries.map(entry => ({
                    district_manager_name: planData.districtManager,
                    start_date: planData.startDate,
                    end_date: planData.endDate,
                    entry_day: entry.day,
                    entry_type: entry.type,
                    start_hour: entry.startHour,
                    end_hour: entry.endHour,
                    start_time_option: entry.startTimeOption,
                    end_time_option: getTimeOption(entry.startHour, entry.endHour),
                    visit_type: entry.visitType,
                    medical_rep_name: entry.medicalRep,
                    brick: entry.brick,
                    event_type: entry.event,
                    leave_type: entry.leaveType,
                    details: entry.details
                }));

                const { error: insertError } = await _supabase
                    .from('dms_weekly_plans')
                    .insert(entriesToInsert);

                if (insertError) {
                    throw error;
                }

                showMessageBox('Plan submitted successfully!', 'Success');
                fetchExistingPlanData(planData.startDate);
            }
            catch (error) {
                console.error('Error submitting plan:', error);
                showMessageBox(`Failed to submit plan. Error: ${error.message}`, 'Error');
            } finally {
                toggleLoading(false);
            }
        }

        function getTimeOption(startHour, endHour) {
            if (startHour === 9 && endHour === 23) {
                return 'Full Day';
            } else if (startHour === 9 && endHour === 14) {
                return 'AM';
            } else if (startHour === 14 && endHour === 23) {
                return 'PM';
            } else {
                return 'Pick a Time';
            }
        }

        function populateDaySelector(startDateStr) {
            const daySelect = document.getElementById('selectedDay');
            daySelect.innerHTML = '<option value="">Select a Day</option>';
            if (startDateStr) {
                const startDate = new Date(startDateStr);
                daysOfWeek.forEach((dayName, index) => {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + index);
                    const dateString = currentDate.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
                    const option = document.createElement('option');
                    option.value = `${dayName}|${currentDate.toISOString().split('T')[0]}|${index}`;
                    option.textContent = `${dayName} (${dateString})`;
                    daySelect.appendChild(option);
                });
            }
        }

        function updateTableHeader(startDateStr) {
            const tableHeaderRow = document.getElementById('table-header-row');
            tableHeaderRow.innerHTML = '<th class="time-cell">Time</th>';
            if (startDateStr) {
                const startDate = new Date(startDateStr);
                daysOfWeek.forEach((dayName, index) => {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + index);
                    const dateString = currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const th = document.createElement('th');
                    th.innerHTML = `<div><span>${dayName}</span><span class="text-xs font-normal text-gray-500">${dateString}</span></div>`;
                    tableHeaderRow.appendChild(th);
                });
            } else {
                daysOfWeek.forEach(dayName => {
                    const th = document.createElement('th');
                    th.innerHTML = `<div><span>${dayName}</span><span class="text-xs font-normal text-gray-500">Select Date</span></div>`;
                    tableHeaderRow.appendChild(th);
                });
            }
        }

        function populateTimeSlotTable(startDateStr) {
            const planTableBody = document.getElementById('plan-table-body');
            planTableBody.innerHTML = '';
            if (!startDateStr) {
                planTableBody.innerHTML = `
                    <tr>
                        <td colspan="${daysOfWeek.length + 1}" class="text-center py-4 text-gray-500" data-empty-message="true">No plan entries yet. Select a day and add an entry.</td>
                    </tr>
                `;
                return;
            }
            for (let hour = startHour; hour <= endHour; hour++) {
                const tr = document.createElement('tr');
                const timeLabelTd = document.createElement('td');
                timeLabelTd.classList.add('time-cell');
                timeLabelTd.textContent = `${hour > 12 ? hour - 12 : hour}${hour >= 12 ? ' PM' : ' AM'}`;
                tr.appendChild(timeLabelTd);
                for (let dayIndex = 0; dayIndex < daysOfWeek.length; dayIndex++) {
                    const td = document.createElement('td');
                    td.id = `day-${dayIndex}-hour-${hour}`;
                    td.classList.add('table-cell-hour');
                    tr.appendChild(td);
                }
                planTableBody.appendChild(tr);
            }
            if (planTableBody.querySelector('.table-cell-hour')) {
                cellHeight = planTableBody.querySelector('.table-cell-hour').offsetHeight;
            }
        }

        function handleEntryTypeChange() {
            const entryTypeSelect = document.getElementById('entryTypeSelect');
            const visitInputsContainer = document.getElementById('visitInputsContainer');
            const eventInputsContainer = document.getElementById('eventInputsContainer');
            const leavesInputsContainer = document.getElementById('leavesInputsContainer');

            visitInputsContainer.classList.add('hidden');
            eventInputsContainer.classList.add('hidden');
            leavesInputsContainer.classList.add('hidden');

            document.getElementById('visitTypeSelect').value = '';
            document.getElementById('visitTimeChoice').value = '';
            document.getElementById('visitTimeInput').value = '';
            document.getElementById('visitTimeInputContainer').classList.add('hidden');
            document.getElementById('medicalRepSelect').innerHTML = '<option value="">Select MR</option>';
            document.getElementById('brickSelect').innerHTML = '<option value="">Select Brick</option>';
            document.getElementById('mrBrickContainer').classList.add('hidden');
            document.getElementById('visitDetails').value = '';

            document.getElementById('eventSelect').value = '';
            document.getElementById('eventTimeChoice').value = '';
            document.getElementById('eventTimeInput').value = '';
            document.getElementById('eventTimeInputContainer').classList.add('hidden');
            document.getElementById('eventDetails').value = '';
            document.getElementById('adminWorkTypeContainer').classList.add('hidden');
            document.getElementById('adminWorkTypeSelect').value = '';

            document.getElementById('leaveSelect').value = '';
            document.getElementById('leaveTimeChoice').value = '';
            document.getElementById('leaveTimeInput').value = '';
            document.getElementById('leaveTimeInputContainer').classList.add('hidden');
            document.getElementById('leaveDetails').value = '';

            if (entryTypeSelect.value === 'Visit') {
                visitInputsContainer.classList.remove('hidden');
            } else if (entryTypeSelect.value === 'Event') {
                eventInputsContainer.classList.remove('hidden');
            } else if (entryTypeSelect.value === 'Leave') {
                leavesInputsContainer.classList.remove('hidden');
            }
        }

        function handleEventTimeChoiceChange() {
            const eventTimeChoice = document.getElementById('eventTimeChoice');
            const eventTimeInputContainer = document.getElementById('eventTimeInputContainer');
            const eventTimeInput = document.getElementById('eventTimeInput');
            if (eventTimeChoice.value === 'Pick a Time') {
                eventTimeInputContainer.classList.remove('hidden');
            } else {
                eventTimeInputContainer.classList.add('hidden');
                eventTimeInput.value = '';
            }
        }

        function handleVisitTimeChoiceChange() {
            const visitTimeChoice = document.getElementById('visitTimeChoice');
            const visitTimeInputContainer = document.getElementById('visitTimeInputContainer');
            const visitTimeInput = document.getElementById('visitTimeInput');
            if (visitTimeChoice.value === 'Pick a Time') {
                visitTimeInputContainer.classList.remove('hidden');
            } else {
                visitTimeInputContainer.classList.add('hidden');
                visitTimeInput.value = '';
            }
        }

        function handleLeaveTimeChoiceChange() {
            const leaveTimeChoice = document.getElementById('leaveTimeChoice');
            const leaveTimeInputContainer = document.getElementById('leaveTimeInputContainer');
            const leaveTimeInput = document.getElementById('leaveTimeInput');
            if (leaveTimeChoice.value === 'Pick a Time') {
                leaveTimeInputContainer.classList.remove('hidden');
            } else {
                leaveTimeInputContainer.classList.add('hidden');
                leaveTimeInput.value = '';
            }
        }

        function handleEventChange() {
            const eventSelect = document.getElementById('eventSelect');
            const adminWorkTypeContainer = document.getElementById('adminWorkTypeContainer');
            if (eventSelect.value === 'Admin Work') {
                adminWorkTypeContainer.classList.remove('hidden');
            } else {
                adminWorkTypeContainer.classList.add('hidden');
                document.getElementById('adminWorkTypeSelect').value = '';
            }
        }

        function handleLeaveChange() {
        }

        function handleVisitTypeChange() {
            const visitTypeSelect = document.getElementById('visitTypeSelect');
            const mrBrickContainer = document.getElementById('mrBrickContainer');

            if (visitTypeSelect.value === 'Double Visit') {
                mrBrickContainer.classList.remove('hidden');
                populateMedicalReps();
            } else if (visitTypeSelect.value === 'Single Visit') {
                mrBrickContainer.classList.add('hidden');
                document.getElementById('medicalRepSelect').innerHTML = '<option value="">Select MR</option>';
                document.getElementById('brickSelect').innerHTML = '<option value="">Select Brick</option>';
            } else {
                mrBrickContainer.classList.add('hidden');
                document.getElementById('medicalRepSelect').innerHTML = '<option value="">Select MR</option>';
                document.getElementById('brickSelect').innerHTML = '<option value="">Select Brick</option>';
            }
        }

        function populateMedicalReps() {
            const dmSelect = document.getElementById('districtManager');
            const selectedDM = dmSelect.value;
            const medicalRepSelect = document.getElementById('medicalRepSelect');
            medicalRepSelect.innerHTML = '<option value="">Select MR</option>';
            if (selectedDM) {
                const mrsForDM = new Set();
                allData.forEach(row => {
                    if (row['District Manager'] === selectedDM && row['medical rep']) {
                        mrsForDM.add(row['medical rep']);
                    }
                });
                Array.from(mrsForDM).sort().forEach(mr => {
                    const option = document.createElement('option');
                    option.value = mr;
                    option.textContent = mr;
                    medicalRepSelect.appendChild(option);
                });
            }
        }

        function handleMedicalRepChange() {
            const selectedMR = document.getElementById('medicalRepSelect').value;
            const brickSelect = document.getElementById('brickSelect');
            brickSelect.innerHTML = '<option value="">Select Brick</option>';
            if (selectedMR) {
                const bricksForMR = new Set();
                allData.forEach(row => {
                    if (row['medical rep'] === selectedMR && row['Brick']) {
                        bricksForMR.add(row['Brick']);
                    }
                });
                Array.from(bricksForMR).sort().forEach(brick => {
                    const option = document.createElement('option');
                    option.value = brick;
                    option.textContent = brick;
                    brickSelect.appendChild(option);
                });
            }
        }

        function addPlanEntry() {
            const selectedDayValue = document.getElementById('selectedDay').value;
            const entryType = document.getElementById('entryTypeSelect').value;
            const districtManager = document.getElementById('districtManager').value;
            const startDate = document.getElementById('startDate').value;

            if (!districtManager) {
                showMessageBox('Please select a District Manager.');
                return;
            }
            if (!startDate) {
                showMessageBox('Please select a Week Start Date.');
                return;
            }
            if (!selectedDayValue) {
                showMessageBox('Please select a Day for the entry.');
                return;
            }
            if (!entryType) {
                showMessageBox('Please select an Entry Type (Visit, Event, or Leave).');
                return;
            }

            let planDetailsHtml = '';
            let entryData = {
                day: '',
                date: '',
                type: entryType,
                details: ''
            };

            const [dayName, dateString, dayIndexStr] = selectedDayValue.split('|');
            const dayIndex = parseInt(dayIndexStr);
            entryData.day = dayName;
            entryData.date = dateString;
            let entryStartHour = -1;
            let entryEndHour = -1;
            let timeDisplay = '';
            let isFullDay = false;
            let timeChoiceElement;
            let isLeave = false;
            let startTimeOption = '';
            
            if (entryType === 'Event') {
                const event = document.getElementById('eventSelect').value;
                const adminWorkType = document.getElementById('adminWorkTypeSelect').value;
                timeChoiceElement = document.getElementById('eventTimeChoice');
                startTimeOption = timeChoiceElement.value;

                if (!event) {
                    showMessageBox('Please select an Event Type.');
                    return;
                }
                if (event === 'Admin Work' && !adminWorkType) {
                    showMessageBox('Please select an Admin Work Type (Office or Online).');
                    return;
                }
                if (!startTimeOption) {
                    showMessageBox('Please select a Time Option for the event.');
                    return;
                }
                if (startTimeOption === 'Pick a Time') {
                    const eventTimeInput = document.getElementById('eventTimeInput').value;
                    if (!eventTimeInput) {
                        showMessageBox('Please select a specific Event Time.');
                        return;
                    }
                    entryStartHour = parseInt(eventTimeInput.split(':')[0]);
                    entryEndHour = entryStartHour + 1;
                    if (entryEndHour > endHour) entryEndHour = endHour;
                    timeDisplay = `${eventTimeInput} - ${formatHourForDisplay(entryEndHour)}`;
                } else if (startTimeOption === 'AM') {
                    entryStartHour = 9;
                    entryEndHour = 14;
                    timeDisplay = 'AM (9 AM - 2 PM)';
                } else if (startTimeOption === 'PM') {
                    entryStartHour = 14;
                    entryEndHour = 23;
                    timeDisplay = 'PM (2 PM - 11 PM)';
                } else if (startTimeOption === 'Full Day') {
                    entryStartHour = startHour;
                    entryEndHour = endHour;
                    timeDisplay = 'Full Day (9 AM - 11 PM)';
                    isFullDay = true;
                }
                let eventDetails = document.getElementById('eventDetails').value;
                if (event === 'Admin Work' && adminWorkType) {
                    eventDetails = `${adminWorkType} - ${eventDetails}`;
                    entryData.adminWorkType = adminWorkType;
                }

                entryData.event = event;
                entryData.eventTime = timeDisplay;
                entryData.details = eventDetails;
                entryData.startHour = entryStartHour;
                entryData.endHour = entryEndHour;
                entryData.isLeave = isLeave;
                entryData.startTimeOption = startTimeOption;
                planDetailsHtml = `
                    <div class="plan-box event-box"
                         data-type="Event"
                         data-event="${event}"
                         data-time="${timeDisplay}"
                         data-details="${eventDetails || ''}"
                         data-start-hour="${entryStartHour}"
                         data-end-hour="${entryEndHour}"
                         data-is-leave="${isLeave}"
                         data-start-time-option="${startTimeOption}">
                        <p>${event}</p>
                        ${event === 'Admin Work' && adminWorkType ? `<p><span class="font-semibold">Type:</span> ${adminWorkType}</p>` : ''}
                        ${!isFullDay ? '<div class="resize-handle"></div>' : ''}
                    </div>
                `;
            } else if (entryType === 'Visit') {
                const visitType = document.getElementById('visitTypeSelect').value;
                timeChoiceElement = document.getElementById('visitTimeChoice');
                startTimeOption = timeChoiceElement.value;

                if (!visitType) {
                    showMessageBox('Please select a Visit Type.');
                    return;
                }
                if (!startTimeOption) {
                    showMessageBox('Please select a Time Option for the visit.');
                    return;
                }
                if (startTimeOption === 'Pick a Time') {
                    const visitTimeInput = document.getElementById('visitTimeInput').value;
                    if (!visitTimeInput) {
                        showMessageBox('Please select a specific Visit Time.');
                        return;
                    }
                    entryStartHour = parseInt(visitTimeInput.split(':')[0]);
                    entryEndHour = entryStartHour + 1;
                    if (entryEndHour > endHour) entryEndHour = endHour;
                    timeDisplay = `${visitTimeInput} - ${formatHourForDisplay(entryEndHour)}`;
                } else if (startTimeOption === 'AM') {
                    entryStartHour = 9;
                    entryEndHour = 14;
                    timeDisplay = 'AM (9 AM - 2 PM)';
                } else if (startTimeOption === 'PM') {
                    entryStartHour = 14;
                    entryEndHour = 23;
                    timeDisplay = 'PM (2 PM - 11 PM)';
                } else if (startTimeOption === 'Full Day') {
                    entryStartHour = startHour;
                    entryEndHour = endHour;
                    timeDisplay = 'Full Day (9 AM - 11 PM)';
                    isFullDay = true;
                }
                let medicalRep = '';
                let brick = '';
                let visitDetails = '';
                if (visitType === 'Double Visit') {
                    medicalRep = document.getElementById('medicalRepSelect').value;
                    brick = document.getElementById('brickSelect').value;
                    if (!medicalRep || !brick) {
                        showMessageBox('For Double Visit, please select medical rep and Brick.');
                        return;
                    }
                } else if (visitType === 'Single Visit') {
                }
                visitDetails = document.getElementById('visitDetails').value;
                entryData.visitType = visitType;
                entryData.visitTime = timeDisplay;
                entryData.medicalRep = medicalRep;
                entryData.brick = brick;
                entryData.details = visitDetails;
                entryData.startHour = entryStartHour;
                entryData.endHour = entryEndHour;
                entryData.isLeave = isLeave;
                entryData.startTimeOption = startTimeOption;
                planDetailsHtml = `
                    <div class="plan-box visit-box"
                             data-type="Visit"
                             data-visit-type="${visitType}"
                             data-time="${timeDisplay}"
                             data-mr="${medicalRep}"
                             data-brick="${brick}"
                             data-details="${visitDetails || ''}"
                             data-start-hour="${entryStartHour}"
                             data-end-hour="${entryEndHour}"
                             data-is-leave="${isLeave}"
                             data-start-time-option="${startTimeOption}">
                        <p>${visitType}</p>
                        ${visitType === 'Double Visit' ? `<p><span class="font-semibold">Brick:</span> ${brick}</p>` : ''}
                        ${!isFullDay ? '<div class="resize-handle"></div>' : ''}
                    </div>
                `;
            } else if (entryType === 'Leave') {
                const leaveType = document.getElementById('leaveSelect').value;
                timeChoiceElement = document.getElementById('leaveTimeChoice');
                startTimeOption = timeChoiceElement.value;
                if (!leaveType) {
                    showMessageBox('Please select a Leave Type.');
                    return;
                }
                if (!startTimeOption) {
                    showMessageBox('Please select a Time Option for the leave.');
                    return;
                }
                isLeave = true;
                if (startTimeOption === 'Pick a Time') {
                    const leaveTimeInput = document.getElementById('leaveTimeInput').value;
                    if (!leaveTimeInput) {
                        showMessageBox('Please select a specific Leave Time.');
                        return;
                    }
                    entryStartHour = parseInt(leaveTimeInput.split(':')[0]);
                    entryEndHour = entryStartHour + 1;
                    if (entryEndHour > endHour) entryEndHour = endHour;
                    timeDisplay = `${leaveTimeInput} - ${formatHourForDisplay(entryEndHour)}`;
                } else if (startTimeOption === 'AM') {
                    entryStartHour = 9;
                    entryEndHour = 14;
                    timeDisplay = 'AM (9 AM - 2 PM)';
                } else if (startTimeOption === 'PM') {
                    entryStartHour = 14;
                    entryEndHour = 23;
                    timeDisplay = 'PM (2 PM - 11 PM)';
                } else if (startTimeOption === 'Full Day') {
                    entryStartHour = startHour;
                    entryEndHour = endHour;
                    timeDisplay = 'Full Day (9 AM - 11 PM)';
                    isFullDay = true;
                }
                const leaveDetails = document.getElementById('leaveDetails').value;
                entryData.leaveType = leaveType;
                entryData.leaveTime = timeDisplay;
                entryData.details = leaveDetails;
                entryData.startHour = entryStartHour;
                entryData.endHour = entryEndHour;
                entryData.isLeave = isLeave;
                entryData.startTimeOption = startTimeOption;
                planDetailsHtml = `
                    <div class="plan-box leave-box"
                         data-type="Leave"
                         data-leave-type="${leaveType}"
                         data-time="${timeDisplay}"
                         data-details="${leaveDetails || ''}"
                         data-start-hour="${entryStartHour}"
                         data-end-hour="${entryEndHour}"
                         data-is-leave="${isLeave}"
                         data-start-time-option="${startTimeOption}">
                        <p>${leaveType}</p>
                        ${!isFullDay ? '<div class="resize-handle"></div>' : ''}
                    </div>
                `;
            }

            let effectiveRangeStartForNewEntry = startHour;
            let effectiveRangeEndForNewEntry = endHour;
            if (startTimeOption === 'AM') {
                effectiveRangeStartForNewEntry = 9;
                effectiveRangeEndForNewEntry = 14;
            } else if (startTimeOption === 'PM') {
                effectiveRangeStartForNewEntry = 14;
                effectiveRangeEndForNewEntry = 23;
            }

            if (entryStartHour < effectiveRangeStartForNewEntry) {
                entryStartHour = effectiveRangeStartForNewEntry;
            }
            if (entryEndHour > effectiveRangeEndForNewEntry) {
                entryEndHour = effectiveRangeEndForNewEntry;
            }

            if (!isFullDay) {
                const existingEntriesOnDay = [];
                for (let hour = startHour; hour <= endHour; hour++) {
                    const cell = document.getElementById(`day-${dayIndex}-hour-${hour}`);
                    if (cell) {
                        const boxesInCell = cell.querySelectorAll('.plan-box:not(.full-day-entry)');
                        boxesInCell.forEach(box => {
                            const data = JSON.parse(box.getAttribute('data-entry-details'));
                            if (data.startHour === hour) {
                                existingEntriesOnDay.push(data);
                            }
                        });
                    }
                }
                existingEntriesOnDay.sort((a, b) => a.startHour - b.startHour);
                let proposedStartHourForAdjustment = entryStartHour;
                let proposedEndHourForAdjustment = entryEndHour;
                const originalDurationHours = entryEndHour - entryStartHour + 1;
                let foundNonOverlappingSlot = false;
                let currentCheckStartHour = proposedStartHourForAdjustment;
                while (currentCheckStartHour <= effectiveRangeEndForNewEntry) {
                    let overlapsWithAnyExisting = false;
                    let nextAvailableHourAfterOverlap = currentCheckStartHour;
                    for (const existingEntry of existingEntriesOnDay) {
                        const proposedEndForThisCheck = currentCheckStartHour + originalDurationHours - 1;
                        if (currentCheckStartHour <= existingEntry.endHour && proposedEndForThisCheck >= existingEntry.startHour) {
                            overlapsWithAnyExisting = true;
                            nextAvailableHourAfterOverlap = Math.max(nextAvailableHourAfterOverlap, existingEntry.endHour + 1);
                        }
                    }
                    if (!overlapsWithAnyExisting) {
                        if ((currentCheckStartHour + originalDurationHours - 1) <= effectiveRangeEndForNewEntry) {
                            proposedStartHourForAdjustment = currentCheckStartHour;
                            proposedEndHourForAdjustment = currentCheckStartHour + originalDurationHours - 1;
                            foundNonOverlappingSlot = true;
                            break;
                        } else {
                            if (startTimeOption === 'AM' || startTimeOption === 'PM') {
                                proposedStartHourForAdjustment = currentCheckStartHour;
                                proposedEndHourForAdjustment = effectiveRangeEndForNewEntry;
                                if (proposedStartHourForAdjustment <= proposedEndHourForAdjustment) {
                                    foundNonOverlappingSlot = true;
                                    break;
                                }
                            }
                        }
                    }
                    currentCheckStartHour = nextAvailableHourAfterOverlap;
                    if (currentCheckStartHour > effectiveRangeEndForNewEntry) {
                        break;
                    }
                }
                if (!foundNonOverlappingSlot || proposedStartHourForAdjustment > proposedEndHourForAdjustment) {
                    showMessageBox('Could not find an available non-overlapping time slot for this entry within the selected time option (AM/PM/Pick a Time). Please adjust existing entries or choose a different time.');
                    return;
                }
                entryStartHour = proposedStartHourForAdjustment;
                entryEndHour = proposedEndHourForAdjustment;
                entryData.startHour = entryStartHour;
                entryData.endHour = entryEndHour;

                if (startTimeOption === 'AM') {
                    timeDisplay = `AM (${formatHourForDisplay(entryStartHour)} - ${formatHourForDisplay(entryEndHour)})`;
                } else if (startTimeOption === 'PM') {
                    timeDisplay = `PM (${formatHourForDisplay(entryStartHour)} - ${formatHourForDisplay(entryEndHour)})`;
                } else if (startTimeOption === 'Pick a Time') {
                    const originalInputTime = document.getElementById(entryType === 'Event' ? 'eventTimeInput' : (entryType === 'Visit' ? 'visitTimeInput' : 'leaveTimeInput')).value;
                    timeDisplay = `${originalInputTime} - ${formatHourForDisplay(entryEndHour)}`;
                }

                if (entryData.type === 'Event') {
                    entryData.eventTime = timeDisplay;
                } else if (entryData.type === 'Visit') {
                    entryData.visitTime = timeDisplay;
                } else if (entryData.type === 'Leave') {
                    entryData.leaveTime = timeDisplay;
                }
            } else {
                for (let hourToClear = startHour; hourToClear <= endHour; hourToClear++) {
                    const cellToClear = document.getElementById(`day-${dayIndex}-hour-${hourToClear}`);
                    if (cellToClear) {
                        const existingNonFullDayBoxes = cellToClear.querySelectorAll('.plan-box:not(.full-day-entry)');
                        existingNonFullDayBoxes.forEach(box => box.remove());
                    }
                }
            }

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = planDetailsHtml.trim();
            const planBoxElement = tempDiv.firstChild;
            planBoxElement.setAttribute('data-entry-details', JSON.stringify(entryData));

            const targetCell = document.getElementById(`day-${dayIndex}-hour-${entryStartHour}`);
            if (!targetCell) {
                showMessageBox('Error: Could not find the target cell for the selected time.');
                return;
            }
            
            if (isFullDay) {
                 const durationHours = endHour - startHour + 1;
                 planBoxElement.style.height = `${cellHeight * durationHours + (durationHours - 1) * 1}px`;
                 planBoxElement.style.top = '0px';
                 planBoxElement.setAttribute('data-entry-id', `entry-${dayIndex}-full-day-${Date.now()}`);
                 targetCell.appendChild(planBoxElement);
            } else {
                const durationHours = entryEndHour - entryStartHour + 1;
                planBoxElement.style.height = `${cellHeight * durationHours + (durationHours - 1) * 1}px`;
                planBoxElement.style.top = '0px';
                planBoxElement.setAttribute('data-entry-id', `entry-${dayIndex}-${entryStartHour}-${Date.now()}`);
                targetCell.appendChild(planBoxElement);

                const resizeHandle = planBoxElement.querySelector('.resize-handle');
                if (resizeHandle) {
                    resizeHandle.addEventListener('mousedown', startResize);
                    resizeHandle.addEventListener('touchstart', startResize, { passive: false });
                }
            }
            
            document.getElementById('selectedDay').value = '';
            document.getElementById('entryTypeSelect').value = '';
            handleEntryTypeChange();
        }

        async function deleteSelectedEntries() {
            const selectedBoxes = document.querySelectorAll('.plan-box.selected');
            if (selectedBoxes.length === 0) {
                showMessageBox('No entries selected for deletion.');
                return;
            }

            const idsToDelete = [];
            selectedBoxes.forEach(box => {
                const entryId = box.getAttribute('data-entry-id');
                if (entryId && !entryId.startsWith('entry-')) {
                    idsToDelete.push(entryId);
                }
                box.remove();
            });

            if (idsToDelete.length > 0) {
                toggleLoading(true);
                try {
                    const { error } = await _supabase
                        .from('dms_weekly_plans')
                        .delete()
                        .in('id', idsToDelete);

                    if (error) {
                        throw error;
                    }
                    showMessageBox('Selected entries deleted successfully from database!', 'Success');
                } catch (error) {
                    console.error('Error deleting entries from Supabase:', error);
                    showMessageBox(`Failed to delete entries from database. Error: ${error.message}`, 'Error');
                } finally {
                    toggleLoading(false);
                }
            }
            updateDeleteButtonVisibility();
            hideAllPopovers();
        }

        const deleteEntryButton = document.getElementById('deleteEntryButton');
        deleteEntryButton.addEventListener('click', deleteSelectedEntries);

        function updateDeleteButtonVisibility() {
            const selectedBoxes = document.querySelectorAll('.plan-box.selected');
            if (selectedBoxes.length > 0) {
                deleteEntryButton.style.display = 'inline-flex';
            } else {
                deleteEntryButton.style.display = 'none';
            }
        }

        function hideDeleteButton() {
            deleteEntryButton.style.display = 'none';
        }

        function displayEntryPopover(planBoxElement) {
            hideAllPopovers();
            const popover = document.createElement('div');
            popover.className = 'popover';
            const entryData = JSON.parse(planBoxElement.getAttribute('data-entry-details'));
            let contentHtml = '';
            const type = entryData.type;
            if (type === 'Event') {
                contentHtml = `
                    <p><span class="font-semibold">Event:</span> ${entryData.event}</p>
                    ${entryData.event === 'Admin Work' && entryData.adminWorkType ? `<p><span class="font-semibold">Type:</span> ${entryData.adminWorkType}</p>` : ''}
                    <p><span class="font-semibold">Time:</span> ${entryData.eventTime}</p>
                    <p><span class="font-semibold">Details:</span> ${entryData.details || 'N/A'}</p>
                `;
            } else if (type === 'Visit') {
                contentHtml = `
                    <p><span class="font-semibold">Visit Type:</span> ${entryData.visitType}</p>
                    <p><span class="font-semibold">Time:</span> ${entryData.visitTime}</p>
                    ${entryData.visitType === 'Double Visit' ? `<p><span class="font-semibold">MR:</span> ${entryData.medicalRep}</p><p><span class="font-semibold">Brick:</span> ${entryData.brick}</p>` : ''}
                    <p><span class="font-semibold">General Details:</span> ${entryData.details || 'N/A'}</p>
                `;
            } else if (type === 'Leave') {
                contentHtml = `
                    <p><span class="font-semibold">Leave Type:</span> ${entryData.leaveType}</p>
                    <p><span class="font-semibold">Time:</span> ${entryData.leaveTime}</p>
                    <p><span class="font-semibold">Details:</span> ${entryData.details || 'N/A'}</p>
                `;
            }
            popover.innerHTML = `
                ${contentHtml}
                <button type="button" class="btn btn-danger" onclick="deleteSingleEntry(event, '${planBoxElement.getAttribute('data-entry-id')}')">Delete</button>
            `;

            const planBoxRect = planBoxElement.getBoundingClientRect();
            
            popover.style.left = `${planBoxRect.right + 10}px`;
            popover.style.top = `${planBoxRect.top}px`;
            
            document.body.appendChild(popover);
            popover.style.display = 'block';
        }
        
        async function deleteSingleEntry(e, entryId) {
            e.stopPropagation();
            hideAllPopovers();
            const planBoxElement = document.querySelector(`[data-entry-id="${entryId}"]`);
            if (entryId && !entryId.startsWith('entry-')) {
                toggleLoading(true);
                try {
                    const { error } = await _supabase
                        .from('dms_weekly_plans')
                        .delete()
                        .eq('id', entryId);

                    if (error) {
                        throw error;
                    }
                    showMessageBox('Entry deleted successfully from database!', 'Success');
                    if (planBoxElement) {
                        planBoxElement.remove();
                    }
                } catch (error) {
                    console.error('Error deleting entry from Supabase:', error);
                    showMessageBox(`Failed to delete entry from database. Error: ${error.message}`, 'Error');
                } finally {
                    toggleLoading(false);
                }
            } else {
                if (planBoxElement) {
                    planBoxElement.remove();
                }
            }
            updateDeleteButtonVisibility();
        }

        function hideAllPopovers() {
            document.querySelectorAll('.popover').forEach(popover => popover.remove());
        }

        function startResize(event) {
            if (!event.target.classList.contains('resize-handle')) {
                return;
            }
            isResizing = true;
            currentResizingBox = event.target.closest('.plan-box');
            const clientY = event.touches ? event.touches[0].clientY : event.clientY;
            initialY = clientY;
            initialHeight = currentResizingBox.offsetHeight;
            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
            document.addEventListener('touchmove', doResize, { passive: false });
            document.addEventListener('touchend', stopResize);
        }

        function doResize(event) {
            if (!isResizing) return;
            event.preventDefault(); // Prevents touch scrolling
            const clientY = event.touches ? event.touches[0].clientY : event.clientY;
            const deltaY = clientY - initialY;
            
            let newHeight = initialHeight + deltaY;
            let newDurationHours = Math.max(1, Math.round(newHeight / cellHeight));
            let newEndHour = parseInt(currentResizingBox.dataset.startHour) + newDurationHours - 1;
            newEndHour = Math.min(newEndHour, endHour);
            newDurationHours = newEndHour - parseInt(currentResizingBox.dataset.startHour) + 1;
            currentResizingBox.style.height = `${newDurationHours * cellHeight + (newDurationHours - 1) * 1}px`;
            
            const entryData = JSON.parse(currentResizingBox.getAttribute('data-entry-details'));
            entryData.endHour = newEndHour;
            currentResizingBox.setAttribute('data-entry-details', JSON.stringify(entryData));
            
            const startTimeOption = currentResizingBox.dataset.startTimeOption;
            let updatedTimeDisplay = getTimeDisplay(entryData.startHour, entryData.endHour, startTimeOption, null);
            currentResizingBox.dataset.time = updatedTimeDisplay;
            
            // Update the display text inside the box immediately
            const pTags = currentResizingBox.querySelectorAll('p');
            // We only update the time if it's a simple 'Visit' or 'Event' that doesn't have other details
            if (pTags.length > 1 && (pTags[1].innerHTML.includes('Brick:') || pTags[1].innerHTML.includes('Type:'))) {
                 // Do not update the display of a sub-type
            } else if (pTags.length > 1) {
                 pTags[1].textContent = updatedTimeDisplay;
            }
        }

        async function stopResize() {
            if (!isResizing) return;
            isResizing = false;
            document.removeEventListener('mousemove', doResize);
            document.removeEventListener('mouseup', stopResize);
            document.removeEventListener('touchmove', doResize);
            document.removeEventListener('touchend', stopResize);

            if (currentResizingBox) {
                const entryData = JSON.parse(currentResizingBox.getAttribute('data-entry-details'));
                const entryId = currentResizingBox.getAttribute('data-entry-id');
                const newEndHour = entryData.endHour;

                if (entryId && !entryId.startsWith('entry-')) {
                    const loadingSpinner = document.createElement('div');
                    loadingSpinner.className = 'box-loading-spinner';
                    currentResizingBox.appendChild(loadingSpinner);
                    
                    await updateSupabaseEntry(entryId, newEndHour);
                    
                    loadingSpinner.remove();
                }
            }
            currentResizingBox = null;
        }

        async function updateSupabaseEntry(id, newEndHour) {
            try {
                let updateData = {
                    end_hour: newEndHour,
                    end_time_option: getTimeOption(JSON.parse(currentResizingBox.getAttribute('data-entry-details')).startHour, newEndHour)
                };

                const { error } = await _supabase
                    .from('dms_weekly_plans')
                    .update(updateData)
                    .eq('id', id);

                if (error) {
                    throw error;
                }
                showMessageBox('Entry updated successfully in database!', 'Success');
            } catch (error) {
                console.error('Error updating entry in Supabase:', error);
                showMessageBox(`Failed to update entry in database. Error: ${error.message}`, 'Error');
            }
        }

        function clearLongPressTimer() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        
        document.getElementById('plan-table-body').addEventListener('mousedown', (e) => {
            if (e.target.closest('.plan-box')) {
                clearLongPressTimer();
            }
        });
        
        document.getElementById('plan-table-body').addEventListener('touchstart', (e) => {
            const targetBox = e.target.closest('.plan-box');
            if (targetBox) {
                longPressTimer = setTimeout(() => {
                    multiSelectMode = true;
                    targetBox.classList.add('selected');
                    updateDeleteButtonVisibility();
                    hideAllPopovers();
                    navigator.vibrate(100); // Haptic feedback for touch devices
                }, 500); // 500ms for a long press
            }
        }, { passive: true });

        document.getElementById('plan-table-body').addEventListener('touchend', (e) => {
            clearLongPressTimer();
        });
        
        document.getElementById('plan-table-body').addEventListener('touchmove', (e) => {
            clearLongPressTimer();
        });

        document.getElementById('plan-table-body').addEventListener('click', (event) => {
            const targetBox = event.target.closest('.plan-box');
            
            // Handle multi-select with Ctrl/Cmd key on PC
            if (event.ctrlKey || event.metaKey || multiSelectMode) {
                if (targetBox) {
                    targetBox.classList.toggle('selected');
                    hideAllPopovers();
                    updateDeleteButtonVisibility();
                }
            } else { // Normal single click behavior
                hideAllPopovers();
                const selectedBoxes = document.querySelectorAll('.plan-box.selected');
                
                if (targetBox && !targetBox.classList.contains('selected')) {
                    selectedBoxes.forEach(box => box.classList.remove('selected'));
                    displayEntryPopover(targetBox);
                    updateDeleteButtonVisibility();
                } else if (targetBox && targetBox.classList.contains('selected')) {
                    targetBox.classList.remove('selected');
                    updateDeleteButtonVisibility();
                } else if (!targetBox && selectedBoxes.length > 0) {
                     selectedBoxes.forEach(box => box.classList.remove('selected'));
                     updateDeleteButtonVisibility();
                }
            }
        });
        
        // Hide popovers and deselect boxes on clicks outside the table and form.
        document.addEventListener('click', (event) => {
            const isClickInsideTable = event.target.closest('.scrollable-table-container');
            const isClickInsideForm = event.target.closest('.form-section');
            const isClickInsideNav = event.target.closest('.nav-controls');
            const isClickInsideButtonContainer = event.target.closest('.justify-end.gap-3');
            
            if (!isClickInsideTable && !isClickInsideForm && !isClickInsideNav && !isClickInsideButtonContainer) {
                hideAllPopovers();
                document.querySelectorAll('.plan-box.selected').forEach(box => box.classList.remove('selected'));
                updateDeleteButtonVisibility();
                multiSelectMode = false;
            }
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Control' || e.key === 'Meta') {
                multiSelectMode = true;
            }
        });
        
        document.addEventListener('keyup', (e) => {
            if (e.key === 'Control' || e.key === 'Meta') {
                multiSelectMode = false;
            }
        });

        // Hide popovers on scroll
        const scrollContainer = document.querySelector('.scrollable-table-container');
        if (scrollContainer) {
            scrollContainer.addEventListener('scroll', () => {
                hideAllPopovers();
            });
        }


        document.getElementById('districtManager').addEventListener('change', updateDatesAndDaySelector);
        document.getElementById('startDate').addEventListener('change', updateDatesAndDaySelector);

        function clearForm() {
            document.getElementById('districtManager').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('selectedDay').innerHTML = '<option value="">Select a Day</option>';
            document.getElementById('entryTypeSelect').value = '';
            handleEntryTypeChange();
            updateTableHeader('');
            populateTimeSlotTable('');
            document.querySelectorAll('.plan-box.selected').forEach(box => box.classList.remove('selected'));
            hideDeleteButton();
            hideAllPopovers();
            if (loggedInUser) {
                filterAndPopulateDMs(loggedInUser);
                setDefaultStartDate();
                updateDatesAndDaySelector();
            }
        }

        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'dmPlanningUserPermissions') {
                console.log('DM-Plan received user data:', event.data.user);
                initializeApp(event.data.user);
            }
        });

    </script>
</body>
</html>
