<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Plan Submission</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #212529;
            line-height: 1.4;
        }

        .container {
            max-width: 1200px;
            margin: 10px auto;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            color: #495057;
            font-size: 1.5rem;
            font-weight: 600;
        }

        /* Simplified form controls */
        input, select, textarea {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            background: #fff;
            transition: border-color 0.15s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #007bff;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            font-size: 13px;
            color: #495057;
        }

        /* Grid layout for form rows */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .full-width-form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        /* Button styles */
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .btn-primary {
            background: #007bff;
            color: #fff;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-danger {
            background: #dc3545;
            color: #fff;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        /* Form sections */
        .form-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .form-section h2 {
            font-size: 1.1rem;
            color: #495057;
            margin-bottom: 15px;
            font-weight: 600;
        }

        /* Entry type containers */
        .entry-container {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
        }

        .visit-container { border-left: 4px solid #28a745; }
        .event-container { border-left: 4px solid #007bff; }
        .leave-container { border-left: 4px solid #dc3545; }

        /* Table styles */
        .scrollable-table-container {
            position: relative;
            overflow-x: auto;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th, td {
            padding: 8px 10px;
            border-bottom: 1px solid #dee2e6;
            text-align: left;
            font-size: 13px;
        }
        
        /* Time column styling */
        .time-cell {
            background: #f8f9fa;
            font-weight: 500;
            position: sticky;
            left: 0;
            z-index: 30;
            min-width: 60px;
            width: auto;
            white-space: nowrap;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 31;
        }
        
        th:first-child {
            z-index: 32; /* Ensure top-left corner is on top */
        }

        .table-cell-hour {
            height: 35px;
            position: relative;
            vertical-align: top;
        }
        
        /* Plan entry boxes */
        .plan-box {
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 4px 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s;
            overflow: hidden;
            z-index: 20;
        }

        .plan-box:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }
        
        .plan-box.selected {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        .visit-box { background: #d4edda; border-color: #28a745; }
        .event-box { background: #d1ecf1; border-color: #007bff; }
        .leave-box { background: #f8d7da; border-color: #dc3545; }

        /* Resizing handle */
        .resize-handle {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 8px;
            cursor: ns-resize;
            background-color: rgba(0, 0, 0, 0.1);
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            z-index: 25;
            transition: background-color 0.2s;
        }
        .plan-box:hover .resize-handle {
            background-color: rgba(0, 0, 0, 0.2);
        }

        .plan-time {
            margin-top: 4px;
            font-size: 10px;
        }

        /* Loading overlay */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            flex-direction: column;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        
        .box-loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: absolute;
            right: 5px;
            top: 5px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Utility classes */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-end { justify-content: flex-end; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
        .mb-1 { margin-bottom: 4px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        .mt-3 { margin-top: 12px; }
        .p-2 { padding: 8px; }
        .font-semibold { font-weight: 600; }

        /* Navigation */
        .nav-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
        }

        /* Popover */
        .popover {
            position: fixed;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            font-size: 13px;
            max-width: 250px;
        }
        
        .modal-box {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .modal-content h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #007bff;
        }

        .modal-content p {
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .popover p {
            margin-bottom: 6px;
        }

        .popover p:last-child {
            margin-bottom: 0;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                margin: 5px;
                padding: 10px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            h1 {
                font-size: 1.3rem;
            }

            .btn {
                font-size: 12px;
                padding: 5px 10px;
            }
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading">
        <div class="spinner"></div>
        <p>Loading data...</p>
    </div>
    <div class="container">
        <div class="header-controls">
            <h1>Weekly Plan</h1>
            <button type="button" class="btn btn-primary" id="editPlanBtn">Edit Plan</button>
        </div>
        <div class="form-row">
            <div class="flex-col">
                <label for="districtManager">District Manager:</label>
                <select id="districtManager">
                    <option value="">Select District Manager</option>
                </select>
            </div>
            <div class="flex-col">
                <label for="startDate">Week Start Date (Saturday):</label>
                <input type="date" id="startDate">
            </div>
            <div class="flex-col">
                <label for="endDate">Week End Date (Friday):</label>
                <input type="date" id="endDate" readonly>
            </div>
        </div>

        <div id="form-section-container" class="form-section hidden">
            <h2>Add Daily Plan Entry</h2>
            <div class="form-row">
                <div class="flex-col">
                    <label for="selectedDay">Select Day:</label>
                    <select id="selectedDay">
                        <option value="">Select a Day</option>
                    </select>
                </div>
                <div class="flex-col">
                    <label for="entryTypeSelect">Entry Type:</label>
                    <select id="entryTypeSelect" onchange="handleEntryTypeChange()">
                        <option value="">Select Type</option>
                        <option value="Visit">Visit</option>
                        <option value="Event">Event</option>
                        <option value="Leave">Leave</option>
                    </select>
                </div>
            </div>
            <div id="visitInputsContainer" class="hidden entry-container visit-container">
                <div class="form-row">
                    <div class="flex-col">
                        <label for="visitTypeSelect">Visit Type:</label>
                        <select id="visitTypeSelect" onchange="handleVisitTypeChange()">
                            <option value="">Select Visit Type</option>
                            <option value="Single Visit">Single Visit</option>
                            <option value="Double Visit">Double Visit</option>
                        </select>
                    </div>
                    <div class="flex-col">
                        <label for="visitTimeChoice">Time Option:</label>
                        <select id="visitTimeChoice" onchange="handleVisitTimeChoiceChange()">
                            <option value="">Select Time Option</option>
                            <option value="Pick a Time">Pick a Time</option>
                            <option value="AM">AM</option>
                            <option value="PM">PM</option>
                            <option value="Full Day">Full Day</option>
                        </select>
                    </div>
                    <div id="visitTimeInputContainer" class="flex-col hidden">
                        <label for="visitTimeInput">Specific Time:</label>
                        <input type="time" id="visitTimeInput">
                    </div>
                </div>
                <div id="mrBrickContainer" class="form-row hidden">
                    <div class="flex-col">
                        <label for="medicalRepSelect">Medical Rep:</label>
                        <select id="medicalRepSelect" onchange="handleMedicalRepChange()">
                            <option value="">Select MR</option>
                        </select>
                    </div>
                    <div class="flex-col">
                        <label for="brickSelect">Brick:</label>
                        <select id="brickSelect">
                            <option value="">Select Brick</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="flex-col col-span-full">
                        <label for="visitDetails">Visit Details:</label>
                        <textarea id="visitDetails" rows="2" placeholder="Add specific details about the visit..."></textarea>
                    </div>
                </div>
            </div>
            <div id="eventInputsContainer" class="hidden entry-container event-container">
                <div class="form-row">
                    <div class="flex-col">
                        <label for="eventSelect">Event Type:</label>
                        <select id="eventSelect" onchange="handleEventChange()">
                            <option value="">Select Event</option>
                            <option value="Meeting">Meeting</option>
                            <option value="Training">Training</option>
                            <option value="Event">Event</option>
                            <option value="Admin Work">Admin Work</option>
                        </select>
                    </div>
                    <div id="adminWorkTypeContainer" class="flex-col hidden">
                        <label for="adminWorkTypeSelect">Admin Work Type:</label>
                        <select id="adminWorkTypeSelect">
                            <option value="">Select Type</option>
                            <option value="Office">Office</option>
                            <option value="Online">Online</option>
                        </select>
                    </div>
                    <div class="flex-col">
                        <label for="eventTimeChoice">Time Option:</label>
                        <select id="eventTimeChoice" onchange="handleEventTimeChoiceChange()">
                            <option value="">Select Time Option</option>
                            <option value="Pick a Time">Pick a Time</option>
                            <option value="AM">AM</option>
                            <option value="PM">PM</option>
                            <option value="Full Day">Full Day</option>
                        </select>
                    </div>
                    <div id="eventTimeInputContainer" class="flex-col hidden">
                        <label for="eventTimeInput">Specific Time:</label>
                        <input type="time" id="eventTimeInput">
                    </div>
                </div>
                <div class="form-row">
                    <div class="flex-col col-span-full">
                        <label for="eventDetails">Event Details:</label>
                        <textarea id="eventDetails" rows="2" placeholder="Add specific details about the event..."></textarea>
                    </div>
                </div>
            </div>
            <div id="leavesInputsContainer" class="hidden entry-container leave-container">
                <div class="form-row">
                    <div class="flex-col">
                        <label for="leaveSelect">Leave Type:</label>
                        <select id="leaveSelect" onchange="handleLeaveChange()">
                            <option value="">Select Leave Type</option>
                            <option value="Annual Leave">Annual Leave</option>
                            <option value="Official Leave">Official Leave</option>
                            <option value="Sick Leave">Sick Leave</option>
                        </select>
                    </div>
                    <div class="flex-col">
                        <label for="leaveTimeChoice">Time Option:</label>
                        <select id="leaveTimeChoice" onchange="handleLeaveTimeChoiceChange()">
                            <option value="">Select Time Option</option>
                            <option value="Pick a Time">Pick a Time</option>
                            <option value="AM">AM</option>
                            <option value="PM">PM</option>
                            <option value="Full Day">Full Day</option>
                        </select>
                    </div>
                    <div id="leaveTimeInputContainer" class="flex-col hidden">
                        <label for="leaveTimeInput">Specific Time:</label>
                        <input type="time" id="leaveTimeInput">
                    </div>
                </div>
                <div class="form-row">
                    <div class="flex-col col-span-full">
                        <label for="leaveDetails">Leave Details:</label>
                        <textarea id="leaveDetails" rows="2" placeholder="Add specific details about the leave..."></textarea>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-3">
                <button type="button" class="btn btn-primary" onclick="addPlanEntry()">Add Entry to Plan</button>
                <button type="button" class="btn btn-danger" id="deleteEntryButton" style="display:none;">Delete Selected Entries</button>
            </div>
        </div>

        <div class="nav-controls">
            <button id="prevWeekBtn" class="btn btn-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                <span class="hidden sm:inline">Previous Week</span>
            </button>
            <button id="nextWeekBtn" class="btn btn-secondary">
                <span class="hidden sm:inline">Next Week</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>

        <div class="scrollable-table-container">
            <table>
                <thead>
                    <tr id="table-header-row">
                        <th class="time-cell">Time</th>
                    </tr>
                </thead>
                <tbody id="plan-table-body">
                </tbody>
            </table>
        </div>
        <div class="flex justify-end gap-3 mt-3">
            <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
            <button type="submit" class="btn btn-primary" onclick="submitPlan()">Submit Plan</button>
        </div>
    </div>
    <div id="global-popover-container" class="popover-container"></div>
    <script>
        // --- STATE MANAGEMENT ---
        let allData = [];
        let districtManagers = [];
        let loggedInUser = null;
        let multiSelectMode = false;
        let longPressTimer;
        let isResizing = false;
        let currentResizingBox = null;
        let initialY = 0;
        let initialHeight = 0;
        let cellHeight = 35; // Default cell height
        let isAppInitialized = false;

        // --- CONSTANTS ---
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRcnOTUUiyczqtn1s8zhVfYGARkjx-xfT621A9AX7jw3TxmvnBbdc-BZ_EjuOk1uahqY7s5FcdFvQKm/pub?output=csv';
        const daysOfWeek = ['Saturday', 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
        const startHour = 9;
        const endHour = 23;

        // --- SUPABASE CLIENT ---
        const supabaseUrl = 'https://plmevfyxpngzymvzvkzn.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBsbWV2Znl4cG5nenltdnp2a3puIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NjM5NDEsImV4cCI6MjA2NjMzOTk0MX0.lUm3efHFCL3aAB-PL7H54BpnvcpbXxp1BeUzw0yjp5c';
        const _supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);

        // --- UI HELPER FUNCTIONS ---
        function toggleLoading(show) {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        }

        function showMessageBox(message, title = 'Notification') {
            const modalBox = document.createElement('div');
            modalBox.className = 'modal-box';
            modalBox.innerHTML = `
                <div class="modal-content">
                    <h3>${title}</h3>
                    <p>${message}</p>
                    <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-box').remove()">Close</button>
                </div>
            `;
            document.body.appendChild(modalBox);
        }

        // --- DATA FETCHING & PARSING ---
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const nonEmptyLines = lines.filter(line => line.trim() !== '');
            if (nonEmptyLines.length === 0) return [];
            const headers = nonEmptyLines[0].split(',').map(header => header.trim());
            const data = [];
            for (let i = 1; i < nonEmptyLines.length; i++) {
                const currentLine = nonEmptyLines[i].split(',');
                if (currentLine.length === headers.length) {
                    const row = {};
                    for (let j = 0; j < headers.length; j++) {
                        row[headers[j]] = currentLine[j].trim();
                    }
                    data.push(row);
                }
            }
            return data;
        }

        async function fetchData() {
            toggleLoading(true);
            try {
                const maxRetries = 5;
                let retries = 0;
                let delay = 1000;
                while (retries < maxRetries) {
                    try {
                        const response = await fetch(CSV_URL, { mode: 'cors' });
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const csvText = await response.text();
                        allData = parseCSV(csvText);
                        const managerSet = new Set();
                        allData.forEach(row => {
                            if (row['District Manager']) {
                                managerSet.add(row['District Manager']);
                            }
                        });
                        districtManagers = Array.from(managerSet).sort();
                        return; // Success, exit the function
                    } catch (error) {
                        console.error(`Error fetching or parsing data (attempt ${retries + 1}):`, error);
                        retries++;
                        if (retries >= maxRetries) {
                             showMessageBox(`Failed to load data after multiple attempts. Please check your connection and refresh.`, 'Error');
                        } else {
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2;
                        }
                    }
                }
            } finally {
                toggleLoading(false); // This will always run
            }
        }

        // --- INITIALIZATION ---
        async function initializeApp(user) {
            loggedInUser = user;
            await fetchData();
            filterAndPopulateDMs(user);
            setDefaultStartDate();
            updateDatesAndDaySelector();
            handleEntryTypeChange();
        }
        
        function handleInitialization(user) {
            if (isAppInitialized) return;
            isAppInitialized = true;
            initializeApp(user);
        }

        function filterAndPopulateDMs(user) {
            const select = document.getElementById('districtManager');
            select.innerHTML = '<option value="">Select District Manager</option>';
            select.disabled = false;

            if (user && user.title === 'admin') {
                districtManagers.forEach(manager => {
                    const option = document.createElement('option');
                    option.value = manager;
                    option.textContent = manager;
                    select.appendChild(option);
                });
            } else if (user && user.title === 'District Manager') {
                const option = document.createElement('option');
                option.value = user.username;
                option.textContent = user.username;
                select.appendChild(option);
                select.value = user.username;
                select.disabled = true;
            } else {
                 districtManagers.forEach(manager => {
                    const option = document.createElement('option');
                    option.value = manager;
                    option.textContent = manager;
                    select.appendChild(option);
                });
            }
        }

        // --- DATE & TIME LOGIC ---
        function calculateEndDate(startDateStr) {
            if (!startDateStr) return '';
            const startDate = new Date(startDateStr);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            return endDate.toISOString().split('T')[0];
        }
        
        function setDefaultStartDate() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday, 6 = Saturday
            let daysSinceSaturday = (dayOfWeek + 1) % 7;
            
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - daysSinceSaturday);

            if (dayOfWeek === 5) { // If today is Friday, go to the next week's Saturday
                startOfWeek.setDate(startOfWeek.getDate() + 7);
            }

            document.getElementById('startDate').value = startOfWeek.toISOString().split('T')[0];
        }

        function updateDatesAndDaySelector() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const selectedStartDate = startDateInput.value;
            endDateInput.value = calculateEndDate(selectedStartDate);
            populateDaySelector(selectedStartDate);
            updateTableHeader(selectedStartDate);
            populateTimeSlotTable(selectedStartDate);
            fetchExistingPlanData(selectedStartDate);
        }

        function formatHourForDisplay(hour) {
            if (hour === 12) return '12 PM';
            if (hour > 12) return `${hour - 12} PM`;
            return `${hour} AM`;
        }
        
        function getTimeDisplay(startHour, endHour, startTimeOption) {
            if (startTimeOption === 'Full Day') return 'Full Day';
            if (startTimeOption === 'AM') return `AM (9 AM - 2 PM)`;
            if (startTimeOption === 'PM') return `PM (2 PM - 11 PM)`;
            
            // For specific times, show the range. End hour is inclusive.
            return `${formatHourForDisplay(startHour)} - ${formatHourForDisplay(endHour + 1)}`;
        }

        // --- PLAN DATA MANAGEMENT (SUPABASE) ---
        async function fetchExistingPlanData(startDate) {
            const districtManager = document.getElementById('districtManager').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate || !districtManager) {
                console.log('Missing required filters to fetch plan data.');
                clearPlanTableBody(); // Clear table if filters are incomplete
                return;
            }

            toggleLoading(true);
            try {
                const { data: entries, error } = await _supabase
                    .from('dms_weekly_plans')
                    .select('*')
                    .eq('district_manager_name', districtManager)
                    .gte('start_date', startDate)
                    .lte('end_date', endDate);

                if (error) throw error;
                populatePlanTable(entries || []);
            } catch (error) {
                console.error('Error fetching plan data:', error);
                showMessageBox(`Failed to load plan data. Error: ${error.message}`, 'Error');
            } finally {
                toggleLoading(false);
            }
        }

        async function submitPlan() {
            // This function will handle submitting NEW entries. Updates are handled separately.
            const planData = {
                districtManager: document.getElementById('districtManager').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                weeklyEntries: []
            };

            if (!planData.districtManager || !planData.startDate) {
                showMessageBox('Please fill in the District Manager and Week Start Date before submitting.');
                return;
            }
            
            // Collect only new, unsaved entries (those with temporary IDs)
            const allPlanBoxes = document.querySelectorAll('.plan-box');
            allPlanBoxes.forEach(planBox => {
                const entryId = planBox.getAttribute('data-entry-id');
                if (entryId && entryId.startsWith('entry-')) {
                     const entry = JSON.parse(planBox.getAttribute('data-entry-details'));
                     planData.weeklyEntries.push(entry);
                }
            });

            if (planData.weeklyEntries.length === 0) {
                showMessageBox('No new entries to submit. Use the form to add entries first.');
                return;
            }

            toggleLoading(true);
            try {
                const entriesToInsert = planData.weeklyEntries.map(entry => ({
                    district_manager_name: planData.districtManager,
                    start_date: planData.startDate,
                    end_date: planData.endDate,
                    entry_day: entry.day,
                    entry_type: entry.type,
                    start_hour: entry.startHour,
                    end_hour: entry.endHour,
                    start_time_option: entry.startTimeOption,
                    visit_type: entry.visitType,
                    medical_rep_name: entry.medicalRep,
                    brick: entry.brick,
                    event_type: entry.event,
                    leave_type: entry.leaveType,
                    details: entry.details
                }));

                const { error } = await _supabase.from('dms_weekly_plans').insert(entriesToInsert);
                if (error) throw error;

                showMessageBox('Plan submitted successfully!', 'Success');
                
                // Hide form and reset button after successful submission
                document.getElementById('form-section-container').classList.add('hidden');
                document.getElementById('editPlanBtn').textContent = 'Edit Plan';

                await fetchExistingPlanData(planData.startDate); // Refresh to get new IDs
            } catch (error) {
                console.error('Error submitting plan:', error);
                showMessageBox(`Failed to submit plan. Error: ${error.message}`, 'Error');
            } finally {
                toggleLoading(false);
            }
        }
        
        async function updateSupabaseEntry(id, updateData) {
            try {
                const { error } = await _supabase
                    .from('dms_weekly_plans')
                    .update(updateData)
                    .eq('id', id);
                if (error) throw error;
                console.log('Entry updated successfully:', id);
            } catch (error) {
                console.error('Error updating entry in Supabase:', error);
                showMessageBox(`Failed to update entry. Error: ${error.message}`, 'Error');
            }
        }

        async function deleteSelectedEntries() {
            const selectedBoxes = document.querySelectorAll('.plan-box.selected');
            if (selectedBoxes.length === 0) {
                showMessageBox('No entries selected for deletion.');
                return;
            }

            const idsToDelete = [];
            selectedBoxes.forEach(box => {
                const entryId = box.getAttribute('data-entry-id');
                if (entryId && !entryId.startsWith('entry-')) {
                    idsToDelete.push(entryId);
                }
                box.remove(); // Remove from DOM immediately
            });

            if (idsToDelete.length > 0) {
                toggleLoading(true);
                try {
                    const { error } = await _supabase.from('dms_weekly_plans').delete().in('id', idsToDelete);
                    if (error) throw error;
                    showMessageBox('Selected entries deleted successfully!', 'Success');
                } catch (error) {
                    console.error('Error deleting entries from Supabase:', error);
                    showMessageBox(`Failed to delete entries. Error: ${error.message}`, 'Error');
                    // If deletion fails, refresh data to restore the boxes
                    await fetchExistingPlanData(document.getElementById('startDate').value);
                } finally {
                    toggleLoading(false);
                }
            }
            updateDeleteButtonVisibility();
            hideAllPopovers();
        }
        
        async function deleteSingleEntry(e, entryId) {
            e.stopPropagation();
            hideAllPopovers();
            const planBoxElement = document.querySelector(`[data-entry-id="${entryId}"]`);
            if (!planBoxElement) return;

            if (entryId && !entryId.startsWith('entry-')) {
                toggleLoading(true);
                try {
                    const { error } = await _supabase.from('dms_weekly_plans').delete().eq('id', entryId);
                    if (error) throw error;
                    showMessageBox('Entry deleted successfully!', 'Success');
                    planBoxElement.remove();
                } catch (error) {
                    console.error('Error deleting entry from Supabase:', error);
                    showMessageBox(`Failed to delete entry. Error: ${error.message}`, 'Error');
                } finally {
                    toggleLoading(false);
                }
            } else {
                planBoxElement.remove(); // It's a temporary entry, just remove from DOM
            }
            updateDeleteButtonVisibility();
        }

        // --- TABLE & UI RENDERING ---
        function populateDaySelector(startDateStr) {
            const daySelect = document.getElementById('selectedDay');
            daySelect.innerHTML = '<option value="">Select a Day</option>';
            if (startDateStr) {
                const startDate = new Date(startDateStr);
                daysOfWeek.forEach((dayName, index) => {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + index);
                    const dateString = currentDate.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
                    const option = document.createElement('option');
                    option.value = `${dayName}|${currentDate.toISOString().split('T')[0]}|${index}`;
                    option.textContent = `${dayName} (${dateString})`;
                    daySelect.appendChild(option);
                });
            }
        }

        function updateTableHeader(startDateStr) {
            const tableHeaderRow = document.getElementById('table-header-row');
            tableHeaderRow.innerHTML = '<th class="time-cell">Time</th>';
            if (startDateStr) {
                const startDate = new Date(startDateStr);
                daysOfWeek.forEach((dayName, index) => {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + index);
                    const dateString = currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const th = document.createElement('th');
                    th.innerHTML = `<div><span>${dayName}</span><br><span class="text-xs font-normal text-gray-500" style="font-weight:400;">${dateString}</span></div>`;
                    tableHeaderRow.appendChild(th);
                });
            }
        }

        function populateTimeSlotTable(startDateStr) {
            const planTableBody = document.getElementById('plan-table-body');
            planTableBody.innerHTML = ''; // Clear existing rows
            if (!startDateStr) {
                planTableBody.innerHTML = `<tr><td colspan="${daysOfWeek.length + 1}" class="text-center p-4">Please select a start date to view the plan.</td></tr>`;
                return;
            }
            for (let hour = startHour; hour <= endHour; hour++) {
                const tr = document.createElement('tr');
                const timeLabelTd = document.createElement('td');
                timeLabelTd.classList.add('time-cell');
                timeLabelTd.textContent = formatHourForDisplay(hour);
                tr.appendChild(timeLabelTd);
                for (let dayIndex = 0; dayIndex < daysOfWeek.length; dayIndex++) {
                    const td = document.createElement('td');
                    td.id = `day-${dayIndex}-hour-${hour}`;
                    td.classList.add('table-cell-hour');
                    tr.appendChild(td);
                }
                planTableBody.appendChild(tr);
            }
            // Ensure cellHeight is updated after table is rendered
            const firstCell = planTableBody.querySelector('.table-cell-hour');
            if (firstCell) {
                cellHeight = firstCell.offsetHeight;
            }
        }
        
        function clearPlanTableBody() {
             populateTimeSlotTable(document.getElementById('startDate').value);
        }

        function populatePlanTable(entries) {
            clearPlanTableBody(); // Start with a fresh grid
            if (!entries || entries.length === 0) {
                console.log('No entries to populate.');
                return;
            }

            entries.forEach(entry => {
                const dayIndex = daysOfWeek.indexOf(entry.entry_day);
                if (dayIndex === -1) return;

                const entryData = {
                    id: entry.id,
                    day: entry.entry_day,
                    type: entry.entry_type,
                    details: entry.details || '',
                    startHour: entry.start_hour,
                    endHour: entry.end_hour,
                    startTimeOption: entry.start_time_option,
                    visitType: entry.visit_type,
                    medicalRep: entry.medical_rep_name,
                    brick: entry.brick,
                    event: entry.event_type,
                    leaveType: entry.leave_type
                };

                const targetCell = document.getElementById(`day-${dayIndex}-hour-${entry.start_hour}`);
                if (!targetCell) return;
                
                const planBoxElement = createPlanBoxElement(entryData);
                targetCell.appendChild(planBoxElement);
            });
        }
        
        function createPlanBoxElement(entryData) {
            const { type, startHour, endHour, startTimeOption } = entryData;
            const isFullDay = startTimeOption === 'Full Day';
            const durationHours = endHour - startHour + 1;
            
            let boxClass = '';
            let contentHtml = '';

            if (type === 'Event') {
                boxClass = 'event-box';
                contentHtml = `<p>${entryData.event}</p>`;
                if (entryData.event === 'Admin Work' && entryData.details) {
                    const adminType = entryData.details.split(' - ')[0];
                    if (['Office', 'Online'].includes(adminType)) {
                         contentHtml += `<p><span class="font-semibold">Type:</span> ${adminType}</p>`;
                    }
                }
            } else if (type === 'Visit') {
                boxClass = 'visit-box';
                contentHtml = `<p>${entryData.visitType}</p>`;
                if (entryData.visitType === 'Double Visit') {
                    contentHtml += `<p><span class="font-semibold">Brick:</span> ${entryData.brick || ''}</p>`;
                }
            } else if (type === 'Leave') {
                boxClass = 'leave-box';
                contentHtml = `<p>${entryData.leaveType}</p>`;
            }

            if (!isFullDay) {
                contentHtml += `<p class="plan-time">${getTimeDisplay(startHour, endHour, startTimeOption)}</p><div class="resize-handle"></div>`;
            }
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = `<div class="plan-box ${boxClass}"></div>`;
            const planBoxElement = tempDiv.firstChild;
            
            planBoxElement.innerHTML = contentHtml;
            planBoxElement.style.height = `${cellHeight * durationHours + (durationHours - 1)}px`;
            planBoxElement.setAttribute('data-entry-id', entryData.id || `entry-${Date.now()}`);
            planBoxElement.setAttribute('data-entry-details', JSON.stringify(entryData));

            if (!isFullDay) {
                const resizeHandle = planBoxElement.querySelector('.resize-handle');
                if (resizeHandle) {
                    resizeHandle.addEventListener('mousedown', startResize);
                    resizeHandle.addEventListener('touchstart', startResize, { passive: false });
                }
            }

            return planBoxElement;
        }

        // --- FORM HANDLING ---
        function handleEntryTypeChange() {
            const entryType = document.getElementById('entryTypeSelect').value;
            document.getElementById('visitInputsContainer').classList.toggle('hidden', entryType !== 'Visit');
            document.getElementById('eventInputsContainer').classList.toggle('hidden', entryType !== 'Event');
            document.getElementById('leavesInputsContainer').classList.toggle('hidden', entryType !== 'Leave');
        }

        function handleVisitTypeChange() {
            const visitType = document.getElementById('visitTypeSelect').value;
            const mrBrickContainer = document.getElementById('mrBrickContainer');
            mrBrickContainer.classList.toggle('hidden', visitType !== 'Double Visit');
            if (visitType === 'Double Visit') {
                populateMedicalReps();
            }
        }
        
        function handleEventChange() {
            const eventType = document.getElementById('eventSelect').value;
            document.getElementById('adminWorkTypeContainer').classList.toggle('hidden', eventType !== 'Admin Work');
        }

        function handleTimeChoiceChange(type) {
            const timeChoice = document.getElementById(`${type}TimeChoice`).value;
            const timeInputContainer = document.getElementById(`${type}TimeInputContainer`);
            timeInputContainer.classList.toggle('hidden', timeChoice !== 'Pick a Time');
        }
        
        function handleVisitTimeChoiceChange() { handleTimeChoiceChange('visit'); }
        function handleEventTimeChoiceChange() { handleTimeChoiceChange('event'); }
        function handleLeaveTimeChoiceChange() { handleTimeChoiceChange('leave'); }
        function handleLeaveChange() { /* Future logic if needed */ }

        function populateMedicalReps() {
            const selectedDM = document.getElementById('districtManager').value;
            const medicalRepSelect = document.getElementById('medicalRepSelect');
            medicalRepSelect.innerHTML = '<option value="">Select MR</option>';
            if (selectedDM) {
                const mrsForDM = [...new Set(allData.filter(row => row['District Manager'] === selectedDM && row['medical rep']).map(row => row['medical rep']))].sort();
                mrsForDM.forEach(mr => {
                    medicalRepSelect.add(new Option(mr, mr));
                });
            }
        }

        function handleMedicalRepChange() {
            const selectedMR = document.getElementById('medicalRepSelect').value;
            const brickSelect = document.getElementById('brickSelect');
            brickSelect.innerHTML = '<option value="">Select Brick</option>';
            if (selectedMR) {
                const bricksForMR = [...new Set(allData.filter(row => row['medical rep'] === selectedMR && row['Brick']).map(row => row['Brick']))].sort();
                bricksForMR.forEach(brick => {
                    brickSelect.add(new Option(brick, brick));
                });
            }
        }
        
        function clearForm() {
            document.getElementById('districtManager').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('selectedDay').innerHTML = '<option value="">Select a Day</option>';
            document.getElementById('entryTypeSelect').value = '';
            handleEntryTypeChange(); // This will reset all sub-forms
            updateTableHeader('');
            populateTimeSlotTable('');
            document.querySelectorAll('.plan-box.selected').forEach(box => box.classList.remove('selected'));
            hideDeleteButton();
            hideAllPopovers();
            if (loggedInUser) {
                filterAndPopulateDMs(loggedInUser);
                setDefaultStartDate();
                updateDatesAndDaySelector();
            }
        }

        // --- DYNAMIC ENTRY ADDITION & OVERLAP LOGIC ---
        function addPlanEntry() {
            const selectedDayValue = document.getElementById('selectedDay').value;
            const entryType = document.getElementById('entryTypeSelect').value;
            if (!document.getElementById('districtManager').value || !document.getElementById('startDate').value || !selectedDayValue || !entryType) {
                showMessageBox('Please ensure District Manager, Start Date, Day, and Entry Type are all selected.');
                return;
            }

            const [dayName, dateString, dayIndexStr] = selectedDayValue.split('|');
            const dayIndex = parseInt(dayIndexStr);
            
            let entryData = { day: dayName, date: dateString, type: entryType };
            let timeChoice, timeInput;
            let start, end, timeOption;

            // 1. Collect data from the correct form section
            if (entryType === 'Visit') {
                entryData.visitType = document.getElementById('visitTypeSelect').value;
                if (!entryData.visitType) { showMessageBox('Please select a Visit Type.'); return; }
                if (entryData.visitType === 'Double Visit') {
                    entryData.medicalRep = document.getElementById('medicalRepSelect').value;
                    entryData.brick = document.getElementById('brickSelect').value;
                    if (!entryData.medicalRep || !entryData.brick) { showMessageBox('Please select a Medical Rep and Brick for Double Visits.'); return; }
                }
                entryData.details = document.getElementById('visitDetails').value;
                timeOption = document.getElementById('visitTimeChoice').value;
                timeInput = document.getElementById('visitTimeInput').value;
            } else if (entryType === 'Event') {
                entryData.event = document.getElementById('eventSelect').value;
                if (!entryData.event) { showMessageBox('Please select an Event Type.'); return; }
                if (entryData.event === 'Admin Work') {
                    const adminType = document.getElementById('adminWorkTypeSelect').value;
                    if (!adminType) { showMessageBox('Please select an Admin Work Type.'); return; }
                    entryData.details = `${adminType} - ${document.getElementById('eventDetails').value}`;
                } else {
                    entryData.details = document.getElementById('eventDetails').value;
                }
                timeOption = document.getElementById('eventTimeChoice').value;
                timeInput = document.getElementById('eventTimeInput').value;
            } else if (entryType === 'Leave') {
                entryData.leaveType = document.getElementById('leaveSelect').value;
                if (!entryData.leaveType) { showMessageBox('Please select a Leave Type.'); return; }
                entryData.details = document.getElementById('leaveDetails').value;
                timeOption = document.getElementById('leaveTimeChoice').value;
                timeInput = document.getElementById('leaveTimeInput').value;
            }
            
            if (!timeOption) { showMessageBox('Please select a Time Option.'); return; }
            entryData.startTimeOption = timeOption;

            // 2. Determine start/end hours
            if (timeOption === 'Pick a Time') {
                if (!timeInput) { showMessageBox('Please pick a specific time.'); return; }
                start = parseInt(timeInput.split(':')[0]);
                end = start; // A new entry is 1 hour long by default
            } else if (timeOption === 'AM') { start = 9; end = 13; }
            else if (timeOption === 'PM') { start = 14; end = 23; }
            else if (timeOption === 'Full Day') { start = startHour; end = endHour; }

            entryData.startHour = start;
            entryData.endHour = end;
            
            // 3. Handle Full Day entries separately
            if (timeOption === 'Full Day') {
                // Remove all other entries for that day
                for (let hour = startHour; hour <= endHour; hour++) {
                    const cell = document.getElementById(`day-${dayIndex}-hour-${hour}`);
                    if (cell) cell.innerHTML = '';
                }
                const targetCell = document.getElementById(`day-${dayIndex}-hour-${startHour}`);
                targetCell.appendChild(createPlanBoxElement(entryData));
                return; // Done
            }

            // 4. Overlap detection for non-Full Day entries
            const existingEntriesOnDay = [];
            const seenEntryIds = new Set();
            for (let hour = startHour; hour <= endHour; hour++) {
                const cell = document.getElementById(`day-${dayIndex}-hour-${hour}`);
                if (cell) {
                    cell.querySelectorAll('.plan-box').forEach(box => {
                        const entryId = box.getAttribute('data-entry-id');
                        if (!seenEntryIds.has(entryId)) {
                            existingEntriesOnDay.push(JSON.parse(box.getAttribute('data-entry-details')));
                            seenEntryIds.add(entryId);
                        }
                    });
                }
            }
            
            // If an existing entry is Full Day, we can't add another one
            if (existingEntriesOnDay.some(e => e.startTimeOption === 'Full Day')) {
                showMessageBox('Cannot add an entry on a day that is already marked as Full Day.');
                return;
            }

            let proposedStart = entryData.startHour;
            const duration = entryData.endHour - entryData.startHour + 1;
            
            let isOverlapping = true;
            while(isOverlapping) {
                isOverlapping = false;
                let proposedEnd = proposedStart + duration - 1;
                for (const existing of existingEntriesOnDay) {
                    // Standard overlap check: (StartA <= EndB) and (EndA >= StartB)
                    if (proposedStart <= existing.endHour && proposedEnd >= existing.startHour) {
                        isOverlapping = true;
                        proposedStart = existing.endHour + 1; // Try to place it right after the conflicting block
                        break;
                    }
                }
            }
            
            // 5. Check if the non-overlapping slot is valid
            const effectiveRangeEnd = (timeOption === 'AM') ? 13 : (timeOption === 'PM') ? 23 : endHour;
            if (proposedStart + duration - 1 > effectiveRangeEnd) {
                showMessageBox('Could not find an available time slot for this entry. Please adjust existing entries or choose a different time.');
                return;
            }
            
            entryData.startHour = proposedStart;
            entryData.endHour = proposedStart + duration - 1;

            // 6. Add the new entry to the DOM
            const targetCell = document.getElementById(`day-${dayIndex}-hour-${entryData.startHour}`);
            if (targetCell) {
                targetCell.appendChild(createPlanBoxElement(entryData));
            }
        }

        // --- RESIZING LOGIC ---
        function startResize(event) {
            event.stopPropagation(); // Prevent click event from firing
            isResizing = true;
            currentResizingBox = event.target.closest('.plan-box');
            const clientY = event.touches ? event.touches[0].clientY : event.clientY;
            initialY = clientY;
            initialHeight = currentResizingBox.offsetHeight;
            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
            document.addEventListener('touchmove', doResize, { passive: false });
            document.addEventListener('touchend', stopResize);
            hideAllPopovers();
        }

        function doResize(event) {
            if (!isResizing) return;
            event.preventDefault();
            const clientY = event.touches ? event.touches[0].clientY : event.clientY;
            const deltaY = clientY - initialY;
            
            let newHeight = initialHeight + deltaY;
            let newDurationHours = Math.max(1, Math.round(newHeight / cellHeight));
            
            const entryData = JSON.parse(currentResizingBox.getAttribute('data-entry-details'));
            const newEndHour = Math.min(entryData.startHour + newDurationHours - 1, endHour);
            const finalDuration = newEndHour - entryData.startHour + 1;

            currentResizingBox.style.height = `${finalDuration * cellHeight + (finalDuration - 1)}px`;
            
            const planTimeElement = currentResizingBox.querySelector('.plan-time');
            if(planTimeElement) {
                planTimeElement.textContent = getTimeDisplay(entryData.startHour, newEndHour, entryData.startTimeOption);
            }
        }

        async function stopResize() {
            if (!isResizing) return;
            isResizing = false;
            document.removeEventListener('mousemove', doResize);
            document.removeEventListener('mouseup', stopResize);
            document.removeEventListener('touchmove', doResize);
            document.removeEventListener('touchend', stopResize);

            if (currentResizingBox) {
                const entryData = JSON.parse(currentResizingBox.getAttribute('data-entry-details'));
                const newDurationHours = Math.max(1, Math.round(currentResizingBox.offsetHeight / cellHeight));
                const newEndHour = Math.min(entryData.startHour + newDurationHours - 1, endHour);

                // Update the data attribute for persistence
                entryData.endHour = newEndHour;
                currentResizingBox.setAttribute('data-entry-details', JSON.stringify(entryData));

                const entryId = currentResizingBox.getAttribute('data-entry-id');
                if (entryId && !entryId.startsWith('entry-')) {
                    const loadingSpinner = document.createElement('div');
                    loadingSpinner.className = 'box-loading-spinner';
                    currentResizingBox.appendChild(loadingSpinner);
                    await updateSupabaseEntry(entryId, { end_hour: newEndHour });
                    loadingSpinner.remove();
                }
            }
            currentResizingBox = null;
        }
        
        // --- EVENT LISTENERS & POPOVERS ---
        function displayEntryPopover(planBoxElement) {
            hideAllPopovers();
            const popover = document.createElement('div');
            popover.className = 'popover';
            const entryData = JSON.parse(planBoxElement.getAttribute('data-entry-details'));
            let contentHtml = '';
            
            if (entryData.type === 'Event') {
                contentHtml = `<p><span class="font-semibold">Event:</span> ${entryData.event}</p>`;
                if (entryData.event === 'Admin Work') {
                     const detailsParts = entryData.details.split(' - ');
                     contentHtml += `<p><span class="font-semibold">Type:</span> ${detailsParts[0]}</p>`;
                     contentHtml += `<p><span class="font-semibold">Details:</span> ${detailsParts.slice(1).join(' - ') || 'N/A'}</p>`;
                } else {
                     contentHtml += `<p><span class="font-semibold">Details:</span> ${entryData.details || 'N/A'}</p>`;
                }
            } else if (entryData.type === 'Visit') {
                contentHtml = `<p><span class="font-semibold">Visit:</span> ${entryData.visitType}</p>`;
                if (entryData.visitType === 'Double Visit') {
                    contentHtml += `<p><span class="font-semibold">MR:</span> ${entryData.medicalRep}</p><p><span class="font-semibold">Brick:</span> ${entryData.brick}</p>`;
                }
                contentHtml += `<p><span class="font-semibold">Details:</span> ${entryData.details || 'N/A'}</p>`;
            } else if (entryData.type === 'Leave') {
                contentHtml = `<p><span class="font-semibold">Leave:</span> ${entryData.leaveType}</p><p><span class="font-semibold">Details:</span> ${entryData.details || 'N/A'}</p>`;
            }
            contentHtml += `<p><span class="font-semibold">Time:</span> ${getTimeDisplay(entryData.startHour, entryData.endHour, entryData.startTimeOption)}</p>`;
            
            popover.innerHTML = `${contentHtml}<button type="button" class="btn btn-danger mt-2" onclick="deleteSingleEntry(event, '${planBoxElement.getAttribute('data-entry-id')}')">Delete</button>`;

            const planBoxRect = planBoxElement.getBoundingClientRect();
            document.body.appendChild(popover);
            
            // Position popover intelligently
            const popoverRect = popover.getBoundingClientRect();
            let top = planBoxRect.top;
            let left = planBoxRect.right + 10;
            if (left + popoverRect.width > window.innerWidth) {
                left = planBoxRect.left - popoverRect.width - 10;
            }
            if (top + popoverRect.height > window.innerHeight) {
                top = window.innerHeight - popoverRect.height - 10;
            }
            popover.style.left = `${left}px`;
            popover.style.top = `${top}px`;
        }

        function hideAllPopovers() {
            document.querySelectorAll('.popover').forEach(popover => popover.remove());
        }
        
        function updateDeleteButtonVisibility() {
            const selectedBoxes = document.querySelectorAll('.plan-box.selected');
            const deleteBtn = document.getElementById('deleteEntryButton');
            deleteBtn.style.display = selectedBoxes.length > 0 ? 'inline-flex' : 'none';
        }

        function hideDeleteButton() {
            document.getElementById('deleteEntryButton').style.display = 'none';
        }
        
        // --- GLOBAL EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            // The app will wait for user data from the parent window via the 'message' event.
            // If it's stuck on "Loading...", it means the user data was not received.
            console.log("Weekly plan waiting for user data...");
        });

        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'dmPlanningUserPermissions') {
                console.log('DM-Plan received user data:', event.data.user);
                handleInitialization(event.data.user);
            }
        });
        
        document.getElementById('districtManager').addEventListener('change', updateDatesAndDaySelector);
        document.getElementById('startDate').addEventListener('change', updateDatesAndDaySelector);
        
        document.getElementById('editPlanBtn').addEventListener('click', (e) => {
            const form = document.getElementById('form-section-container');
            const isHidden = form.classList.toggle('hidden');
            e.target.textContent = isHidden ? 'Edit Plan' : 'Hide Form';
        });

        document.getElementById('prevWeekBtn').addEventListener('click', () => {
            const startDateInput = document.getElementById('startDate');
            const currentDate = new Date(startDateInput.value);
            currentDate.setDate(currentDate.getDate() - 7);
            startDateInput.value = currentDate.toISOString().split('T')[0];
            updateDatesAndDaySelector();
        });

        document.getElementById('nextWeekBtn').addEventListener('click', () => {
            const startDateInput = document.getElementById('startDate');
            const currentDate = new Date(startDateInput.value);
            currentDate.setDate(currentDate.getDate() + 7);
            startDateInput.value = currentDate.toISOString().split('T')[0];
            updateDatesAndDaySelector();
        });

        document.getElementById('plan-table-body').addEventListener('click', (event) => {
            const targetBox = event.target.closest('.plan-box');
            if (event.target.closest('.resize-handle')) return; // Ignore clicks on resize handle

            if (event.ctrlKey || event.metaKey || multiSelectMode) {
                if (targetBox) {
                    targetBox.classList.toggle('selected');
                    hideAllPopovers();
                }
            } else {
                const wasSelected = targetBox ? targetBox.classList.contains('selected') : false;
                document.querySelectorAll('.plan-box.selected').forEach(b => b.classList.remove('selected'));
                
                if (targetBox && !wasSelected) {
                    displayEntryPopover(targetBox);
                } else {
                    hideAllPopovers();
                }
            }
            updateDeleteButtonVisibility();
        });
        
        document.getElementById('deleteEntryButton').addEventListener('click', deleteSelectedEntries);

        document.addEventListener('click', (event) => {
            if (!event.target.closest('.container')) {
                hideAllPopovers();
                document.querySelectorAll('.plan-box.selected').forEach(box => box.classList.remove('selected'));
                updateDeleteButtonVisibility();
                multiSelectMode = false;
            }
        });

        document.querySelector('.scrollable-table-container').addEventListener('scroll', hideAllPopovers);

    </script>
</body>
</html>
