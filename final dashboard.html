<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700&display=swap">
    <style>
        /* Base styles for Inter font */
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 0;
            line-height: 1.5;
            color: var(--text);
            background-color: #eef2f7; /* Light gray background */
            font-size: 0.9rem;
        }

        /* Root variables for consistent theming */
        :root {
            --primary: #3b82f6; /* Blue */
            --primary-dark: #2563eb;
            --primary-light: #93c5fd;
            --secondary: #64748b; /* Gray */
            --accent: #0ea5e9; /* Light Blue */
            --background: #f1f5f9; /* Light Gray */
            --card-bg: #ffffff;
            --success: #22c55e; /* Green */
            --warning: #f59e0b; /* Orange */
            --danger: #ef4444; /* Red */
            --text: #1e293b; /* Dark Blue-Gray */
            --text-light: #64748b;
            --border: #e2e8f0; /* Light Gray Border */
            --hover-bg: #f8fafc; /* Very Light Gray */

            /* Specific colors for weekly plan */
            --specialty-bg-weekly: #d1fae5; /* Baby Green */
            --hcp-bg-weekly: #fff3cd; /* Baby Yellow */
            --special-speciality-color-weekly: #FFD8D8; /* New color for AM/PM/Full Day specialties */
            --selected-border-weekly: #3b82f6; /* Blue for selected */
            --visit-time-weekly: #dc2626; /* Red for visit time */
        }
        
        /* Common Layout Classes */
        .dashboard-container {
            max-width: 1600px; /* Increased width for PC */
            margin: 0 auto;
            padding: 1rem;
        }

        .common-header {
            background: linear-gradient(135deg, #1a365d 0%, #3182ce 100%); /* Requests header gradient */
            padding: 1rem 1.5rem;
            border-radius: 18px;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 16px -4px rgba(59, 130, 246, 0.15);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            min-height: 70px;
            color: white;
        }

        .common-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="1" fill="white" opacity="0.1"/><circle cx="10" cy="90" r="1" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            z-index: 1;
            opacity: 0.2;
            pointer-events: none;
        }

        .common-header h1 {
            font-size: clamp(1.1rem, 2.3vw, 1.7rem);
            margin: 0;
            font-weight: 600;
            letter-spacing: -0.025em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex-grow: 1;
            text-align: left;
            position: relative; /* For z-index */
            z-index: 2; /* Ensure text is above grain */
        }
        .common-header p {
            font-size: 0.85rem;
            opacity: 0.9;
            font-weight: 300;
            position: relative; /* For z-index */
            z-index: 2; /* Ensure text is above grain */
        }

        .common-card {
            background: var(--card-bg);
            border-radius: 18px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05),
                        0 2px 4px -1px rgba(0, 0, 0, 0.03);
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            overflow: hidden;
            border: 1px solid rgba(226, 232, 240, 0.8);
            padding: 1rem; /* Default padding for cards */
        }

        .common-card:hover {
            box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .common-table-container {
            overflow-x: auto;
            margin: 0;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            background: linear-gradient(to right, var(--card-bg) 30%, transparent 100%);
        }

        .common-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            table-layout: auto;
        }

        .common-table th, .common-table td {
            padding: 0.4rem 0.6rem;
            text-align: center;
            font-size: 0.65rem;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
            min-width: 40px;
        }

        .common-table th {
            background: #f8fafc;
            font-weight: 600;
            color: var(--secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            z-index: 1;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
        }

        .common-table th:first-child, .common-table td:first-child {
            position: sticky;
            left: 0;
            background: var(--card-bg);
            z-index: 2;
            box-shadow: 4px 0 8px -4px rgba(0, 0, 0, 0.1);
            min-width: 140px;
            max-width: 240px;
            width: 170px;
            text-align: left;
            padding-left: 0.8rem;
        }

        .common-table tbody tr:hover td {
            background-color: #e2fbff;
        }

        /* Form Controls */
        .common-filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .common-filter-group label {
            font-weight: 600;
            color: #718096; /* Default label color */
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .common-filter-input {
            padding: 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid var(--border);
            background: var(--card-bg);
            font-size: 0.875rem;
            transition: all 0.2s;
            width: 100%;
            color: var(--text);
            appearance: none; /* For select dropdown arrow */
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%234a5568' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3csvg%3e");
            background-repeat: no-repeat;
            background-position: right 0.6rem center;
            background-size: 0.55em auto;
        }
        .common-filter-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        /* Style for filter controls inside common-header */
        .common-header .filter-controls .common-filter-group label {
            color: white; /* Make labels white */
            font-size: 0.75rem; /* Smaller label font */
        }
        .common-header .filter-controls .common-filter-input {
            padding: 0.35rem 0.6rem; /* Smaller padding */
            font-size: 0.8rem; /* Smaller font size */
            height: 32px; /* Fixed height for better alignment */
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }
        .common-header .filter-controls .common-filter-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .common-header .filter-controls .common-filter-input option {
            background-color: #1a365d; /* Dark background for options */
            color: white;
        }
        .common-header .filter-controls .common-filter-input:focus {
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
        }

        .common-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
        }
        .common-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); /* shadow */
        }
        .common-button-primary {
            background: var(--primary);
            color: white;
        }
        .common-button-primary:hover {
            background: var(--primary-dark);
        }
        .common-button-secondary {
            background: var(--background);
            color: var(--text);
            border: 1px solid var(--border);
        }
        .common-button-secondary:hover {
            background: #e2e8f0;
        }
        .common-button-danger {
            background: var(--danger);
            color: white;
        }
        .common-button-danger:hover {
            background: #dc2626;
        }
        .common-button-success {
            background: var(--success);
            color: white;
        }
        .common-button-success:hover {
            background: #16a34a;
        }

        /* Tab styles */
        .tabs {
            display: flex;
            margin-bottom: 1rem;
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-button {
            flex: 1;
            min-width: fit-content;
            padding: 10px 16px;
            cursor: pointer;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--secondary);
            background-color: var(--card-bg);
            border: none;
            transition: all 0.3s ease;
            position: relative;
            outline: none;
        }

        .tab-button::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: transparent;
            transition: background-color 0.3s ease;
        }

        .tab-button:hover {
            background-color: var(--hover-bg);
            color: var(--primary);
        }

        .tab-button.active {
            color: var(--primary);
            background-color: var(--background);
        }

        .tab-button.active::after {
            background-color: var(--primary);
        }
        
        .tab-content {
            display: none;
            padding: 8px;
        }

        .tab-content.active {
            display: block;
        }

        /* KPI Dashboard Specific Styles */
        .kpi-table-tabs {
            position: relative;
            display: flex;
            margin-bottom: 10px;
            background-color: #e2e8f0;
            border-radius: 9999px;
            padding: 4px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .kpi-table-tabs::before {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            height: calc(100% - 8px);
            width: calc(50% - 4px);
            background-color: var(--primary);
            border-radius: 9999px;
            transition: transform 0.3s ease-in-out;
            z-index: 0;
        }

        .kpi-table-tabs.am-active::before {
            transform: translateX(100%);
        }

        .kpi-tab-button {
            flex: 1;
            min-width: 120px;
            padding: 8px 12px;
            cursor: pointer;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--secondary);
            background-color: transparent;
            border: none;
            transition: color 0.3s ease;
            position: relative;
            z-index: 1;
            outline: none;
        }

        .kpi-tab-button.active {
            color: white;
        }

        .kpi-tab-button:hover:not(.active) {
            color: var(--primary-dark);
        }

        .kpi-table-content {
            display: none;
        }

        .kpi-table-content.active {
            display: block;
        }

        .progress-bar {
            background: var(--border);
            border-radius: 9999px;
            height: 0.7rem;
            overflow: hidden;
            position: relative;
            min-width: 110px;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .progress {
            height: 100%;
            transition: width 0.3s ease;
            position: absolute;
            top: 0;
            left: 0;
            background-image: linear-gradient(45deg,
                rgba(255, 255, 255, 0.15) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, 0.15) 50%,
                rgba(255, 255, 255, 0.15) 75%,
                transparent 75%,
                transparent);
            background-size: 1rem 1rem;
            animation: progress-stripes 1s linear infinite;
        }

        @keyframes progress-stripes {
            0% { background-position: 1rem 0; }
            100% { background-position: 0 0; }
        }

        .progress-text-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: #323232;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
            z-index: 1;
        }

        .progress-coverage.success { background-color: var(--success); }
        .progress-coverage.warning { background-color: var(--warning); }
        .progress-coverage.danger { background-color: var(--danger); }

        .progress-frequency.success { background-color: var(--success); }
        .progress-frequency.warning { background-color: var(--warning); }
        .progress-frequency.danger { background-color: var(--danger); }

        .first-visit { background-color: inherit !important; }
        .duplicate-visit { background-color: #fee2e2 !important; }
        tr.duplicate-visit:hover td { background-color: #fcd5d5 !important; }

        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-danger { color: var(--danger); }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }

        .highest-coverage { color: #22c55e !important; font-weight: bold; }
        .lowest-coverage { color: #ef4444 !important; font-weight: bold; }

        .first-visit-of-day { background-color: #d1fae5 !important; }
        .event-training-meeting { background-color: #fed7aa !important; font-weight: bold; }
        .leave-row { background-color: #fee2e2 !important; font-weight: bold; } /* Changed to light red */
        .am-specialty-hcp { color: #a52a2a; font-weight: bold; }

        .unvisited { color: #e67a00; font-weight: bold; }
        .pharmacy-hcp { color: #009a25; }
        .negative-remaining-row { color: #ef4444; font-weight: bold; }

        .floating-box {
            position: absolute;
            background: var(--card-bg);
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 0.4rem;
            border-radius: 8px;
            z-index: 1000;
            display: none;
            max-width: 200px;
            word-wrap: break-word;
        }

        .floating-box::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent var(--card-bg) transparent;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .action-buttons button {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 1.05rem;
            cursor: pointer;
            transition: color 0.2s, transform 0.2s;
            padding: 0.2rem;
            border-radius: 4px;
        }
        .action-buttons button:hover {
            color: var(--primary-dark);
            background-color: rgba(59, 130, 246, 0.1);
        }

        #leavesFilterOptions {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            justify-content: flex-end;
            font-size: 0.75rem;
            color: var(--text);
            display: none;
        }
        #leavesFilterOptions label {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            cursor: pointer;
        }
        #leavesFilterOptions input[type="radio"] {
            margin: 0;
            cursor: pointer;
        }

        .search-box {
            margin-top: 0.2rem;
            margin-bottom: 0.6rem;
            display: flex;
            justify-content: center;
            align-items: center; /* Align items in search box */
        }

        .search-box input {
            padding: 0.25rem;
            font-size: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            width: 100%;
            max-width: 420px;
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            width: auto;
            flex-wrap: nowrap;
            align-items: center;
            position: relative; /* For z-index of elements inside header */
            z-index: 2; /* Ensure filters are above grain */
        }
        .filter-controls select {
            padding: 7px 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            outline: none;
            transition: all 0.2s ease;
        }
        .filter-controls select:hover { background-color: rgba(255, 255, 255, 0.3); }
        .filter-controls select option {
            background-color: var(--primary-dark);
            color: white;
        }

        .sync-button {
            background: none;
            border: none;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.3s ease, color 0.2s ease;
            padding: 5px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sync-button:hover {
            transform: rotate(30deg);
            color: var(--accent);
        }
        .sync-button:active {
            transform: rotate(60deg);
        }

        /* KPI Footer Buttons */
        .kpi-footer-icon-button {
            background: none;
            border: none;
            font-size: 1.2rem; /* Larger icon size */
            cursor: pointer;
            transition: color 0.2s, transform 0.2s;
            padding: 0.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .kpi-footer-icon-button.success {
            color: var(--success);
        }
        .kpi-footer-icon-button.secondary {
            color: var(--secondary);
        }
        .kpi-footer-icon-button:hover {
            transform: translateY(-2px);
            opacity: 0.8;
        }

        /* Daily Report Specific Styles */
        .daily-report-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .tables-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            align-items: center; /* Center tables */
        }
        .section-container {
            background: var(--card-bg);
            border-radius: 18px;
            box-shadow: 0 2px 4px -1px rgb(0 0 0 / 0.1);
            overflow: hidden;
            margin-bottom: 16px;
            min-width: 100%;
            max-width: 100%; /* Ensure it doesn't overflow */
        }
        .daily-report-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 1px;
            min-width: 550px;
            table-layout: fixed;
        }
        .daily-report-table th {
            background-color: var(--card-bg);
            color: var(--text);
            font-weight: 600;
            padding: 3px;
            text-align: center;
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
            white-space: nowrap;
            min-width: 90px;
            width: 110px;
        }
        .daily-report-table .count-column {
            background-color: var(--card-bg) !important;
            font-weight: 600;
            color: var(--primary);
            width: 70px;
            min-width: 70px !important;
            max-width: 70px;
            position: sticky;
            left: 0;
            z-index: 1;
            border-right: 1px solid var(--border) !important;
        }
        .daily-report-table td {
            padding: 1px;
            text-align: center;
            border: 1px solid var(--border);
            min-width: 90px;
            vertical-align: top;
            width: 110px;
        }
        .hcp-cell {
            padding: 3px;
            margin: 1px 0;
            background: var(--card-bg);
            border-radius: 6px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            font-size: 0.75rem;
            cursor: pointer;
            position: relative;
            text-align: left;
            padding-left: 7px;
        }
        .hcp-cell span {
            display: block;
            line-height: 1.2;
        }
        .hcp-cell span.hcp-name {
            font-weight: 600;
            color: var(--text);
        }
        .hcp-cell span.hcp-detail {
            font-size: 0.65rem;
            color: #666;
        }
        .hcp-cell.event { background-color: #ffe5b4; }
        .hcp-cell.leave-entry { background-color: #fee2e2; font-weight: bold; } /* Changed to light red */
        .comment-box {
            display: none;
            position: relative;
            background-color: #e6d5f5;
            border: 1px solid #d1b8e6;
            border-radius: 6px;
            padding: 8px;
            margin-top: 4px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10;
            width: 200px;
            left: 0;
            top: 100%;
        }
        .comment-box.top::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -8px;
            border-width: 8px;
            border-style: solid;
            border-color: #d1b8e6 transparent transparent transparent;
            
        }
        .comment-box.top::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -7px;
            border-width: 7px;
            border-style: solid;
            border-color: #e6d5f5 transparent transparent transparent;
        }
        .comment-box.bottom::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            margin-left: -8px;
            border-width: 8px;
            border-style: solid;
            border-color: transparent transparent #d1b8e6 transparent;
        }
        .comment-box.bottom::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            margin-left: -7px;
            border-width: 7px;
            border-style: solid;
            border-color: transparent transparent #e6d5f5 transparent;
        }

        /* Daily Report Section Headers - New Style */
        .daily-report-section-header {
            background: linear-gradient(135deg, #0ea5e9, #38bdf8); /* Default blue gradient */
            padding: 0.75rem 1rem;
            border-radius: 18px 18px 0 0;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        .daily-report-section-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1));
            pointer-events: none;
        }
        .daily-report-section-header.pm-gradient {
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
        }
        .daily-report-section-header.pharmacy-gradient {
            background: linear-gradient(135deg, #10b981, #34d399);
        }

        /* Daily Report Header Filter Controls */
        #daily-report .filter-controls .common-filter-group {
            flex-grow: 1; /* Allow groups to grow */
            min-width: 150px; /* Ensure minimum width */
        }
        .daily-report-icon-button {
            background: none;
            border: none;
            font-size: 1.2rem; /* Larger icon size */
            cursor: pointer;
            transition: color 0.2s, transform 0.2s;
            width: 32px; /* Same width as input */
            height: 32px; /* Same height as input */
            border-radius: 0.375rem; /* Match input border-radius */
            display: flex;
            align-items: center;
            justify-content: center;
            color: white; /* Icon color */
            background-color: rgba(255, 255, 255, 0.2); /* Match input background */
            border: 1px solid rgba(255, 255, 255, 0.3); /* Match input border */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .daily-report-icon-button:hover {
            transform: translateY(-1px);
            opacity: 0.8;
            color: var(--accent); /* Hover color */
            background-color: rgba(255, 255, 255, 0.3);
        }
        .daily-report-header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
         /* Add this to your existing styles */
    .clinic-hcp {
        background-color: #F0F2BD !important;
    }
    .visit-place-cell {
        font-weight: bold;
        color: var(--danger);
    }


        /* Lists Dashboard Specific Styles */
        .custom-select {
            position: relative;
            width: 100%;
        }
        .custom-select-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.4rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 3.5rem;
            background-color: white;
            color: #374151;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .custom-select-trigger:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .custom-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 0.25rem;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        .custom-select-options.show {
            display: block;
        }
        .custom-select-option {
            padding: 0.45rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
        }
        .custom-select-option:hover {
            background-color: #f3f4f6;
        }
        .custom-select-option.selected {
            background-color: var(--primary);
            color: white;
        }
        .custom-select-option.highlighted {
            background-color: #dbeafe;
        }
        .status-count {
            display: inline-flex;
            align-items: center;
            padding: 0.45rem 0.9rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 500;
            background-color: #dbeafe;
            color: #1e40af;
            margin-bottom: 1rem;
        }
        .lists-table-container {
            position: relative;
            overflow-x: auto;
            margin: 1rem 0;
            padding: 0;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
        }
        .lists-table th, .lists-table td {
            white-space: nowrap;
            padding: 0.65rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .lists-table th {
            background-color: #f8fafc;
            color: #374151;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .lists-table .sticky-col, .lists-table td.sticky {
            position: sticky;
            left: 0;
            background-color: inherit;
            z-index: 20;
            border-right: 2px solid #e5e7eb;
            background-color: #fff;
            min-width: 140px;
        }
        .lists-table th.sticky-col {
            z-index: 30;
            background-color: #f8fafc;
        }
        .lists-table tbody tr:hover {
            background-color: #f8fafc;
        }
        .light-red { background-color: #fee2e2; }
        .light-yellow { background-color: #fef3c7; }
        .light-green { background-color: #dcfce7; }
        .highlight { background-color: #dbeafe !important; }

        /* Requests Dashboard Specific Styles */
        .requests-header {
            background: linear-gradient(135deg, #1a365d 0%, #3182ce 100%);
            color: white;
            padding: 1.25rem 0.8rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 18px 18px 0 0; /* Rounded top corners */
        }
        .requests-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="1" fill="white" opacity="0.1"/><circle cx="10" cy="90" r="1" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            z-index: 1;
            opacity: 0.2;
        }
        .requests-header-content {
            position: relative;
            z-index: 2;
        }
        .requests-header h1 {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 0.4rem;
            letter-spacing: -0.02em;
        }
        .requests-header p {
            font-size: 0.85rem;
            opacity: 0.9;
            font-weight: 300;
        }
        .requests-main-content {
            padding: 1rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .requests-filters-section {
            background: #ffffff;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .requests-filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.6rem;
            margin-bottom: 0.6rem;
        }
        .requests-filter-group label {
            font-weight: 600;
            color: #718096;
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .requests-action-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.6rem;
            margin-top: 1rem;
        }
        .requests-stats-bar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: #ffffff;
            padding: 0.7rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid #e2e8f0;
            margin-bottom: 1rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .requests-stats-item {
            text-align: center;
            padding: 0.3rem;
        }
        .requests-stats-number {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1a365d;
            display: block;
            margin-bottom: 0.15rem;
        }
        .requests-stats-label {
            font-size: 0.65rem;
            color: #718096;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .requests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(270px, 1fr));
            gap: 1rem;
        }
        .request-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            padding: 1rem;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }
        .request-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .request-card.status-requested { background-color: #fefcbf; }
        .request-card.status-scheduled { background-color: #c6f6d5; }
        .request-card.status-pending { background-color: #fefcbf; }
        .request-card.status-postponed { background-color: #fed7d7; }
        .request-card.status-done { background-color: #b2f5ea; }
        .request-card.status-rejected { background-color: #fed7d7; }
        .request-card.status-approved { background-color: #c6f6d5; }

        .request-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: #3182ce;
        }
        .request-card.status-done::before { background: #38a169; }
        .request-card.status-rejected::before { background: #e53e3e; }
        .request-card.status-canceled::before { background: #ed8936; }
        .request-card.status-approved::before { background: #38a169; }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.2em 0.5em;
            border-radius: 9999px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            white-space: nowrap;
            margin-left: auto;
        }
        .status-requested { background-color: #fefcbf; color: #92400e; }
        .status-scheduled { background-color: #c6f6d5; color: #22543d; }
        .status-pending { background-color: #fefcbf; color: #92400e; }
        .status-postponed { background-color: #fed7d7; color: #9b2c2c; }
        .status-done { background-color: #b2f5ea; color: #234e52; }
        .status-rejected { background-color: #fed7d7; color: #9b2c2c; }
        .status-approved { background-color: #c6f6d5; color: #22543d; }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.7rem;
            flex-wrap: wrap;
            gap: 0.3rem;
        }
        .request-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: #1a365d;
            margin-bottom: 0.15rem;
        }
        .request-meta {
            font-size: 0.65rem;
            color: #718096;
            font-weight: 500;
        }
        .request-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 0.7rem;
            margin-bottom: 0.7rem;
            border-top: 1px dashed #e2e8f0;
            padding-top: 0.7rem;
        }
        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }
        .detail-label {
            font-size: 0.6rem;
            color: #718096;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .detail-value {
            font-size: 0.75rem;
            color: #2d3748;
            font-weight: 500;
        }
        .request-description {
            background: #f7fafc;
            padding: 0.7rem;
            border-radius: 0.375rem;
            margin-bottom: 0.7rem;
            border-left: 3px solid #63b3ed;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .request-description h4 {
            font-size: 0.75rem;
            font-weight: 700;
            color: #1a365d;
            margin-bottom: 0.5rem;
        }
        .request-description p {
            font-size: 0.75rem;
            color: #718096;
            line-height: 1.4;
        }
        .status-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.7rem;
            padding-top: 0.7rem;
            border-top: 1px dashed #e2e8f0;
        }
        .status-control label {
            font-size: 0.7rem;
            font-weight: 600;
            color: #2d3748;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .status-select {
            padding: 0.35rem 0.55rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            font-size: 0.7rem;
            background: #ffffff;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #2d3748;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%234a5568' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3csvg%3e");
            background-repeat: no-repeat;
            background-position: right 0.55rem center;
            background-size: 0.55em auto;
        }
        .status-select:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 2px rgba(49, 130, 206, 0.15);
        }
        .designer-credit {
            text-align: center;
            padding: 0.7rem;
            background: #f7fafc;
            border-top: 1px solid #e2e8f0;
            font-size: 0.65rem;
            color: #718096;
            margin-top: auto;
            border-radius: 0 0 18px 18px; /* Rounded bottom corners */
        }
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #718096;
            background: #ffffff;
            border-radius: 0.375rem;
            border: 1px dashed #e2e8f0;
            margin-top: 1rem;
        }
        .empty-state svg {
            width: 50px;
            height: 50px;
            margin-bottom: 0.7rem;
            opacity: 0.4;
            color: #63b3ed;
        }
        .empty-state h3 {
            font-size: 1.05rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.35rem;
        }
        .empty-state p {
            font-size: 0.8rem;
            color: #718096;
        }
        
        /* Requests Card Action Buttons */
        .request-card-actions {
            display: flex;
            justify-content: flex-end; /* Align to the right */
            gap: 0.5rem;
            margin-top: 0.7rem;
            padding-top: 0.7rem;
            border-top: 1px dashed #e2e8f0;
        }

        .request-card-actions button {
            background: none;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            color: var(--secondary); /* Default color */
            transition: color 0.2s, transform 0.2s;
            padding: 0.3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .request-card-actions button:hover {
            transform: translateY(-1px);
            background-color: rgba(0, 0, 0, 0.05);
        }

        .request-card-actions .delete-request-button {
            color: var(--danger);
        }
        .request-card-actions .delete-request-button:hover {
            color: #c53030;
        }

        .request-card-actions .email-request-button {
            color: var(--primary);
        }
        .request-card-actions .email-request-button:hover {
            color: var(--primary-dark);
        }

        /* Weekly Plan Specific Styles */
        .weekly-plan-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .weekly-plan-table-container {
            overflow-x: auto;
            border-radius: 0.375rem;
            border: 1px solid var(--border);
            background: var(--background);
        }
        .weekly-plan-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }
        .weekly-plan-table th, .weekly-plan-table td {
            padding: 0.5rem;
            text-align: center;
            border: 1px solid var(--border);
            vertical-align: top;
        }
        .weekly-plan-table th {
            background: var(--primary);
            color: white;
            font-weight: 500;
            position: sticky;
            top: 0;
        }
        .activities-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-height: 100px;
        }
        .hcp-box, .specialty-box, .special-speciality-box {
            border: 1px solid var(--hcp-border);
            border-radius: 0.375rem;
            width: 100%;
            padding: 0.5rem;
            margin: 0.25rem 0;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            transition: all 0.2s;
            cursor: pointer;
        }
        .hcp-box:hover, .specialty-box:hover, .special-speciality-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); /* shadow */
        }
        .specialty-box {
            background: var(--specialty-bg-weekly);
        }
        .hcp-box {
            background: var(--hcp-bg-weekly);
        }
        .special-speciality-box {
            background: var(--special-speciality-color-weekly);
            border-color: #fca5a5;
        }
        .selected-visit-box {
            border: 2px solid var(--selected-border-weekly);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
            transform: scale(1.02);
        }
        .visit-time-weekly {
            color: var(--visit-time-weekly);
            font-weight: bold;
        }
        .hcp-name-weekly {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .brick-info-weekly {
            color: var(--text-light);
            font-size: 0.75rem;
        }
        .empty-message {
            color: var(--text-light);
            text-align: center;
            padding: 1rem;
            font-style: italic;
        }

        /* Loading and Error Messages */
        .loading-indicator {
            text-align: center;
            padding: 20px;
            display: none;
            color: var(--primary);
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-radius: 50%;
            border-top: 3px solid var(--primary);
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        .loading-spinner span {
            font-size: 0.75rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            background: #fee2e2;
            color: var(--danger);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            display: none;
        }

        /* Custom Modal for confirmation and alert */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        .custom-modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 380px;
            width: 90%;
            animation: fadeInScale 0.3s ease-out forwards;
        }
        .custom-modal-content p {
            margin-bottom: 15px;
            font-size: 0.95rem;
            color: #333;
        }
        .custom-modal-buttons button {
            padding: 8px 16px;
            margin: 0 6px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        .custom-modal-buttons button.confirm-yes {
            background-color: var(--primary);
            color: white;
        }
        .custom-modal-buttons button.confirm-yes:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
        }
        .custom-modal-buttons button.confirm-no, .custom-modal-buttons button.alert-ok {
            background-color: var(--danger);
            color: white;
        }
        .custom-modal-buttons button.confirm-no:hover, .custom-modal-buttons button.alert-ok:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .dashboard-container { padding: 0.5rem; }
            .common-header { padding: 1rem 0.6rem; }
            .common-header h1 { font-size: 1.4rem; }
            /* Adjusted font size for KPI Overview title and rep name */
            #kpi-dashboard .common-card h2 {
                font-size: 1rem; /* Fixed smaller size for mobile */
                flex-direction: column; /* Stack elements vertically */
                align-items: flex-start; /* Align to start when stacked */
            }
            #selectedRepName {
                font-size: 0.9rem; /* Fixed smaller size for mobile */
                margin-top: 0.2rem; /* Add some space below the main title */
            }

            .common-table th, .common-table td { padding: 0.35rem; font-size: 0.65rem; }
            .common-table th:first-child, .common-table td:first-child {
                min-width: 110px;
                max-width: 180px;
            }
            .common-table td:first-child::after {
                content: '';
                position: absolute;
                right: 0;
                top: 0;
                height: 100%;
                width: 20px;
                background: linear-gradient(to right, transparent, var(--card-bg));
                pointer-events: none;
            }
            .common-table-container {
                margin-left: -0.25rem;
                margin-right: -0.25rem;
                padding: 0 0.25rem;
            }
            .filter-controls { flex-direction: column; align-items: flex-start; gap: 0.5rem;}
            .filter-controls select { width: 100%; }
            .common-card { padding: 0.8rem; }
            .requests-filters-grid { grid-template-columns: 1fr; gap: 0.5rem; }
            .requests-stats-bar { flex-direction: column; gap: 0.5rem; padding: 0.6rem; }
            .requests-grid { grid-template-columns: 1fr; gap: 0.8rem; }
            .request-card { padding: 0.8rem; }
            .request-card::before { width: 3px; }
            .request-header { flex-direction: column; align-items: flex-start; gap: 0.4rem; }
            .status-badge { margin-left: 0; font-size: 0.6rem; }
            .request-title { font-size: 0.9rem; }
            .request-meta { font-size: 0.6rem; }
            .request-details { grid-template-columns: 1fr; gap: 0.5rem; padding-top: 0.5rem; }
            .detail-label { font-size: 0.55rem; }
            .detail-value { font-size: 0.7rem; }
            .request-description { padding: 0.5rem; }
            .request-description h4 { font-size: 0.7rem; }
            .request-description p { font-size: 0.7rem; }
            .status-control { flex-direction: column; align-items: flex-start; gap: 0.35rem; padding-top: 0.5rem; }
            .status-select { padding: 0.3rem 0.45rem; font-size: 0.65rem; }
            .designer-credit { padding: 0.5rem; font-size: 0.6rem; }
            .empty-state { padding: 1.5rem; }
            .empty-state svg { width: 40px; height: 40px; }
            .empty-state h3 { font-size: 0.95rem; }
            .empty-state p { font-size: 0.75rem; }
            .weekly-plan-grid .common-card { padding: 0.75rem; margin-bottom: 0.5rem; }
            .weekly-plan-table th, .weekly-plan-table td { padding: 0.25rem; font-size: 0.7rem; }
            .weekly-plan-table-container { max-height: 300px; overflow-y: auto; }
        }

        /* KPI Month Dropdown Width for PC */
        @media (min-width: 769px) {
            #monthSelect {
                max-width: 150px; /* Adjust as needed */
            }
        }
       
    </style>
</head>
<body>
    <div id="dashboard-content">
        <div class="dashboard-container">
            <div class="tabs">
                <button class="tab-button active" onclick="openTab(event, 'kpi-dashboard')">KPI Dashboard</button>
                <button class="tab-button" onclick="openTab(event, 'daily-report')">Daily Report</button>
                <button class="tab-button" onclick="openTab(event, 'lists-dashboard')">Lists</button>
                <button class="tab-button" onclick="openTab(event, 'requests-dashboard')">Requests</button>
                <button class="tab-button" onclick="openTab(event, 'weekly-plan-dashboard')">Weekly Plan</button>
            </div>
            
            <div id="kpi-dashboard" class="tab-content active">
                <header class="common-header">
                    <div class="flex justify-between items-center w-full flex-wrap gap-2">
                        <h1>KPI Dashboard</h1>
                        <div class="filter-controls">
                            <div class="common-filter-group">
                                <select id="monthSelect" class="common-filter-input"></select>
                            </div>
                            <div id="kpiDmFilterContainer" class="flex gap-2 items-center">
                                <div class="common-filter-group">
                                    <select id="kpiDistrictManagerSelect" class="common-filter-input">
                                        <!-- Options populated by JS -->
                                    </select>
                                </div>
                                <button id="syncKpiData" class="sync-button" title="Sync Latest Data"><i class="fas fa-sync-alt"></i></button>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- KPI Tables Container with Tabs -->
                <div class="common-card">
                    <div class="kpi-table-tabs">
                        <button class="kpi-tab-button active" data-tab-id="pm-visits-table" onclick="openKpiTab(event, 'pm-visits-table')">PM Visits</button>
                        <button class="kpi-tab-button" data-tab-id="am-visits-table" onclick="openKpiTab(event, 'am-visits-table')">AM Visits</button>
                    </div>

                    <!-- PM Visits Table (Class A-B HCPs) -->
                    <div id="pm-visits-table" class="kpi-table-content active">
                        <div class="common-table-container">
                            <table class="common-table">
                                <thead>
                                    <tr>
                                        <th class="col-rep"><i class="fas fa-user"></i> Representative</th>
                                        <th class="col-area"><i class="fas fa-map-marker-alt"></i> area</th>
                                        <th class="col-hcp"><i class="fas fa-users"></i> Total HCPs (PM)</th>
                                        <th class="col-unvisited"><i class="fas fa-user-slash"></i> Unvisited (PM)</th>
                                        <th class="col-coverage"><i class="fas fa-percentage"></i> Coverage (PM)</th>
                                        <th class="col-progress"><i class="fas fa-chart-pie"></i> Progress (PM)</th>
                                        <th class="col-frequency"><i class="fas fa-history"></i> Frequency (PM)</th>
                                        <th class="col-progress"><i class="fas fa-chart-line"></i> Progress (PM)</th>
                                        <th class="col-working-days"><i class="fas fa-calendar-day"></i> Working Days</th>
                                        <th class="col-average-visits"><i class="fas fa-calendar-alt"></i> PM Call Rate</th>
                                    </tr>
                                </thead>
                                <tbody id="privateVisitsTableBody">
                                    <!-- Data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- AM Visits Table (UPA - Private Class HCPs) -->
                    <div id="am-visits-table" class="kpi-table-content">
                        <div class="common-table-container">
                            <table class="common-table">
                                <thead>
                                    <tr>
                                        <th class="col-rep"><i class="fas fa-user"></i> Representative</th>
                                        <th class="col-area"><i class="fas fa-map-marker-alt"></i> area</th>
                                        <th class="col-hcp"><i class="fas fa-users"></i> Total HCPs (AM)</th>
                                        <th class="col-unvisited"><i class="fas fa-user-slash"></i> Unvisited (AM)</th>
                                        <th class="col-coverage"><i class="fas fa-percentage"></i> Coverage (AM)</th>
                                        <th class="col-progress"><i class="fas fa-chart-pie"></i> Progress (AM)</th>
                                        <th class="col-frequency"><i class="fas fa-history"></i> Frequency (AM)</th>
                                        <th class="col-progress"><i class="fas fa-chart-line"></i> Progress (AM)</th>
                                        <th class="col-working-days"><i class="fas fa-calendar-day"></i> Working Days</th>
                                        <th class="col-average-visits"><i class="fas fa-calendar-alt"></i> AM Call Rate</th>
                                    </tr>
                                </thead>
                                <tbody id="amVisitsTableBody">
                                    <!-- Data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


                <div class="common-card" id="visitsTableContainer" style="display: none;">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2"><i class="fas fa-calendar-check"></i> HCP Visits Overview - <span id="selectedRepName" class="small-font"></span></h2>
                        <div class="action-buttons">
                            <button id="listButton" title="Show All Visits"><i class="fas fa-list"></i></button>
                            <button id="leavesButton" title="Show Leaves"><i class="fas fa-ban"></i></button>
                            <button id="archivedButton" title="Show Archived Visits"><i class="fas fa-box-archive"></i></button>
                        </div>
                    </div>
                    <div id="leavesFilterOptions">
                        <label><input type="radio" name="leaveFilter" value="currentMonth" checked> Current Month</label>
                        <label><input type="radio" name="leaveFilter" value="allYear"> All Year</label>
                    </div>
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Search for HCP Name, Specialty, Brick, etc." class="common-filter-input">
                        <button id="clearSearchButton" class="kpi-footer-icon-button secondary" title="Clear Search" style="margin-left: 0.5rem;"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="common-table-container">
                        <table id="visitsTable" class="common-table">
                            <thead>
                                <tr id="visitsTableHeader">
                                    <th><i class="fas fa-user-doctor"></i> HCP Name</th>
                                    <th><i class="fas fa-stethoscope"></i> Specialty</th>
                                    <th><i class="fas fa-building"></i> Brick</th>
                                    <th><i class="fas fa-map-marker-alt"></i> Visit Place</th>
                                    <th><i class="fas fa-bullseye"></i> Target</th>
                                    <th><i class="fas fa-clock"></i> Remaining</th>
                                    <th><i class="fas fa-comments"></i> Comments</th>
                                    <th><i class="fas fa-calendar-alt"></i> Visit Time</th>
                                    <th class="action-column">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-end gap-2 p-4">
                        <button id="downloadExcelVisits" class="kpi-footer-icon-button success" title="Download as Excel"><i class="fas fa-file-excel"></i></button>
                        <button id="printVisits" class="kpi-footer-icon-button secondary" title="Print Table"><i class="fas fa-print"></i></button>
                    </div>
                </div>
            </div>

            <div id="daily-report" class="tab-content">
                <header class="common-header">
                    <div class="requests-header-content">
                        <h1><i class="fas fa-calendar-alt"></i> Daily Report</h1>
                    </div>
                    <div class="filter-controls mt-4 daily-report-header-buttons">
                        <div class="common-filter-group">
                            <select id="dailyMedRepSelect" class="common-filter-input">
                                <option value="">Select Medical Representative</option>
                            </select>
                        </div>
                        <div class="common-filter-group">
                            <input type="date" id="dailyStartDate" class="common-filter-input">
                        </div>
                        <button id="dailyReportDownloadExcel" class="daily-report-icon-button" title="Export to Excel"><i class="fas fa-file-excel"></i></button>
                    </div>
                </header>

                <div class="loading-indicator">
                    <i class="fas fa-spinner fa-spin"></i> Loading data...
                </div>

                <div class="daily-report-print-header" style="display:none;">
                    <h2 id="printRepName"></h2>
                    <p id="printDateRange"></p>
                </div>

                <div class="daily-report-content">
                    <div class="tables-container">
                        <!-- AM Section -->
                        <div class="section-container">
                            <div class="daily-report-section-header">
                                <i class="fas fa-sun"></i> AM Activities
                            </div>
                            <div class="common-table-container">
                                <table class="daily-report-table" id="amTable">
                                    <thead>
                                        <tr>
                                            <th class="count-column">Count</th>
                                            <!-- Day headers will be appended here by JS -->
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="section-am">
                                            <td class="count-column">0</td>
                                            <!-- Daily cells will be appended here by JS -->
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- AM Details Section -->
                        <div class="section-container">
                            <div class="daily-report-section-header">
                                <i class="fas fa-info-circle"></i> AM Details
                            </div>
                            <div class="common-table-container">
                                <table class="daily-report-table" id="amDetailsTable">
                                    <thead>
                                        <tr>
                                            <th class="count-column">Count</th>
                                            <!-- Day headers will be appended here by JS -->
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="section-am-details">
                                            <td class="count-column">0</td>
                                            <!-- Daily cells will be appended here by JS -->
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- PM Section -->
                        <div class="section-container">
                            <div class="daily-report-section-header pm-gradient">
                                <i class="fas fa-moon"></i> PM Activities
                            </div>
                            <div class="common-table-container">
                                <table class="daily-report-table" id="pmTable">
                                    <thead>
                                        <tr>
                                            <th class="count-column">Count</th>
                                            <!-- Day headers will be appended here by JS -->
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="section-pm">
                                            <td class="count-column">0</td>
                                            <!-- Daily cells will be appended here by JS -->
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Pharmacy Section -->
                        <div class="section-container">
                            <div class="daily-report-section-header pharmacy-gradient">
                                <i class="fas fa-prescription-bottle-medical"></i> Pharmacy Activities
                            </div>
                            <div class="common-table-container">
                                <table class="daily-report-table" id="pharmacyTable">
                                    <thead>
                                        <tr>
                                            <th class="count-column">Count</th>
                                            <!-- Day headers will be appended here by JS -->
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="section-pharmacy">
                                            <td class="count-column">0</td>
                                            <!-- Daily cells will be appended here by JS -->
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="lists-dashboard" class="tab-content">
                <header class="common-header">
                    <div class="requests-header-content">
                        <h1><i class="fas fa-list-alt"></i> Medical Team Lists</h1>
                    </div>
                    <div class="filter-controls mt-4">
                        <div class="common-filter-group">
                            <select id="medicalReps" class="common-filter-input">
                                <option value="">Select Representative</option>
                            </select>
                        </div>

                        <div class="common-filter-group">
                            <select id="bricksSelect" class="common-filter-input">
                                <option value="">Select Brick</option>
                            </select>
                        </div>

                        <div class="common-filter-group">
                            <select id="visitOptions" class="common-filter-input">
                                <option value="">Select Display Option</option>
                                <option value="unvisited">Unvisited HCPs</option>
                                <option value="remaining">Remaining Visits</option>
                                <option value="full">Full List</option>
                            </select>
                        </div>

                        <div class="common-filter-group">
                            <select id="dayFilter" class="common-filter-input">
                                <option value="">All Days</option>
                                <option value="Saturday">Saturday</option>
                                <option value="Sunday">Sunday</option>
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                            </select>
                        </div>
                    </div>
                </header>
                
                <div class="common-card p-4 sm:p-6">
                    <div id="listsLoading" class="flex items-center space-x-2" style="display:none;">
                        <div class="loading-spinner"></div>
                        <span class="text-sm text-gray-600">Loading data...</span>
                    </div>

                    <div id="listsContent">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                            <div id="countDisplay" class="status-count hidden w-full sm:w-auto"></div>
                            <div class="flex gap-2">
                                <button id="filterButton" class="common-button common-button-primary">
                                    Apply Filters
                                </button>
                                <button id="resetButton" class="common-button common-button-secondary">
                                    Reset
                                </button>
                            </div>
                        </div>

                        <div id="listsError" class="hidden text-red-600 mb-4 p-4 bg-red-50 rounded-lg"></div>

                        <!-- Search box above the table - initially hidden -->
                        <div id="searchContainer" class="mb-4 hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                            <input type="text" id="searchBox" class="search-box common-filter-input" placeholder="Search in table data...">
                        </div>

                        <div class="lists-table-container">
                            <table id="hcpTable" class="hidden min-w-full lists-table">
                                <thead>
                                    <tr>
                                        <th class="sticky-col">HCP Name</th>
                                        <th>Specialty</th>
                                        <th>Class</th>
                                        <th>Total Visits</th>
                                        <th>Remaining</th>
                                        <th>Brick</th>
                                        <th>Address</th>
                                        <th>Contact</th>
                                        <th>Sat</th>
                                        <th>Sun</th>
                                        <th>Mon</th>
                                        <th>Tue</th>
                                        <th>Wed</th>
                                        <th>Thu</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="requests-dashboard" class="tab-content">
                <div class="common-card" style="padding: 0;">
                    <div class="requests-header">
                        <div class="requests-header-content">
                            <h1>Requests</h1>
                        </div>
                    </div>
                    <div class="requests-main-content">
                        <div class="requests-filters-section">
                            <div class="requests-filters-grid">
                                <div class="common-filter-group">
                                    <select id="requests_districtManager" class="common-filter-input" onchange="requests_filterMedicalRepsForRequests()">
                                        <option value="">Select District Manager</option>
                                    </select>
                                </div>
                                <div class="common-filter-group">
                                    <select id="requests_medRepFilter" class="common-filter-input" onchange="requests_populateareasForRequests(); requests_filterRequests()">
                                        <option value="">Select Medical Rep</option>
                                    </select>
                                </div>
                                <div class="common-filter-group">
                                    <select id="requests_areaFilter" class="common-filter-input" onchange="requests_filterRequests()">
                                        <option value="">Select area</option>
                                    </select>
                                </div>
                                <div class="common-filter-group">
                                    <select id="requests_statusFilter" class="common-filter-input" onchange="requests_filterRequests()">
                                        <option value="">All Status</option>
                                        <option value="Requested">Requested</option>
                                        <option value="Scheduled">Scheduled</option>
                                        <option value="Pending">Pending</option>
                                        <option value="Postponed">Postponed</option>
                                        <option value="Done">Done</option>
                                        <option value="Rejected">Rejected</option>
                                        <option value="Approved">Approved</option>
                                    </select>
                                </div>
                                <div class="common-filter-group">
                                    <select id="requests_requestTypeFilter" class="common-filter-input" onchange="requests_filterRequests()">
                                        <option value="">All Request Types</option>
                                        <option value="Personal">Personal</option>
                                        <option value="Customer">Customer</option>
                                    </select>
                                </div>
                                <div class="common-filter-group">
                                    <input type="text" id="requests_searchBox" class="common-filter-input" placeholder="Search requests..." oninput="requests_filterRequests()">
                                </div>
                            </div>
                        </div>
                        <div class="requests-stats-bar">
                            <div class="requests-stats-item">
                                <span class="requests-stats-number" id="requests_requestCount">0</span>
                                <span class="requests-stats-label">Total Requests</span>
                            </div>
                            <div class="requests-stats-item">
                                <span class="requests-stats-number" id="requests_filteredCount">0</span>
                                <span class="requests-stats-label">Filtered Results</span>
                            </div>
                        </div>
                        <div id="requests_retrievedRequests">
                            <div id="requests_requestDetailsDisplay" class="requests-grid"></div>
                        </div>
                    </div>
                    <div class="designer-credit">
                        Designed by <strong>DrTahaDesigns</strong>
                    </div>
                </div>
            </div>

            <div id="weekly-plan-dashboard" class="tab-content">
                <header class="common-header">
                    <div class="requests-header-content">
                        <h1><i class="fas fa-calendar-alt"></i> Weekly Plan Dashboard</h1>
                    </div>
                    <div class="filter-controls mt-4 daily-report-header-buttons">
                        <div class="common-filter-group">
                            <select id="weeklyPlanMedicalReps" class="common-filter-input">
                                <option value="">Select a Medical Rep</option>
                            </select>
                        </div>
                        <div class="common-filter-group">
                            <input type="date" id="weeklyPlanStartDate" class="common-filter-input">
                        </div>
                        <div class="common-filter-group">
                            <input type="date" id="weeklyPlanEndDate" class="common-filter-input" readonly>
                        </div>
                        <button id="weeklyPlanResetButton" class="common-button common-button-secondary"><i class="fas fa-redo"></i> Reset</button>
                        <button id="weeklyPlanDownloadButton" class="daily-report-icon-button" title="Download Excel"><i class="fas fa-file-excel"></i></button>
                        <button id="weeklyPlanDeleteVisitButton" class="common-button common-button-danger" style="display:none;"><i class="fas fa-trash-alt"></i> Delete Selected Visit</button>
                    </div>
                </header>

                <div id="weeklyPlanLoading" class="loading-indicator" style="display:none;">
                    <i class="fas fa-spinner"></i> Loading data...
                </div>
                <div id="weeklyPlanError" class="error-message"></div>

                <div id="weeklyPlanContent" class="weekly-plan-grid" style="display: none;">
                    <div class="common-card">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2"><i class="fas fa-sun"></i> AM Activities</h2>
                        </div>
                        <div class="weekly-plan-table-container">
                            <table class="weekly-plan-table" id="amActivitiesTable">
                                <thead>
                                    <tr>
                                        <th id="saturdayAmHeader">Saturday</th>
                                        <th id="sundayAmHeader">Sunday</th>
                                        <th id="mondayAmHeader">Monday</th>
                                        <th id="tuesdayAmHeader">Tuesday</th>
                                        <th id="wednesdayAmHeader">Wednesday</th>
                                        <th id="thursdayAmHeader">Thursday</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td id="saturdayAm"><div class="empty-message">No activities</div></td>
                                        <td id="sundayAm"><div class="empty-message">No activities</div></td>
                                        <td id="mondayAm"><div class="empty-message">No activities</div></td>
                                        <td id="tuesdayAm"><div class="empty-message">No activities</div></td>
                                        <td id="wednesdayAm"><div class="empty-message">No activities</div></td>
                                        <td id="thursdayAm"><div class="empty-message">No activities</div></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="common-card">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2"><i class="fas fa-moon"></i> PM Activities</h2>
                        </div>
                        <div class="weekly-plan-table-container">
                            <table class="weekly-plan-table" id="pmActivitiesTable">
                                <thead>
                                    <tr>
                                        <th id="saturdayPmHeader">Saturday</th>
                                        <th id="sundayPmHeader">Sunday</th>
                                        <th id="mondayPmHeader">Monday</th>
                                        <th id="tuesdayPmHeader">Tuesday</th>
                                        <th id="wednesdayPmHeader">Wednesday</th>
                                        <th id="thursdayPmHeader">Thursday</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td id="saturdayPm"><div class="empty-message">No activities</div></td>
                                        <td id="sundayPm"><div class="empty-message">No activities</div></td>
                                        <td id="mondayPm"><div class="empty-message">No activities</div></td>
                                        <td id="tuesdayPm"><div class="empty-message">No activities</div></td>
                                        <td id="wednesdayPm"><div class="empty-message">No activities</div></td>
                                        <td id="thursdayPm"><div class="empty-message">No activities</div></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Floating box for red rows (KPI Dashboard) -->
    <div class="floating-box" id="floatingBox"></div>

    <!-- Custom Confirmation Modal -->
    <div id="customConfirmModal" class="custom-modal-overlay" style="display:none;">
        <div class="custom-modal-content">
            <p id="confirmModalMessage"></p>
            <div class="custom-modal-buttons">
                <button id="confirmYes" class="confirm-yes">Yes</button>
                <button id="confirmNo" class="confirm-no">No</button>
            </div>
        </div>
    </div>

    <script>
// Supabase and Google Sheet URLs - Consolidated
const SUPABASE_URL = 'https://plmevfyxpngzymvzvkzn.supabase.co/rest/v1/';
const SUPABASE_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBsbWV2Znl4cG5nenltdnp2a3puIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NjM5NDEsImV4cCI6MjA2NjMzOTk0MX0.lUm3efHFCL3aAB-PL7H54BpnvcpbXxp1BeUzw0yjp5c'; 
const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRcnOTUUiyczqtn1s8zhVfYGARkjx-xfT621A9AX7jw3TxmvnBbdc-BZ_EjuOk1uahqY7s5FcdFvQKm/pub?output=csv';

// Supabase Client
const supabaseClient = supabase.createClient('https://plmevfyxpngzymvzvkzn.supabase.co', SUPABASE_API_KEY);

// Global variables to store fetched data
let allMedicalRepsData = {};
let allVisitsData = [];
let allGoogleSheetData = [];
let medicalRepsForDailyReport = [];

// Global variables for Lists Dashboard
let listsGoogleData = [];
let listsVisitCounts = {};
let listsBricks = new Set();
let listsSelectedBricks = [];
let listsFilteredHCPs = [];
let listsCurrentMonthVisits = []; // Added for Lists Dashboard

// Global variables for Requests Dashboard
let requests_districtManagers = new Set();
let requests_medicalReps = new Map();
let requests_areasByMedRep = new Map();
let requests_allRequests = [];

// Global variables for Weekly Plan Dashboard
let weeklyPlan = {
    Saturday: { am: [], pm: [] },
    Sunday: { am: [], pm: [] },
    Monday: { am: [], pm: [] },
    Tuesday: { am: [], pm: [] },
    Wednesday: { am: [], pm: [] },
    Thursday: { am: [], pm: [] }
};
let weeklyPlanSelectedVisitIds = []; // Renamed to avoid conflict

// Global user role and DM information - Now populated from iframe or default
let loggedInUserRole = null;
let loggedInUserDM = null;
let loggedInUserGovernorates = [];
let loggedInUserAreas = []; // Added for MR area display

// State for visits table view (normal, leaves, archived)
let currentVisitsTableView = 'normal';
let archivedVisitsData = [];

// Pagination constant
const PAGE_SIZE = 1000; 

// Global variable to store the currently displayed visits data for HCP filtering
let currentDisplayedVisitsData = [];

// Global variable for Daily Report raw visits data for Excel export
let dailyReportRawVisitsData = [];

// Global variable for central DM filter selection
let selectedDistrictManagerFilter = '';

// --- Auto-Login/User Detection from iframe ---
function getIframeUserInfo() {
    try {
        // Attempt to get user info from parent iframe's dataset
        if (window.frameElement && window.frameElement.dataset) {
            const username = window.frameElement.dataset.username;
            const title = window.frameElement.dataset.title; // 'admin' or 'District Manager'
            if (username && title) {
                console.log("User info from iframe:", { username, title });
                return { username: username, title: title };
            }
        }
    } catch (e) {
        console.warn("Could not access iframe parent data directly:", e);
    }
    // If iframe data is not available, return null for username and title.
    // This ensures no default admin access if not explicitly set by the iframe.
    console.warn("User info not found in iframe dataset. Defaulting to a restricted 'Guest' role (null username/title). Please ensure your iframe has data-username and data-title attributes.");
    return { username: null, title: null };
}

// --- Common Dashboard Initialization ---
async function initializeCommonDashboard() {
    const userInfo = getIframeUserInfo();
    loggedInUserRole = userInfo.title;
    loggedInUserDM = userInfo.username; // This will be the DM name for DMs, or 'AdminUser' for admin

    // Display user info
    if (loggedInUserDM) {
        $('#loggedInUsernameDisplay').text(loggedInUserDM);
        // Fetch governorates/areas for the logged-in user
        if (allGoogleSheetData.length === 0) {
            const response = await fetch(GOOGLE_SHEET_URL);
            if (!response.ok) {
                throw new Error('Failed to fetch Google Sheet data for user info display.');
            }
            const csvText = await response.text();
            allGoogleSheetData = parseCSV(csvText);
        }

        const dmGovernorates = new Set();
        const dmAreas = new Set();
        allGoogleSheetData.forEach(row => {
            if (row['District Manager'] === loggedInUserDM) {
                if (row['Governorate']) {
                    dmGovernorates.add(row['Governorate'].trim());
                }
                if (row['area']) {
                    dmAreas.add(row['area'].trim());
                }
            }
        });
        loggedInUserGovernorates = Array.from(dmGovernorates);
        loggedInUserAreas = Array.from(dmAreas);

        if (loggedInUserRole === 'District Manager' && loggedInUserGovernorates.length > 0) {
            $('#loggedInUserGovernorates').html(`(${loggedInUserGovernorates.join(', ')})`);
        } else if (loggedInUserRole === 'Medical Representative' && loggedInUserAreas.length > 0) {
             $('#loggedInUserGovernorates').html(`(Area: ${loggedInUserAreas.join(', ')})`);
        } else {
            $('#loggedInUserGovernorates').text('');
        }
    }

    // Initialize the default active tab
    openTab(null, 'kpi-dashboard');

    // Pre-load Google Sheet data once for all dashboards
    fetchMedicalRepsData().then(() => {
        // Set initial DM filter based on user role
        if (loggedInUserRole === 'District Manager' && loggedInUserDM) {
            selectedDistrictManagerFilter = loggedInUserDM;
            $('#kpiDistrictManagerSelect').val(loggedInUserDM).prop('disabled', true);
        } else if (loggedInUserRole === 'admin') {
            selectedDistrictManagerFilter = ''; // Admin starts with 'All DMs'
            $('#kpiDistrictManagerSelect').prop('disabled', false);
        } else {
            // For a regular Medical Representative, disable the DM filter and set to their DM
            const repDM = allGoogleSheetData.find(row => row['medical rep'] === loggedInUserDM)?.['District Manager'];
            if (repDM) {
                selectedDistrictManagerFilter = repDM;
                $('#kpiDistrictManagerSelect').val(repDM).prop('disabled', true);
            } else {
                selectedDistrictManagerFilter = ''; // Fallback if DM not found for MR or unknown role
                $('#kpiDistrictManagerSelect').prop('disabled', true);
            }
        }

        // Initialize each dashboard when the common data is ready
        initKpiDashboard();
        initDailyReportDashboard();
        initListsDashboard(); 
        requests_initRequestsDashboard(); 
        initWeeklyPlanDashboard(); 
    }).catch(error => {
        console.error("Failed to load essential common data:", error);
        showAlertDialog("Failed to load essential data. Please refresh the page and verify Google Sheet URL and publishing settings.");
    });
}

// Tab switching logic
function openTab(evt, tabName) {
    // Reset any previously opened sub-tables or specific UI elements
    $('#visitsTableContainer').hide(); // Hide KPI overview table
    $('#selectedRepName').text(''); // Clear selected rep name in KPI
    $('#kpi-dashboard .rep-name').removeClass('active'); // Deactivate any active rep name in KPI table
    currentVisitsTableView = 'normal'; // Reset KPI table view
    $('#leavesFilterOptions').hide(); // Hide KPI leaves filter options
    $('#searchInput').val(''); // Clear KPI search input

    // Hide all tab content and remove active class from all buttons
    $('.tab-content').hide();
    $('.tab-button').removeClass('active');
    
    // Show the selected tab content and add active class to the clicked button
    $(`#${tabName}`).show();
    if (evt) {
        $(evt.currentTarget).addClass('active');
    } else {
        // If called without an event (e.g., on initial load), find the button and activate it
        $(`.tab-button[onclick*="'${tabName}'"]`).addClass('active');
    }

    // Call specific initialization functions when a tab is opened
    // These functions will now handle their own data fetching and filtering based on user role
    // and the central DM filter.
    if (tabName === 'kpi-dashboard') initKpiDashboard();
    else if (tabName === 'daily-report') initDailyReportDashboard();
    else if (tabName === 'lists-dashboard') initListsDashboard();
    else if (tabName === 'requests-dashboard') requests_initRequestsDashboard();
    else if (tabName === 'weekly-plan-dashboard') initWeeklyPlanDashboard();
}

// Custom Modal for Confirmations
function showConfirmModal(message) {
    return new Promise((resolve) => {
        const modal = $('#customConfirmModal');
        $('#confirmModalMessage').text(message);
        modal.show();

        $('#confirmYes').off('click').on('click', function() {
            modal.hide();
            resolve(true);
        });
        $('#confirmNo').off('click').on('click', function() {
            modal.hide();
            resolve(false);
        });
    });
}

// Custom Modal for Alerts
function showAlertDialog(message, type = 'info') {
    const messageBox = document.createElement('div');
    messageBox.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 20px;
        border-radius: 6px;
        font-family: 'Inter', sans-serif;
        font-size: 0.85rem;
        font-weight: 500;
        color: white;
        z-index: 1000;
        box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        animation: fadeIn 0.4s forwards, fadeOut 0.4s 2.2s forwards;
    `;

    if (type === 'error') {
        messageBox.style.backgroundColor = '#e53e3e';
    } else if (type === 'success') {
        messageBox.style.backgroundColor = '#38a169';
    } else {
        messageBox.style.backgroundColor = '#3182ce';
    }

    messageBox.textContent = message;
    document.body.appendChild(messageBox);

    const style = document.createElement('style');
    style.innerHTML = `
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(-15px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateX(-50%) translateY(0); }
            to { opacity: 0; transform: translateX(-50%) translateY(-15px); }
        }
    `;
    document.head.appendChild(style);

    setTimeout(() => {
        messageBox.remove();
        style.remove();
    }, 2600);
}

// Parses CSV text into an array of objects
function parseCSV(csvText) {
    const rows = csvText.split('\n').filter(row => row.trim() !== '');
    if (rows.length === 0) return [];
    const headers = rows[0].split(',').map(header => header.trim());
    const data = [];

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i].split(',');
        const rowObject = {};
        headers.forEach((header, index) => {
            rowObject[header] = row[index] ? row[index].trim() : '';
        });
        data.push(rowObject);
    }
    return data;
}

// Populate select dropdowns (generic function)
function populateSelect(selectElementId, items, defaultOptionText, defaultOptionValue = '') {
    const select = $(`#${selectElementId}`);
    select.empty();
    select.append($('<option>', { value: defaultOptionValue, text: defaultOptionText }));
    items.forEach(item => {
        select.append($('<option>', { value: item, text: item }));
    });
}

// Utility function to format date and time
function formatDateTime(dateString) {
    if (!dateString) return '-';
    const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true };
    return new Date(dateString).toLocaleString('en-US', options);
}

// Utility function to format date only
function formatDateOnly(dateString) {
    if (!dateString) return '-';
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    return new Date(dateString).toLocaleDateString('en-US', options);
}

function formatDateForInput(date) {
    return date.toISOString().split('T')[0];
}

// --- KPI Dashboard Functions ---
async function initKpiDashboard() {
    setupMonthDropdown();
    populateKpiDistrictManagers(); // This now handles DM/Admin logic
    
    // KPI Dashboard listeners
    $('#monthSelect').off('change').on('change', function() {
        const [month, year] = $(this).val().split('-').map(Number);
        fetchKPIData(month, year, selectedDistrictManagerFilter);
        $('#visitsTableContainer').hide(); // Hide on filter change
        $('#selectedRepName').text('');
        currentVisitsTableView = 'normal';
        $('#leavesFilterOptions').hide();
        $('#kpi-dashboard .rep-name').removeClass('active'); // Deactivate any active rep name
    });

    $('#syncKpiData').off('click').on('click', function() {
        const [month, year] = $('#monthSelect').val().split('-').map(Number);
        fetchKPIData(month, year, selectedDistrictManagerFilter);
        showAlertDialog('Refreshing KPI data...');
        $('#visitsTableContainer').hide(); // Hide on sync button click
        $('#selectedRepName').text('');
        currentVisitsTableView = 'normal';
        $('#leavesFilterOptions').hide();
        $('#kpi-dashboard .rep-name').removeClass('active'); // Deactivate any active rep name
    });
    
    // CENTRAL DM FILTER LISTENER
    $('#kpiDistrictManagerSelect').off('change').on('change', function() {
        selectedDistrictManagerFilter = $(this).val(); // Update global filter
        const [month, year] = $('#monthSelect').val().split('-').map(Number);
        
        // Re-fetch data for all dashboards based on new central filter
        fetchKPIData(month, year, selectedDistrictManagerFilter);
        initDailyReportDashboard();
        initListsDashboard(); 
        requests_initRequestsDashboard(); 
        initWeeklyPlanDashboard(); 

        $('#visitsTableContainer').hide(); // Hide on filter change
        $('#selectedRepName').text('');
        currentVisitsTableView = 'normal';
        $('#leavesFilterOptions').hide();
        $('#kpi-dashboard .rep-name').removeClass('active'); // Deactivate any active rep name
    });

    $('#leavesButton').off('click').on('click', function() {
        currentVisitsTableView = 'leaves';
        const selectedRep = sessionStorage.getItem('selectedMedicalRep');
        if (selectedRep) {
            displayLeavesForRep(selectedRep);
        } else {
            showAlertDialog("Please select a Medical Representative first from the KPI tables.");
        }
    });

    $('#listButton').off('click').on('click', function() {
        currentVisitsTableView = 'normal';
        const selectedRep = sessionStorage.getItem('selectedMedicalRep');
        if (selectedRep) {
            showVisitsLoading();
            $('#selectedRepName').html(`(${selectedRep})`);
            $('#leavesFilterOptions').hide();
            const [month, year] = $('#monthSelect').val().split('-').map(Number);
            const filteredVisits = allVisitsData.filter(visit =>
                visit.medical_rep === selectedRep &&
                new Date(visit.created_at).getMonth() + 1 === month &&
                new Date(visit.created_at).getFullYear() === year
            );
            currentDisplayedVisitsData = filteredVisits; // Store for HCP filtering
            renderVisitsTable(filteredVisits, 'normal');
            $('#visitsTableContainer').show();
        } else {
            showAlertDialog("Please select a Medical Representative first from the KPI tables.");
        }
    });

    $('#archivedButton').off('click').on('click', function() {
        currentVisitsTableView = 'archived';
        displayArchivedVisits();
    });

    $('input[name="leaveFilter"]').off('change').on('change', function() {
        const selectedRep = sessionStorage.getItem('selectedMedicalRep');
        if (selectedRep && currentVisitsTableView === 'leaves') {
            displayLeavesForRep(selectedRep);
        }
    });

    $('#downloadExcelVisits').off('click').on('click', function() {
        const repName = $('#selectedRepName').text().replace(/[()]/g, '').trim();
        if (!repName) {
            showAlertDialog('Please select a Medical Representative from the KPI tables first.', 'warning');
            return;
        }
        const tableData = [];
        const headers = [];
        $('#visitsTable thead th').each(function() {
            headers.push($(this).text().trim());
        });

        $('#visitsTable tbody tr').each(function() {
            const row = $(this);
            if (row.find('.loading').length === 0 && row.find('td').length > 1) {
                const rowData = {};
                row.find('td').each(function(index) {
                    if (headers[index] !== 'Action') {
                        rowData[headers[index]] = $(this).text().trim();
                    }
                });
                tableData.push(rowData);
            }
        });
        exportToExcel(tableData, repName + '_visits_overview', currentVisitsTableView);
    });

    $('#printVisits').off('click').on('click', function() {
        printVisitsTable();
    });
    
    // Single click to open/toggle visibility of the visits table
    $(document).off('click', '#kpi-dashboard .rep-name').on('click', '#kpi-dashboard .rep-name', function() {
        const repName = $(this).data('rep');
        const selectedDm = $(this).data('dm');
        
        // If this rep is already selected and the table is visible, clicking again will close it
        if ($(this).hasClass('active') && $('#visitsTableContainer').is(':visible')) {
            $('#visitsTableContainer').hide(); // Hide the table
            $(this).removeClass('active'); // Deactivate the rep name
            sessionStorage.removeItem('selectedMedicalRep'); // Clear selected rep
            return; // Exit if already open and clicked to close
        }

        // Otherwise, open/refresh the table for this rep
        $('#selectedRepName').html(`(${repName})`);
        sessionStorage.setItem('selectedMedicalRep', repName);
        sessionStorage.setItem('selectedDistrictManager', selectedDm);
        currentVisitsTableView = 'normal';
        $('#leavesFilterOptions').hide();

        $('#kpi-dashboard .rep-name').removeClass('active');
        $(this).addClass('active');
        showVisitsLoading();

        const [month, year] = $('#monthSelect').val().split('-').map(Number);
        const filteredVisits = allVisitsData.filter(visit =>
            visit.medical_rep === repName &&
            new Date(visit.created_at).getMonth() + 1 === month &&
            new Date(visit.created_at).getFullYear() === year
        );
        currentDisplayedVisitsData = filteredVisits; // Store for HCP filtering

        renderVisitsTable(filteredVisits, 'normal');
        $('#visitsTableContainer').show();

        $('html, body').animate({
            scrollTop: $("#visitsTableContainer").offset().top
        }, 1000);
    });

    // Double click to explicitly close the visits table and scroll up
    $(document).off('dblclick', '#kpi-dashboard .rep-name').on('dblclick', '#kpi-dashboard .rep-name', function() {
        $('#visitsTableContainer').hide(); // Hide the table
        $('#kpi-dashboard .rep-name').removeClass('active'); // Deactivate any active rep name
        sessionStorage.removeItem('selectedMedicalRep'); // Clear selected rep
        // Scroll back up to the KPI dashboard table
        $('html, body').animate({
            scrollTop: $("#kpi-dashboard .common-table-container").offset().top
        }, 1000);
    });

    // Add click listener to the HCP Visits Overview header to hide the table
    $(document).off('click', '#selectedRepName').on('click', '#selectedRepName', function() {
        // Check if the visits table is currently visible
        if ($('#visitsTableContainer').is(':visible')) {
            $('#visitsTableContainer').hide(); // Hide the table
            $('#kpi-dashboard .rep-name').removeClass('active'); // Deactivate any active rep name in KPI table
            sessionStorage.removeItem('selectedMedicalRep'); // Clear selected rep
            // Optionally scroll back up to the KPI dashboard table
            $('html, body').animate({
                scrollTop: $("#kpi-dashboard .common-table-container").offset().top
            }, 1000);
        }
    });


    $(document).off('mouseenter', '#kpi-dashboard .duplicate-visit').on('mouseenter', '#kpi-dashboard .duplicate-visit', function() {
        const visitsData = $(this).data('visits');
        if (!visitsData || visitsData.length === 0) return;
        const visitDates = visitsData.map(visit => formatDateTime(visit.created_at)).join('<br>');
        const floatingBox = $('#floatingBox');
        floatingBox.html(visitDates).css({
            top: $(this).offset().top + $(this).height() + 'px',
            left: $(this).offset().left + 'px',
            display: 'block'
        });
    });

    $(document).off('mouseleave', '#kpi-dashboard .duplicate-visit').on('mouseleave', '#kpi-dashboard .duplicate-visit', function() {
        $('#floatingBox').hide();
    });

    $('#searchInput').off('input').on('input', function() {
        const query = $(this).val().toLowerCase().trim(); // Trim whitespace
        $('#visitsTable tbody tr').each(function() {
            const row = $(this);
            if (row.find('.loading').length > 0 || row.find('td').length <= 1) return;
            const text = row.text().toLowerCase();
            if (text.includes(query)) row.show();
            else row.hide();
        });
    });

    $('#clearSearchButton').off('click').on('click', function() {
        $('#searchInput').val('').trigger('input');
    });

    $(document).off('click', '#kpi-dashboard .archive-button').on('click', '#kpi-dashboard .archive-button', async function() {
        const row = $(this).closest('tr');
        const visitId = $(this).data('id');
        const confirmed = await showConfirmModal('Are you sure you want to archive this visit? It will be moved to archived records.');
        if (!confirmed) return;

        try {
            const { data: visitToArchive, error: fetchError } = await supabaseClient
                .from('healthcarepro_visits') // Changed from hcps_visits2
                .select('*')
                .eq('id', visitId)
                .single();

            if (fetchError) throw fetchError;
            if (!visitToArchive) throw new Error('Visit not found for archiving.');

            const visitToArchiveForArchive = { ...visitToArchive };
            if (visitToArchiveForArchive.visit_place === null || visitToArchiveForArchive.visit_place === undefined) {
                visitToArchiveForArchive.visit_place = '';
            }

            const { error: archiveError } = await supabaseClient
                .from('archived_visits')
                .insert([visitToArchiveForArchive]);

            if (archiveError) throw archiveError;

            const { error: deleteError } = await supabaseClient
                .from('healthcarepro_visits') // Changed from hcps_visits2
                .delete()
                .eq('id', visitId);

            if (deleteError) throw deleteError;

            row.remove();
            showAlertDialog('Visit archived successfully!', 'success');
            const [month, year] = $('#monthSelect').val().split('-').map(Number);
            fetchKPIData(month, year, selectedDistrictManagerFilter);
        } catch (error) {
            console.error('Error archiving visit:', error);
            showAlertDialog('An error occurred while archiving the visit: ' + error.message, 'error');
        }
    });

    $(document).off('click', '#kpi-dashboard .restore-button').on('click', '#kpi-dashboard .restore-button', async function() {
        const row = $(this).closest('tr');
        const visitId = $(this).data('id');
        const confirmed = await showConfirmModal('Are you sure you want to restore this visit? It will be moved back to active records.');
        if (!confirmed) return;

        try {
            const { data: visitToRestore, error: fetchError } = await supabaseClient
                .from('archived_visits')
                .select('*')
                .eq('id', visitId)
                .single();

            if (fetchError) throw fetchError;
            if (!visitToRestore) throw new Error('Visit not found for restoring.');

            const visitToRestoreForActive = { ...visitToRestore };
            if (visitToRestoreForActive.visit_place === null || visitToRestoreForActive.visit_place === undefined) {
                visitToRestoreForActive.visit_place = '';
            }

            const { error: restoreError } = await supabaseClient
                .from('healthcarepro_visits') // Changed from hcps_visits2
                .insert([visitToRestoreForActive]);

            if (restoreError) throw restoreError;

            const { error: deleteError } = await supabaseClient
                .from('archived_visits')
                .delete()
                .eq('id', visitId);

            if (deleteError) throw deleteError;

            row.remove();
            showAlertDialog('Visit restored successfully!', 'success');
            const [month, year] = $('#monthSelect').val().split('-').map(Number);
            fetchKPIData(month, year, selectedDistrictManagerFilter);
            displayArchivedVisits();
        } catch (error) {
            console.error('Error restoring visit:', error);
            showAlertDialog('An error occurred while restoring the visit: ' + error.message, 'error');
        }
    });

    $(document).off('click', '#kpi-dashboard .remove-archived-button').on('click', '#kpi-dashboard .remove-archived-button', async function() {
        const row = $(this).closest('tr');
        const visitId = $(this).data('id');
        const confirmed = await showConfirmModal('Are you sure you want to PERMANENTLY remove this archived visit? This action cannot be undone.');
        if (!confirmed) return;

        try {
            const { error: deleteError } = await supabaseClient
                .from('archived_visits')
                .delete()
                .eq('id', visitId);

            if (deleteError) throw deleteError;

            row.remove();
            showAlertDialog('Archived visit permanently removed!', 'success');
            displayArchivedVisits();
        }
        catch (error) {
            console.error('Error permanently removing archived visit:', error);
            showAlertDialog('An error occurred while permanently removing the archived visit: ' + error.message, 'error');
        }
    });

    const today = new Date();
    const currentMonth = today.getMonth() + 1;
    const currentYear = today.getFullYear();
    $('#monthSelect').val(`${currentMonth}-${currentYear}`);
    
    // Initial fetch based on the determined selectedDistrictManagerFilter
    fetchKPIData(currentMonth, currentYear, selectedDistrictManagerFilter);
}

function showKPILoading() {
    $('#privateVisitsTableBody').html(`
        <tr>
            <td colspan="10" class="loading" style="text-align: center; padding: 20px;">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading PM visits data...</p>
            </td>
        </tr>
    `);
    $('#amVisitsTableBody').html(`
        <tr>
            <td colspan="10" class="loading" style="text-align: center; padding: 20px;">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading AM visits data...</p>
            </td>
        </tr>
    `);
}

function showVisitsLoading() {
    $('#visitsTable tbody').html(`
        <tr>
            <td colspan="9" class="loading" style="text-align: center; padding: 20px;">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading visits data...</p>
            </td>
        </tr>
    `);
}

function clearVisitsTable() {
    $('#visitsTable tbody').empty();
}

async function fetchMedicalRepsData() {
    try {
        if (allGoogleSheetData.length === 0) {
             const response = await fetch(GOOGLE_SHEET_URL);
            if (!response.ok) {
                throw new Error('Failed to fetch medical reps data from Google Sheets. Please ensure the Google Sheet URL is correct and publicly accessible.');
            }
            const csvText = await response.text();
            allGoogleSheetData = parseCSV(csvText);
        }
        return processMedicalRepsData(allGoogleSheetData);
    } catch (error) {
        console.error('Error fetching medical reps data:', error);
        throw error;
    }
}

function processMedicalRepsData(googleSheetData) {
    const data = {};
    const districtManagers = new Set();
    const allMedicalReps = new Set();

    googleSheetData.forEach(row => {
        const repName = row['medical rep'];
        const area = row['area']?.trim() || 'N/A';
        const targetVisitsPerHCP = parseInt(row['T.V'], 10) || 0;
        const hcpName = row['HCPS'];
        let hcpClass = row['Class'];

        const districtManager = row['District Manager'] || 'N/A';

        hcpClass = hcpClass ? hcpClass.trim().toUpperCase() : '';

        if (repName && repName.includes("")) return;

        if (repName) {
            if (!data[repName]) {
                data[repName] = {
                    area: area,
                    totalHCPs: 0,
                    totalHCPs_AB: 0,
                    totalHCPs_UPA_Private: 0,
                    targetVisitsPerHCP: 0,
                    targetVisits_AB: 0,
                    targetVisits_UPA_Private: 0,
                    hcps: [],
                    hcps_AB: [],
                    hcps_UPA_Private: [],
                    districtManager: districtManager
                };
            }
            if (hcpName && hcpName.trim() !== '') {
                data[repName].totalHCPs++;
                data[repName].hcps.push({ name: hcpName, class: hcpClass, target_visits: targetVisitsPerHCP });
                
                if (['A', 'B'].includes(hcpClass)) {
                    data[repName].totalHCPs_AB++;
                    data[repName].hcps_AB.push({ name: hcpName, target_visits: targetVisitsPerHCP });
                    data[repName].targetVisits_AB += targetVisitsPerHCP;
                } else if (['UPA', 'PRIVATE'].includes(hcpClass)) {
                    data[repName].totalHCPs_UPA_Private++;
                    data[repName].hcps_UPA_Private.push({ name: hcpName, target_visits: targetVisitsPerHCP });
                    data[repName].targetVisits_UPA_Private += targetVisitsPerHCP;
                }
            }
            data[repName].targetVisitsPerHCP += targetVisitsPerHCP;
            if (districtManager !== 'N/A') {
                districtManagers.add(districtManager);
            }
            allMedicalReps.add({ name: repName, dm: districtManager });
        }
    });
    medicalRepsForDailyReport = Array.from(allMedicalReps);
    allMedicalRepsData = data;
    return { processedData: data, districtManagers: Array.from(districtManagers).sort() };
}

function populateKpiDistrictManagers() {
    const kpiDmSelect = $('#kpiDistrictManagerSelect');
    kpiDmSelect.empty();
    kpiDmSelect.append($('<option>', { value: '', text: 'All District Managers' }));

    const uniqueDMs = new Set();
    allGoogleSheetData.forEach(row => {
        if (row['District Manager']) {
            uniqueDMs.add(row['District Manager'].trim());
        }
    });
    Array.from(uniqueDMs).sort().forEach(dm => {
        kpiDmSelect.append($('<option>', { value: dm, text: dm }));
    });

    // Set initial selection and disable if DM is logged in
    if (loggedInUserRole === 'District Manager' && loggedInUserDM) {
        kpiDmSelect.val(loggedInUserDM);
        kpiDmSelect.prop('disabled', true); 
    } else if (loggedInUserRole === 'admin') {
        kpiDmSelect.prop('disabled', false); // Admin can select any DM
        kpiDmSelect.val(selectedDistrictManagerFilter); // Set to current filter, which might be ''
    } else {
        // For a regular Medical Representative or unknown role, set their DM and disable
        const repDM = allGoogleSheetData.find(row => row['medical rep'] === loggedInUserDM)?.['District Manager'];
        if (repDM) {
            kpiDmSelect.val(repDM);
        }
        kpiDmSelect.prop('disabled', true); 
    }
}

/**
 * Fetches visits data from Supabase with pagination.
 * @param {number} month - The month to fetch data for (1-12).
 * @param {number} year - The year to fetch data for.
 * @returns {Promise<Array>} A promise that resolves to an array of all fetched visits.
 */
async function fetchVisitsData(month, year) {
    const startDate = new Date(year, month - 1, 1);
    const endDate = new Date(year, month, 0);
    endDate.setHours(23, 59, 59, 999);

    let allData = [];
    let offset = 0;
    let hasMore = true;

    try {
        while (hasMore) {
            const { data, error } = await supabaseClient
                .from('healthcarepro_visits')
                .select('id,medical_rep,hcp_name,created_at,specialty,brick,target_visits,remaining_visits,comments,visit_place')
                .gte('created_at', startDate.toISOString())
                .lte('created_at', endDate.toISOString())
                .range(offset, offset + PAGE_SIZE - 1); // Supabase range is inclusive

            if (error) {
                throw error;
            }

            allData = allData.concat(data);
            if (data.length < PAGE_SIZE) {
                hasMore = false; // No more data to fetch
            } else {
                offset += PAGE_SIZE;
            }
        }
        allVisitsData = allData; // Store the fetched data globally
        return allData;
    } catch (error) {
        console.error('Error fetching visits data with pagination:', error);
        throw error;
    }
}

async function fetchKPIData(month, year, currentDmFilter) { // Renamed selectedKpiDm to currentDmFilter for clarity
    showKPILoading();
    try {
        const { processedData: medicalRepsProcessedData, districtManagers } = await fetchMedicalRepsData();
        const visitsData = await fetchVisitsData(month, year);

        const workingDaysMap = calculateUnifiedWorkingDays(visitsData, allGoogleSheetData, month, year);
        const filteredVisitsData = filterRecentVisits(visitsData, medicalRepsProcessedData, month, year);

        let pmVisitsMetrics = calculateMetrics(medicalRepsProcessedData, filteredVisitsData, ['A', 'B']);
        let amVisitsMetrics = calculateMetrics(medicalRepsProcessedData, filteredVisitsData, ['UPA', 'PRIVATE']);

        // --- Start of refined filtering logic for data display ---
        let finalPmMetrics = [];
        let finalAmMetrics = [];

        if (loggedInUserRole === 'admin') {
            // Admin can see all or filter by selected DM
            if (currentDmFilter) {
                finalPmMetrics = pmVisitsMetrics.filter(metric => metric.districtManager === currentDmFilter);
                finalAmMetrics = amVisitsMetrics.filter(metric => metric.districtManager === currentDmFilter);
            } else {
                finalPmMetrics = pmVisitsMetrics; // Show all if no DM selected
                finalAmMetrics = amVisitsMetrics;
            }
        } else if (loggedInUserRole === 'District Manager' && loggedInUserDM) {
            // DM can only see their own reps
            finalPmMetrics = pmVisitsMetrics.filter(metric => metric.districtManager === loggedInUserDM);
            finalAmMetrics = amVisitsMetrics.filter(metric => metric.districtManager === loggedInUserDM);
        } else if (loggedInUserRole === 'Medical Representative' && loggedInUserDM) {
            // MR can only see their own data
            finalPmMetrics = pmVisitsMetrics.filter(metric => metric.repName === loggedInUserDM);
            finalAmMetrics = amVisitsMetrics.filter(metric => metric.repName === loggedInUserDM);
        } else {
            // Default for unknown/guest users: show nothing
            finalPmMetrics = [];
            finalAmMetrics = [];
        }
        // --- End of refined filtering logic for data display ---

        finalPmMetrics.forEach(metric => {
            metric.workingDays = workingDaysMap[metric.repName] || 0;
        });
        const calculatedPmMetrics = calculateAverageVisits(finalPmMetrics, filteredVisitsData, ['A', 'B']);
        updateKPITableRows(calculatedPmMetrics, 'privateVisitsTableBody');

        calculatedAmMetrics.forEach(metric => { // Corrected variable name from finalAmMetrics to calculatedAmMetrics
            metric.workingDays = workingDaysMap[metric.repName] || 0;
        });
        const calculatedAmMetrics = calculateAverageVisits(finalAmMetrics, filteredVisitsData, ['UPA', 'PRIVATE']);
        updateKPITableRows(calculatedAmMetrics, 'amVisitsTableBody');

        const activeKpiTab = $('.kpi-tab-button.active').data('tab-id');
        $('.kpi-table-content').removeClass('active').hide();
        $(`#${activeKpiTab}`).addClass('active').show();

        populateDailyReportMedReps(); // Ensure this is called to update other dropdowns

    } catch (error) {
        console.error("Error in fetchKPIData:", error);
        showAlertDialog('Error loading dashboard data. Please check console for details and verify Google Sheet URL/publishing settings.');
    }
}

function filterRecentVisits(visitsData, medicalRepsData, month, year) {
    const selectedMonth = month;
    const selectedYear = year;

    return visitsData.filter(visit => {
        const visitDate = new Date(visit.created_at);
        const hcpName = visit.hcp_name;
        const repName = visit.medical_rep;
        const isCurrentMonth = visitDate.getMonth() + 1 === selectedMonth && visitDate.getFullYear() === selectedYear;
        const isHCPInMedicalReps = medicalRepsData[repName] && medicalRepsData[repName].hcps.some(hcp => hcp.name === hcpName);
        return isCurrentMonth && isHCPInMedicalReps; 
    });
}

function calculateMetrics(medicalRepsData, visitsData, hcpClasses) {
    const metrics = {};

    for (const rep in medicalRepsData) {
        metrics[rep] = {
            repName: rep,
            area: medicalRepsData[rep].area,
            totalHCPs: 0,
            visitedCount: 0,
            uniqueHCPs: new Set(),
            hcps: [],
            targetVisitsForClass: 0,
            districtManager: medicalRepsData[rep].districtManager || 'N/A',
            workingDays: 0,
            hcpVisitCounts: {}
        };

        if (hcpClasses.includes('A') && hcpClasses.includes('B')) {
            metrics[rep].totalHCPs = medicalRepsData[rep].totalHCPs_AB || 0;
            metrics[rep].hcps = medicalRepsData[rep].hcps_AB || [];
            metrics[rep].targetVisitsForClass = medicalRepsData[rep].targetVisits_AB || 0;
        } else if (hcpClasses.includes('UPA') && hcpClasses.includes('PRIVATE')) {
            metrics[rep].totalHCPs = medicalRepsData[rep].totalHCPs_UPA_Private || 0;
            metrics[rep].hcps = medicalRepsData[rep].hcps_UPA_Private || [];
            metrics[rep].targetVisitsForClass = medicalRepsData[rep].targetVisits_UPA_Private || 0;
        }

        metrics[rep].hcps.forEach(hcp => {
            metrics[rep].hcpVisitCounts[hcp.name] = { currentVisits: 0, targetVisits: hcp.target_visits };
        });
    }

    visitsData.forEach(visit => {
        const { medical_rep, hcp_name, specialty } = visit;
        const hcpInfo = allGoogleSheetData.find(row => row['medical rep'] === medical_rep && row['HCPS'] === hcp_name);
        const hcpClass = hcpInfo ? hcpInfo['Class'].trim().toUpperCase() : null;

        if (hcpClass && hcpClasses.includes(hcpClass)) {
            if (specialty.toLowerCase() === 'pharmacy' || specialty.toLowerCase().includes('event(') || specialty.toLowerCase().includes('am(')) {
                return;
            }

            if (metrics[medical_rep] && metrics[medical_rep].hcpVisitCounts[hcp_name]) {
                const hcpMetrics = metrics[medical_rep].hcpVisitCounts[hcp_name];
                
                if (hcpMetrics.currentVisits < hcpMetrics.targetVisits) {
                    metrics[medical_rep].visitedCount++;
                    metrics[medical_rep].uniqueHCPs.add(hcp_name);
                    hcpMetrics.currentVisits++;
                }
            }
        }
    });

    const result = [];
    for (const rep in metrics) {
        const totalHCPCount = metrics[rep].totalHCPs; 
        const uniqueHCPCount = metrics[rep].uniqueHCPs.size;
        
        // Fix for unvisitedHCPs: calculate directly
        const unvisitedHCPs = totalHCPCount - uniqueHCPCount;
        
        const coverage = uniqueHCPCount;
        const coveragePercentage = totalHCPCount > 0 ? ((coverage / totalHCPCount) * 100).toFixed(2) : 0;
        
        const frequency = metrics[rep].visitedCount;
        const targetFrequency = metrics[rep].targetVisitsForClass;
        const frequencyPercentage = targetFrequency > 0 ? ((frequency / targetFrequency) * 100).toFixed(2) : 0;

        result.push({
            repName: rep,
            area: medicalRepsData[rep].area,
            totalHCPCount,
            unvisitedHCPs, 
            coverage,
            coveragePercentage,
            frequency,
            targetVisitsForClass: targetFrequency,
            frequencyPercentage,
            districtManager: metrics[rep].districtManager,
            workingDays: metrics[rep].workingDays,
            hcps: metrics[rep].hcps
        });
    }
    return result;
}

function updateKPITableRows(data, tableBodyId) {
    let filteredData = data;
    filteredData.sort((a, b) => parseFloat(b.coveragePercentage) - parseFloat(a.coveragePercentage));
    const tableBody = document.getElementById(tableBodyId);
    tableBody.innerHTML = '';
    if (filteredData.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="10" style="text-align: center; padding: 20px;">No data available for the selected filters.</td></tr>`;
        return;
    }

    filteredData.forEach((row, index) => {
        const tr = document.createElement('tr');
        let coverageClass = '';
        if (index === 0) coverageClass = 'highest-coverage';
        if (index === filteredData.length - 1) coverageClass = 'lowest-coverage';
        const coverageProgressClass = row.coveragePercentage >= 75 ? 'success' : (row.coveragePercentage >= 50 ? 'warning' : 'danger');
        const frequencyProgressClass = row.frequencyPercentage >= 75 ? 'success' : (row.frequencyPercentage >= 50 ? 'warning' : 'danger');

        tr.innerHTML = `
            <td class="rep-name ${coverageClass}" data-rep="${row.repName}" data-dm="${row.districtManager}">${row.repName}</td>
            <td>${row.area || 'N/A'}</td>
            <td>${row.totalHCPCount}</td>
            <td class="unvisited">${row.unvisitedHCPs}</td>
            <td>${row.coverage}/${row.totalHCPCount}</td>
            <td>
                <div class="progress-bar">
                    <div class="progress progress-coverage ${coverageProgressClass}" style="width: ${row.coveragePercentage}%;"></div>
                    <div class="progress-text-container">${row.coveragePercentage}%</div>
                </div>
            </td>
            <td>${row.frequency}/${row.targetVisitsForClass}</td>
            <td>
                <div class="progress-bar">
                    <div class="progress progress-frequency ${frequencyProgressClass}" style="width: ${row.frequencyPercentage}%;"></div>
                    <div class="progress-text-container">${row.frequencyPercentage}%</div>
                </div>
            </td>
            <td>${row.workingDays || 0}</td>
            <td class="pm-call-rate" data-rep="${row.repName}">${row.averageVisits || 0}</td>
        `;
        tableBody.appendChild(tr);
    });

    // Add click event listeners to the "PM Call Rate" cells
    document.querySelectorAll('.pm-call-rate').forEach(cell => {
        cell.addEventListener('click', function() {
            const repName = this.getAttribute('data-rep');
            showFloatingBox(repName);
        });
    });
}

function showFloatingBox(repName) {
    const floatingBox = document.getElementById('floatingBox');
    
    // Step 1: Filter all data for the specific representative
    const repData = allVisitsData.filter(visit => visit.medical_rep === repName);

    // Step 2: Filter specifically for visits to clinics
    // Ensure 'visit_place' exists and case-insensitively includes 'clinic'
    const clinicVisits = repData.filter(visit => 
        visit.visit_place && typeof visit.visit_place === 'string' && visit.visit_place.toLowerCase().includes('clinic')
    );
    
    // Calculate the number of clinic visits
    const clinicVisitCount = clinicVisits.length;

    // Step 3: Get the number of working days (excluding leaves and full-day events)
    const workingDays = getWorkingDays(repName); 
    
    // Step 4: Calculate the call rate
    let callRate;
    if (workingDays > 0) {
        // Perform the division and format to two decimal places
        callRate = (clinicVisitCount / workingDays).toFixed(2);
    } else {
        // Handle cases where workingDays is zero to avoid division by zero
        callRate = '0.00'; 
    }

    // Update the floating box content
    floatingBox.innerHTML = `
        <div>
            <p>Private Clinics: ${clinicVisitCount}</p>
            <p>Call Rate: ${callRate}</p>
        </div>
    `;

    // Position the floating box
    const cell = document.querySelector(`.pm-call-rate[data-rep="${repName}"]`);
    if (cell) {
        const rect = cell.getBoundingClientRect();
        floatingBox.style.position = 'absolute';
        floatingBox.style.top = `${rect.bottom + window.scrollY}px`;
        floatingBox.style.left = `${rect.left + window.scrollX}px`;
        floatingBox.style.display = 'block';
    }
}

// Function to get working days, excluding leave and full-day event entries
function getWorkingDays(repName) {
    const repVisits = allVisitsData.filter(visit => visit.medical_rep === repName);
    const workingDaysSet = new Set();
    const leaveKeywords = ['annual leave', 'official vacation', 'casual leave', 'sick leave', 'leave', 'vacation'];
    const eventSpecialties = ['event(full day activity)']; // Only full day events should be excluded from working days

    repVisits.forEach(visit => {
        const visitDate = new Date(visit.created_at);
        const dateKey = visitDate.toISOString().split('T')[0];
        const hcpNameLower = visit.hcp_name ? visit.hcp_name.toLowerCase() : '';
        const specialtyLower = visit.specialty ? visit.specialty.toLowerCase() : '';

        // Exclude days that are explicitly leaves or full-day events
        const isLeave = leaveKeywords.some(keyword => hcpNameLower.includes(keyword));
        const isFullDayEvent = eventSpecialties.includes(specialtyLower);

        if (!isLeave && !isFullDayEvent) {
            workingDaysSet.add(dateKey);
        }
    });

    return workingDaysSet.size;
}


// Close the floating box when clicking outside
document.addEventListener('click', function(event) {
    const floatingBox = document.getElementById('floatingBox');
    if (!event.target.closest('.pm-call-rate') && !event.target.closest('#floatingBox')) {
        floatingBox.style.display = 'none';
    }
});

function renderVisitsTable(data, tableType = 'normal') {
    const tableBody = $('#visitsTable tbody');
    const tableHeader = $('#visitsTableHeader');
    tableBody.empty();

    if (tableType === 'normal') {
        tableHeader.html(`
            <th><i class="fas fa-user-doctor"></i> HCP Name</th>
            <th><i class="fas fa-stethoscope"></i> Specialty</th>
            <th><i class="fas fa-building"></i> Brick</th>
            <th><i class="fas fa-map-marker-alt"></i> Visit Place</th>
            <th><i class="fas fa-bullseye"></i> Target</th>
            <th><i class="fas fa-clock"></i> Remaining</th>
            <th><i class="fas fa-comments"></i> Comments</th>
            <th><i class="fas fa-calendar-alt"></i> Visit Time</th>
            <th class="action-column">Action</th>
        `);
    } else if (tableType === 'leaves') {
        tableHeader.html(`
            <th><i class="fas fa-calendar-times"></i> Leave Type</th>
            <th><i class="fas fa-clock"></i> Leave Duration</th>
            <th><i class="fas fa-comments"></i> Comments</th>
            <th><i class="fas fa-calendar-alt"></i> Date</th>
            <th class="action-column">Action</th>
        `);
    } else if (tableType === 'archived') {
         tableHeader.html(`
            <th><i class="fas fa-user-doctor"></i> HCP Name</th>
            <th><i class="fas fa-stethoscope"></i> Specialty</th>
            <th><i class="fas fa-building"></i> Brick</th>
            <th><i class="fas fa-map-marker-alt"></i> Visit Place</th>
            <th><i class="fas fa-bullseye"></i> Target</th>
            <th><i class="fas fa-clock"></i> Remaining</th>
            <th><i class="fas fa-comments"></i> Comments</th>
            <th><i class="fas fa-calendar-alt"></i> Visit Time</th>
            <th class="action-column">Action</th>
        `);
    }

    if (data.length === 0) {
         tableBody.append(`<tr><td colspan="${tableType === 'leaves' ? 5 : 9}" style="text-align: center; padding: 20px;">No data available for this view.</td></tr>`);
        return;
    }

    data.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

    const dailyFirstVisits = new Map();
    const previousVisits = {};

    data.forEach(item => {
        const visitDate = new Date(item.created_at).toLocaleDateString();
        if (!dailyFirstVisits.has(visitDate)) {
            dailyFirstVisits.set(visitDate, item.created_at);
            item.isFirstOfDay = true;
        } else {
            item.isFirstOfDay = false;
        }

        if (previousVisits[item.hcp_name]) {
            const lastVisitDate = new Date(previousVisits[item.hcp_name]);
            const currentVisitDate = new Date(item.created_at);
            const dayDifference = (currentVisitDate - lastVisitDate) / (1000 * 60 * 60 * 24);
            item.isDuplicate = dayDifference < 6;
        } else {
            item.isDuplicate = false;
        }
        previousVisits[item.hcp_name] = item.created_at;
    });

    data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

    data.forEach(item => {
        let rowClasses = [];
        const specialEvents = ['event', 'training', 'meeting'];
        const leaveTypes = ['annual leave', 'Official vacation', 'casual leave', 'sick leave'];
        const hcpNameLower = item.hcp_name ? item.hcp_name.toLowerCase() : '';
        const specialtyLower = item.specialty ? item.specialty.toLowerCase() : '';

        const isSpecialEvent = specialEvents.some(event => hcpNameLower.includes(event));
        const isLeave = leaveTypes.some(leave => hcpNameLower.includes(leave));
        
        if (isSpecialEvent) rowClasses.push('event-training-meeting');
        else if (isLeave) rowClasses.push('leave-row');
        
        if (item.isFirstOfDay) rowClasses.push('first-visit-of-day');
        
        if (item.isDuplicate) rowClasses.push('duplicate-visit');
        if (item.specialty && item.specialty.toLowerCase() === 'pharmacy') rowClasses.push('pharmacy-hcp');
        
        if (item.remaining_visits !== null && parseInt(item.remaining_visits) < 0) {
            rowClasses.push('negative-remaining-row');
        }

        let hcpNameCellClass = '';
        if (specialtyLower.startsWith('am(')) hcpNameCellClass = 'am-specialty-hcp';

        let rowHtml = '';
        if (tableType === 'normal' || tableType === 'archived') { 
            rowHtml = `
                <tr class="${rowClasses.join(' ')}" data-visits='${JSON.stringify(data.filter(visit => visit.hcp_name === item.hcp_name))}'>
                    <td class="${hcpNameCellClass} hcp-name-cell" data-hcp-name="${item.hcp_name || ''}">${item.hcp_name || '-'}</td>
                    <td>${item.specialty || '-'}</td>
                    <td>${item.brick || '-'}</td>
                    <td>${item.visit_place || '-'}</td>
                    <td>${item.target_visits || '-'}</td>
                    <td>${item.remaining_visits || '-'}</td>
                    <td>${item.comments || '-'}</td>
                    <td class="visit-time">${formatDateTime(item.created_at)}</td>
                    <td>
                        ${tableType === 'normal' ? `<button class="archive-button" data-id="${item.id}" title="Archive Visit"><i class="fas fa-archive"></i></button>` : ''}
                        ${tableType === 'archived' ? `
                            <button class="restore-button" data-id="${item.id}" title="Restore Visit"><i class="fas fa-undo"></i></button>
                            ${loggedInUserRole === 'admin' ? `<button class="remove-archived-button" data-id="${item.id}" title="Remove Permanently"><i class="fas fa-trash-alt"></i></button>` : ''}
                        ` : ''}
                    </td>
                </tr>
            `;
        } else if (tableType === 'leaves') {
            rowHtml = `
                <tr class="${rowClasses.join(' ')}">
                    <td class="hcp-name-cell" data-hcp-name="${item.hcp_name || ''}">${item.hcp_name || '-'}</td>
                    <td>${item.specialty || '-'}</td>
                    <td>${item.comments || '-'}</td>
                    <td>${formatDateOnly(item.created_at)}</td>
                    <td></td>
                </tr>
            `;
        }
        tableBody.append(rowHtml);
    });

    // Add double-click event listener to HCP Name cells
    $('#visitsTable tbody .hcp-name-cell').off('dblclick').on('dblclick', function() {
        const clickedHcpName = $(this).data('hcp-name');
        filterVisitsTableByHCP(clickedHcpName);
    });

    // Add a double-click listener to the HCP Name header to clear filter
    $('#visitsTable thead th:first-child').off('dblclick').on('dblclick', function() {
        clearHCPFilter();
    });
}

// Function to filter visits table by HCP name
function filterVisitsTableByHCP(hcpName) {
    const tableBody = $('#visitsTable tbody');
    const rows = tableBody.find('tr');

    // If already filtered by this HCP, clear the filter
    if ($('#visitsTable').data('filtered-hcp') === hcpName) {
        clearHCPFilter();
        return;
    }

    rows.each(function() {
        const rowHcpName = $(this).find('.hcp-name-cell').data('hcp-name');
        if (rowHcpName && rowHcpName === hcpName) {
            $(this).show();
        } else {
            $(this).hide();
        }
    });
    $('#visitsTable').data('filtered-hcp', hcpName); // Store the current filter
    $('#searchInput').val(hcpName).trigger('input'); // Update search input
    showAlertDialog(`Showing visits for: ${hcpName}`, 'info');
}

// Function to clear HCP filter
function clearHCPFilter() {
    $('#visitsTable tbody tr').show();
    $('#visitsTable').removeData('filtered-hcp'); // Clear stored filter
    $('#searchInput').val(''); // Clear search input
    showAlertDialog('HCP filter cleared. Showing all visits.', 'info');
}

function calculateUnifiedWorkingDays(visitsData, googleSheetData, month, year) {
    const workingDaysMap = {};
    // Ensure all variations of leave are covered, including "Official vacation"
    const leaveKeywords = ['annual leave', 'official vacation', 'casual leave', 'sick leave', 'leave', 'vacation'];

    visitsData.forEach(visit => {
        const repName = visit.medical_rep;
        const visitDate = new Date(visit.created_at);
        const visitDateKey = visitDate.toISOString().split('T')[0];

        // Filter visits for the specified month and year
        if (visitDate.getMonth() + 1 !== month || visitDate.getFullYear() !== year) {
            return;
        }

        const hcpNameLower = visit.hcp_name ? visit.hcp_name.toLowerCase() : '';

        // Determine if the visit is a leave, using a single, comprehensive check
        // We use .some() to check if any of the keywords are present in hcpNameLower
        const isLeave = leaveKeywords.some(keyword => hcpNameLower.includes(keyword));

        if (!isLeave) {
            if (!workingDaysMap[repName]) {
                workingDaysMap[repName] = new Set();
            }
            workingDaysMap[repName].add(visitDateKey);
        }
    });

    const finalWorkingDays = {};
    for (const rep in workingDaysMap) {
        finalWorkingDays[rep] = workingDaysMap[rep].size;
    }

    return finalWorkingDays;
}



function calculateAverageVisits(metrics, visitsData, hcpClasses) {
    const selectedMonth = parseInt($('#monthSelect').val().split('-')[0]);
    const selectedYear = parseInt($('#monthSelect').val().split('-')[1]);
    const leaveTypes = ['annual leave', 'Official vacation', 'casual leave', 'sick leave'];
    const eventSpecialties = ['event(am activity)', 'event(pm activity)', 'event(full day activity)'];

    metrics.forEach(metric => {
        const repVisits = visitsData.filter(visit => visit.medical_rep === metric.repName);
        
        const hcpActualVisits = {};
        if (Array.isArray(metric.hcps)) { 
            metric.hcps.forEach(hcp => { 
                hcpActualVisits[hcp.name] = { count: 0, target: hcp.target_visits };
            });
        }

        const validVisitsCount = repVisits.filter(visit => {
            const visitDate = new Date(visit.created_at);
            const hcpNameLower = visit.hcp_name ? visit.hcp_name.toLowerCase() : '';
            const specialtyLower = visit.specialty ? visit.specialty.toLowerCase() : '';
            const hcpInfo = allGoogleSheetData.find(row => row['medical rep'] === visit.medical_rep && row['HCPS'] === visit.hcp_name);
            const hcpClass = hcpInfo ? hcpInfo['Class'].trim().toUpperCase() : null;

            const isRelevantHCP = hcpClass && hcpClasses.includes(hcpClass);
            const isNotSpecialVisit = specialtyLower !== 'pharmacy' &&
                                    !eventSpecialties.includes(specialtyLower) &&
                                    !specialtyLower.includes('am(') &&
                                    !leaveTypes.some(leave => hcpNameLower.includes(leave));

            if (visitDate.getMonth() + 1 === selectedMonth && visitDate.getFullYear() === selectedYear && isRelevantHCP && isNotSpecialVisit) {
                if (hcpActualVisits[visit.hcp_name] && hcpActualVisits[visit.hcp_name].count < hcpActualVisits[visit.hcp_name].target) {
                    hcpActualVisits[visit.hcp_name].count++;
                    return true;
                }
            }
            return false;
        }).length;

        const workingDays = metric.workingDays || 1;
        metric.averageVisits = (validVisitsCount / workingDays).toFixed(2);
    });
    return metrics;
}

function exportToExcel(data, fileNamePrefix, tableType = 'normal') {
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Data');
    
    if (tableType === 'normal' || tableType === 'archived') {
        ws['!cols'] = [
            { wch: 25 }, { wch: 20 }, { wch: 15 }, { wch: 20 },
            { wch: 10 }, { wch: 15 }, { wch: 30 }, { wch: 25 }
        ];
    } else if (tableType === 'leaves') {
        ws['!cols'] = [
            { wch: 25 }, { wch: 20 }, { wch: 30 }, { wch: 15 }
        ];
    }
    XLSX.writeFile(wb, `${fileNamePrefix}.xlsx`);
}

function setupMonthDropdown() {
    const monthSelect = $('#monthSelect');
    monthSelect.empty();
    const today = new Date();
    const currentYear = today.getFullYear();
    for (let i = 0; i < 12; i++) {
        const date = new Date(currentYear, i, 1);
        const monthName = date.toLocaleString('default', { month: 'long' });
        const year = date.getFullYear();
        const monthValue = `${date.getMonth() + 1}-${year}`;
        monthSelect.append($('<option>', { value: monthValue, text: `${monthName} ${year}` }));
    }
    monthSelect.val(`${today.getMonth() + 1}-${currentYear}`);
}

function openKpiTab(evt, tabId) {
    $('.kpi-table-content').hide().removeClass('active');
    $('.kpi-tab-button').removeClass('active');
    $(evt.currentTarget).addClass('active');
    $(`#${tabId}`).show().addClass('active');

    const kpiTabsContainer = $('.kpi-table-tabs');
    if (tabId === 'am-visits-table') {
        kpiTabsContainer.addClass('am-active');
    } else {
        kpiTabsContainer.removeClass('am-active');
    }
}

async function displayLeavesForRep(repName) {
    showVisitsLoading();
    $('#selectedRepName').html(`(${repName}) - Leaves`);
    $('#leavesFilterOptions').show();

    const leaveTypes = ['annual leave', 'sick leave', 'casual leave', 'Official vacation'];
    let filteredLeaves = [];

    try {
        let allLeaves = [];
        const currentYear = new Date().getFullYear();
        const currentMonth = new Date().getMonth() + 1;

        const filterType = $('input[name="leaveFilter"]:checked').val();

        if (filterType === 'currentMonth') {
            const startDate = new Date(currentYear, currentMonth - 1, 1).toISOString();
            const endDate = new Date(currentYear, currentMonth, 0).toISOString();
            const { data, error } = await supabaseClient
                .from('healthcarepro_visits') 
                .select('id, hcp_name, specialty, comments, created_at')
                .eq('medical_rep', repName)
                .gte('created_at', startDate)
                .lte('created_at', endDate);
            if (error) throw error;
            allLeaves = data;
        } else {
            const startDate = new Date(currentYear, 0, 1).toISOString();
            const endDate = new Date(currentYear, 11, 31, 23, 59, 59, 999).toISOString();
             const { data, error } = await supabaseClient
                .from('healthcarepro_visits') 
                .select('id, hcp_name, specialty, comments, created_at')
                .eq('medical_rep', repName)
                .gte('created_at', startDate)
                .lte('created_at', endDate);
            if (error) throw error;
            allLeaves = data;
        }
        
        filteredLeaves = allLeaves.filter(visit => 
            leaveTypes.some(leave => visit.hcp_name?.toLowerCase().includes(leave))
        );
        currentDisplayedVisitsData = filteredLeaves; // Store for HCP filtering

        renderVisitsTable(filteredLeaves, 'leaves');
        $('#visitsTableContainer').show();
    } catch (error) {
        console.error('Error fetching leaves data:', error);
        showAlertDialog('Error loading leave data: ' + error.message, 'error');
        clearVisitsTable();
    }
}

async function displayArchivedVisits() {
    showVisitsLoading();
    const selectedRep = sessionStorage.getItem('selectedMedicalRep');
    if (selectedRep) {
        $('#selectedRepName').html(`(${selectedRep}) - Archived Visits`);
    } else {
        $('#selectedRepName').html(`(Archived Visits)`);
    }
    
    $('#leavesFilterOptions').hide();

    try {
        let allArchivedData = [];
        let offset = 0;
        let hasMore = true;

        while(hasMore) {
            const { data, error } = await supabaseClient
                .from('archived_visits')
                .select('*')
                .range(offset, offset + PAGE_SIZE - 1);

            if (error) throw error;

            allArchivedData = allArchivedData.concat(data);
            if (data.length < PAGE_SIZE) {
                hasMore = false;
            } else {
                offset += PAGE_SIZE;
            }
        }
        
        let filteredArchivedData = allArchivedData;

        // Apply filtering based on central DM filter or logged-in user
        if (loggedInUserRole === 'admin') {
            if (selectedDistrictManagerFilter) {
                const dmMedicalReps = new Set();
                allGoogleSheetData.forEach(row => {
                    if (row['District Manager'] === selectedDistrictManagerFilter && row['medical rep']) {
                        dmMedicalReps.add(row['medical rep']);
                    }
                });
                filteredArchivedData = filteredArchivedData.filter(visit => dmMedicalReps.has(visit.medical_rep));
            }
            // If admin and no DM filter, filteredArchivedData remains all archived data
        } else if (loggedInUserRole === 'District Manager' && loggedInUserDM) {
            const dmMedicalReps = new Set();
            allGoogleSheetData.forEach(row => {
                if (row['District Manager'] === loggedInUserDM && row['medical rep']) {
                    dmMedicalReps.add(row['medical rep']);
                }
            });
            filteredArchivedData = filteredArchivedData.filter(visit => dmMedicalReps.has(visit.medical_rep));
        } else if (loggedInUserRole === 'Medical Representative' && loggedInUserDM) {
            filteredArchivedData = filteredArchivedData.filter(visit => visit.medical_rep === loggedInUserDM);
        } else {
            filteredArchivedData = []; // Default for unknown/guest: no archived data
        }

        if (selectedRep) { // If a specific rep is chosen in KPI tab, further filter by that rep
            filteredArchivedData = filteredArchivedData.filter(visit => visit.medical_rep === selectedRep);
        }

        archivedVisitsData = filteredArchivedData;
        currentDisplayedVisitsData = archivedVisitsData; // Store for HCP filtering
        renderVisitsTable(archivedVisitsData, 'archived');
        $('#visitsTableContainer').show();
    } catch (error) {
        console.error('Error fetching archived visits:', error);
        showAlertDialog('Error loading archived data: ' + error.message, 'error');
        clearVisitsTable();
    }
}

function printVisitsTable() {
    const tableToPrint = document.getElementById('visitsTable').outerHTML;
    const repName = $('#selectedRepName').text();
    const printWindow = window.open('', '', 'height=600,width=800');
    printWindow.document.write('<html><head><title>HCP Visits Report</title>');
    printWindow.document.write('<style>');
    printWindow.document.write(`
        body { font-family: 'Inter', sans-serif; margin: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
        th { background-color: #f2f2f2; }
        .action-column { display: none; }
        h2 { text-align: center; margin-bottom: 10px; }
        @page { size: landscape; }
    `);
    printWindow.document.write('</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(`<h2>HCP Visits Overview ${repName}</h2>`);
    printWindow.document.write(tableToPrint);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
}

function setupMonthDropdown() {
    const monthSelect = $('#monthSelect');
    monthSelect.empty();
    const today = new Date();
    const currentYear = today.getFullYear();
    for (let i = 0; i < 12; i++) {
        const date = new Date(currentYear, i, 1);
        const monthName = date.toLocaleString('default', { month: 'long' });
        const year = date.getFullYear();
        const monthValue = `${date.getMonth() + 1}-${year}`;
        monthSelect.append($('<option>', { value: monthValue, text: `${monthName} ${year}` }));
    }
    monthSelect.val(`${today.getMonth() + 1}-${currentYear}`);
}

function openKpiTab(evt, tabId) {
    $('.kpi-table-content').hide().removeClass('active');
    $('.kpi-tab-button').removeClass('active');
    $(evt.currentTarget).addClass('active');
    $(`#${tabId}`).show().addClass('active');

    const kpiTabsContainer = $('.kpi-table-tabs');
    if (tabId === 'am-visits-table') {
        kpiTabsContainer.addClass('am-active');
    } else {
        kpiTabsContainer.removeClass('am-active');
    }
}

// --- Daily Report Functions ---
function initDailyReportDashboard() {
    populateDailyReportMedReps();
    setupDailyReportDateInput();

    $('#dailyMedRepSelect, #dailyStartDate').off('change').on('change', function() {
        const selectedRep = $('#dailyMedRepSelect').val();
        const startDate = $('#dailyStartDate').val();
        if (selectedRep && startDate) {
            const adjustedStartDate = getFirstSaturday(startDate);
            const endDate = getEndDate(adjustedStartDate);
            updateTableStructure(adjustedStartDate, endDate);
            fetchDailyVisits(selectedRep, adjustedStartDate, endDate);
        } else if (!selectedRep) {
            showAlertDialog('Please select a Medical Representative to view the Daily Report.', 'warning');
            clearDailyReportTable();
        } else if (!startDate) {
            showAlertDialog('Please select a Start Date to view the Daily Report.', 'warning');
            clearDailyReportTable();
        }
    });

    $('#dailyReportDownloadExcel').off('click').on('click', downloadDailyReportExcel);

    $('#daily-report .common-table-container').off('scroll').on('scroll', function() {
        const scrollLeft = $(this).scrollLeft();
        $('#daily-report .common-table-container').not(this).scrollLeft(scrollLeft);
    });
}

function populateDailyReportMedReps() {
    const medRepSelect = $('#dailyMedRepSelect');
    medRepSelect.empty().append($('<option>', { value: '', text: 'Select Medical Representative' }));
    
    let repsToPopulate = [];
    if (loggedInUserRole === 'admin') {
        if (selectedDistrictManagerFilter) {
            repsToPopulate = medicalRepsForDailyReport.filter(rep => rep.dm === selectedDistrictManagerFilter);
        } else {
            repsToPopulate = medicalRepsForDailyReport; // Admin sees all if no DM filter selected
        }
        medRepSelect.prop('disabled', false); // Admin can select
    } else if (loggedInUserRole === 'District Manager' && loggedInUserDM) {
        repsToPopulate = medicalRepsForDailyReport.filter(rep => rep.dm === loggedInUserDM);
        medRepSelect.prop('disabled', false); // DM can select their own reps
    } else if (loggedInUserRole === 'Medical Representative' && loggedInUserDM) {
        repsToPopulate = medicalRepsForDailyReport.filter(rep => rep.name === loggedInUserDM);
        medRepSelect.prop('disabled', true); // MR sees only themselves and it's disabled
    } else {
        // Default for unknown/guest: no reps to select, disabled
        medRepSelect.prop('disabled', true);
    }

    const uniqueRepNames = new Set(repsToPopulate.map(rep => rep.name));

    Array.from(uniqueRepNames).sort().forEach(repName => {
        medRepSelect.append($('<option>', { value: repName, text: repName }));
    });

    // Set default selection to the logged-in MR if applicable, otherwise "Select Medical Representative"
    if (loggedInUserRole === 'Medical Representative' && loggedInUserDM) {
        medRepSelect.val(loggedInUserDM);
        // Automatically trigger data fetch for the MR
        const startDate = $('#dailyStartDate').val();
        if (startDate) {
            const adjustedStartDate = getFirstSaturday(startDate);
            const endDate = getEndDate(adjustedStartDate);
            updateTableStructure(adjustedStartDate, endDate);
            fetchDailyVisits(loggedInUserDM, adjustedStartDate, endDate);
        }
    } else if (loggedInUserRole === 'District Manager' && loggedInUserDM && repsToPopulate.length > 0) {
        // If DM is logged in, and there are reps under them, select the first one or keep "Select Medical Rep"
        medRepSelect.val(''); // Keep it as "Select Medical Rep" initially for DMs
    } else {
        medRepSelect.val('');
    }
}

function setupDailyReportDateInput() {
    const today = new Date();
    const daysToLastSaturday = (today.getDay() + 1) % 7;
    const lastSaturday = new Date(today);
    lastSaturday.setDate(today.getDate() - daysToLastSaturday);
    const startDate = formatDateForInput(lastSaturday);
    $('#dailyStartDate').val(startDate);
    const endDate = getEndDate(startDate);
    updateTableStructure(startDate, endDate);
}

function getFirstSaturday(dateStr) {
    const inputDate = new Date(dateStr);
    const dayOfWeek = inputDate.getDay();
    if (dayOfWeek === 6) return inputDate;
    const daysToSaturday = (6 - dayOfWeek + 7) % 7;
    inputDate.setDate(inputDate.getDate() + daysToSaturday);
    return inputDate;
}

function getEndDate(startDate) {
    const start = typeof startDate === 'string' ? new Date(startDate) : startDate;
    const end = new Date(start);
    end.setDate(end.getDate() + 5);
    return end;
}

function updateTableStructure(startDate, endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    const daysDiff = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;

    // Update headers for all daily report tables
    $('#daily-report .daily-report-table').each(function() {
        const tableId = $(this).attr('id');
        const headerRow = $(this).find('thead tr');
        headerRow.empty().append('<th class="count-column">Count</th>'); // Restore Count header

        for (let i = 0; i < daysDiff; i++) {
            const currentDate = new Date(start);
            currentDate.setDate(start.getDate() + i);
            const dayName = currentDate.toLocaleDateString('en-US', { weekday: 'short' });
            const dateStr = currentDate.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit' });
            headerRow.append(`<th>${dayName} ${dateStr}</th>`);
        }

        // Clear existing cells and append new ones for tbody
        $(this).find('tbody tr').each(function() {
            $(this).find('td:not(.count-column)').remove();
            for (let i = 0; i < daysDiff; i++) $(this).append('<td></td>');
        });
    });
}

async function fetchDailyVisits(repName, startDate, endDate) {
    $('#daily-report .loading-indicator').show();
    $('#daily-report .daily-report-content').css('opacity', '0.5');
    const start = typeof startDate === 'string' ? new Date(startDate) : startDate;
    const end = typeof endDate === 'string' ? new Date(endDate) : endDate;
    end.setHours(23, 59, 59, 999);

    let allDailyVisits = [];
    let offset = 0;
    let hasMore = true;

    try {
        while (hasMore) {
            let query = supabaseClient
                .from('healthcarepro_visits')
                .select('*,brick,comments,visit_place')
                .gte('created_at', start.toISOString())
                .lte('created_at', end.toISOString())
                .range(offset, offset + PAGE_SIZE - 1);

            // Apply role-based filtering directly in the Supabase query
            if (loggedInUserRole === 'District Manager' && loggedInUserDM) {
                const dmReps = new Set();
                allGoogleSheetData.forEach(row => {
                    if (row['District Manager'] === loggedInUserDM && row['medical rep']) {
                        dmReps.add(row['medical rep']);
                    }
                });
                // Ensure the selected rep is one of the DM's reps
                if (!dmReps.has(repName)) {
                    allDailyVisits = []; // No data for this rep if not under the DM
                    hasMore = false;
                    break;
                }
                query = query.eq('medical_rep', repName); // Already filtered by repName, ensure it's valid
            } else if (loggedInUserRole === 'Medical Representative' && loggedInUserDM) {
                query = query.eq('medical_rep', loggedInUserDM); // Only fetch for the logged-in MR
            } else if (loggedInUserRole === 'admin' && selectedDistrictManagerFilter) {
                const dmReps = new Set();
                allGoogleSheetData.forEach(row => {
                    if (row['District Manager'] === selectedDistrictManagerFilter && row['medical rep']) {
                        dmReps.add(row['medical rep']);
                    }
                });
                if (!dmReps.has(repName)) {
                    allDailyVisits = [];
                    hasMore = false;
                    break;
                }
                query = query.eq('medical_rep', repName); // Filter by selected rep under the admin's DM filter
            } else {
                query = query.eq('medical_rep', repName); // For admin with no DM filter, or unknown, use selected rep
            }


            const { data, error } = await query;

            if (error) {
                throw error;
            }

            allDailyVisits = allDailyVisits.concat(data);
            if (data.length < PAGE_SIZE) {
                hasMore = false;
            } else {
                offset += PAGE_SIZE;
            }
        }
        dailyReportRawVisitsData = allDailyVisits; // Store raw data for Excel export
        clearDailyReportTable();
        if (Array.isArray(allDailyVisits)) populateDailyReportTable(allDailyVisits, start);
        else console.error('Expected array but received:', allDailyVisits);
    } catch (err) {
        console.error('Error fetching daily visits:', err);
        showAlertDialog('Error loading daily visit data. Please try again later.', 'error');
    } finally {
        $('#daily-report .loading-indicator').hide();
        $('#daily-report .daily-report-content').css('opacity', '1');
    }
}

function clearDailyReportTable() {
    $('#daily-report .daily-report-table td:not(.count-column)').empty();
    $('#daily-report .count-column').text('0');
}

function populateDailyReportTable(visits, startDate) {
    const visitMap = new Map();
    const sectionCounts = { am: 0, pm: 0, pharmacy: 0, amDetails: 0 };
    const amDetailsData = [];

    visits.forEach(visit => {
        const dateKey = new Date(visit.created_at).toISOString().split('T')[0];
        if (!visitMap.has(dateKey)) visitMap.set(dateKey, []);
        visitMap.get(dateKey).push(visit);
    });
    visitMap.forEach(visits => visits.sort((a, b) => new Date(a.created_at) - new Date(b.created_at)));

    const columnDates = [];
    const endDate = getEndDate(startDate);
    for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
        columnDates.push(date.toISOString().split('T')[0]);
    }

    const amActivitiesSpecialties = ['hospital', 'account', 'dialysis center', 'oncology center'];
    const leaveTypes = ['annual leave', 'Official vacation', 'casual leave', 'sick leave'];
    const eventSpecialties = ['event(am activity)', 'event(pm activity)', 'event(full day activity)'];


    columnDates.forEach((dateStr, columnIndex) => {
        const dailyVisits = visitMap.get(dateStr) || [];

        const dailyAmActivitiesHCPs = new Set();
        const dailyAmDetailsHCPs = new Set();
        const dailyPmActivitiesHCPs = new Set();
        const dailyPharmacyActivitiesHCPs = new Set();

        const dailyAmCells = [];
        const dailyPmCells = [];
        const dailyPharmacyCells = [];

        dailyVisits.forEach(visit => {
            const visitDate = new Date(visit.created_at);
            const visitDayDate = visitDate.toLocaleDateString('en-US', { weekday: 'short', month: '2-digit', day: '2-digit' }); // Day and Date
            const visitTime = visitDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            const specialty = visit.specialty?.toLowerCase() || '';
            const brick = visit.brick || '';
            const visitPlace = visit.visit_place || '';
            const hcpName = visit.hcp_name || 'Unknown';
            const comments = visit.comments || '';

            const hcpGoogleData = allGoogleSheetData.find(row => row['medical rep'] === visit.medical_rep && row['HCPS'] === hcpName);
            const hcpTargetVisits = hcpGoogleData ? (parseInt(hcpGoogleData['T.V'], 10) || 0) : null;

            const createCellContent = (name, dayDate, time, specialtyDisplay, brickDisplay, visitPlaceDisplay, comment = '', isEvent = false, isLeave = false, isAmSpecialty = false) => {
    let visitPlaceClass = 'visit-place-cell'; // Apply the visit-place-cell class by default
    if (visitPlaceDisplay.toLowerCase().includes('clinic')) {
        visitPlaceClass += ' clinic-hcp'; // Add clinic-hcp class if it's a clinic
    }
    return `<div class="hcp-cell ${isEvent ? 'event' : ''} ${isLeave ? 'leave-entry' : ''} ${visitPlaceClass}" onclick="toggleComment(this)">
                <span class="hcp-name ${isAmSpecialty ? 'am-specialty-hcp' : ''}">${name}</span>
                <span class="hcp-detail">${dayDate} ${time}</span>
                <span class="hcp-detail">${specialtyDisplay}</span>
                <span class="hcp-detail">${brickDisplay} - <span class="${visitPlaceClass}">${visitPlaceDisplay}</span></span>
                <div class="comment-box" data-comment-text="${escapeHtml(comment)}">${comment || 'No comment available'}</div>
            </div>`;
};



            const isAmActivitySpecialty = amActivitiesSpecialties.includes(specialty);
            const isAmActivityEvent = specialty === 'event(am activity)';
            const isAmDetailsSpecialty = specialty.includes('am(');
            const isAmDetailsEvent = specialty === 'event(am activity)';
            const isPharmacySpecialty = specialty === 'pharmacy';
            const isPmActivityEvent = specialty === 'event(pm activity)';
            const isFullDayEvent = specialty === 'event(full day)';
            const isLeaveHCP = leaveTypes.some(leave => hcpName.toLowerCase().includes(leave));
            const isAnyEvent = eventSpecialties.includes(specialty);
            const originalSpecialty = visit.specialty || 'N/A';

            if (isFullDayEvent) {
                // Handle full-day events
                if (!dailyAmActivitiesHCPs.has(hcpName)) {
                    dailyAmCells.push(createCellContent(hcpName, visitDayDate, visitTime, originalSpecialty, brick, visitPlace, comments, true, false, isAmDetailsSpecialty));
                    dailyAmActivitiesHCPs.add(hcpName);
                }
                if (!dailyAmDetailsHCPs.has(hcpName)) {
                    amDetailsData.push({ name: hcpName, specialty: originalSpecialty, brick: brick, time: visitTime, date: dateStr, isEvent: true, comment: comments, visit_place: visitPlace, target_visits: hcpTargetVisits, isAmSpecialty: isAmDetailsSpecialty, dayDate: visitDayDate });
                    dailyAmDetailsHCPs.add(hcpName);
                }
                if (!dailyPmActivitiesHCPs.has(hcpName)) {
                    dailyPmCells.push(createCellContent(hcpName, visitDayDate, visitTime, originalSpecialty, brick, visitPlace, comments, true, false, isAmDetailsSpecialty));
                    dailyPmActivitiesHCPs.add(hcpName);
                }
                if (!dailyPharmacyActivitiesHCPs.has(hcpName)) {
                    dailyPharmacyCells.push(createCellContent(hcpName, visitDayDate, visitTime, originalSpecialty, brick, visitPlace, comments, true, false, isAmDetailsSpecialty));
                    dailyPharmacyActivitiesHCPs.add(hcpName);
                }
            } else if (isLeaveHCP && !isAmActivitySpecialty && !isAmActivityEvent) {
                // Handle leaves only if it's not an AM activity or event
                if (!dailyPmActivitiesHCPs.has(hcpName)) {
                    dailyPmCells.push(createCellContent(hcpName, visitDayDate, visitTime, originalSpecialty, brick, visitPlace, comments, false, true, isAmDetailsSpecialty));
                    dailyPmActivitiesHCPs.add(hcpName);
                }
            } else {
                // Handle AM and PM activities based on specialty
                let addedToAmActivities = false;
                if ((isAmActivitySpecialty || isAmActivityEvent) && !dailyAmActivitiesHCPs.has(hcpName)) {
                    dailyAmCells.push(createCellContent(hcpName, visitDayDate, visitTime, originalSpecialty, brick, visitPlace, comments, isAnyEvent, false, isAmDetailsSpecialty));
                    dailyAmActivitiesHCPs.add(hcpName);
                    addedToAmActivities = true;
                }

                let addedToAmDetails = false;
                if ((isAmDetailsSpecialty || isAmDetailsEvent) && !dailyAmDetailsHCPs.has(hcpName)) {
                    amDetailsData.push({ name: hcpName, specialty: originalSpecialty, brick: brick, time: visitTime, date: dateStr, isEvent: isAmDetailsEvent, comment: comments, visit_place: visitPlace, target_visits: hcpTargetVisits, isAmSpecialty: isAmDetailsSpecialty, dayDate: visitDayDate });
                    dailyAmDetailsHCPs.add(hcpName);
                    addedToAmDetails = true;
                }

                let addedToPharmacy = false;
                if (isPharmacySpecialty && !dailyPharmacyActivitiesHCPs.has(hcpName)) {
                    dailyPharmacyCells.push(createCellContent(hcpName, visitDayDate, visitTime, originalSpecialty, brick, visitPlace, comments, isAnyEvent, false, isAmDetailsSpecialty));
                    dailyPharmacyActivitiesHCPs.add(hcpName);
                    addedToPharmacy = true;
                }

                if (isPmActivityEvent && !dailyPmActivitiesHCPs.has(hcpName)) {
                    dailyPmCells.push(createCellContent(hcpName, visitDayDate, visitTime, originalSpecialty, brick, visitPlace, comments, isAnyEvent, false, isAmDetailsSpecialty));
                    dailyPmActivitiesHCPs.add(hcpName);
                } else if (!addedToAmActivities && !addedToAmDetails && !addedToPharmacy) {
                    if (hcpTargetVisits !== null && hcpTargetVisits !== 0 && !dailyPmActivitiesHCPs.has(hcpName)) {
                        dailyPmCells.push(createCellContent(hcpName, visitDayDate, visitTime, originalSpecialty, brick, visitPlace, comments, isAnyEvent, false, isAmDetailsSpecialty));
                        dailyPmActivitiesHCPs.add(hcpName);
                    }
                }
            }
        });

        const amCell = findDailyReportTableCell('am', columnIndex);
        if (amCell) amCell.html(dailyAmCells.join(''));

        const pmCell = findDailyReportTableCell('pm', columnIndex);
        if (pmCell) pmCell.html(dailyPmCells.join(''));

        const pharmacyCell = findDailyReportTableCell('pharmacy', columnIndex);
        if (pharmacyCell) pharmacyCell.html(dailyPharmacyCells.join(''));

        sectionCounts.am += dailyAmActivitiesHCPs.size;
        sectionCounts.pm += dailyPmActivitiesHCPs.size;
        sectionCounts.pharmacy += dailyPharmacyActivitiesHCPs.size;
        sectionCounts.amDetails += dailyAmDetailsHCPs.size;
    });

    $('#daily-report .section-am .count-column').text(sectionCounts.am);
    $('#daily-report .section-pm .count-column').text(sectionCounts.pm);
    $('#daily-report .section-pharmacy .count-column').text(sectionCounts.pharmacy);
    $('#daily-report .section-am-details .count-column').text(sectionCounts.amDetails);

    populateAmDetailsTable(amDetailsData, columnDates);
}

function populateAmDetailsTable(amDetails, columnDates) {
    $('#amDetailsTable tbody td:not(.count-column)').empty();
    if (amDetails.length === 0) return;

    const detailsByDate = {};
    amDetails.forEach(detail => {
        if (!detailsByDate[detail.date]) detailsByDate[detail.date] = [];
        detailsByDate[detail.date].push(detail);
    });
    Object.keys(detailsByDate).forEach(dateKey => detailsByDate[dateKey].sort((a, b) => new Date(`1970-01-01T${a.time}`) - new Date(`1970-01-01T${b.time}`)));

    columnDates.forEach((dateStr, columnIndex) => {
        const dailyDetails = detailsByDate[dateStr] || [];
        if (dailyDetails.length > 0) {
            const cell = findDailyReportTableCell('am-details', columnIndex);
            if (cell) {
                cell.empty();
                dailyDetails.forEach(detail => {
                    cell.append(`<div class="hcp-cell ${detail.isEvent ? 'event' : ''}" onclick="toggleComment(this)">
                        <span class="hcp-name ${detail.isAmSpecialty ? 'am-specialty-hcp' : ''}">${detail.name}</span>
                        <span class="hcp-detail">${detail.dayDate} ${detail.time}</span> <!-- Combined Day and Date with Time -->
                        <span class="hcp-detail">${detail.specialty}</span>
                        <span class="hcp-detail">${detail.brick} - ${detail.visit_place}</span>
                        <div class="comment-box" data-comment-text="${escapeHtml(detail.comment || '')}">${detail.comment || 'No comment available'}</div>
                    </div>`);
                });
            }
        }
    });
}

function findDailyReportTableCell(section, columnIndex) {
    const rows = $(`#daily-report .section-${section}`);
    return rows.length > 0 ? rows.eq(0).find('td:not(.count-column)').eq(columnIndex) : null;
}

function escapeHtml(unsafe) {
    return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}

function toggleComment(element) {
    const commentBox = element.querySelector('.comment-box');
    const isVisible = commentBox.style.display === 'block';
    $('.comment-box').hide().removeClass('top bottom');

    if (!isVisible) {
        const rect = element.getBoundingClientRect();
        const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
        const viewportWidth = window.innerWidth || document.documentElement.clientWidth;
        const scrollLeft = document.querySelector('.daily-report-table').parentElement.scrollLeft;

        // Calculate space below and above
        const spaceBelow = viewportHeight - rect.bottom;
        const spaceAbove = rect.top;

        // Position the comment box
        commentBox.style.display = 'block';
        commentBox.style.left = '50%';
        commentBox.style.transform = 'translateX(-50%)';
        commentBox.style.zIndex = '9999'; // Add this line to ensure it's on top!

        // Temporarily show to get its dimensions
        commentBox.style.visibility = 'hidden';
        commentBox.style.display = 'block';
        const commentBoxHeight = commentBox.offsetHeight;
        const commentBoxWidth = commentBox.offsetWidth;
        commentBox.style.visibility = 'visible';

        // Check if there's enough space below
        if (spaceBelow >= commentBoxHeight + 10) { // +10 for a little margin
            commentBox.style.top = '100%';
            commentBox.style.bottom = 'auto';
            commentBox.style.marginTop = '5px';
            commentBox.style.marginBottom = 'auto';
            commentBox.classList.add('bottom');
        } else if (spaceAbove >= commentBoxHeight + 10) { // Check if there's enough space above
            commentBox.style.top = 'auto';
            commentBox.style.bottom = '100%';
            commentBox.style.marginTop = '5px';
            commentBox.style.marginBottom = 'auto';
            commentBox.classList.add('top');
        } else {
            // Fallback: position below but adjust if it goes off screen horizontally
            commentBox.style.top = '100%';
            commentBox.style.bottom = 'auto';
            commentBox.style.marginTop = '5px';
            commentBox.style.marginBottom = 'auto';
            commentBox.classList.add('bottom');

            // Adjust horizontal position if it goes off screen
            let newLeft = rect.left + rect.width / 2 - commentBoxWidth / 2;
            if (newLeft < 0) {
                newLeft = 5; // Small padding from left edge
            } else if (newLeft + commentBoxWidth > viewportWidth) {
                newLeft = viewportWidth - commentBoxWidth - 5; // Small padding from right edge
            }
            commentBox.style.left = `${newLeft - rect.left + (element.offsetWidth/2)}px`; // Adjust relative to parent
            commentBox.style.transform = 'translateX(-50%)';
        }
    } else {
        commentBox.style.display = 'none';
        commentBox.classList.remove('top', 'bottom');
        commentBox.style.zIndex = ''; // Reset z-index when hidden
    }
}


function downloadDailyReportExcel() {
    const selectedRep = $('#dailyMedRepSelect').val();
    if (!selectedRep) {
        showAlertDialog('Please select a Medical Representative first to download the Daily Report.', 'warning');
        return;
    }

    const wb = XLSX.utils.book_new();
    const startDate = $('#dailyStartDate').val();
    const endDate = getEndDate(startDate).toISOString().split('T')[0];
    const fileName = `Daily_Report_${selectedRep}_${startDate}_to_${endDate}.xlsx`;

    const excelData = [
        ['Medical Rep', 'Date', 'Day', 'Time', 'HCP Name', 'Specialty', 'Brick', 'Visit Place', 'Section']
    ];

    const amActivitiesSpecialties = ['hospital', 'account', 'dialysis center', 'oncology center'];
    const leaveTypes = ['annual leave', 'Official vacation', 'casual leave', 'sick leave'];
    const eventSpecialties = ['event(am activity)', 'event(pm activity)', 'event(full day activity)'];

    dailyReportRawVisitsData.forEach(visit => {
        const visitDate = new Date(visit.created_at);
        const formattedDate = visitDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        const formattedDay = visitDate.toLocaleDateString('en-US', { weekday: 'short' });
        const formattedTime = visitDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        
        const specialty = visit.specialty?.toLowerCase() || '';
        const hcpNameLower = visit.hcp_name ? visit.hcp_name.toLowerCase() : '';

        let section = 'PM Activity'; // Default

        const isFullDayEvent = specialty === 'event(full day)';
        const isLeaveHCP = leaveTypes.some(leave => hcpNameLower.includes(leave));
        const isPharmacySpecialty = specialty === 'pharmacy';
        const isAmActivity = amActivitiesSpecialties.includes(specialty) || specialty === 'event(am activity)';
        const isAmDetails = specialty.includes('am('); // This covers 'am(activity)'
        const isPmActivityEvent = specialty === 'event(pm activity)';

        if (isFullDayEvent) {
            section = 'Full Day Event';
        } else if (isLeaveHCP) {
            section = 'Leave';
        } else if (isPharmacySpecialty) {
            section = 'Pharmacy Activity';
        } else if (isAmActivity) {
            section = 'AM Activity';
        } else if (isAmDetails) {
            section = 'AM Details';
        } else if (isPmActivityEvent) {
            section = 'PM Activity (Event)';
        }
        // If none of the above, it remains 'PM Activity'

        excelData.push([
            visit.medical_rep || 'N/A',
            formattedDate,
            formattedDay,
            formattedTime,
            visit.hcp_name || 'N/A',
            visit.specialty || 'N/A',
            visit.brick || 'N/A',
            visit.visit_place || 'N/A',
            section
        ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(excelData);
    XLSX.utils.book_append_sheet(wb, ws, 'Daily Report');
    
    if (wb.SheetNames.length > 0) {
        XLSX.writeFile(wb, fileName);
        showAlertDialog('Daily Report downloaded successfully!', 'success');
    } else {
        showAlertDialog('No data to export for the Daily Report.', 'warning');
    }
}
        
// --- Lists Dashboard Functions ---
async function initListsDashboard() {
    if (allGoogleSheetData.length === 0) { 
        const googleResponse = await fetch(GOOGLE_SHEET_URL);
        if (!googleResponse.ok) {
            throw new Error('Failed to fetch Lists data from Google Sheets. Please ensure the Google Sheet URL is correct and publicly accessible.');
        }
        const data = await googleResponse.text();
        allGoogleSheetData = parseCSV(data); 
    }
    listsGoogleData = allGoogleSheetData;

    // Hide content and show loading initially
    $('#listsContent').hide();
    $('#listsLoading').show();

    try {
        let allSupabaseData = [];
        let offset = 0;
        let hasMore = true;

        while(hasMore) {
            const { data, error } = await supabaseClient
                .from('healthcarepro_visits')
                .select('*')
                .range(offset, offset + PAGE_SIZE - 1);

            if (error) throw error;

            allSupabaseData = allSupabaseData.concat(data);
            if (data.length < PAGE_SIZE) {
                hasMore = false;
            } else {
                offset += PAGE_SIZE;
            }
        }

        processListsData(listsGoogleData, allSupabaseData);
        
        $('#listsLoading').hide();
        $('#listsContent').show();
        
        $('#lists-dashboard #filterButton').off('click').on('click', applyListsFilter);
        $('#lists-dashboard #resetButton').off('click').on('click', resetListsData);
        $('#lists-dashboard #medicalReps').off('change').on('change', populateListsBricks);
        $('#lists-dashboard #visitOptions, #lists-dashboard #dayFilter').off('change').on('change', updateListsCountDisplay);
        $('#lists-dashboard #searchBox').off('input').on('input', searchListsTable);
        // Removed initListsCustomSelect as we're using standard select
        $('#bricksSelect').off('change').on('change', updateListsCountDisplay); // Listener for standard select
    }
    catch (error) {
        $('#listsLoading').hide();
        $('#listsError').show().text('Error loading data for Lists. Please try again.');
        console.error('Error loading Lists data:', error);
    }
}

function processListsData(googleData, supabaseData) {
    let medicalReps = [...new Set(googleData.map(row => row['medical rep']).filter(rep => rep && !/[\u0600-\u06FF]/.test(rep)))];
    
    // Filter medical reps based on central DM filter OR logged-in user role
    if (loggedInUserRole === 'admin') {
        if (selectedDistrictManagerFilter) {
            const dmReps = new Set();
            googleData.forEach(row => {
                if (row['District Manager'] === selectedDistrictManagerFilter && row['medical rep']) {
                    dmReps.add(row['medical rep']);
                }
            });
            medicalReps = medicalReps.filter(rep => dmReps.has(rep));
        }
        // If admin and no DM filter, medicalReps remains all reps
        $('#lists-dashboard #medicalReps').prop('disabled', false); // Admin can select
    } else if (loggedInUserRole === 'District Manager' && loggedInUserDM) {
        const dmReps = new Set();
        googleData.forEach(row => {
            if (row['District Manager'] === loggedInUserDM && row['medical rep']) {
                dmReps.add(row['medical rep']);
            }
        });
        medicalReps = medicalReps.filter(rep => dmReps.has(rep));
        $('#lists-dashboard #medicalReps').prop('disabled', false); // DM can select their own reps
    } else if (loggedInUserRole === 'Medical Representative' && loggedInUserDM) {
        medicalReps = medicalReps.filter(rep => rep === loggedInUserDM);
        $('#lists-dashboard #medicalReps').prop('disabled', true); // MR sees only themselves and it's disabled
    } else {
        // Default for unknown/guest: no reps, disabled
        medicalReps = [];
        $('#lists-dashboard #medicalReps').prop('disabled', true);
    }

    populateSelect('medicalReps', medicalReps, 'Select Representative');
    if (loggedInUserRole === 'Medical Representative' && loggedInUserDM) {
        $('#lists-dashboard #medicalReps').val(loggedInUserDM);
        populateListsBricks(); // Populate bricks for the auto-selected MR
    } else if (loggedInUserRole === 'District Manager' && loggedInUserDM && medicalReps.length > 0) {
        // If DM, pre-select the first rep or keep "Select Representative"
        $('#lists-dashboard #medicalReps').val(''); // Keep it as "Select Representative" initially for DMs
    } else {
        $('#lists-dashboard #medicalReps').val('');
    }

    listsVisitCounts = {};
    const currentDate = new Date();
    listsCurrentMonthVisits = supabaseData.filter(visit => {
        const visitDate = new Date(visit.visit_date || visit.created_at);
        const isCurrentMonth = visitDate.getMonth() === currentDate.getMonth() && visitDate.getFullYear() === currentDate.getFullYear();
        
        // Additional filtering for Supabase data based on user role
        if (loggedInUserRole === 'District Manager' && loggedInUserDM) {
            const dmReps = new Set();
            allGoogleSheetData.forEach(row => {
                if (row['District Manager'] === loggedInUserDM && row['medical rep']) {
                    dmReps.add(row['medical rep']);
                }
            });
            return isCurrentMonth && dmReps.has(visit.medical_rep);
        } else if (loggedInUserRole === 'Medical Representative' && loggedInUserDM) {
            return isCurrentMonth && visit.medical_rep === loggedInUserDM;
        } else if (loggedInUserRole === 'admin' && selectedDistrictManagerFilter) {
            const dmReps = new Set();
            allGoogleSheetData.forEach(row => {
                if (row['District Manager'] === selectedDistrictManagerFilter && row['medical rep']) {
                    dmReps.add(row['medical rep']);
                }
            });
            return isCurrentMonth && dmReps.has(visit.medical_rep);
        }
        return isCurrentMonth; // Admin with no DM filter, or unknown user
    });
    listsCurrentMonthVisits.forEach(visit => {
        listsVisitCounts[visit.hcp_name] = (listsVisitCounts[visit.hcp_name] || 0) + 1;
    });
}

function populateListsBricks() {
    const selectedRep = $('#lists-dashboard #medicalReps').val();
    const filteredData = listsGoogleData.filter(row => row['medical rep'] === selectedRep);
    listsBricks = new Set(filteredData.map(row => row['Brick']).filter(Boolean));
    const bricksSelect = $('#lists-dashboard #bricksSelect').empty();
    bricksSelect.append($('<option>', { value: '', text: 'Select Brick' })); // Add default option
    if (listsBricks.size === 0) {
        return;
    }
    Array.from(listsBricks).sort().forEach(brick => {
        bricksSelect.append($('<option>', { value: brick, text: brick }));
    });
    updateListsCountDisplay();
}

// Removed initListsCustomSelect as we're using standard select
// Removed toggleListsBrickSelection as we're using standard select

function updateListsCountDisplay() {
    const selectedRep = $('#lists-dashboard #medicalReps').val();
    const selectedOption = $('#lists-dashboard #visitOptions').val();
    const selectedDay = $('#lists-dashboard #dayFilter').val();
    const selectedBrick = $('#lists-dashboard #bricksSelect').val(); // Get selected brick from standard select
    const countDisplay = $('#lists-dashboard #countDisplay');

    if (!selectedRep || !selectedOption) {
        countDisplay.hide();
        return;
    }

    let count = 0;
    let displayText = '';
    const filteredByDay = listsGoogleData.filter(row => 
        row['medical rep'] === selectedRep &&
        (selectedBrick === '' || row['Brick'] === selectedBrick) && // Filter by selected brick
        (selectedDay === '' || row[selectedDay]?.trim() !== '')
    );

    if (selectedOption === 'unvisited') {
        count = filteredByDay.filter(row => !listsVisitCounts[row['HCPS']] || listsVisitCounts[row['HCPS']] === 0).length;
        displayText = `Unvisited HCPs Count: `;
    } else if (selectedOption === 'remaining') {
        count = filteredByDay.filter(row => (parseInt(row['T.V']) || 0) > (listsVisitCounts[row['HCPS']] || 0)).length;
        displayText = `Remaining Visits Count: `;
    } else if (selectedOption === 'full') {
        count = filteredByDay.length;
        displayText = `Full List Count: `;
    }
    countDisplay.text(`${displayText} ${count}`).show();
}

function applyListsFilter() {
    const selectedRep = $('#lists-dashboard #medicalReps').val();
    const selectedOption = $('#lists-dashboard #visitOptions').val();
    const selectedDay = $('#lists-dashboard #dayFilter').val();
    const selectedBrick = $('#lists-dashboard #bricksSelect').val(); // Get selected brick from standard select
    const listsErrorDiv = $('#lists-dashboard #listsError');

    if (!selectedRep || !selectedOption) {
        listsErrorDiv.show().text('Please select a Medical Representative and a Display Option.');
        return;
    }
    listsErrorDiv.hide();
    
    listsFilteredHCPs = listsGoogleData.filter(row => {
        if (row['medical rep'] !== selectedRep) return false;
        if (selectedBrick !== '' && row['Brick'] !== selectedBrick) return false; // Filter by selected brick
        if (selectedDay !== '' && !row[selectedDay]?.trim()) return false;
        
        if (selectedOption === 'unvisited') return !listsVisitCounts[row['HCPS']] || listsVisitCounts[row['HCPS']] === 0;
        if (selectedOption === 'remaining') return (parseInt(row['T.V']) || 0) > (listsVisitCounts[row['HCPS']] || 0);
        if (selectedOption === 'full') return true;
        return false;
    });

    populateListsHCPTable(listsFilteredHCPs, selectedDay);
    $('#lists-dashboard #searchContainer').removeClass('hidden');
}

function populateListsHCPTable(hcpData, selectedDay) {
    const tbody = $('#lists-dashboard #hcpTable tbody').empty();
    const hcpTable = $('#lists-dashboard #hcpTable');

    hcpData.forEach(row => {
        const actualVisits = listsVisitCounts[row['HCPS']] || 0;
        const targetVisits = parseInt(row['T.V']) || 0;
        const remainingVisits = targetVisits - actualVisits;
        
        let rowClass = '';
        if (remainingVisits < 0) {
            rowClass = 'negative-remaining-row';
        } else if (remainingVisits === 0) {
            rowClass = 'light-green';
        } else if (remainingVisits < targetVisits) {
            rowClass = 'light-yellow';
        } else {
            rowClass = 'light-red';
        }

        const tr = $('<tr>').html(`
            <td class="sticky">${row['HCPS']}</td><td>${row['Speciality']}</td><td>${row['Class']}</td>
            <td>${row['T.V']}</td><td class="${rowClass}">${remainingVisits}</td><td>${row['Brick']}</td>
            <td>${row['Address']}</td><td>${row['Mobile']}</td>
            <td class="${selectedDay === 'Saturday' ? 'highlight' : ''}">${row['Saturday']}</td>
            <td class="${selectedDay === 'Sunday' ? 'highlight' : ''}">${row['Sunday']}</td>
            <td class="${selectedDay === 'Monday' ? 'highlight' : ''}">${row['Monday']}</td>
            <td class="${selectedDay === 'Tuesday' ? 'highlight' : ''}">${row['Tuesday']}</td>
            <td class="${selectedDay === 'Wednesday' ? 'highlight' : ''}">${row['Wednesday']}</td>
            <td class="${selectedDay === 'Thursday' ? 'highlight' : ''}">${row['Thursday']}</td>
        `).on('click', () => {
            tbody.find('tr').removeClass('selected');
            tr.addClass('selected');
        });
        tbody.append(tr);
    });
    hcpTable.toggle(hcpData.length > 0);
}

function searchListsTable() {
    const searchTerm = $('#lists-dashboard #searchBox').val().toLowerCase();
    $('#lists-dashboard #hcpTable tbody tr').each(function() {
        $(this).toggle($(this).text().toLowerCase().includes(searchTerm));
    });
}

function resetListsData() {
    $('#lists-dashboard #medicalReps, #lists-dashboard #visitOptions, #lists-dashboard #dayFilter, #lists-dashboard #bricksSelect').prop('selectedIndex', 0);
    listsSelectedBricks = []; 
    $('#lists-dashboard #searchBox').val('');
    $('#lists-dashboard #hcpTable tbody').empty();
    $('#lists-dashboard #hcpTable, #lists-dashboard #listsError, #lists-dashboard #countDisplay, #lists-dashboard #searchContainer').hide();
    
    // Re-initialize the lists dashboard to re-populate medical reps and apply role-based disabling
    initListsDashboard(); 
}
        
// --- Requests Management Dashboard Functions ---
async function requests_initRequestsDashboard() {
    if (allGoogleSheetData.length === 0) {
        const response = await fetch(GOOGLE_SHEET_URL);
        if (!response.ok) {
            throw new Error('Failed to fetch Requests data from Google Sheets. Please ensure the Google Sheet URL is correct and publicly accessible.');
        }
        const data = await response.text();
        allGoogleSheetData = parseCSV(data);
    }
    
    requests_districtManagers.clear();
    requests_medicalReps.clear();
    requests_areasByMedRep.clear();

    allGoogleSheetData.forEach(row => {
        const districtManager = row['District Manager']?.trim();
        const medRep = row['medical rep']?.trim();
        const area = row['area']?.trim();

        if (districtManager) requests_districtManagers.add(districtManager);

        if (districtManager && medRep) {
            if (!requests_medicalReps.has(districtManager)) {
                requests_medicalReps.set(districtManager, new Set());
            }
            requests_medicalReps.get(districtManager).add(medRep);
        }
        if (medRep && area) { 
            if (!requests_areasByMedRep.has(medRep)) {
                requests_areasByMedRep.set(medRep, new Set());
            }
            requests_areasByMedRep.get(medRep).add(area);
        }
    });
    
    requests_populateDistrictManagers();
    await requests_fetchAllRequests();

    // Attach event listeners for delete and email buttons
    $(document).off('click', '.delete-request-button').on('click', '.delete-request-button', async function() {
        const requestId = $(this).data('id');
        await requests_deleteRequest(requestId);
    });

    $(document).off('click', '.email-request-button').on('click', '.email-request-button', async function() {
        const requestId = $(this).data('id');
        await requests_emailRequest(requestId);
    });
}

function requests_populateDistrictManagers() {
    const districtManagerSelect = document.getElementById("requests_districtManager");
    districtManagerSelect.innerHTML = '';
    
    let dmsToDisplay = Array.from(requests_districtManagers).sort();

    if (loggedInUserRole === 'District Manager' && loggedInUserDM) {
        dmsToDisplay = dmsToDisplay.filter(dm => dm === loggedInUserDM);
        districtManagerSelect.disabled = true;
    } else if (loggedInUserRole === 'Medical Representative' && loggedInUserDM) {
        const repDM = allGoogleSheetData.find(row => row['medical rep'] === loggedInUserDM)?.['District Manager'];
        dmsToDisplay = repDM ? [repDM] : [];
        districtManagerSelect.disabled = true;
    } else { // Admin
        districtManagerSelect.disabled = false;
        districtManagerSelect.innerHTML = '<option value="">Select District Manager</option>';
    }

    dmsToDisplay.forEach(manager => {
        const option = document.createElement("option");
        option.value = manager;
        option.textContent = manager;
        districtManagerSelect.appendChild(option);
    });

    // Set initial selection based on central filter or logged-in user
    if (loggedInUserRole === 'admin') {
        districtManagerSelect.value = selectedDistrictManagerFilter;
    } else if (loggedInUserRole === 'District Manager' && loggedInUserDM) {
        districtManagerSelect.value = loggedInUserDM;
    } else if (loggedInUserRole === 'Medical Representative' && loggedInUserDM) {
        const repDM = allGoogleSheetData.find(row => row['medical rep'] === loggedInUserDM)?.['District Manager'];
        districtManagerSelect.value = repDM || '';
    }

    requests_filterMedicalRepsForRequests();
}

async function requests_fetchAllRequests() {
    try {
        let allRequests = [];
        const limit = 1000;
        let offset = 0;
        let hasMoreRequests = true;

        while(hasMoreRequests) {
            const { data, error } = await supabaseClient
                .from('requests')
                .select('*')
                .order('date', { ascending: false })
                .range(offset, offset + limit - 1);

            if (error) throw error;

            if (data && data.length > 0) {
                allRequests = allRequests.concat(data);
                offset += data.length;
                hasMoreRequests = data.length === limit;
            } else {
                hasMoreRequests = false;
            }
        }
        
        // Apply initial filtering based on central DM filter or logged-in user
        // This is the primary filtering for the requests data itself
        if (loggedInUserRole === 'admin') {
            if (selectedDistrictManagerFilter) {
                const dmReps = requests_medicalReps.get(selectedDistrictManagerFilter) || new Set();
                requests_allRequests = allRequests.filter(req => dmReps.has(req.medRep));
            } else {
                requests_allRequests = allRequests; // Admin sees all if no DM filter selected
            }
        } else if (loggedInUserRole === 'District Manager' && loggedInUserDM) {
            const dmReps = requests_medicalReps.get(loggedInUserDM) || new Set();
            requests_allRequests = allRequests.filter(req => dmReps.has(req.medRep));
        } else if (loggedInUserRole === 'Medical Representative' && loggedInUserDM) {
            requests_allRequests = allRequests.filter(req => req.medRep === loggedInUserDM);
        } else {
            requests_allRequests = []; // Default for unknown/guest: no requests
        }

        document.getElementById("requests_requestCount").textContent = requests_allRequests.length;
        requests_filterRequests(); // This will apply further UI filters on the already filtered data
    } catch (error) {
        console.error('Error fetching total requests for Requests Dashboard:', error);
        document.getElementById("requests_requestCount").textContent = 'Error';
        showAlertDialog('Error loading requests data. Please try again.', 'error');
    }
}

function requests_filterMedicalRepsForRequests() {
    const districtManager = document.getElementById("requests_districtManager").value;
    const medRepSelect = document.getElementById("requests_medRepFilter");

    medRepSelect.innerHTML = '<option value="">Select Medical Rep</option>';
    
    let repsToPopulate = new Set();
    if (loggedInUserRole === 'admin') {
        if (districtManager) {
            repsToPopulate = requests_medicalReps.get(districtManager) || new Set();
        } else {
            requests_medicalReps.forEach(reps => {
                reps.forEach(rep => repsToPopulate.add(rep));
            });
        }
        medRepSelect.disabled = false;
    } else if (loggedInUserRole === 'District Manager' && loggedInUserDM) {
        repsToPopulate = requests_medicalReps.get(loggedInUserDM) || new Set();
        medRepSelect.disabled = false;
    } else if (loggedInUserRole === 'Medical Representative' && loggedInUserDM) {
        repsToPopulate.add(loggedInUserDM);
        medRepSelect.disabled = true;
    } else {
        medRepSelect.disabled = true;
    }

    Array.from(repsToPopulate).sort().forEach(rep => {
        const option = document.createElement("option");
        option.value = rep;
        option.textContent = rep;
        medRepSelect.appendChild(option);
    });

    if (loggedInUserRole === 'Medical Representative' && loggedInUserDM) {
        medRepSelect.value = loggedInUserDM;
    }

    requests_populateareasForRequests();
    requests_filterRequests();
}

function requests_populateareasForRequests() {
    const medRepSelect = document.getElementById("requests_medRepFilter");
    const areaSelect = document.getElementById("requests_areaFilter");
    const districtManager = document.getElementById("requests_districtManager").value;

    areaSelect.innerHTML = '<option value="">Select area</option>';
    let areasToPopulate = new Set();

    const selectedMedRep = medRepSelect.value;

    if (selectedMedRep) {
        if (requests_areasByMedRep.has(selectedMedRep)) {
            requests_areasByMedRep.get(selectedMedRep).forEach(area => areasToPopulate.add(area));
        }
    } else if (districtManager) {
        const repsUnderDM = requests_medicalReps.get(districtManager) || new Set();
        repsUnderDM.forEach(rep => {
            if (requests_areasByMedRep.has(rep)) {
                requests_areasByMedRep.get(rep).forEach(area => areasToPopulate.add(area));
            }
        });
    } else {
        // If no DM or Med Rep selected, populate all areas from all reps
        requests_areasByMedRep.forEach(areas => {
            areas.forEach(area => areasToPopulate.add(area));
        });
    }

    Array.from(areasToPopulate).sort().forEach(area => {
        const option = document.createElement("option");
        option.value = area;
        option.textContent = area;
        areaSelect.appendChild(option);
    });
}

function requests_filterRequests() {
    const districtManager = document.getElementById("requests_districtManager").value;
    const medRep = document.getElementById("requests_medRepFilter").value;
    const area = document.getElementById("requests_areaFilter").value; 
    const status = document.getElementById("requests_statusFilter").value;
    const requestType = document.getElementById("requests_requestTypeFilter").value;
    const searchTerm = document.getElementById("requests_searchBox").value.toLowerCase();

    let filteredData = requests_allRequests;

    // Apply central DM filter first if admin is logged in and a DM is selected
    if (loggedInUserRole === 'admin' && selectedDistrictManagerFilter) {
        const repsForSelectedDM = requests_medicalReps.get(selectedDistrictManagerFilter) || new Set();
        filteredData = filteredData.filter(req => repsForSelectedDM.has(req.medRep));
    } else if (loggedInUserRole === 'District Manager' && loggedInUserDM) {
        const repsForLoggedInDM = requests_medicalReps.get(loggedInUserDM) || new Set();
        filteredData = filteredData.filter(req => repsForLoggedInDM.has(req.medRep));
    } else if (loggedInUserRole === 'Medical Representative' && loggedInUserDM) {
        filteredData = filteredData.filter(req => req.medRep === loggedInUserDM);
    }


    if (districtManager) { // This filter is now secondary to the central DM filter for admin
        const repsForSelectedDM = requests_medicalReps.get(districtManager) || new Set();
        filteredData = filteredData.filter(req => repsForSelectedDM.has(req.medRep));
    }

    if (medRep) {
        filteredData = filteredData.filter(req => req.medRep === medRep);
    }

    if (area) { 
        filteredData = filteredData.filter(req => req.area === area);
    }

    if (status) {
        filteredData = filteredData.filter(req => req.status === status);
    }

    if (requestType) {
        if (requestType.toLowerCase() === 'personal') {
            filteredData = filteredData.filter(req => req.customerType?.toLowerCase() === 'personal');
        } else if (requestType.toLowerCase() === 'customer') {
            filteredData = filteredData.filter(req => req.customerType?.toLowerCase() !== 'personal');
        }
    }

    if (searchTerm) {
        filteredData = filteredData.filter(req =>
            req.medRep?.toLowerCase().includes(searchTerm) ||
            req.customerName?.toLowerCase().includes(searchTerm) ||
            req.requestTitle?.toLowerCase().includes(searchTerm) ||
            req.requestDetails?.toLowerCase().includes(searchTerm) ||
            req.area?.toLowerCase().includes(searchTerm) ||
            req.status?.toLowerCase().includes(searchTerm) ||
            req.customerType?.toLowerCase().includes(searchTerm)
        );
    }

    const sortedData = filteredData.sort((a, b) => {
        const dateA = new Date(a.date).getTime();
        const dateB = new Date(b.date).getTime();
        const statusOrder = { "Requested": 1, "Pending": 2, "Scheduled": 3, "Postponed": 4, "Approved": 5, "Done": 6, "Rejected": 7 };

        const statusA = statusOrder[a.status] || 99;
        const statusB = statusOrder[b.status] || 99;

        if (statusA !== statusB) {
            return statusA - statusB;
        }
        return dateB - dateA;
    });

    document.getElementById("requests_filteredCount").textContent = sortedData.length;
    requests_displayRequests(sortedData);
}

function requests_displayRequests(data) {
    const requestDetailsDisplay = document.getElementById("requests_requestDetailsDisplay");
    requestDetailsDisplay.innerHTML = '';

    if (data.length > 0) {
        data.forEach(req => {
            const requestCard = document.createElement("div");
            requestCard.className = `request-card status-${req.status.toLowerCase()}`;

            let customerTypeDisplay = '';
            let customerNameDisplay = '';
            let statusOptions = ``;

            if (req.customerType && req.customerType.toLowerCase() === 'personal') {
                customerTypeDisplay = '';
                customerNameDisplay = `<div class="detail-item">
                                            <div class="detail-label">Medical Rep</div>
                                            <div class="detail-value">${req.medRep || 'N/A'}</div>
                                        </div>`;
                statusOptions = `
                    <option value="Requested" ${req.status === "Requested" ? 'selected' : ''}>Requested</option>
                    <option value="Approved" ${req.status === "Approved" ? 'selected' : ''}>Approved</option>
                    <option value="Rejected" ${req.status === "Rejected" ? 'selected' : ''}>Rejected</option>
                `;
            } else {
                customerTypeDisplay = `<div class="detail-item">
                                            <div class="detail-label">Customer Type</div>
                                            <div class="detail-value">${req.customerType || 'N/A'}</div>
                                        </div>`;
                customerNameDisplay = `<div class="detail-item">
                                            <div class="detail-label">Customer Name</div>
                                            <div class="detail-value">${req.customerName || 'N/A'}</div>
                                        </div>`;
                statusOptions = `
                    <option value="Requested" ${req.status === "Requested" ? 'selected' : ''}>Requested</option>
                    <option value="Scheduled" ${req.status === "Scheduled" ? 'selected' : ''}>Scheduled</option>
                    <option value="Pending" ${req.status === "Pending" ? 'selected' : ''}>Pending</option>
                    <option value="Postponed" ${req.status === "Postponed" ? 'selected' : ''}>Postponed</option>
                    <option value="Done" ${req.status === "Done" ? 'selected' : ''}>Done</option>
                    <option value="Rejected" ${req.status === "Rejected" ? 'selected' : ''}>Rejected</option>
                    <option value="Approved" ${req.status === "Approved" ? 'selected' : ''}>Approved</option>
                `;
            }


            requestCard.innerHTML = `
                <div class="request-header">
                    <div>
                        <div class="request-title">${req.requestTitle || 'No Title'}</div>
                        <div class="request-meta">By ${req.medRep || 'Unknown'}  ${new Date(req.date).toLocaleDateString()}</div>
                    </div>
                    <div class="status-badge status-${req.status.toLowerCase()}">${req.status}</div>
                </div>

                <div class="request-details">
                    <div class="detail-item">
                        <div class="detail-label">area</div>
                        <div class="detail-value">${req.area || 'N/A'}</div>
                    </div>
                    ${customerTypeDisplay}
                    ${customerNameDisplay}
                </div>

                <div class="request-description">
                    <h4>Request Details</h4>
                    <p>${req.requestDetails || 'No details provided'}</p>
                </div>

                <div class="status-control">
                    <label>Update Status:</label>
                    <select class="status-select" onchange="requests_updateStatus(${req.id}, this.value)" ${loggedInUserRole === 'admin' ? '' : 'disabled'}>
                        ${statusOptions}
                    </select>
                </div>
                <div class="request-card-actions">
                    ${loggedInUserRole === 'admin' ? `<button class="delete-request-button" data-id="${req.id}" title="Delete Request"><i class="fas fa-trash"></i></button>` : ''}
                    <button class="email-request-button" data-id="${req.id}" title="Email Request"><i class="fas fa-envelope"></i></button>
                </div>
            `;
            requestDetailsDisplay.appendChild(requestCard);
        });
    } else {
        requestDetailsDisplay.innerHTML = `
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <h3>No requests found</h3>
                <p>Try adjusting your filters or search terms.</p>
            </div>
        `;
    }
}

async function requests_updateStatus(requestId, newStatus) {
    if (loggedInUserRole !== 'admin') {
        showAlertDialog('You do not have permission to update request status.', 'error');
        return;
    }
    try {
        const response = await fetch(`${SUPABASE_URL}requests?id=eq.${requestId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'apikey': SUPABASE_API_KEY,
                'Authorization': `Bearer ${SUPABASE_API_KEY}`
            },
            body: JSON.stringify({ status: newStatus })
        });
        if (response.ok) {
            const updatedRequestIndex = requests_allRequests.findIndex(req => req.id === requestId);
            if (updatedRequestIndex !== -1) {
                requests_allRequests[updatedRequestIndex].status = newStatus;
            }
            requests_filterRequests();
            showAlertDialog('Status updated successfully!', 'success');
        } else {
            const errorData = await response.json();
            console.error('Error updating status:', errorData);
            showAlertDialog("Failed to update status: " + (errorData.message || 'Unknown error'), 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlertDialog("An error occurred while updating the status.", 'error');
    }
}

async function requests_deleteRequest(requestId) {
    if (loggedInUserRole !== 'admin') {
        showAlertDialog('You do not have permission to delete requests.', 'error');
        return;
    }
    const confirmed = await showConfirmModal('Are you sure you want to delete this request? This action cannot be undone.');
    if (!confirmed) {
        showAlertDialog('Deletion cancelled.', 'info');
        return;
    }

    try {
        const response = await fetch(`${SUPABASE_URL}requests?id=eq.${requestId}`, {
            method: 'DELETE',
            headers: {
                'apikey': SUPABASE_API_KEY,
                'Authorization': `Bearer ${SUPABASE_API_KEY}`
            }
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to delete request from Supabase.');
        }

        showAlertDialog('Request deleted successfully!', 'success');
        await requests_fetchAllRequests(); // Refresh the list
    } catch (error) {
        console.error('Error deleting request:', error);
        showAlertDialog('Error deleting request: ' + error.message, 'danger');
    }
}

async function requests_emailRequest(requestId) {
    const request = requests_allRequests.find(req => req.id === requestId);
    if (!request) {
        showAlertDialog('Request details not found.', 'error');
        return;
    }

    // Generate the email content directly
    const emailBody = `Dear Doctor,

Kindly review the following request at your convenience.

Request Title: ${request.requestTitle}
Request Details: ${request.requestDetails}
Medical Representative: ${request.medRep}
Customer Name: ${request.customerName || 'N/A'}
Area: ${request.area}
Status: ${request.status}

Thank you.`;

    // Include the request title in the mail subject
    const subject = `Request Review: ${request.requestTitle}`;

    // Create the mailto link with the subject and body
    const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;

    // Open the default email client with the pre-filled subject and body
    window.location.href = mailtoLink;
}


// --- Weekly Plan Dashboard Functions ---
async function initWeeklyPlanDashboard() {
    // Fetch medical reps for weekly plan dropdown
    try {
        if (allGoogleSheetData.length === 0) {
            const response = await fetch(GOOGLE_SHEET_URL);
            if (!response.ok) {
                throw new Error('Failed to fetch medical reps for weekly plan from Google Sheets.');
            }
            const csvText = await response.text();
            allGoogleSheetData = parseCSV(csvText);
        }

        let medicalReps = [...new Set(allGoogleSheetData.map(row => row['medical rep']).filter(Boolean))];
        
        // Filter medical reps based on central DM filter
        if (loggedInUserRole === 'admin') {
            if (selectedDistrictManagerFilter) {
                const dmReps = new Set();
                allGoogleSheetData.forEach(row => {
                    if (row['District Manager'] === selectedDistrictManagerFilter && row['medical rep']) {
                        dmReps.add(row['medical rep']);
                    }
                });
                medicalReps = medicalReps.filter(rep => dmReps.has(rep));
            }
            // If admin and no DM filter, medicalReps remains all reps
            $('#weeklyPlanMedicalReps').prop('disabled', false); // Admin can select
        } else if (loggedInUserRole === 'District Manager' && loggedInUserDM) {
            const dmReps = new Set();
            allGoogleSheetData.forEach(row => {
                if (row['District Manager'] === loggedInUserDM && row['medical rep']) {
                    dmReps.add(row['medical rep']);
                }
            });
            medicalReps = medicalReps.filter(rep => dmReps.has(rep));
            $('#weeklyPlanMedicalReps').prop('disabled', false); // DM can select their own reps
        } else if (loggedInUserRole === 'Medical Representative' && loggedInUserDM) {
            medicalReps = medicalReps.filter(rep => rep === loggedInUserDM);
            $('#weeklyPlanMedicalReps').prop('disabled', true); // MR sees only themselves and it's disabled
        } else {
            medicalReps = []; // Default for unknown/guest: no reps, disabled
            $('#weeklyPlanMedicalReps').prop('disabled', true);
        }

        populateSelect('weeklyPlanMedicalReps', medicalReps, 'Select a Medical Rep');
        if (loggedInUserRole === 'Medical Representative' && loggedInUserDM) {
            $('#weeklyPlanMedicalReps').val(loggedInUserDM);
        }

        setDefaultWeeklyPlanDateRange();
        $('#weeklyPlanLoading').hide();
    } catch (error) {
        $('#weeklyPlanLoading').hide();
        $('#weeklyPlanError').show().text('Error loading medical representatives: ' + error.message);
        console.error('Error loading medical representatives for weekly plan:', error);
    }

    // Attach event listeners for weekly plan
    $('#weeklyPlanMedicalReps').off('change').on('change', function() {
        const selectedRep = $(this).val();
        const startDate = $('#weeklyPlanStartDate').val();
        if (selectedRep && startDate) {
            retrieveWeeklyPlan();
        } else if (!selectedRep) {
            // If no rep is selected, clear the plan content
            document.getElementById('weeklyPlanContent').style.display = 'none';
            clearWeeklyPlanSelection();
            renderWeeklyPlan(); // Render empty tables
        }
    });
    $('#weeklyPlanStartDate').off('change').on('change', function() {
        const startDateInput = document.getElementById('weeklyPlanStartDate');
        const startDate = new Date(startDateInput.value);
        const endDateInput = document.getElementById('weeklyPlanEndDate');
        endDateInput.value = new Date(startDate.setDate(startDate.getDate() + 6)).toISOString().split('T')[0];
        
        const selectedRep = $('#weeklyPlanMedicalReps').val();
        if (selectedRep && startDateInput.value) { // Trigger retrieve if both rep and date are selected
            retrieveWeeklyPlan();
        }
    });

    $('#weeklyPlanResetButton').off('click').on('click', resetWeeklyPlanTable);
    $('#weeklyPlanDownloadButton').off('click').on('click', downloadWeeklyPlanExcel);
    $('#weeklyPlanDeleteVisitButton').off('click').on('click', deleteSelectedWeeklyPlanVisit);

    $(document).off('click.weeklyPlanOutside').on('click.weeklyPlanOutside', (event) => {
        const isVisitBox = event.target.closest('.hcp-box, .specialty-box, .special-speciality-box');
        const isDeleteButton = event.target.closest('#weeklyPlanDeleteVisitButton');
        const isModal = event.target.closest('#customConfirmModal');

        if (!isVisitBox && !isDeleteButton && !isModal && weeklyPlanSelectedVisitIds.length > 0) {
            clearWeeklyPlanSelection();
        }
    });

    // Initial retrieval if a medical rep is pre-selected (e.g., for MR login)
    if (loggedInUserRole === 'Medical Representative' && loggedInUserDM) {
        const startDate = $('#weeklyPlanStartDate').val();
        if (loggedInUserDM && startDate) {
            retrieveWeeklyPlan();
        }
    }
}

// Retrieve weekly plan from Supabase
async function retrieveWeeklyPlan() {
    const selectedRep = document.getElementById('weeklyPlanMedicalReps').value;
    const startDate = document.getElementById('weeklyPlanStartDate').value;
    const endDate = document.getElementById('weeklyPlanEndDate').value;

    if (!selectedRep && loggedInUserRole !== 'admin') { // Only require selection if not admin
        showAlertDialog('Please select a Medical Representative.', 'warning');
        return;
    }
    if (!startDate) {
        showAlertDialog('Please select a Start Date.', 'warning');
        return;
    }

    $('#weeklyPlanLoading').show();
    $('#weeklyPlanContent').css('opacity', '0.5');

    let allWeeklyPlans = [];
    const limit = 1000;
    let offset = 0;
    let hasMoreWeeklyPlans = true;

    try {
        while(hasMoreWeeklyPlans) {
            let query = supabaseClient
                .from('weekly_plans')
                .select('*')
                .gte('start_date', startDate)
                .lte('end_date', endDate) 
                .order('visit_day', { ascending: true }) 
                .order('visit_time', { ascending: true }) 
                .range(offset, offset + limit - 1);

            // Apply role-based filtering directly in the Supabase query if possible
            if (loggedInUserRole === 'District Manager' && loggedInUserDM) {
                const dmReps = new Set();
                allGoogleSheetData.forEach(row => {
                    if (row['District Manager'] === loggedInUserDM && row['medical rep']) {
                        dmReps.add(row['medical rep']);
                    }
                });
                // Convert Set to Array for `in` operator
                const repsArray = Array.from(dmReps);
                if (repsArray.length > 0) {
                    query = query.in('medical_rep_name', repsArray);
                } else {
                    // If no reps under this DM, return empty data immediately
                    allWeeklyPlans = [];
                    hasMoreWeeklyPlans = false;
                    break; // Exit loop
                }
            } else if (loggedInUserRole === 'Medical Representative' && loggedInUserDM) {
                query = query.eq('medical_rep_name', loggedInUserDM);
            } else if (loggedInUserRole === 'admin' && selectedDistrictManagerFilter) {
                 const dmReps = new Set();
                allGoogleSheetData.forEach(row => {
                    if (row['District Manager'] === selectedDistrictManagerFilter && row['medical rep']) {
                        dmReps.add(row['medical rep']);
                    }
                });
                const repsArray = Array.from(dmReps);
                if (repsArray.length > 0) {
                    query = query.in('medical_rep_name', repsArray);
                } else {
                    allWeeklyPlans = [];
                    hasMoreWeeklyPlans = false;
                    break;
                }
            }
            // If admin and no selectedDmFilter, query remains unfiltered for all reps

            // If a specific rep is selected in the dropdown (e.g., by admin or DM)
            if (selectedRep) {
                query = query.eq('medical_rep_name', selectedRep);
            }


            const { data, error } = await query;

            if (error) throw error;

            if (data && data.length > 0) {
                allWeeklyPlans = allWeeklyPlans.concat(data);
                offset += data.length;
                hasMoreWeeklyPlans = data.length === limit;
            } else {
                hasMoreWeeklyPlans = false;
            }
        }
        
        weeklyPlan = {
            Saturday: { am: [], pm: [] },
            Sunday: { am: [], pm: [] },
            Monday: { am: [], pm: [] },
            Tuesday: { am: [], pm: [] },
            Wednesday: { am: [], pm: [] },
            Thursday: { am: [], pm: [] }
        };

        allWeeklyPlans.forEach(item => {
            const day = item.visit_day;
            const hcpEntry = {
                id: item.id,
                name: item.hcp_name,
                time: item.visit_time,
                Speciality: item.Speciality,
                brick: item.brick
            };
            
            if (weeklyPlan[day]) {
                if (item.Speciality === 'AM') {
                    weeklyPlan[day].am.push(hcpEntry);
                } else if (item.Speciality === 'PM') {
                    weeklyPlan[day].pm.push(hcpEntry);
                } else if (item.Speciality === 'Full Day') {
                    weeklyPlan[day].am.push({...hcpEntry});
                    weeklyPlan[day].pm.push({...hcpEntry});
                } else {
                    const AMSpecialities = ['Account', 'Hospital', 'Dialysis Center', 'Oncology Center'];
                    const PMSpecialities = ['GP', 'Specialist', 'Pharmacy'];
                    
                    if (AMSpecialities.includes(hcpEntry.Speciality)) {
                        weeklyPlan[day].am.push(hcpEntry);
                    } else if (PMSpecialities.includes(hcpEntry.Speciality)) {
                        weeklyPlan[day].pm.push(hcpEntry);
                    } else {
                        weeklyPlan[day].pm.push(hcpEntry);
                    }
                }
            }
        });

        renderWeeklyPlan();
        updateWeeklyPlanTableHeaders();
        document.getElementById('weeklyPlanContent').style.display = 'flex';
        showAlertDialog('Weekly plan retrieved successfully!', 'success');
        clearWeeklyPlanSelection();
    } catch (error) {
        console.error('Error retrieving weekly plan:', error);
        showAlertDialog('Error retrieving weekly plan: ' + error.message, 'danger');
    } finally {
        $('#weeklyPlanLoading').hide();
        $('#weeklyPlanContent').css('opacity', '1');
    }
}

// Render weekly plan to tables
function renderWeeklyPlan() {
    const daysOfWeek = ['saturday', 'sunday', 'monday', 'tuesday', 'wednesday', 'thursday'];
    daysOfWeek.forEach(day => {
        document.getElementById(`${day}Am`).innerHTML = '';
        document.getElementById(`${day}Pm`).innerHTML = '';
    });

    Object.keys(weeklyPlan).forEach(day => {
        const amCell = document.getElementById(`${day.toLowerCase()}Am`);
        const pmCell = document.getElementById(`${day.toLowerCase()}Pm`);

        if (weeklyPlan[day].am.length > 0) {
            weeklyPlan[day].am.forEach(hcp => {
                const isSpecialSpeciality = ['AM', 'PM', 'Full Day'].includes(hcp.Speciality);
                amCell.innerHTML += `
                    <div class="${isSpecialSpeciality ? 'special-speciality-box' : 'specialty-box'}" 
                        data-id="${hcp.id}" 
                        data-speciality="${hcp.Speciality}" 
                        ondblclick="handleWeeklyPlanVisitDoubleClick(this, '${hcp.id}')">
                        <div class="hcp-name-weekly">${hcp.name}</div>
                        <div class="visit-time-weekly">${hcp.time || 'N/A'}</div>
                        <div class="brick-info-weekly">${hcp.Speciality} | ${hcp.brick || 'N/A'}</div>
                    </div>
                `;
            });
        } else {
            amCell.innerHTML = '<div class="empty-message">No activities</div>';
        }

        if (weeklyPlan[day].pm.length > 0) {
            weeklyPlan[day].pm.forEach(hcp => {
                const isSpecialSpeciality = ['AM', 'PM', 'Full Day'].includes(hcp.Speciality);
                pmCell.innerHTML += `
                    <div class="${isSpecialSpeciality ? 'special-speciality-box' : 'hcp-box'}" 
                        data-id="${hcp.id}" 
                        data-speciality="${hcp.Speciality}" 
                        ondblclick="handleWeeklyPlanVisitDoubleClick(this, '${hcp.id}')">
                        <div class="hcp-name-weekly">${hcp.name}</div>
                        <div class="visit-time-weekly">${hcp.time || 'N/A'}</div>
                        <div class="brick-info-weekly">${hcp.Speciality} | ${hcp.brick || 'N/A'}</div>
                    </div>
                `;
            });
        } else {
            pmCell.innerHTML = '<div class="empty-message">No activities</div>';
        }
    });
}

// Update table headers with dates
function updateWeeklyPlanTableHeaders() {
    const startDate = new Date(document.getElementById('weeklyPlanStartDate').value);
    const daysOfWeek = ['Saturday', 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday'];

    daysOfWeek.forEach((day, index) => {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + index);
        const formattedDate = `${day} ${date.getDate()}-${date.getMonth() + 1}`;
        document.getElementById(`${day.toLowerCase()}AmHeader`).textContent = formattedDate;
        document.getElementById(`${day.toLowerCase()}PmHeader`).textContent = formattedDate;
    });
}

// Reset table and filters
        function resetWeeklyPlanTable() {
    weeklyPlan = {
        Saturday: { am: [], pm: [] },
        Sunday: { am: [], pm: [] },
        Monday: { am: [], pm: [] },
        Tuesday: { am: [], pm: [] },
        Wednesday: { am: [], pm: [] },
        Thursday: { am: [], pm: [] }
    };
    document.getElementById('weeklyPlanMedicalReps').value = '';
    setDefaultWeeklyPlanDateRange();
    document.getElementById('weeklyPlanContent').style.display = 'none';
    renderWeeklyPlan();
    clearWeeklyPlanSelection();
    showAlertDialog('Filters and table reset.', 'info');

    // Re-populate medical reps and disable if MR is logged in after reset
    populateSelect('weeklyPlanMedicalReps', [...new Set(allGoogleSheetData.map(row => row['medical rep']).filter(Boolean))], 'Select a Medical Rep');
    if (loggedInUserRole === 'Medical Representative' && loggedInUserDM) {
        $('#weeklyPlanMedicalReps').val(loggedInUserDM).prop('disabled', true);
    }
}

function setDefaultWeeklyPlanDateRange() {
    // Create a date object for the current time in Cairo (UTC+2)
    const today = new Date();
    const cairoOffset = 2; // Cairo is UTC+2
    const cairoTime = new Date(today.getTime() + cairoOffset * 60 * 60 * 1000);

    // Calculate the day of the week in Cairo time (0 is Sunday, 6 is Saturday)
    const dayOfWeek = cairoTime.getDay();

    // Calculate the start date based on the current day of the week
    const startDate = new Date(cairoTime);

    // If today is Thursday (4), set start date to next Saturday
    if (dayOfWeek === 4) {
        const diffToNextSaturday = (12 - dayOfWeek) % 7; // Days until next Saturday
        startDate.setDate(cairoTime.getDate() + diffToNextSaturday);
    } else {
        // Otherwise, set start date to the most recent past Saturday
        const diffToPastSaturday = -(dayOfWeek + 2) % 7; // Days since past Saturday
        startDate.setDate(cairoTime.getDate() + diffToPastSaturday);
    }

    // Ensure the date is set to Saturday
    if (startDate.getDay() !== 6) {
        startDate.setDate(startDate.getDate() + 1);
    }

    // Calculate the end date, which is 5 days after the start date
    const endDate = new Date(startDate);
    endDate.setDate(startDate.getDate() + 5);

    // Set the start and end date input fields to the calculated dates
    document.getElementById('weeklyPlanStartDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('weeklyPlanEndDate').value = endDate.toISOString().split('T')[0];
}

        
// Download tables as Excel
function downloadWeeklyPlanExcel() {
    const selectedRep = document.getElementById('weeklyPlanMedicalReps').value;
    if (!selectedRep) {
        showAlertDialog('Please select a Medical Representative first to download the Weekly Plan.', 'warning');
        return;
    }

    const wb = XLSX.utils.book_new();
    
    const headerRow = [["Weekly Plan"]];
    const amHeader = ["AM Activities"];
    const amColumns = ["Day", "HCP Name", "Visit Time", "Specialty", "Brick"];
    const pmHeader = ["PM Activities"];
    const pmColumns = ["Day", "HCP Name", "Visit Time", "Specialty", "Brick"];

    const amData = [
        ...Object.keys(weeklyPlan).flatMap(day =>
            weeklyPlan[day].am.map(hcp => [day, hcp.name, hcp.time || 'N/A', hcp.Speciality, hcp.brick || 'N/A'])
        )
    ];

    const pmData = [
        ...Object.keys(weeklyPlan).flatMap(day =>
            weeklyPlan[day].pm.map(hcp => [day, hcp.name, hcp.time || 'N/A', hcp.Speciality, hcp.brick || 'N/A'])
        )
    ];

    const amSheet = XLSX.utils.aoa_to_sheet([...headerRow, [], amHeader, amColumns, ...amData]);
    const pmSheet = XLSX.utils.aoa_to_sheet([...headerRow, [], pmHeader, pmColumns, ...pmData]);

    const applyStyles = (ws) => {
        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let C = range.s.c; C <= range.e.c; ++C) {
            for (let R = range.s.r; R <= range.e.r; ++R) {
                const cell = ws[XLSX.utils.encode_cell({ c: C, r: R })];
                if (cell) {
                    if (R === 0 || R === 2 || R === 5) {
                        cell.s = { alignment: { horizontal: "center" }, font: { bold: true } };
                    } else if (R === 1 || R === 4 || R === 7) {
                        cell.s = { font: { bold: true } };
                    }
                    cell.s = { ...cell.s, border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } } };
                }
            }
        }
    };

    applyStyles(amSheet);
    applyStyles(pmSheet);

    XLSX.utils.book_append_sheet(wb, amSheet, 'AM Activities');
    XLSX.utils.book_append_sheet(wb, pmSheet, 'PM Activities');

    XLSX.writeFile(wb, 'weekly_plan.xlsx');
    showAlertDialog('Weekly plan downloaded as Excel.', 'success');
}

function handleWeeklyPlanVisitDoubleClick(element, visitId) {
    element.classList.toggle('selected-visit-box');

    weeklyPlanSelectedVisitIds = Array.from(document.querySelectorAll('.selected-visit-box')).map(box => box.dataset.id);

    if (weeklyPlanSelectedVisitIds.length > 0) {
        document.getElementById('weeklyPlanDeleteVisitButton').style.display = 'inline-flex';
    } else {
        document.getElementById('weeklyPlanDeleteVisitButton').style.display = 'none';
    }
}

function clearWeeklyPlanSelection() {
    document.querySelectorAll('.selected-visit-box').forEach(box => {
        box.classList.remove('selected-visit-box');
    });
    weeklyPlanSelectedVisitIds = [];
    document.getElementById('weeklyPlanDeleteVisitButton').style.display = 'none';
}

async function deleteSelectedWeeklyPlanVisit() {
    if (weeklyPlanSelectedVisitIds.length === 0) {
        showAlertDialog('No visits selected for deletion.', 'warning');
        return;
    }

    const confirmed = await showConfirmModal(
        weeklyPlanSelectedVisitIds.length > 1 
            ? `Are you sure you want to delete these ${weeklyPlanSelectedVisitIds.length} visits?`
            : `Are you sure you want to delete this visit?`
    );
    if (!confirmed) {
        showAlertDialog('Deletion cancelled.', 'info');
        return;
    }

    try {
        const idsToDelete = weeklyPlanSelectedVisitIds.join(',');
        const response = await fetch(`${SUPABASE_URL}weekly_plans?id=in.(${idsToDelete})`, {
            method: 'DELETE',
            headers: {
                'apikey': SUPABASE_API_KEY,
                'Authorization': `Bearer ${SUPABASE_API_KEY}`
            }
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to delete visits from Supabase.');
        }

        showAlertDialog('Selected visits deleted successfully!', 'success');
        clearWeeklyPlanSelection();
        retrieveWeeklyPlan();
    } catch (error) {
        console.error('Error deleting visits:', error);
        showAlertDialog('Error deleting visits: ' + error.message, 'danger');
    }
}

// --- Document Ready / Initial Load ---
$(document).ready(function() {
    // Hide the original login page and show the dashboard content directly
    $('#login-page').hide();
    $('#dashboard-content').show();
    initializeCommonDashboard();
});
</script>
</body>
</html>
