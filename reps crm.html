<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paxton LLC CRM</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        /* Base styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }
        html, body {
            height: 100%;
            overflow-x: hidden;
        }
        body {
            background-color: #f5f7fa; /* Light background */
            background-image: linear-gradient(to top, #f3e7e9 0%, #e3eeff 99%, #e3eeff 100%);
            padding: 12px;
            color: #333;
        }
        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 14px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .form-header {
            display: flex;
            align-items: center;
            margin-bottom: 14px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e9ecef;
        }
        .form-logo {
            width: 36px;
            height: 36px;
            background-color: #4361ee;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            color: white;
            font-size: 18px;
        }
        .form-title {
            color: #212b36;
            font-size: 18px;
            font-weight: 600;
            flex: 1;
        }
        .form-group {
            margin-bottom: 8px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 12px;
            color: #495057;
        }
        select, input, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #dce0e5;
            border-radius: 18px;
            font-size: 12px;
            transition: all 0.2s ease;
            background-color: #fff;
        }
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #4361ee;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        h2 {
            color: #3a3a3a;
            margin: 10px 0 8px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        h2 i {
            margin-right: 8px;
        }
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        .section-card {
            background-color: white;
            border-radius: 10px;
            margin-bottom: 20px;
            padding: 16px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }
        .info-section {
            background-color: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            border: 1px solid #e9ecef;
        }
        .info-section-title {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 4px;
            color: #3a3a3a;
        }
        .info-section-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .info-value {
            font-weight: 600;
            color: #4361ee;
        }
        .last-visit-date {
            color: #dc3545;
            font-size: 13px;
            margin-top: 4px;
        }
        .saved-comment-title {
            font-weight: 600;
            color: #3a3a3a;
            font-size: 14px;
            margin-bottom: 4px;
        }
        .saved-comment-content {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #90caf9;
            font-size: 12px;
            color: #0d47a1;
        }
        .tab-group {
            display: flex;
            gap: 2px;
            margin: 12px 0;
            background-color: #f5f7fa;
            padding:4px;
            border-radius: 18px;
        }
        .tab-button {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            background-color: transparent;
            color: #495057;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
        }
        .tab-button i {
            margin-right: 8px;
            margin-bottom: 0;
            font-size: 14px;
        }
        .tab-button span {
            font-size: 10px;
            line-height: 1;
        }
        .tab-button.selected {
            background-color: #4361ee;
            color: white;
            box-shadow: 0 2px 4px rgba(67, 97, 238, 0.2);
        }
        .tab-button:hover:not(:disabled):not(.selected) {
            background-color: rgba(67, 97, 238, 0.08);
        }
        .tab-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .action-button-group {
            display: flex;
            gap: 10px;
            margin: 24px 0 16px;
        }
        .action-button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 18px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .action-button i {
            margin-right: 8px;
        }
        .action-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .submit-btn {
            background-color: #4361ee;
            color: white;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
        }
        .submit-btn:hover:not(:disabled) {
            background-color: #3a56d4;
            transform: translateY(-1px);
        }
        .reset-btn {
            background-color: #fff;
            color: red;
            border: 1px solid #dce0e5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .reset-btn:hover:not(:disabled) {
            background-color: #f8f9fa;
        }
        .retrieve-btn {
            background-color: #2e8540;
            color: white;
            box-shadow: 0 4px 12px rgba(46, 133, 64, 0.2);
        }
        .retrieve-btn:hover:not(:disabled) {
            background-color: #267438;
            transform: translateY(-1px);
        }
        .alert {
            padding: 8px 12px;
            margin: 12px 0;
            border-radius: 14px;
            font-size: 13px;
            animation: fadeIn 0.3s;
            display: flex;
            align-items: flex-start;
        }
        .alert i {
            margin-right: 12px;
            font-size: 13px;
            margin-top: 2px;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .alert-error {
            background-color: #ffebee;
            border: 1px solid #ef9a9a;
            color: #c62828;
        }
        .alert-success {
            background-color: #e8f5e9;
            border: 1px solid #a5d6a7;
            color: #2e7d32;
        }
        .table-container {
            overflow-x: auto;
            margin-top: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
            width: 100%;
        }
        table {
            border-collapse: separate;
            border-spacing: 0;
            max-height: 600px;
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            font-size: 13px;
            white-space: nowrap;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
        }
        tbody tr:hover {
            background-color: rgba(67, 97, 238, 0.05);
        }
        th:first-child, td:first-child {
            position: sticky;
            left: 0;
            background-color: white;
            z-index: 10;
        }
        .hidden {
            display: none;
        }
        .readonly-input {
            background-color: #f8fafc;
            color: #6c757d;
            cursor: not-allowed;
        }
        .form-row {
            display: flex;
            gap: 12px;
        }
        .form-row > div {
            flex: 1;
        }
        .search-box {
            margin-bottom: 16px;
            position: relative;
        }
        .search-box input {
            width: 100%;
            padding: 10px 12px 10px 36px;
            border: 1px solid #dce0e5;
            border-radius: 8px;
            font-size: 14px;
        }
        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            color: #6c757d;
        }
        .pharmacy-row {
            color: #2e8540;
        }
        .event-row {
            color: #e67700;
        }
        .required-field::after {
            content: " *";
            color: #dc3545;
        }
        .form-helper-text {
            font-size: 12px;
            color: #6c757d;
            margin-top: 4px;
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-success {
            background-color: #e6f7ed;
            color: #2e8540;
        }
        .badge-warning {
            background-color: #fff3e0;
            color: #e67700;
        }
        .badge-danger {
            background-color: #fee2e2;
            color: #dc3545;
        }
        #brickHcp, #specialtyHcp {
            background-color: #f3e5f5;
            color: #4a148c;
            padding: 10px 12px;
            border: 1px solid #ce93d8;
            border-radius: 18px;
        }
        .med-rep-card {
            background-color: transparent;
            padding: 0;
            margin-bottom: 1rem;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 0.5rem;
        }
        .med-rep-info {
            display: flex;
            flex-direction: column;
            background-color: #f8fafc;
            border-radius: 8px;
            padding: 8px 12px;
            border: 1px solid #e9ecef;
        }
        .med-rep-name {
            font-weight: 600;
            color: #3a3a3a;
            font-size: 14px;
        }
        .med-rep-area, .med-rep-dm, .med-rep-gov {
            font-size: 12px;
            color: #6c757d;
        }
        .dashboard-container {
            width: 100%;
            padding: 0.5rem;
            margin: 0;
        }
        .dashboard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        .dashboard-header h1 {
            font-size: 18px;
            font-weight: 600;
            color: #212b36;
        }
        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .select-wrapper {
            position: relative;
        }
        .select-wrapper::after {
            content: 'â–¼';
            font-size: 0.8rem;
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            pointer-events: none;
        }
        .dashboard-container select, .dashboard-container input {
            padding: 0.45rem 1rem;
            border: 1px solid #dce0e5;
            border-radius: 18px;
            font-size: 12px;
            background-color: white;
            color: #374151;
            transition: all 0.2s;
        }
        .dashboard-container select:focus, .dashboard-container input:focus {
            outline: none;
            border-color: #4361ee;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        .dashboard-container select:disabled {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }
        .btn {
            padding: 10px;
            border-radius: 18px;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.2s;
            width: 100%;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-primary {
            background-color: #4361ee;
            color: white;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
        }
        .btn-primary:hover {
            background-color: #3a56d4;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: #fff;
            color: red;
            border: 1px solid #dce0e5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .btn-secondary:hover {
            background-color: #f8f9fa;
        }
        .custom-select {
            position: relative;
            width: 100%;
        }
        .custom-select-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            border: 1px solid #dce0e5;
            border-radius: 18px;
            background-color: white;
            color: #374151;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .custom-select-trigger:focus {
            outline: none;
            border-color: #4361ee;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        .custom-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 0.25rem;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        .custom-select-options.show {
            display: block;
        }
        .custom-select-option {
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }
        .custom-select-option:hover {
            background-color: #f3f4f6;
        }
        .custom-select-option.selected {
            background-color: #4361ee;
            color: white;
        }
        .custom-select-option.highlighted {
            background-color: #dbeafe;
        }
        .dashboard-container .search-box {
            padding: 10px 12px;
            border: 1px solid #dce0e5;
            border-radius: 18px;
            font-size: 12px;
        }
        .dashboard-container .search-box:focus {
            outline: none;
            border-color: #4361ee;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        .dashboard-container .table-container {
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
        }
        .dashboard-container table {
            font-size: 13px;
        }
        .dashboard-container th, .dashboard-container td {
            padding: 12px 16px;
            font-size: 13px;
            border-bottom: 1px solid #e9ecef;
        }
        .dashboard-container th {
            background-color: #f8f9fa;
            color: #495057;
            font-weight: 600;
        }
        .dashboard-container tbody tr:hover {
            background-color: rgba(67, 97, 238, 0.05);
        }
        #hcpTableDashboard th:first-child,
        #hcpTableDashboard td:first-child {
            position: sticky;
            left: 0;
            background-color: white;
            z-index: 100;
        }
        #hcpTableDashboard {
            overflow-x: auto;
            border-collapse: separate;
            border-spacing: 0;
        }
        .sticky-col, td.sticky {
            position: sticky;
            left: 0;
            background-color: inherit;
            z-index: 20;
            border-right: 2px solid #e5e7eb;
            background-color: #fff;
        }
        th.sticky-col {
            z-index: 30;
            background-color: #f8f9fa;
        }
        .light-red { background-color: #fee2e2; }
        .light-yellow { background-color: #fef3c7; }
        .light-green { background-color: #dcfce7; }
        .highlight { background-color: #dbeafe !important; }
        .first-visit-of-day { background-color: #d4edda !important; }
        .status-count {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            background-color: #dbeafe;
            color: #1e40af;
            margin-bottom: 1rem;
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .visit-stats-card {
            background-color: #f8fafc;
            border-radius: 8px;
            padding: 12px;
            margin: 16px 0;
            border: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .visit-stats-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        .visit-stats-label {
            font-weight: 500;
            color: #495057;
        }
        .visit-stats-value {
            font-weight: 600;
            color: #4361ee;
        }
        .visit-stats-red {
            color: #dc3545;
            font-weight: 600;
        }
        .unvisited-count-square {
            display: inline-block;
            background-color: #ff0000;
            color: #ffffff;
            padding: 1px 5px;
            margin-left: 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            line-height: 1;
            vertical-align: middle;
        }

        /* --- Request Form Specific Styles --- */
        #requestSection h1 {
            color: #212b36;
            text-align: center;
            margin-bottom: 14px;
            font-size: 18px;
            font-weight: 600;
            position: relative;
            text-align: left; /* Explicitly left-align text */
            justify-content: flex-start; /* Align children to the left */
        }
        #requestSection h1 {
    color: #212b36;
    text-align: center;
    margin-bottom: 14px;
    font-size: 18px;
    font-weight: 600;
    position: relative;
    text-align: left;
    justify-content: flex-start;
}

        #requestSection label {
            display: block;
            margin-top: 10px;
            font-weight: 500;
            font-size: 12px;
            color: #495057;
        }
        #requestSection .required::after {
            content: " *";
            color: #dc3545;
        }
        #requestSection select,
        #requestSection input[type="text"],
        #requestSection textarea,
        #requestSection input[type="date"] {
            width: 100%;
            padding: 10px 12px;
            margin-top: 6px;
            box-sizing: border-box;
            border-radius: 18px;
            border: 1px solid #dce0e5;
            margin-bottom: 5px;
            transition: border-color 0.3s ease;
            font-size: 12px;
        }
        #requestSection select:focus, #requestSection input:focus, #requestSection textarea:focus {
            outline: none;
            border-color: #4361ee;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        #requestSection .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            gap: 10px;
        }
        #requestSection .button-container button {
            flex: 1;
            margin: 0;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 18px;
            height: 35px;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        #requestSection .submit-button { background-color: #4361ee; box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2); }
        #requestSection .submit-button:hover { background-color: #3a56d4; transform: translateY(-1px); }
        #requestSection .reset-button { background-color: #fff !important; color: red !important; border: 1px solid #dce0e5; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
        #requestSection .reset-button:hover { background-color: #f8f9fa !important; }
        #requestSection .retrieve-button { background-color: #2e8540; box-shadow: 0 4px 12px rgba(46, 133, 64, 0.2); }
        #requestSection .retrieve-button:hover { background-color: #267438; transform: translateY(-1px); }
        .note-box {
            border-radius: 10px;
            background-color: #fafad2;
            padding: 10px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
            margin-top: 10px;
            font-size: 12px;
        }
        .note-box-done { background-color: #e8f5e9; border: 1px solid #a5d6a7; }
        .note-box-canceled { background-color: #ffebee; border: 1px solid #ef9a9a; }
        .note-header { font-weight: bold; font-size: 12px; color: #4361ee; }
        #requestSection h2 {
            font-weight: 600;
            font-size: 14px;
            margin-top: 15px;
            padding: 6px;
            border-radius: 9px;
            display: block;
            background-color: #ffffff;
            border: 1px solid #e9ecef;
            width: fit-content;
            margin: 15px auto 0;
            cursor: pointer;
        }

        #requestSection .designer-info { text-align: center; font-size: 12px; color: #6c757d; margin-top: 10px; }
        #requestSection h3 { text-align: center; color: #3a3a3a; margin-bottom: 10px; font-size: 14px; font-weight: 600; }
        #requestSection .error { color: #dc3545; font-size: 12px; margin-top: -5px; margin-bottom: 10px; display: none; }
        #requestSection .tab-container { display: flex; justify-content: center; margin-bottom: 1rem; background: #f7fafc; border-bottom: 1px solid #e2e8f0; border-radius: 8px 8px 0 0; }
        #requestSection .tab-button { background-color: transparent; border: none; padding: 0.75rem 1.5rem; cursor: pointer; font-size: 0.875rem; font-weight: 500; color: #718096; transition: all 0.2s ease; border-bottom: 2px solid transparent; }
        #requestSection .tab-button.active { color: #1a365d; border-bottom: 2px solid #1a365d; background-color: #ffffff; }
        #requestSection #personalTabBtn.active { background-color: #e0f2f7; color: #007bff; font-weight: bold; border-bottom: 2px solid #007bff; }
        #requestSection #customerTabBtn.active { background-color: #fff3e0; color: #e67700; font-weight: bold; border-bottom: 2px solid #e67700; }
        #requestSection .requests-display-grid { display: grid; gap: 1rem; }
        #requestSection .note-box { background-color: #f8fafc; border: 1px solid #e9ecef; box-shadow: 0 2px 4px rgba(0,0,0,0.04); }
        #requestSection .note-box::before { background: #4361ee; }
        #requestSection .note-box-done { background-color: #e8f5e9; border: 1px solid #a5d6a7; color: #2e7d32; }
        #requestSection .note-box-done::before { background: #2e7d32; }
        #requestSection .note-box-canceled { background-color: #ffebee; border: 1px solid #ef9a9a; color: #c62828; }
        #requestSection .note-box-canceled::before { background: #c62828; }
        #requestSection .note-box-done .note-header, #requestSection .note-box-canceled .note-header { color: inherit; }
        #requestSection .note-box-done div strong, #requestSection .note-box-canceled div strong { color: inherit; }
        #requestSection .header h1::after { background-color: #4361ee; }

        /* --- Weekly Plan Styles --- */
        #weeklyPlanSection {
            --primary: #6366f1; --primary-light: #a5b4fc; --secondary: #4b5563; --success: #10b981;
            --warning: #f59e0b; --danger: #ef4444; --background: #f1f5f9; --card: #ffffff;
            --text: #1e293b; --border: #cbd5e1; --speciality-bg: #d1fae5; --v-t-color: #dc2626;
            --accent-purple: #8b5cf6; --accent-blue: #3b82f6;

            /* Add these classes to your CSS */
.remaining-equal {
    background-color: #fee2e2; /* light red */
}
.remaining-less {
    background-color: #fef3c7; /* light orange */
}
.remaining-zero-or-negative {
    background-color: #dcfce7; /* light green */
}
.remaining-zero-or-negative.negative {
    color: #dc3545; /* red */
    font-weight: bold;
}

        }
        #weeklyPlanSection .dashboard { max-width: 100%; margin: 0 auto; padding: 0.3rem; }
        #weeklyPlanSection .header { background: var(--card); border-radius: 0.75rem; padding: 0.25rem; margin-bottom: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        #weeklyPlanSection .header h1 { color: var(--primary); font-size: 1.3rem; font-weight: 700; margin-bottom: 1rem; }
        #weeklyPlanSection .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem; }
        #weeklyPlanSection .filter-group { display: flex; flex-direction: column; gap: 0.15rem; }
        #weeklyPlanSection label { font-weight: 500; color: var(--secondary); font-size: 0.775rem; }
        #weeklyPlanSection select, #weeklyPlanSection input[type="date"], #weeklyPlanSection input[type="text"] { padding: 0.5rem; border-radius: 18px; border: 1px solid #dce0e5; background: var(--card); font-size: 0.775rem; transition: all 0.2s; width: 100%; }
        #weeklyPlanSection select:focus, #weeklyPlanSection input[type="date"]:focus, #weeklyPlanSection input[type="text"]:focus { outline: none; border-color: #4361ee; box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1); }
        #weeklyPlanSection .button-group { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
        #weeklyPlanSection button { padding: 0.5rem 1rem; border-radius: 18px; border: none; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.775rem; }
        #weeklyPlanSection .content-grid { display: flex; flex-direction: column; gap: 0.5rem; }
        #weeklyPlanSection .card { background: var(--card); border-radius: 0.5rem; padding: 1rem; box-shadow: 0 2px 4px -1px rgb(0 0 0 / 0.1); overflow: hidden; position: relative; }
        #weeklyPlanSection .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border); }
        #weeklyPlanSection .card-title { font-size: 1rem; font-weight: 600; color: var(--primary); }
        #weeklyPlanSection .table-container { overflow-x: auto; position: relative; border-radius: 0.5rem; border: 1px solid var(--border); }
        #weeklyPlanSection table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.75rem; }
        #weeklyPlanSection th { position: sticky; top: 0; background: var(--primary); color: white; font-weight: 600; z-index: 5; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #weeklyPlanSection th, #weeklyPlanSection td { padding: 0.5rem; text-align: center; border: 1px solid var(--border); white-space: nowrap; }
        #weeklyPlanSection .hcp-box { border: 1px solid var(--border); border-radius: 0.375rem; width: 100px; padding: 0.3rem; margin: 0.2rem 0; background: var(--background); position: relative; }
        #weeklyPlanSection .Speciality-box { background: var(--speciality-bg); border: 1px solid var(--border); width: 100px; border-radius: 0.3rem; padding: 0.3rem; margin-bottom: 0.2rem; position: relative; }
        #weeklyPlanSection .v-t { color: var(--v-t-color); font-weight: bold; }
        #weeklyPlanSection .stats-badge { display: inline-flex; align-items: center; padding: 0.25rem 0.5rem; background: rgba(79, 70, 229, 0.1); color: var(--primary); border-radius: 1rem; font-weight: 500; font-size: 0.75rem; }
        #weeklyPlanSection .highlight { background: rgba(34, 197, 94, 0.1); }
        #weeklyPlanSection .remaining-visit { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        #weeklyPlanSection .not-remaining { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        #weeklyPlanSection .rep-info { display: flex; gap: 0.7rem; margin-bottom: 0.4rem; flex-wrap: wrap; }
        #weeklyPlanSection .rep-badge { padding: 0.25rem 0.3rem; background: rgba(79, 70, 229, 0.1); color: var(--primary); border-radius: 0.25rem; font-weight: 500; font-size: 0.65rem; }
        #weeklyPlanSection .table-container::-webkit-scrollbar { height: 8px; width: 8px; }
        #weeklyPlanSection .table-container::-webkit-scrollbar-track { background: var(--border); border-radius: 3px; }
        #weeklyPlanSection .table-container::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }
        #weeklyPlanSection .remove-button { color: var(--danger); cursor: pointer; font-weight: bold; position: absolute; top: 0; left: 0; }
        #weeklyPlanSection .remove-button.hidden { display: none; }
        #weeklyPlanSection .bold { font-weight: bold; }
        #weeklyPlanSection .date-boxes { display: flex; gap: 0.7rem; }
        #weeklyPlanSection .rep-info-container { display: flex; justify-content: space-between; margin-bottom: 1rem; font-size: 0.875rem; color: purple; }
        #weeklyPlanSection .message { padding: 0.5rem; border-radius: 0.5rem; margin-top: 0.7rem; display: none; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); font-family: 'Arial', sans-serif; transition: all 0.3s ease; background-color: white; }
        #weeklyPlanSection .message.success { background-color: var(--success); color: white; }
        #weeklyPlanSection .message.error { background-color: var(--danger); color: white; }
        #weeklyPlanSection #weeklyPlanHcpTable th:first-child, #weeklyPlanSection #weeklyPlanHcpTable td:first-child { position: sticky; left: 0; background: var(--card); color: var(--text); z-index: 4; }
        #weeklyPlanSection #weeklyPlanHcpTable th:first-child { background: var(--primary); color: white; z-index: 6; }
        #weeklyPlanSection .table-container .card-title { font-size: 0.75rem; }
        #weeklyPlanSection #weeklyPlanAmActivitiesTable td, #weeklyPlanSection #weeklyPlanPmActivitiesTable td { word-break: break-word; white-space: normal; padding: 0.5rem; }
        #weeklyPlanSection .event-box { background: #fef3c7; border: 1px solid #f59e0b; border-radius: 0.3rem; padding: 0.3rem; margin: 0.2rem 0; position: relative; width: 100px; }
        #weeklyPlanSection #weeklyPlanResetButton { background-color: #e0e0e0; color: #424242; border: 1px solid #bdbdbd; }
        #weeklyPlanSection #weeklyPlanResetButton:hover { background-color: #c0c0c0; color: #212121; }

        /* --- New Layout Styles for Desktop --- */
        .desktop-layout-wrapper {
            display: flex;
            flex-direction: column; /* Default for mobile */
        }
        .main-content-scrollable {
            width: 100%;
        }

        @media (min-width: 1024px) {
            body {
                overflow: hidden; /* Prevent body scroll on desktop */
                padding: 0; /* Remove body padding on desktop */
            }
            .container {
                max-width: 100%; /* Use full width */
                height: 100vh; /* Use full height */
                display: flex;
                flex-direction: row;
                padding: 0;
                border-radius: 0;
            }
            .desktop-layout-wrapper {
                flex-direction: row;
                flex-grow: 1;
                overflow: hidden;
            }
            .side-navigation {
                flex-basis: 240px; /* Slightly wider */
                flex-shrink: 0;
                background-color: #f8fafc;
                border-right: 1px solid #e9ecef;
                padding: 20px 10px;
                display: flex;
                flex-direction: column;
            }
            .side-navigation .main-tab-group {
                flex-direction: column;
                gap: 8px;
                background-color: transparent;
                padding: 0;
                margin-top: 1rem; /* Add space below user card */
            }
            .side-navigation .tab-button {
                flex: none;
                justify-content: flex-start;
                width: 100%;
                padding: 12px 16px;
                font-size: 14px;
            }
            .side-navigation .tab-button i {
                font-size: 16px;
                width: 20px; /* Align text */
                text-align: center;
            }
            .main-content-scrollable {
                flex-grow: 1;
                overflow-y: auto;
                padding: 20px;
            }
            .main-content-wrapper {
                margin: 0;
            }
            .pc-hidden {
                display: none;
            }
            .mobile-only-header {
                display: none;
            }
        }
        
        /* --- Mobile View Fixes & Enhancements --- */
        @media (max-width: 1023px) {
            .side-navigation {
                display: none; /* Hide the entire side nav container on mobile */
            }
            .med-rep-card-wrapper.mobile-only-header {
                display: block; /* Show the mobile header */
            }
            /* New CSS to handle mobile tab icon/text toggle */
            .main-tab-group.tab-group .tab-button i {
                margin-right: 0;
                font-size: 16px;
            }
            .main-tab-group.tab-group .tab-button .tab-title {
                display: none;
                margin-left: 8px;
                font-size: 13px;
                line-height: 1;
            }
            .main-tab-group.tab-group .tab-button.selected .tab-title {
                display: inline;
            }
        }
        @media (max-width: 991px) {
            .dashboard-header { flex-direction: column; gap: 1rem; align-items: flex-start !important; }
            .button-group { flex-direction: column; width: 100%; }
            .filters-section { gap: 1rem !important; }
            th, td { padding: 0.375rem; font-size: 0.75rem; }
        }
        @media (max-width: 768px) {
            #weeklyPlanSection .dashboard { max-width: 100%; padding: 0.5rem; }
            #weeklyPlanSection .header { padding: 0.75rem; }
            #weeklyPlanSection .filters-grid { grid-template-columns: 1fr; }
            #weeklyPlanSection .button-group { flex-direction: row; width: 100%; }
            #weeklyPlanSection button { flex: 1; }
            #weeklyPlanSection th, #weeklyPlanSection td { padding: 0.25rem; font-size: 0.7rem; }
            #weeklyPlanSection .card { padding: 0.75rem; margin-bottom: 0.5rem; width: 100%; }
            #weeklyPlanSection .table-container { max-height: 300px; overflow-y: auto; width: 100%; }
        }
        @media (max-width: 600px) {
            .container { padding: 16px; }
            .form-row { flex-direction: column; gap: 16px; }
            .action-button { padding: 10px; font-size: 13px; }
            .tab-button { padding: 8px; font-size: 12px; }
            .tab-button i { margin-right: 4px; }
            th, td { padding: 10px 12px; font-size: 12px; }
        }

        /* --- Scroll to Top Button --- */
        #scrollToTopBtn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 30px;
            z-index: 99;
            border: none;
            outline: none;
            background-color: #4361ee;
            color: white;
            cursor: pointer;
            padding: 12px;
            border-radius: 50%;
            font-size: 18px;
            width: 48px;
            height: 48px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: opacity 0.3s, transform 0.3s;
        }
        #scrollToTopBtn:hover {
            background-color: #3a56d4;
            transform: scale(1.1);
        }

        /* --- Loading Overlay --- */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            flex-direction: column;
            gap: 1rem;
        }
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p class="text-gray-600">Loading CRM Data...</p>
    </div>

    <div id="mainAppContainer" class="container">
        
        <div class="desktop-layout-wrapper">
            <nav class="side-navigation">
                <div class="med-rep-card-wrapper">
                    <div class="med-rep-card">
                        <div class="med-rep-info">
                            <div class="med-rep-name" id="medRepName">
                                <i class="fas fa-spinner fa-spin"></i> Loading User...
                            </div>
                            <div class="med-rep-area" id="medRepArea">Area</div>
                            <div class="med-rep-dm pc-hidden" id="medRepDM">District Manager: N/A</div>
                            <div class="med-rep-gov pc-hidden" id="medRepGov">Governorate: N/A</div>
                        </div>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none">
                                <i class="fas fa-user-tie text-gray-400"></i>
                            </span>
                            <select id="medicalRepSelector" class="pl-10">
                                <option value="">Select Medical Rep</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="main-tab-group tab-group">
                    <button id="crmMainTabBtn" class="tab-button" disabled>
                        <i class="fas fa-edit"></i> CRM
                    </button>
                    <button id="dashboardMainTabBtn" class="tab-button" disabled>
                        <i class="fas fa-chart-bar"></i> Customers Lists
                    </button>
                    <button id="requestMainTabBtn" class="tab-button" disabled>
                        <i class="fas fa-file-alt"></i> Requests
                    </button>
                    <button id="weeklyPlanMainTabBtn" class="tab-button" disabled>
                        <i class="fas fa-calendar-week"></i> Weekly Plan
                    </button>
                </div>
            </nav>
            
            <main class="main-content-scrollable">
                <div class="med-rep-card-wrapper mobile-only-header">
                     <div class="med-rep-card">
                        <div class="med-rep-info">
                            <div class="med-rep-name" id="medRepNameMobile">
                                <i class="fas fa-spinner fa-spin"></i> Loading User...
                            </div>
                            <div class="med-rep-area" id="medRepAreaMobile">Area</div>
                            <div class="med-rep-dm" id="medRepDMMobile">District Manager: N/A</div>
                            <div class="med-rep-gov" id="medRepGovMobile">Governorate: N/A</div>
                        </div>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none">
                                <i class="fas fa-user-tie text-gray-400"></i>
                            </span>
                            <select id="medicalRepSelectorMobile" class="pl-10">
                                <option value="">Select Medical Rep</option>
                            </select>
                        </div>
                    </div>
                     <div class="main-tab-group tab-group">
                        <button id="crmMainTabBtnMobile" class="tab-button" disabled>
                            <i class="fas fa-edit"></i><span class="tab-title">CRM</span>
                        </button>
                        <button id="dashboardMainTabBtnMobile" class="tab-button" disabled>
                            <i class="fas fa-chart-bar"></i><span class="tab-title">Customers</span>
                        </button>
                        <button id="requestMainTabBtnMobile" class="tab-button" disabled>
                            <i class="fas fa-file-alt"></i><span class="tab-title">Requests</span>
                        </button>
                        <button id="weeklyPlanMainTabBtnMobile" class="tab-button" disabled>
                            <i class="fas fa-calendar-week"></i><span class="tab-title">Weekly Plan</span>
                        </button>
                    </div>
                </div>
                <div class="main-content-wrapper">
                    <!-- Form Section -->
                    <div id="formSection" class="section-card hidden">
                        <div class="form-header">
                            <div class="form-logo">
                                <i class="fas fa-handshake"></i>
                            </div>
                            <h1 class="form-title">Visits Submission Form</h1>
                        </div>
                        <div id="alertContainer"></div>
                        <div class="tab-group">
                            <button id="hcpBtn" class="tab-button" disabled>
                                <i class="fas fa-user-md"></i> HCPs
                            </button>
                            <button id="amBtn" class="tab-button" disabled>
                                <i class="fas fa-clipboard-check"></i> AM Details
                            </button>
                            <button id="pharmacyBtn" class="tab-button" disabled>
                                <i class="fas fa-pills"></i> Pharmacy
                            </button>
                            <button id="eventBtn" class="tab-button" disabled>
                                <i class="fas fa-calendar-alt"></i> Event
                            </button>
                        </div>
                        <div id="hcpForm" class="hidden">
                             <h2>
                                 <i class="fas fa-user-md"></i> HCP Submission Form
                                 <span id="hcpFormUnvisitedCount" class="unvisited-count-square hidden"></span>
                             </h2>
                            <div class="form-group">
                                <label for="hcp" class="required-field">Healthcare Professional</label>
                                <select id="hcp" required>
                                    <option value="">Select Healthcare Professional</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="brickHcp">Brick</label>
                                    <input type="text" id="brickHcp" class="readonly-input" readonly />
                                </div>
                                <div class="form-group">
                                    <label for="specialtyHcp">Specialty</label>
                                    <input type="text" id="specialtyHcp" class="readonly-input" readonly />
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="visitLocationHcp" class="required-field">Visit Location</label>
                                <select id="visitLocationHcp" required>
                                    <option value="">Select Visit Location</option>
                                    <option value="Clinic">Clinic</option>
                                    <option value="AM Hospital">AM Hospital</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="visitTimeHcp">Visit Time</label>
                                <input type="datetime-local" id="visitTimeHcp" required readonly />
                            </div>
                            <div class="form-group">
                                <label for="commentsHcp" class="required-field">Comments</label>
                                <textarea id="commentsHcp" placeholder="Enter detailed visit notes here..." required></textarea>
                            </div>
                            <div id="remainingVisitsSection" class="visit-stats-card hidden">
                                <div class="visit-stats-item">
                                    <div class="visit-stats-label">Remaining Visits for Selected HCP:</div>
                                    <div class="visit-stats-value"><span id="remainingVisits">0</span></div>
                                </div>
                                <div id="lastVisitDate" class="visit-stats-item">
                                    <div class="visit-stats-label">Last Visit:</div>
                                    <div class="visit-stats-value"><span id="lastVisitDateValue">N/A</span></div>
                                </div>
                            </div>
                            <div id="savedCommentSection" class="info-section hidden">
                                <div class="saved-comment-title">Saved Comment:</div>
                                <div id="savedComment" class="saved-comment-content">No previous comments available</div>
                            </div>
                        </div>
                        <div id="pharmacyForm" class="hidden">
                            <h2><i class="fas fa-pills"></i> Pharmacy Submission</h2>
                            <div class="form-group">
                                <label for="pharmacyName" class="required-field">Pharmacy Name</label>
                                <input type="text" id="pharmacyName" placeholder="Enter pharmacy name" required />
                            </div>
                            <div class="form-group">
                                <label for="brick" class="required-field">Brick</label>
                                <select id="brick" required>
                                    <option value="">Select Brick</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="visitTimePharmacy">Visit Time</label>
                                <input type="datetime-local" id="visitTimePharmacy" required readonly />
                            </div>
                            <div class="form-group">
                                <label for="commentsPharmacy">Comments</label>
                                <textarea id="commentsPharmacy" placeholder="Enter pharmacy visit notes here..."></textarea>
                            </div>
                        </div>
                        <div id="eventForm" class="hidden">
                            <h2><i class="fas fa-calendar-alt"></i> Event Submission</h2>
                            <div class="form-group">
                                <label for="eventType" class="required-field">Event Type</label>
                                <select id="eventType" required>
                                    <option value="">Select Event Type</option>
                                    <option value="Meeting">Meeting</option>
                                    <option value="Training">Training</option>
                                    <option value="Event">Event</option>
                                    <option value="Official vacation">Official vacation</option>
                                    <option value="Annual leave">Annual leave</option>
                                    <option value="Sick leave">Sick leave</option>
                                    <option value="Casual leave">Casual leave</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="eventActivity" class="required-field">Event Time</label>
                                <select id="eventActivity" required>
                                    <option value="">Select Event Time</option>
                                    <option value="AM activity">AM activity</option>
                                    <option value="PM activity">PM activity</option>
                                    <option value="Full day">Full day</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="commentsEvent" class="required-field">Comments</label>
                                <textarea id="commentsEvent" placeholder="Enter event details here..." required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="dateEvent" class="required-field">Date</label>
                                <input type="date" id="dateEvent" required />
                            </div>
                        </div>
                        <div id="amForm" class="hidden">
                             <h2>
                                <i class="fas fa-clipboard-check"></i> AM Details Submission
                                <span id="amFormUnvisitedCount" class="unvisited-count-square hidden"></span>
                             </h2>
                            <div class="form-group">
                                <label for="associatedAccount" class="required-field">Associated Account</label>
                                <select id="associatedAccount" required>
                                    <option value="">Select Associated Account</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="amDoctorName" class="required-field">AM Doctor Name</label>
                                <input type="text" id="amDoctorName" placeholder="Enter AM doctor name" required />
                            </div>
                            <div class="form-group">
                                <label for="amBrick" class="required-field">Brick</label>
                                <select id="amBrick" required>
                                    <option value="">Select Brick</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="visitTimeAm">Visit Time</label>
                                <input type="datetime-local" id="visitTimeAm" required readonly />
                            </div>
                            <div class="form-group">
                                <label for="commentsAm" class="required-field">Comments</label>
                                <textarea id="commentsAm" placeholder="Enter detailed AM notes here..." required></textarea>
                            </div>
                        </div>
                        <div class="action-button-group">
                            <button id="submitBtn" class="action-button submit-btn" disabled><i class="fas fa-save"></i> Submit</button>
                            <button id="resetBtn" class="action-button reset-btn"><i class="fas fa-undo"></i> Reset</button>
                            <button id="retrieveBtn" class="action-button retrieve-btn"><i class="fas fa-sync-alt"></i> Retrieve</button>
                        </div>
                        <div id="dataTable" class="hidden">
                            <h2><i class="fas fa-table"></i> Submitted Visits</h2>
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchInput" placeholder="Search for data..." />
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>HCP Name</th>
                                            <th>Specialty</th>
                                            <th>Brick</th>
                                            <th>Target Visits</th>
                                            <th>Last Visit</th>
                                            <th>Remaining Visits</th>
                                            <th>Comments</th>
                                            <th>Visit Place</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Dashboard Section -->
                    <div id="dashboardSection" class="section-card hidden">
                        <div class="form-header">
                            <div class="form-logo">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <h1 class="form-title">Customer List</h1>
                        </div>
                        <div id="loadingDashboard" class="flex items-center space-x-2 hidden">
                            <div class="loading-spinner"></div>
                            <span class="text-sm text-gray-600">Loading dashboard data...</span>
                        </div>
                        <div id="dashboardContent">
                            <div class="filters-section grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                                <div>
                                    <div class="select-wrapper">
                                        <select id="dashboardMedicalReps" class="w-full" disabled>
                                            <option value="">Select Representative</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <div class="custom-select">
                                        <div class="custom-select-trigger" id="bricksTrigger"> Select Brick </div>
                                        <div class="custom-select-options" id="bricksOptions"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="select-wrapper">
                                        <select id="visitOptions">
                                            <option value="">Select Display Option</option>
                                            <option value="unvisited">Unvisited HCPs</option>
                                            <option value="remaining">Remaining Visits</option>
                                            <option value="full">Full List</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <div class="select-wrapper">
                                        <select id="dayFilter">
                                            <option value="">All Days</option>
                                            <option value="Saturday">Saturday</option>
                                            <option value="Sunday">Sunday</option>
                                            <option value="Monday">Monday</option>
                                            <option value="Tuesday">Tuesday</option>
                                            <option value="Wednesday">Wednesday</option>
                                            <option value="Thursday">Thursday</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                                <div id="countDisplay" class="status-count hidden w-full sm:w-auto"></div>
                                <div class="button-group flex gap-2">
                                    <button id="filterDashboardButton" class="btn btn-primary">
                                        <i class="fas fa-filter"></i> Apply Filters
                                    </button>
                                    <button id="resetDashboardButton" class="btn btn-secondary">
                                        <i class="fas fa-undo"></i> Reset
                                    </button>
                                </div>
                            </div>
                            <div id="errorDashboard" class="hidden text-red-600 mb-4 p-4 bg-red-50 rounded-lg"></div>
                            <div id="searchContainerDashboard" class="mb-4 hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                                <input type="text" id="searchBoxDashboard" class="search-box" placeholder="Search in table data...">
                            </div>
                            <div class="table-container rounded-lg border border-gray-200">
                                <table id="hcpTableDashboard" class="hidden">
                                    <thead>
                                        <tr>
                                            <th class="sticky-col">HCP Name</th>
                                            <th>Specialty</th><th>Class</th><th>Total Visits</th><th>Remaining</th>
                                            <th>Brick</th><th>Address</th><th>Contact</th><th>Sat</th><th>Sun</th>
                                            <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Request Section -->
                    <div id="requestSection" class="section-card hidden">
                        <div class="form-header">
                            <div class="form-logo"><i class="fas fa-file-alt"></i></div>
                            <h1 class="form-title">Request Form</h1>
                        </div>
                        <div id="requestAlertContainer"></div>
                        <div class="tab-container">
                            <button class="tab-button active" id="personalTabBtn">Personal Request</button>
                            <button class="tab-button" id="customerTabBtn">Customer Request</button>
                        </div>
                        <div id="personalRequestTab" class="tab-content">
                            <label for="personalName">Name:</label>
                            <select id="personalName" required><option value="">Select Your Name</option></select>
                            <div id="personalNameError" class="error">This field is required.</div>
                            <div id="personalAreaContainer" class="hidden">
                                <label for="personalArea">Area:</label>
                                <select id="personalArea" required><option value="">Select Your Area</option></select>
                                <div id="personalAreaError" class="error">This field is required.</div>
                            </div>
                            <label for="personalDate">Date:</label>
                            <input type="date" id="personalDate" required readonly>
                            <div id="personalDateError" class="error">This field is required.</div>
                            <label for="personalRequestTitle">Request Title:</label>
                            <select id="personalRequestTitle" required>
                                <option value="">Select Request Title</option>
                                <option value="Annual Leave">Annual Leave</option>
                                <option value="Sick Leave">Sick Leave</option>
                                <option value="Unpaid Leave">Unpaid Leave</option>
                            </select>
                            <div id="personalRequestTitleError" class="error">This field is required.</div>
                            <label for="personalRequestDetails">Request Details:</label>
                            <textarea id="personalRequestDetails" rows="4" placeholder="Enter Your Request" required></textarea>
                            <div id="personalRequestDetailsError" class="error">This field is required.</div>
                            <div class="button-container">
                                <button type="button" class="submit-button" id="submitPersonalRequestBtn">Submit</button>
                                <button type="button" class="reset-button" id="resetPersonalFormBtn">Reset</button>
                                <button type="button" class="retrieve-button" id="retrievePersonalRequestsBtn">Retrieve </button>
                            </div>
                            <h2>Total Personal Requests: <span id="personalRequestCount">0</span></h2>
                            <div id="retrievedPersonalRequests" class="hidden">
                                <h3>Personal Requests:</h3>
                                <div id="personalRequestDetailsDisplay" class="requests-display-grid"></div>
                            </div>
                        </div>
                        <div id="customerRequestTab" class="tab-content hidden">
                            <div id="areaContainer" class="hidden">
                                <label for="area">Area:</label>
                                <select id="area" name="area" required><option value="">Select an Area</option></select>
                                <div id="areaError" class="error">This field is required.</div>
                            </div>
                            <label for="customerType">Customer Type:</label>
                            <select id="customerType" required>
                                <option value="">Select Customer Type</option>
                                <option value="AM Accounts">AM Accounts</option>
                                <option value="PM Doctors">PM Doctors</option>
                            </select>
                            <div id="customerTypeError" class="error">This field is required.</div>
                            <div id="accountDropdown" class="hidden">
                                <label for="amAccounts">AM Accounts:</label>
                                <select id="amAccounts" required>
                                    <option value="">Select AM Account</option>
                                    <option value="UPA Hospital">UPA Hospital</option>
                                    <option value="Military Hospital">Military Hospital</option>
                                    <option value="Private Hospital">Private Hospital</option>
                                    <option value="Dialysis Center">Dialysis Center</option>
                                    <option value="Oncology Center">Oncology Center</option>
                                </select>
                                <div id="amAccountsError" class="error">This field is required.</div>
                            </div>
                            <div id="doctorDropdown" class="hidden">
                                <label for="pmDoctors">PM Doctors:</label>
                                <select id="pmDoctors" required>
                                    <option value="">Select PM Doctor</option>
                                    <option value="Intervention">Intervention</option>
                                    <option value="Hematology">Hematology</option>
                                    <option value="Vascular">Vascular</option>
                                    <option value="GP">GP</option>
                                    <option value="ICU">ICU</option>
                                    <option value="Oncology">Oncology</option>
                                    <option value="Nephrology">Nephrology</option>
                                </select>
                                <div id="pmDoctorsError" class="error">This field is required.</div>
                            </div>
                            <div id="customerNames" class="hidden">
                                <label for="customerName">Customer Name:</label>
                                <input type="text" id="customerName" placeholder="Enter Customer Name" required>
                                <div id="customerNameError" class="error">This field is required.</div>
                            </div>
                            <label for="date">Date:</label>
                            <input type="date" id="date" required readonly>
                            <div id="dateError" class="error">This field is required.</div>
                            <label for="requestTitle">Request Title:</label>
                            <input type="text" id="requestTitle" placeholder="Enter Request Title" required>
                            <div id="requestTitleError" class="error">This field is required.</div>
                            <label for="requestDetails">Request Details:</label>
                            <textarea id="requestDetails" rows="4" placeholder="Enter Request Details" required></textarea>
                            <div id="requestDetailsError" class="error">This field is required.</div>
                            <div class="button-container">
                                <button type="button" class="submit-button" id="submitCustomerRequestBtn">Submit</button>
                                <button type="button" class="reset-button" id="resetCustomerFormBtn">Reset</button>
                                <button type="button" class="retrieve-button" id="retrieveCustomerRequestsBtn">Retrieve</button>
                            </div>
                            <h2>Total Customer Requests: <span id="customerRequestCount">0</span></h2>
                            <div id="retrievedCustomerRequests" class="hidden">
                                <h3>Customer Requests:</h3>
                                <div id="customerRequestDetailsDisplay" class="requests-display-grid"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Weekly Plan Section -->
                    <div id="weeklyPlanSection" class="section-card hidden">
                        <div class="form-header">
                            <div class="form-logo">
                                <i class="fas fa-calendar-week"></i>
                            </div>
                            <h1 class="form-title">Weekly Plan Form</h1>
                        </div>
                         <div class="dashboard">
                            <div class="header">
                                <div id="weeklyPlanLoading">Loading data...</div>
                                <div id="weeklyPlanError" class="message error" style="display: none;"></div>
                                <div id="weeklyPlanSuccess" class="message success" style="display: none;"></div>
                                <div id="weeklyPlanContent" style="display: none;">
                                    <div class="filters-grid">
                                        <div class="filter-group">
                                            <select id="weeklyPlanMedicalReps" disabled><option value="">Select a Medical Rep</option></select>
                                        </div>
                                        <div class="filter-group">
                                            <select id="weeklyPlanBricks" disabled><option value="">Select a Brick</option></select>
                                        </div>
                                        <div class="filter-group">
                                            <select id="weeklyPlanDayFilter">
                                                <option value="">Select a Days</option>
                                                <option value="Saturday">Saturday</option><option value="Sunday">Sunday</option>
                                                <option value="Monday">Monday</option><option value="Tuesday">Tuesday</option>
                                                <option value="Wednesday">Wednesday</option><option value="Thursday">Thursday</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="button-group">
                                        <button id="weeklyPlanFilterButton" class="action-button submit-btn"><i class="fas fa-filter"></i> Apply Filter</button>
                                        <button id="weeklyPlanRetrieveButton" class="action-button retrieve-btn"><i class="fas fa-sync-alt"></i> Retrieve</button>
                                    </div>
                                    <div class="filters-grid">
                                        <div class="filter-group">
                                            <label for="weeklyPlanEventType">Event Type</label>
                                            <select id="weeklyPlanEventType">
                                                <option value="">Select Event Type</option>
                                                <option value="Meeting">Meeting</option><option value="Training">Training</option>
                                                <option value="Event">Event</option><option value="Annual Leave">Annual Leave</option>
                                                <option value="Sick Leave">Sick Leave</option><option value="Official Leave">Official Leave</option>
                                            </select>
                                        </div>
                                        <div class="filter-group" id="weeklyPlanEventNameGroup" style="display: none;">
                                            <label for="weeklyPlanEventName">Event Name</label>
                                            <input type="text" id="weeklyPlanEventName" placeholder="Enter event name">
                                        </div>
                                        <div class="filter-group" id="weeklyPlanEventTimeGroup" style="display: none;">
                                            <label for="weeklyPlanEventTime">Event Time</label>
                                            <select id="weeklyPlanEventTime">
                                                <option value="">Select Time</option><option value="AM">AM</option>
                                                <option value="PM">PM</option><option value="Full Day">Full Day</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="content-grid">
                                <div class="card">
                                    <div class="card-header">
                                        <h2 class="card-title">HCP List</h2>
                                        <div id="weeklyPlanStatsDisplay" class="stats-badge" style="display: none;"></div>
                                    </div>
                                    <div class="table-container">
                                        <table id="weeklyPlanHcpTable" style="display: none;">
                                            <thead>
                                                <tr>
                                                    <th>HCPS</th><th>Speciality</th><th>Class</th><th>T.V</th>
                                                    <th>Remaining</th><th>Brick</th><th>Address</th><th>Mobile</th>
                                                    <th>Sat</th><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="card">
                                    <div class="card-header"><h2 class="card-title">Weekly Schedule</h2></div>
                                    <div class="rep-info-container">
                                        <div id="weeklyPlanRepArea" class="rep-badge"></div>
                                        <div id="weeklyPlanRepNameArea" class="rep-badge"></div>
                                    </div>
                                    <div class="date-boxes">
                                        <div class="filter-group">
                                            <label for="weeklyPlanStartDate">Start Date</label>
                                            <input type="date" id="weeklyPlanStartDate">
                                        </div>
                                        <div class="filter-group">
                                            <label for="weeklyPlanEndDate">End Date</label>
                                            <input type="date" id="weeklyPlanEndDate" readonly>
                                        </div>
                                    </div>
                                    <div id="weeklyPlanAmActivitiesTable" class="table-container">
                                        <div class="card-title">AM Activities</div>
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th id="saturdayAmHeader">Saturday</th><th id="sundayAmHeader">Sunday</th>
                                                    <th id="mondayAmHeader">Monday</th><th id="tuesdayAmHeader">Tuesday</th>
                                                    <th id="wednesdayAmHeader">Wednesday</th><th id="thursdayAmHeader">Thursday</th>
                                                </tr>
                                            </thead>
                                            <tbody><tr><td id="saturdayAm"></td><td id="sundayAm"></td><td id="mondayAm"></td><td id="tuesdayAm"></td><td id="wednesdayAm"></td><td id="thursdayAm"></td></tr></tbody>
                                        </table>
                                    </div>
                                    <div id="weeklyPlanPmActivitiesTable" class="table-container">
                                        <div class="card-title">PM Activities</div>
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th id="saturdayPmHeader">Saturday</th><th id="sundayPmHeader">Sunday</th>
                                                    <th id="mondayPmHeader">Monday</th><th id="tuesdayPmHeader">Tuesday</th>
                                                    <th id="wednesdayPmHeader">Wednesday</th><th id="thursdayPmHeader">Thursday</th>
                                                </tr>
                                            </thead>
                                            <tbody><tr><td id="saturdayPm"></td><td id="sundayPm"></td><td id="mondayPm"></td><td id="tuesdayPm"></td><td id="wednesdayPm"></td><td id="thursdayPm"></td></tr></tbody>
                                        </table>
                                    </div>
                                    <div class="button-group">
                                        <button id="weeklyPlanSubmitButton" class="action-button submit-btn"><i class="fas fa-save"></i> Submit</button>
                                        <button id="weeklyPlanResetButton" class="action-button reset-btn"><i class="fas fa-undo"></i> Reset</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <button id="scrollToTopBtn" title="Go to top"><i class="fas fa-arrow-up"></i></button>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://plmevfyxpngzymvzvkzn.supabase.co/rest/v1/healthcarepro_visits';
        const SAVED_COMMENTS_URL = 'https://plmevfyxpngzymvzvkzn.supabase.co/rest/v1/saved_comments';
        const REQUESTS_URL = 'https://plmevfyxpngzymvzvkzn.supabase.co/rest/v1/requests';
        const SUPABASE_WEEKLY_PLANS_URL = 'https://plmevfyxpngzymvzvkzn.supabase.co/rest/v1/weekly_plans';
        const SUPABASE_VACATIONS_URL = 'https://plmevfyxpngzymvzvkzn.supabase.co/rest/v1/vacations';
        const SUPABASE_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBsbWV2Znl4cG5nenltdnp2a3puIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NjM5NDEsImV4cCI6MjA2NjMzOTk0MX0.lUm3efHFCL3aAB-PL7H54BpnvcpbXxp1BeUzw0yjp5c';
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRcnOTUUiyczqtn1s8zhVfYGARkjx-xfT621A9AX7jw3TxmvnBbdc-BZ_EjuOk1uahqY7s5FcdFvQKm/pub?output=csv';

        // Global variables
        let currentMedRep = null;
        let loggedInUser = null;
        let globalGoogleData = [];
        let globalGoogleSheetDataFromParent = [];
        let globalSupabaseVisits = [];
        let visitCountsForCurrentRep = {};
        let medicalRepsAreas = new Map();
        let districtManagersGovernorates = new Map();
        let selectedBricks = [];
        let filteredHCPsForDashboard = [];

        document.addEventListener('DOMContentLoaded', () => {
            const loadingOverlay = document.getElementById('loadingOverlay');

            function showAlert(message, type) {
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i>${message}`;
                document.getElementById('alertContainer').innerHTML = '';
                document.getElementById('alertContainer').appendChild(alert);
                alert.scrollIntoView({ behavior: 'smooth', block: 'start' });
                setTimeout(() => { alert.style.display = 'none'; }, 5000);
            }

            function showRequestAlert(message, type) {
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i>${message}`;
                document.getElementById('requestAlertContainer').innerHTML = '';
                document.getElementById('requestAlertContainer').appendChild(alert);
                alert.scrollIntoView({ behavior: 'smooth', block: 'start' });
                setTimeout(() => { alert.style.display = 'none'; }, 5000);
            }

            function parseCSV(csvText) {
                const lines = csvText.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                return lines.slice(1).filter(line => line.trim()).map(line => {
                    const values = line.split(',').map(v => v.trim());
                    return headers.reduce((obj, header, index) => {
                        obj[header] = values[index] || '';
                        return obj;
                    }, {});
                });
            }

            async function fetchPaginatedData(url, apiKey, pageSize = 1000) {
                let allData = [];
                let offset = 0;
                let hasMore = true;
                const separator = url.includes('?') ? '&' : '?';
                while (hasMore) {
                    const response = await fetch(`${url}${separator}select=*&offset=${offset}&limit=${pageSize}`, {
                        headers: { 'apikey': apiKey, 'Authorization': `Bearer ${apiKey}`, 'Range': `${offset}-${offset + pageSize - 1}` }
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`Supabase Fetch Error from ${url}: Status ${response.status}, Details: ${errorText}`);
                        throw new Error(`Failed to fetch paginated data from ${url}`);
                    }
                    const data = await response.json();
                    allData = allData.concat(data);
                    hasMore = data.length === pageSize;
                    offset += pageSize;
                }
                return allData;
            }

            async function fetchAllData() {
                try {
                    const [googleResponse, supabaseVisitsResponse] = await Promise.all([
                        fetch(GOOGLE_SHEET_URL),
                        fetchPaginatedData(SUPABASE_URL, SUPABASE_API_KEY)
                    ]);

                    if (!googleResponse.ok) {
                        throw new Error('Failed to fetch Google Sheet data');
                    }
                    
                    const googleText = await googleResponse.text();
                    globalGoogleData = parseCSV(googleText);
                    globalSupabaseVisits = supabaseVisitsResponse;

                    medicalRepsAreas.clear();
                    districtManagersGovernorates.clear();
                    globalGoogleData.forEach(row => {
                        const repName = row['medical rep'] ? row['medical rep'].trim() : '';
                        const area = row['area'] ? row['area'].trim() : '';
                        const districtManager = row['District Manager'] ? row['District Manager'].trim() : 'N/A';
                        const governorate = row['Governorate'] ? row['Governorate'].trim() : 'N/A';
                        if (repName) {
                            if (!medicalRepsAreas.has(repName)) medicalRepsAreas.set(repName, new Set());
                            if (area) medicalRepsAreas.get(repName).add(area);
                        }
                        if (districtManager !== 'N/A') {
                            if (!districtManagersGovernorates.has(districtManager)) districtManagersGovernorates.set(districtManager, new Set());
                            if (governorate !== 'N/A') districtManagersGovernorates.get(districtManager).add(governorate);
                        }
                    });
                } catch (error) {
                    console.error('Error fetching initial data:', error);
                    showAlert('Error loading data. Please try again later.', 'error');
                }
            }

            function populateSelect(selectElement, items) {
                const initialOption = selectElement.querySelector('option[value=""]');
                selectElement.innerHTML = '';
                if (initialOption) selectElement.appendChild(initialOption);
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    selectElement.appendChild(option);
                });
            }

            const medicalRepSelector = document.getElementById('medicalRepSelector');
            const medRepNameElement = document.getElementById('medRepName');
            const medRepAreaElement = document.getElementById('medRepArea');
            const medRepDMElement = document.getElementById('medRepDM');
            const medRepGovElement = document.getElementById('medRepGov');

             // Mobile Header Elements
            const medicalRepSelectorMobile = document.getElementById('medicalRepSelectorMobile');
            const medRepNameElementMobile = document.getElementById('medRepNameMobile');
            const medRepAreaElementMobile = document.getElementById('medRepAreaMobile');
            const medRepDMElementMobile = document.getElementById('medRepDMMobile');
            const medRepGovElementMobile = document.getElementById('medRepGovMobile');

            const crmMainTabBtn = document.getElementById('crmMainTabBtn');
            const dashboardMainTabBtn = document.getElementById('dashboardMainTabBtn');
            const requestMainTabBtn = document.getElementById('requestMainTabBtn');
            const weeklyPlanMainTabBtn = document.getElementById('weeklyPlanMainTabBtn');
            
            const crmMainTabBtnMobile = document.getElementById('crmMainTabBtnMobile');
            const dashboardMainTabBtnMobile = document.getElementById('dashboardMainTabBtnMobile');
            const requestMainTabBtnMobile = document.getElementById('requestMainTabBtnMobile');
            const weeklyPlanMainTabBtnMobile = document.getElementById('weeklyPlanMainTabBtnMobile');

            const formSection = document.getElementById('formSection');
            const dashboardSection = document.getElementById('dashboardSection');
            const requestSection = document.getElementById('requestSection');
            const weeklyPlanSection = document.getElementById('weeklyPlanSection');

            window.addEventListener('message', async (event) => {
                if (event.data && event.data.type === 'loggedInUser') {
                    loggedInUser = event.data.user;
                    medRepNameElement.innerHTML = loggedInUser.username; 
                    medRepNameElementMobile.innerHTML = loggedInUser.username; 

                    if (event.data.allGoogleSheetData) {
                        globalGoogleSheetDataFromParent = event.data.allGoogleSheetData;
                    }
                    console.log('CRM received loggedInUser:', loggedInUser);
                    
                    loadingOverlay.style.display = 'flex';
                    await fetchAllData();
                    handleUserRoleBasedRepSelection();
                    loadingOverlay.style.display = 'none';
                }
            });

            async function handleUserRoleBasedRepSelection() {
                if (!loggedInUser) {
                    showAlert('User data not received. Please log in again.', 'error');
                    return;
                }
                [medicalRepSelector, medicalRepSelectorMobile].forEach(selector => {
                    selector.innerHTML = '<option value="">Select Medical Rep</option>';
                    selector.disabled = false;
                });
                
                let repsToDisplay = [];
                let defaultSelectedRep = '';
                switch (loggedInUser.title) {
                    case 'Medical Representative':
                        repsToDisplay = [loggedInUser.username];
                        defaultSelectedRep = loggedInUser.username;
                        [medicalRepSelector, medicalRepSelectorMobile].forEach(s => s.disabled = true);
                        break;
                    case 'District Manager':
                        const dmName = loggedInUser.username;
                        const associatedReps = globalGoogleData.filter(row => row['District Manager'] === dmName && row['medical rep']).map(row => row['medical rep']).filter(Boolean);
                        repsToDisplay = [...new Set(associatedReps)];
                        if (repsToDisplay.length === 1) defaultSelectedRep = repsToDisplay[0];
                        break;
                    case 'admin':
                        repsToDisplay = [...new Set(globalGoogleData.map(row => row['medical rep']).filter(Boolean))];
                        break;
                    default:
                        showAlert(`Unknown user title: ${loggedInUser.title}.`, 'error');
                        return;
                }
                
                populateSelect(medicalRepSelector, repsToDisplay);
                populateSelect(medicalRepSelectorMobile, repsToDisplay);

                if (defaultSelectedRep) {
                    medicalRepSelector.value = defaultSelectedRep;
                    medicalRepSelectorMobile.value = defaultSelectedRep;
                }
                medicalRepSelector.dispatchEvent(new Event('change'));
            }

            function updateRepCard(repData) {
                currentMedRep = { name: repData['medical rep'], area: repData['area'], districtManager: repData['District Manager'], governorate: repData['Governorate'] };
                
                medRepNameElement.innerHTML = currentMedRep.name;
                medRepAreaElement.textContent = currentMedRep.area;
                medRepDMElement.textContent = `District Manager: ${currentMedRep.districtManager || 'N/A'}`;
                
                medRepNameElementMobile.innerHTML = currentMedRep.name;
                medRepAreaElementMobile.textContent = currentMedRep.area;
                medRepDMElementMobile.textContent = `District Manager: ${currentMedRep.districtManager || 'N/A'}`;

                const dmGovernorates = districtManagersGovernorates.get(currentMedRep.districtManager);
                const govText = (dmGovernorates && dmGovernorates.size > 0) ? `Governorates: ${Array.from(dmGovernorates).join(', ')}` : `Governorate: N/A`;
                medRepGovElement.textContent = govText;
                medRepGovElementMobile.textContent = govText;
            }

            function handleRepSelectionChange(selectedRepName) {
                 if (!selectedRepName) {
                    currentMedRep = null;
                    [medRepNameElement, medRepNameElementMobile].forEach(el => el.textContent = 'Medical Rep Name');
                    [medRepAreaElement, medRepAreaElementMobile].forEach(el => el.textContent = 'Area');
                    [medRepDMElement, medRepDMElementMobile].forEach(el => el.textContent = 'District Manager: N/A');
                    [medRepGovElement, medRepGovElementMobile].forEach(el => el.textContent = 'Governorate: N/A');
                    
                    [crmMainTabBtn, dashboardMainTabBtn, requestMainTabBtn, weeklyPlanMainTabBtn, crmMainTabBtnMobile, dashboardMainTabBtnMobile, requestMainTabBtnMobile, weeklyPlanMainTabBtnMobile].forEach(btn => btn.disabled = true);
                    formManager.handleReset();
                    dashboardManager.resetDashboard();
                    requestFormManager.resetForm();
                    weeklyPlanManager.reset();
                    [formSection, dashboardSection, requestSection, weeklyPlanSection].forEach(sec => sec.classList.add('hidden'));
                    showAlert('Please select a Medical Representative to proceed.', 'info');
                    return;
                }
                const repData = globalGoogleData.find(row => row['medical rep'] === selectedRepName);
                if (repData) {
                    updateRepCard(repData);

                    [crmMainTabBtn, dashboardMainTabBtn, requestMainTabBtn, weeklyPlanMainTabBtn, crmMainTabBtnMobile, dashboardMainTabBtnMobile, requestMainTabBtnMobile, weeklyPlanMainTabBtnMobile].forEach(btn => btn.disabled = false);
                    formManager.initializeRepSpecificData(currentMedRep.name);
                    dashboardManager.initializeDashboardForRep(currentMedRep.name);
                    requestFormManager.initialize(currentMedRep.name);
                    weeklyPlanManager.initialize(currentMedRep.name);
                    showMainSection('crm');
                    showAlert(`Welcome, ${currentMedRep.name}! Data loaded successfully.`, 'success');
                } else {
                    showAlert('Selected Medical Representative data not found.', 'error');
                }
            }

            medicalRepSelector.addEventListener('change', () => {
                medicalRepSelectorMobile.value = medicalRepSelector.value;
                handleRepSelectionChange(medicalRepSelector.value);
            });
            medicalRepSelectorMobile.addEventListener('change', () => {
                medicalRepSelector.value = medicalRepSelectorMobile.value;
                handleRepSelectionChange(medicalRepSelectorMobile.value);
            });


            const mainTabButtons = document.querySelectorAll('.main-tab-group .tab-button');
            const mainTabButtonsMobile = document.querySelectorAll('.mobile-only-header .main-tab-group .tab-button');
            
            function showMainSection(sectionType) {
                formManager.handleReset();
                dashboardManager.resetDashboard();
                requestFormManager.resetForm();
                weeklyPlanManager.reset();
                [formSection, dashboardSection, requestSection, weeklyPlanSection].forEach(sec => sec.classList.add('hidden'));
                
                mainTabButtons.forEach(button => button.classList.remove('selected'));
                mainTabButtonsMobile.forEach(button => button.classList.remove('selected'));

                const internalTabGroup = formSection.querySelector('.tab-group');
                const formActionButtons = formSection.querySelector('.action-button-group');

                if (sectionType === 'crm') {
                    formSection.classList.remove('hidden');
                    crmMainTabBtn.classList.add('selected');
                    crmMainTabBtnMobile.classList.add('selected');
                    internalTabGroup.classList.remove('hidden');
                    formActionButtons.classList.remove('hidden');
                    formManager.elements.submitBtn.disabled = true;
                    formManager.elements.resetBtn.disabled = false;
                    formManager.elements.retrieveBtn.disabled = false;
                } else if (sectionType === 'dashboard') {
                    dashboardSection.classList.remove('hidden');
                    dashboardMainTabBtn.classList.add('selected');
                    dashboardMainTabBtnMobile.classList.add('selected');
                    internalTabGroup.classList.add('hidden');
                    formActionButtons.classList.add('hidden');
                    dashboardManager.elements.filterButton.disabled = false;
                    dashboardManager.elements.resetButton.disabled = false;
                    dashboardManager.applyFilter();
                } else if (sectionType === 'request') {
                    requestSection.classList.remove('hidden');
                    requestMainTabBtn.classList.add('selected');
                    requestMainTabBtnMobile.classList.add('selected');
                    internalTabGroup.classList.add('hidden');
                    formActionButtons.classList.add('hidden');
                    requestFormManager.initialize(currentMedRep.name);
                    requestFormManager.fetchTotalPersonalRequests();
                    requestFormManager.fetchTotalCustomerRequests();
                    requestFormManager.showTab('personal');
                } else if (sectionType === 'weeklyPlan') {
                    weeklyPlanSection.classList.remove('hidden');
                    weeklyPlanMainTabBtn.classList.add('selected');
                    weeklyPlanMainTabBtnMobile.classList.add('selected');
                    weeklyPlanManager.initialize(currentMedRep.name);
                }
            }
            mainTabButtons.forEach(btn => btn.addEventListener('click', () => showMainSection(btn.id.replace('MainTabBtn', ''))));
            mainTabButtonsMobile.forEach(btn => btn.addEventListener('click', (event) => {
                // Get all mobile tab buttons
                const allMobileButtons = document.querySelectorAll('.mobile-only-header .main-tab-group .tab-button');
                // Remove the 'selected' class from all other buttons
                allMobileButtons.forEach(b => {
                    if (b !== event.currentTarget) {
                        b.classList.remove('selected');
                    }
                });
                // Toggle the 'selected' class on the clicked button
                event.currentTarget.classList.toggle('selected');
                // Only show the section if the button is now selected
                if (event.currentTarget.classList.contains('selected')) {
                    showMainSection(event.currentTarget.id.replace('MainTabBtnMobile', ''));
                } else {
                    // Hide all sections if the user un-selects the tab
                    [formSection, dashboardSection, requestSection, weeklyPlanSection].forEach(sec => sec.classList.add('hidden'));
                }
            }));


            class FormManager {
                constructor() {
                    this.isLoading = false;
                    this.elements = {
                        hcpSelect: document.getElementById('hcp'), brickHcpInput: document.getElementById('brickHcp'), specialtyHcpInput: document.getElementById('specialtyHcp'),
                        visitLocationHcpSelect: document.getElementById('visitLocationHcp'), visitTimeHcpInput: document.getElementById('visitTimeHcp'),
                        commentsHcpInput: document.getElementById('commentsHcp'), hcpFormUnvisitedCountBadge: document.getElementById('hcpFormUnvisitedCount'),
                        lastVisitDateValueSpan: document.getElementById('lastVisitDateValue'), pharmacyNameInput: document.getElementById('pharmacyName'),
                        brickSelect: document.getElementById('brick'), visitTimePharmacyInput: document.getElementById('visitTimePharmacy'),
                        commentsPharmacyInput: document.getElementById('commentsPharmacy'), eventTypeSelect: document.getElementById('eventType'),
                        eventActivitySelect: document.getElementById('eventActivity'), commentsEventInput: document.getElementById('commentsEvent'),
                        dateEventInput: document.getElementById('dateEvent'), amDoctorNameInput: document.getElementById('amDoctorName'),
                        associatedAccountSelect: document.getElementById('associatedAccount'), amBrickSelect: document.getElementById('amBrick'),
                        visitTimeAmInput: document.getElementById('visitTimeAm'), commentsAmInput: document.getElementById('commentsAm'),
                        amFormUnvisitedCountBadge: document.getElementById('amFormUnvisitedCount'), remainingVisitsSpan: document.getElementById('remainingVisits'),
                        savedCommentSpan: document.getElementById('savedComment'), dataTable: document.getElementById('dataTable'), tableBody: document.getElementById('tableBody'),
                        searchInput: document.getElementById('searchInput'), hcpBtn: document.getElementById('hcpBtn'), pharmacyBtn: document.getElementById('pharmacyBtn'),
                        eventBtn: document.getElementById('eventBtn'), amBtn: document.getElementById('amBtn'), submitBtn: document.getElementById('submitBtn'),
                        resetBtn: document.getElementById('resetBtn'), retrieveBtn: document.getElementById('retrieveBtn'), hcpForm: document.getElementById('hcpForm'),
                        pharmacyForm: document.getElementById('pharmacyForm'), eventForm: document.getElementById('eventForm'), amForm: document.getElementById('amForm'),
                        remainingVisitsSection: document.getElementById('remainingVisitsSection'), savedCommentSection: document.getElementById('savedCommentSection'),
                        internalTabButtons: document.querySelectorAll('#formSection .tab-group .tab-button')
                    };
                    this.setupEventListeners();
                    this.setCurrentDateTimeInCairo();
                }
                setupEventListeners() {
                    this.elements.hcpSelect.addEventListener('change', () => this.handleHcpChange());
                    this.elements.hcpBtn.addEventListener('click', () => this.showForm('hcp'));
                    this.elements.pharmacyBtn.addEventListener('click', () => this.showForm('pharmacy'));
                    this.elements.eventBtn.addEventListener('click', () => this.showForm('event'));
                    this.elements.amBtn.addEventListener('click', () => this.showForm('am'));
                    this.elements.submitBtn.addEventListener('click', () => this.handleSubmit());
                    this.elements.resetBtn.addEventListener('click', () => this.handleReset());
                    this.elements.retrieveBtn.addEventListener('click', () => this.handleRetrieve());
                    this.elements.searchInput.addEventListener('input', () => this.filterTable());
                    this.elements.associatedAccountSelect.addEventListener('change', () => this.handleAssociatedAccountChange());
                }
                getCairoDateTime(date = new Date()) {
                    const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: 'Africa/Cairo' };
                    const parts = new Intl.DateTimeFormat('en-US', options).formatToParts(date);
                    const year = parts.find(p => p.type === 'year').value; const month = parts.find(p => p.type === 'month').value;
                    const day = parts.find(p => p.type === 'day').value; const hour = parts.find(p => p.type === 'hour').value;
                    const minute = parts.find(p => p.type === 'minute').value; const second = parts.find(p => p.type === 'second').value;
                    return `${year}-${month}-${day}T${hour}:${minute}:${second.slice(0,2)}`;
                }
                getCairoDate(date = new Date()) {
                    const options = { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Africa/Cairo' };
                    const parts = new Intl.DateTimeFormat('en-US', options).formatToParts(date);
                    const year = parts.find(p => p.type === 'year').value; const month = parts.find(p => p.type === 'month').value; const day = parts.find(p => p.type === 'day').value;
                    return `${year}-${month}-${day}`;
                }
                setCurrentDateTimeInCairo() {
                    const formattedDateTime = this.getCairoDateTime().slice(0, 16);
                    const formattedDate = this.getCairoDate();
                    this.elements.visitTimeHcpInput.value = formattedDateTime;
                    this.elements.visitTimePharmacyInput.value = formattedDateTime;
                    this.elements.visitTimeAmInput.value = formattedDateTime;
                    this.elements.dateEventInput.value = formattedDate;
                }
                initializeRepSpecificData(repName) {
                    this.updateHcpOptions(repName); this.updateBrickOptions(repName); this.updateAmBrickOptions(repName);
                    this.updateAssociatedAccounts(repName); this.updateUnvisitedHcpCount(); this.updateUnvisitedAmAccountCount();
                    [this.elements.hcpBtn, this.elements.pharmacyBtn, this.elements.eventBtn, this.elements.amBtn, crmMainTabBtn, dashboardMainTabBtn, requestMainTabBtn, weeklyPlanMainTabBtn].forEach(el => el.disabled = false);
                }
                showForm(formType) {
                    this.handleReset(); this.setCurrentDateTimeInCairo();
                    [this.elements.hcpForm, this.elements.pharmacyForm, this.elements.eventForm, this.elements.amForm, this.elements.remainingVisitsSection, this.elements.savedCommentSection, this.elements.dataTable].forEach(el => el.classList.add('hidden'));
                    this.elements.internalTabButtons.forEach(button => button.classList.remove('selected'));
                    switch (formType) {
                        case 'hcp':
                            this.elements.hcpForm.classList.remove('hidden'); this.elements.hcpBtn.classList.add('selected');
                            this.elements.remainingVisitsSection.classList.remove('hidden'); this.elements.savedCommentSection.classList.remove('hidden');
                            break;
                        case 'pharmacy': this.elements.pharmacyForm.classList.remove('hidden'); this.elements.pharmacyBtn.classList.add('selected'); break;
                        case 'event': this.elements.eventForm.classList.remove('hidden'); this.elements.eventBtn.classList.add('selected'); break;
                        case 'am':
                            this.elements.amForm.classList.remove('hidden'); this.elements.amBtn.classList.add('selected');
                            if (currentMedRep) { this.updateAssociatedAccounts(currentMedRep.name); this.updateUnvisitedAmAccountCount(); }
                            break;
                    }
                    this.elements.submitBtn.disabled = false;
                }
                setLoading(isLoading) {
                    this.isLoading = isLoading;
                    [this.elements.submitBtn, this.elements.resetBtn, this.elements.retrieveBtn, ...this.elements.internalTabButtons].forEach(el => el.disabled = isLoading);
                    if (!isLoading && currentMedRep && crmMainTabBtn.classList.contains('selected')) {
                        [this.elements.hcpBtn, this.elements.pharmacyBtn, this.elements.eventBtn, this.elements.amBtn].forEach(el => el.disabled = false);
                    }
                }
                validateComment(comment) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!comment || comment.trim().length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return "Comment cannot be empty.";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // The restrictive check for English characters has been removed to allow Arabic.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return null; // No error
Â  Â  Â  Â  Â  Â  Â  Â  }
                async handleSubmit() {
                    if (this.isLoading) return;
                    this.setLoading(true);
                    try {
                        const formData = this.getFormData();
                        let formActive = '';
                        if (this.elements.hcpBtn.classList.contains('selected')) formActive = 'hcp';
                        else if (this.elements.pharmacyBtn.classList.contains('selected')) formActive = 'pharmacy';
                        else if (this.elements.eventBtn.classList.contains('selected')) formActive = 'event';
                        else if (this.elements.amBtn.classList.contains('selected')) formActive = 'am';
                        
                        let commentError;
                        switch(formActive) {
                            case 'hcp':
                                commentError = this.validateComment(formData.comments);
                                if (commentError) throw new Error(commentError);
                                if (!formData.visitPlace) throw new Error('Please select a visit location');
                                await this.validateFormData(formData);
                                await this.storeVisitInSupabase(formData);
                                showAlert('HCP Visit successfully stored!', 'success');
                                break;
                            case 'pharmacy':
                                if (!formData.pharmacyName || !formData.brick) throw new Error('Please fill in all required fields for the pharmacy form');
                                await this.storePharmacyInSupabase(formData);
                                showAlert('Pharmacy visit successfully stored!', 'success');
                                break;
                            case 'event':
                                commentError = this.validateComment(formData.commentsEvent);
                                if (commentError) throw new Error(commentError);
                                if (!formData.eventType || !formData.eventActivity || !formData.dateEvent) throw new Error('Please fill in all required fields for the event form');
                                const leaveTypes = ['Annual leave', 'Sick leave', 'Casual leave', 'Official vacation'];
                                if (leaveTypes.includes(formData.eventType)) {
                                    await this.storeLeaveInSupabase(formData);
                                    showAlert('Leave request successfully stored!', 'success');
                                } else {
                                    await this.storeEventInSupabase(formData);
                                    showAlert('Event successfully stored!', 'success');
                                }
                                break;
                            case 'am':
                                commentError = this.validateComment(formData.commentsAm);
                                if (commentError) throw new Error(commentError);
                                if (!formData.amDoctorName || !formData.associatedAccount || !formData.amBrick) throw new Error('Please fill in all required fields for the AM details form');
                                await this.storeAmDetailsInSupabase(formData);
                                showAlert('AM details successfully stored!', 'success');
                                break;
                            default: throw new Error('No form selected for submission.');
                        }
                        this.handleReset();
                        await fetchAllData();
                        if (currentMedRep) {
                            formManager.initializeRepSpecificData(currentMedRep.name);
                            dashboardManager.initializeDashboardForRep(currentMedRep.name);
                            requestFormManager.initialize(currentMedRep.name);
                            weeklyPlanManager.initialize(currentMedRep.name);
                        }
                    } catch (error) {
                        showAlert(error.message, 'error');
                    } finally {
                        this.setLoading(false);
                    }
                }
                getFormData() {
                    return {
                        hcpName: this.elements.hcpSelect.value, medicalRep: currentMedRep ? currentMedRep.name : '', visitDate: this.elements.visitTimeHcpInput.value, comments: this.elements.commentsHcpInput.value,
                        visitPlace: this.elements.visitLocationHcpSelect.value, pharmacyName: this.elements.pharmacyNameInput.value, brick: this.elements.brickSelect.value,
                        visitTimePharmacy: this.elements.visitTimePharmacyInput.value, commentsPharmacy: this.elements.commentsPharmacyInput.value, eventType: this.elements.eventTypeSelect.value,
                        eventActivity: this.elements.eventActivitySelect.value, commentsEvent: this.elements.commentsEventInput.value, dateEvent: this.elements.dateEventInput.value,
                        amDoctorName: this.elements.amDoctorNameInput.value, associatedAccount: this.elements.associatedAccountSelect.value, amBrick: this.elements.amBrickSelect.value,
                        visitTimeAm: this.elements.visitTimeAmInput.value, commentsAm: this.elements.commentsAmInput.value
                    };
                }
                async validateFormData(data) {
                    if (!data.hcpName || !data.medicalRep || !data.visitDate || !data.comments || !data.visitPlace) { throw new Error('Please fill in all required fields'); }
                    if (await this.hasVisitedToday(data.hcpName, data.medicalRep, data.visitDate)) { throw new Error('This HCP has already been visited today. Please try again tomorrow.'); }
                }
                async hasVisitedToday(name, medicalRep, visitDate) {
                    const visitDateInCairo = new Date(visitDate);
                    const todayDateInCairo = this.getCairoDate(visitDateInCairo);
                    return globalSupabaseVisits.some(visit => {
                        const visitCreatedAtInCairo = this.getCairoDate(new Date(visit.created_at));
                        return visit.hcp_name === name && visit.medical_rep === medicalRep && visitCreatedAtInCairo === todayDateInCairo;
                    });
                }
                async getRemainingVisits(hcpName) {
                    const currentMonthStart = this.getCurrentMonthStart();
                    const visitsThisMonth = globalSupabaseVisits.filter(visit => visit.hcp_name === hcpName && visit.medical_rep === currentMedRep.name && new Date(visit.visit_date) >= new Date(currentMonthStart) && !visit.specialty.startsWith('AM(') && visit.specialty !== 'Pharmacy' && !visit.specialty.startsWith('Event('));
                    const hcp = globalGoogleData.find(h => h['HCPS'] === hcpName && h['medical rep'] === currentMedRep.name);
                    const targetVisits = parseInt(hcp?.['T.V']) || 0;
                    return targetVisits - visitsThisMonth.length;
                }
                async storeVisitInSupabase(formData) {
                    const hcp = globalGoogleData.find(h => h['HCPS'] === formData.hcpName && h['medical rep'] === formData.medicalRep);
                    const currentRemaining = await this.getRemainingVisits(formData.hcpName);
                    const visitData = { hcp_name: formData.hcpName, specialty: hcp?.['Speciality'], brick: hcp?.['Brick'], target_visits: parseInt(hcp?.['T.V']) || 0, last_visit: formData.visitDate, remaining_visits: currentRemaining - 1, medical_rep: formData.medicalRep, visit_date: formData.visitDate, comments: formData.comments, visit_place: formData.visitPlace, created_at: new Date().toISOString() };
                    const response = await fetch(SUPABASE_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_API_KEY}`, 'apikey': SUPABASE_API_KEY, 'Prefer': 'return=representation' }, body: JSON.stringify(visitData) });
                    if (!response.ok) { const errorText = await response.text(); throw new Error(`Failed to store visit: ${errorText}`); }
                    const newVisit = await response.json();
                    globalSupabaseVisits.push(newVisit[0]);
                    const commentData = { hcp_name: formData.hcpName, medical_rep: formData.medicalRep, comment: formData.comments, created_at: new Date().toISOString() };
                    const commentResponse = await fetch(SAVED_COMMENTS_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_API_KEY}`, 'apikey': SUPABASE_API_KEY, 'Prefer': 'return=representation' }, body: JSON.stringify(commentData) });
                    if (!commentResponse.ok) { const errorText = await commentResponse.text(); throw new Error(`Failed to save comment: ${errorText}`); }
                }
                async storePharmacyInSupabase(formData) {
                    if (!currentMedRep) throw new Error('Medical Rep not logged in.');
                    const visitData = { hcp_name: formData.pharmacyName, specialty: 'Pharmacy', brick: formData.brick, visit_date: formData.visitTimePharmacy, comments: formData.commentsPharmacy, medical_rep: currentMedRep.name, created_at: new Date().toISOString() };
                    const response = await fetch(SUPABASE_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_API_KEY}`, 'apikey': SUPABASE_API_KEY, 'Prefer': 'return=representation' }, body: JSON.stringify(visitData) });
                    if (!response.ok) { const errorText = await response.text(); throw new Error(`Failed to store pharmacy visit: ${errorText}`); }
                    globalSupabaseVisits.push((await response.json())[0]);
                }
                async storeLeaveInSupabase(formData) {
                    if (!currentMedRep) throw new Error('Medical Rep not logged in.');
                    const specialtyWithEventActivity = `Event(${formData.eventActivity})`;
                    const visitData = { hcp_name: formData.eventType, specialty: specialtyWithEventActivity, medical_rep: currentMedRep.name, visit_date: formData.dateEvent, comments: formData.commentsEvent, created_at: new Date().toISOString() };
                    const visitResponse = await fetch(SUPABASE_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_API_KEY}`, 'apikey': SUPABASE_API_KEY, 'Prefer': 'return=representation' }, body: JSON.stringify(visitData) });
                    if (!visitResponse.ok) { const errorText = await visitResponse.text(); throw new Error(`Failed to store leave in healthcarepro_visits: ${errorText}`); }
                    const vacationResponse = await fetch(SUPABASE_VACATIONS_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_API_KEY}`, 'apikey': SUPABASE_API_KEY, 'Prefer': 'return=representation' }, body: JSON.stringify(visitData) });
                    if (!vacationResponse.ok) { const errorText = await vacationResponse.text(); throw new Error(`Failed to store leave in vacations: ${errorText}`); }
                    globalSupabaseVisits.push((await visitResponse.json())[0]);
                }
                async storeEventInSupabase(formData) {
                    if (!currentMedRep) throw new Error('Medical Rep not logged in.');
                    const specialtyWithEventActivity = `Event(${formData.eventActivity})`;
                    const eventData = { hcp_name: formData.eventType, specialty: specialtyWithEventActivity, medical_rep: currentMedRep.name, visit_date: formData.dateEvent, comments: formData.commentsEvent, created_at: new Date().toISOString() };
                    const response = await fetch(SUPABASE_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_API_KEY}`, 'apikey': SUPABASE_API_KEY, 'Prefer': 'return=representation' }, body: JSON.stringify(eventData) });
                    if (!response.ok) { const errorText = await response.text(); throw new Error(`Failed to store event: ${errorText}`); }
                    globalSupabaseVisits.push((await response.json())[0]);
                }
                async storeAmDetailsInSupabase(formData) {
                    if (!currentMedRep) throw new Error('Medical Rep not logged in.');
                    const visitData = { hcp_name: formData.amDoctorName, specialty: `AM(${formData.associatedAccount})`, brick: formData.amBrick, visit_date: formData.visitTimeAm, comments: formData.commentsAm, medical_rep: currentMedRep.name, created_at: new Date().toISOString() };
                    const response = await fetch(SUPABASE_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_API_KEY}`, 'apikey': SUPABASE_API_KEY, 'Prefer': 'return=representation' }, body: JSON.stringify(visitData) });
                    if (!response.ok) { const errorText = await response.text(); throw new Error(`Failed to store AM details: ${errorText}`); }
                    globalSupabaseVisits.push((await response.json())[0]);
                }
                updateHcpOptions(repName) {
                    this.elements.hcpSelect.innerHTML = '<option value="">Select Healthcare Professional</option>';
                    const filteredHcps = globalGoogleData.filter(hcp => hcp['medical rep'] === repName);
                    const currentMonthStart = this.getCurrentMonthStart();
                    filteredHcps.forEach(hcp => {
                        const option = document.createElement('option');
                        option.value = hcp['HCPS'];
                        option.textContent = hcp['HCPS'];
                        const isVisited = globalSupabaseVisits.some(visit => visit.hcp_name === hcp['HCPS'] && visit.medical_rep === repName && new Date(visit.visit_date) >= new Date(currentMonthStart) && !visit.specialty.startsWith('AM(') && visit.specialty !== 'Pharmacy' && !visit.specialty.startsWith('Event('));
                        if (!isVisited) option.textContent += ' âš ï¸';
                        this.elements.hcpSelect.appendChild(option);
                    });
                }
                updateBrickOptions(repName) {
                    const uniqueBricks = [...new Set(globalGoogleData.filter(hcp => hcp['medical rep'] === repName).map(hcp => hcp['Brick']).filter(Boolean))];
                    populateSelect(this.elements.brickSelect, uniqueBricks);
                }
                updateAmBrickOptions(repName) {
                    const uniqueBricks = [...new Set(globalGoogleData.filter(hcp => hcp['medical rep'] === repName).map(hcp => hcp['Brick']).filter(Boolean))];
                    populateSelect(this.elements.amBrickSelect, uniqueBricks);
                }
                updateAssociatedAccounts(repName) {
                    this.elements.associatedAccountSelect.innerHTML = '<option value="">Select Associated Account</option>';
                    const filteredAccounts = globalGoogleData.filter(hcp => hcp['medical rep'] === repName && ['hospital', 'account', 'dialysis center'].includes(hcp['Speciality'].toLowerCase()));
                    const hcpClass = globalGoogleData.find(hcp => hcp['medical rep'] === repName && hcp['HCPS'] === this.elements.hcpSelect.value)?.['Class'];
                    if (hcpClass && (hcpClass.toLowerCase() === 'upa' || hcpClass.toLowerCase() === 'private')) {
                        const option = document.createElement('option'); option.value = 'AM Hospital'; option.textContent = 'AM Hospital';
                        this.elements.associatedAccountSelect.appendChild(option); this.elements.associatedAccountSelect.value = 'AM Hospital';
                    } else {
                        const uniqueAccountNames = new Set();
                        filteredAccounts.forEach(account => {
                            if (uniqueAccountNames.has(account['HCPS'])) return;
                            uniqueAccountNames.add(account['HCPS']);
                            const option = document.createElement('option'); option.value = account['HCPS']; option.textContent = account['HCPS'];
                            this.elements.associatedAccountSelect.appendChild(option);
                        });
                    }
                }
                handleHcpChange() {
                    const selectedHcp = this.elements.hcpSelect.value;
                    if (selectedHcp) {
                        const cleanSelectedHcpName = selectedHcp.replace(' âš ï¸', '').trim();
                        const hcpData = globalGoogleData.find(h => h['HCPS'] === cleanSelectedHcpName && h['medical rep'] === currentMedRep.name);
                        this.updateRemainingVisits(cleanSelectedHcpName); this.updateHcpDetails(cleanSelectedHcpName); this.updateSavedComment(cleanSelectedHcpName);
                        if (hcpData && (hcpData['Class'] === 'Private' || hcpData['Class'] === 'UPA')) {
                            this.elements.visitLocationHcpSelect.innerHTML = `<option value="AM Hospital">AM Hospital</option>`;
                            this.elements.visitLocationHcpSelect.value = 'AM Hospital'; this.elements.visitLocationHcpSelect.disabled = true;
                        } else {
                            this.elements.visitLocationHcpSelect.innerHTML = `<option value="">Select Visit Location</option><option value="Clinic">Clinic</option><option value="AM Hospital">AM Hospital</option>`;
                            this.elements.visitLocationHcpSelect.value = ''; this.elements.visitLocationHcpSelect.disabled = false;
                        }
                    } else {
                        this.elements.remainingVisitsSpan.textContent = '0'; this.elements.lastVisitDateValueSpan.textContent = 'N/A';
                        this.elements.brickHcpInput.value = ''; this.elements.specialtyHcpInput.value = '';
                        this.elements.savedCommentSpan.textContent = 'No previous comments available';
                        this.elements.visitLocationHcpSelect.innerHTML = `<option value="">Select Visit Location</option><option value="Clinic">Clinic</option><option value="AM Hospital">AM Hospital</option>`;
                        this.elements.visitLocationHcpSelect.value = ''; this.elements.visitLocationHcpSelect.disabled = false;
                    }
                }
                handleAssociatedAccountChange() {
                    const selectedAccount = this.elements.associatedAccountSelect.value;
                    if (selectedAccount && currentMedRep) {
                        const cleanSelectedAccountName = selectedAccount.replace(' âš ï¸', '').trim();
                        const accountData = globalGoogleData.find(row => row['HCPS'] === cleanSelectedAccountName && row['medical rep'] === currentMedRep.name);
                        this.elements.amBrickSelect.value = accountData ? accountData['Brick'] : '';
                    } else { this.elements.amBrickSelect.value = ''; }
                }
                updateUnvisitedHcpCount() {
                    if (!currentMedRep) return;
                    const googleSheetHcpsForRep = globalGoogleData.filter(hcp => hcp['medical rep'] === currentMedRep.name);
                    const currentMonthStart = this.getCurrentMonthStart();
                    let unvisitedCount = 0;
                    googleSheetHcpsForRep.forEach(hcp => {
                        const hasVisited = globalSupabaseVisits.some(visit => visit.hcp_name === hcp['HCPS'] && visit.medical_rep === currentMedRep.name && new Date(visit.visit_date) >= new Date(currentMonthStart) && !visit.specialty.startsWith('AM(') && visit.specialty !== 'Pharmacy' && !visit.specialty.startsWith('Event('));
                        if (!hasVisited) unvisitedCount++;
                    });
                    const badge = this.elements.hcpFormUnvisitedCountBadge;
                    if (unvisitedCount > 0) { badge.textContent = `Unvisited ${unvisitedCount}`; badge.classList.remove('hidden'); }
                    else { badge.classList.add('hidden'); }
                    this.updateHcpOptions(currentMedRep.name);
                }
                updateUnvisitedAmAccountCount() {
                    if (!currentMedRep) return;
                    const badge = this.elements.amFormUnvisitedCountBadge;
                    badge.classList.add('hidden'); badge.textContent = '';
                    this.updateAssociatedAccounts(currentMedRep.name); 
                }
                getCurrentMonthStart() {
                    const nowInCairo = new Date(new Date().toLocaleString('en-US', { timeZone: 'Africa/Cairo' }));
                    return new Date(nowInCairo.getFullYear(), nowInCairo.getMonth(), 2).toISOString().split('T')[0];
                }
                async updateRemainingVisits(hcpName) {
                    const hcp = globalGoogleData.find(h => h['HCPS'] === hcpName && h['medical rep'] === currentMedRep.name);
                    if (hcp) {
                        const remainingVisits = await this.getRemainingVisits(hcp['HCPS']);
                        this.elements.remainingVisitsSpan.textContent = remainingVisits;
                        const lastVisit = await this.getLastVisitDate(hcpName);
                        this.elements.lastVisitDateValueSpan.textContent = lastVisit !== 'N/A' ? this.formatDateTime(new Date(lastVisit)) : 'N/A';
                    } else {
                        this.elements.remainingVisitsSpan.textContent = '0'; this.elements.lastVisitDateValueSpan.textContent = 'N/A';
                    }
                }
                async getLastVisitDate(name) {
                    const visits = globalSupabaseVisits.filter(visit => visit.hcp_name === name && visit.medical_rep === currentMedRep.name);
                    visits.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    return visits.length > 0 ? visits[0].created_at : 'N/A';
                }
                async updateSavedComment(hcpName) {
                    try {
                        const response = await fetch(`${SAVED_COMMENTS_URL}?hcp_name=eq.${encodeURIComponent(hcpName)}&medical_rep=eq.${encodeURIComponent(currentMedRep.name)}&order=created_at.desc&limit=1`, { headers: { 'Authorization': `Bearer ${SUPABASE_API_KEY}`, 'apikey': SUPABASE_API_KEY, 'Content-Type': 'application/json' }});
                        if (!response.ok) throw new Error('Failed to retrieve saved comment');
                        const lastComment = await response.json();
                        this.elements.savedCommentSpan.textContent = lastComment.length > 0 ? lastComment[0].comment : 'No previous comments available';
                    } catch (error) {
                        console.error('Error fetching saved comment:', error);
                        this.elements.savedCommentSpan.textContent = 'Error loading comment.';
                    }
                }
                updateHcpDetails(hcpName) {
                    const hcp = globalGoogleData.find(h => h['HCPS'] === hcpName && h['medical rep'] === currentMedRep.name);
                    this.elements.brickHcpInput.value = hcp ? hcp['Brick'] : '';
                    this.elements.specialtyHcpInput.value = hcp ? hcp['Speciality'] : '';
                }
                async handleRetrieve() {
                    if (!currentMedRep) { showAlert('Please select a Medical Representative to retrieve visits.', 'error'); return; }
                    this.setLoading(true); this.elements.tableBody.innerHTML = '';
                    try {
                        const currentMonthStart = this.getCurrentMonthStart();
                        const visitsResponse = await fetchPaginatedData(`${SUPABASE_URL}?medical_rep=eq.${encodeURIComponent(currentMedRep.name)}&visit_date=gte.${currentMonthStart}`, SUPABASE_API_KEY);
                        let visits = visitsResponse;
                        visits.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                        let visitsSortedAscending = [...visits].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                        let firstVisitIdsOfDay = new Set(); let currentDay = '';
                        visitsSortedAscending.forEach(visit => {
                            const visitDate = this.getCairoDate(new Date(visit.created_at));
                            if (visitDate !== currentDay) { firstVisitIdsOfDay.add(visit.id); currentDay = visitDate; }
                        });
                        visits.forEach(visit => {
                            const row = this.elements.tableBody.insertRow();
                            if (firstVisitIdsOfDay.has(visit.id)) row.classList.add('first-visit-of-day');
                            if (visit.specialty === 'Pharmacy') row.classList.add('pharmacy-row');
                            if (visit.specialty && (visit.specialty.toLowerCase().includes('event') || visit.specialty.toLowerCase().includes('am('))) row.classList.add('event-row');
                            row.innerHTML = `<td>${visit.hcp_name || 'N/A'}</td><td>${visit.specialty || 'N/A'}</td><td>${visit.brick || 'N/A'}</td><td>${visit.target_visits !== null ? visit.target_visits : 'N/A'}</td><td>${this.formatDateTime(new Date(visit.created_at)) || 'N/A'}</td><td>${visit.remaining_visits !== null ? visit.remaining_visits : 0}</td><td>${visit.comments || 'N/A'}</td><td>${visit.visit_place || 'N/A'}</td>`;
                        });
                        this.elements.dataTable.classList.toggle('hidden', visits.length === 0);
                        if (visits.length === 0) showAlert('No visits found for the current month.', 'info');
                    } catch (error) { showAlert('Failed to retrieve visits.', 'error'); }
                    finally { this.setLoading(false); }
                }
                formatDateTime(date) {
                    return date.toLocaleString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: true, timeZone: 'Africa/Cairo' });
                }
                filterTable() {
                    const searchTerm = this.elements.searchInput.value.toLowerCase();
                    Array.from(this.elements.tableBody.getElementsByTagName('tr')).forEach(row => {
                        row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
                    });
                }
                handleReset() {
                    this.elements.hcpSelect.value = ''; this.elements.brickHcpInput.value = ''; this.elements.specialtyHcpInput.value = '';
                    this.elements.visitLocationHcpSelect.value = ''; this.elements.commentsHcpInput.value = '';
                    this.elements.pharmacyNameInput.value = ''; this.elements.brickSelect.value = ''; this.elements.commentsPharmacyInput.value = '';
                    this.elements.eventTypeSelect.value = ''; this.elements.eventActivitySelect.value = ''; this.elements.commentsEventInput.value = '';
                    this.elements.amDoctorNameInput.value = ''; this.elements.associatedAccountSelect.value = ''; this.elements.amBrickSelect.value = ''; this.elements.commentsAmInput.value = '';
                    [this.elements.hcpForm, this.elements.pharmacyForm, this.elements.eventForm, this.elements.amForm, this.elements.remainingVisitsSection, this.elements.savedCommentSection, this.elements.dataTable].forEach(el => el.classList.add('hidden'));
                    this.elements.internalTabButtons.forEach(button => button.classList.remove('selected'));
                    this.elements.submitBtn.disabled = true;
                    this.setCurrentDateTimeInCairo();
                    if (currentMedRep) { this.updateUnvisitedHcpCount(); this.updateUnvisitedAmAccountCount(); }
                }
            }

            // --- Dashboard, Request, WeeklyPlan classes would follow a similar refactored structure ---
            // NOTE: For brevity, only the fixed FormManager is shown in full. Other classes are included below.
            class DashboardManager {
                constructor() {
                    this.elements = {
                        dashboardMedicalRepsSelect: document.getElementById('dashboardMedicalReps'), bricksTrigger: document.getElementById('bricksTrigger'), bricksOptions: document.getElementById('bricksOptions'),
                        visitOptionsSelect: document.getElementById('visitOptions'), dayFilterSelect: document.getElementById('dayFilter'), filterButton: document.getElementById('filterDashboardButton'),
                        resetButton: document.getElementById('resetDashboardButton'), countDisplay: document.getElementById('countDisplay'), errorDisplay: document.getElementById('errorDashboard'),
                        searchContainer: document.getElementById('searchContainerDashboard'), searchBox: document.getElementById('searchBoxDashboard'), hcpTable: document.getElementById('hcpTableDashboard'),
                        hcpTableBody: document.querySelector('#hcpTableDashboard tbody'), loadingSpinner: document.getElementById('loadingDashboard')
                    };
                    this.setupEventListeners();
                }
                setupEventListeners() {
                    this.elements.filterButton.addEventListener('click', () => this.applyFilter());
                    this.elements.resetButton.addEventListener('click', () => this.resetDashboard());
                    this.elements.visitOptionsSelect.addEventListener('change', () => this.updateCountDisplay());
                    this.elements.dayFilterSelect.addEventListener('change', () => this.updateCountDisplay());
                    this.elements.searchBox.addEventListener('input', () => this.searchTable());
                    this.elements.bricksTrigger.addEventListener('click', () => { this.elements.bricksOptions.classList.toggle('show'); });
                    document.addEventListener('click', (event) => { if (!event.target.closest('.custom-select')) this.elements.bricksOptions.classList.remove('show'); });
                }
                setLoading(isLoading) { this.elements.loadingSpinner.classList.toggle('hidden', !isLoading); this.elements.filterButton.disabled = isLoading; this.elements.resetButton.disabled = isLoading; }
                async initializeDashboardForRep(repName) {
                    this.setLoading(true);
                    this.elements.dashboardMedicalRepsSelect.innerHTML = `<option value="${repName}">${repName}</option>`;
                    this.elements.dashboardMedicalRepsSelect.value = repName;
                    this.processVisitDataForCurrentRep(); this.populateBricksForRep(repName);
                    this.updateCountDisplay(); this.applyFilter(); this.setLoading(false);
                }
                processVisitDataForCurrentRep() {
                    visitCountsForCurrentRep = {};
                    const currentMonthStart = formManager.getCurrentMonthStart();
                    const filteredVisits = globalSupabaseVisits.filter(visit => visit.medical_rep === currentMedRep.name && new Date(visit.visit_date) >= new Date(currentMonthStart));
                    filteredVisits.forEach(visit => { visitCountsForCurrentRep[visit.hcp_name] = (visitCountsForCurrentRep[visit.hcp_name] || 0) + 1; });
                }
                populateBricksForRep(repName) {
                    const uniqueBricks = [...new Set(globalGoogleData.filter(row => row['medical rep'] === repName).map(row => row['Brick']).filter(Boolean))];
                    this.elements.bricksOptions.innerHTML = ''; selectedBricks = []; this.elements.bricksTrigger.textContent = 'Select Brick';
                    if (uniqueBricks.length === 0) { this.elements.bricksTrigger.textContent = 'No Bricks Available'; return; }
                    uniqueBricks.forEach(brick => {
                        const option = document.createElement('div'); option.className = 'custom-select-option'; option.textContent = brick; option.dataset.value = brick;
                        option.addEventListener('click', () => this.toggleBrickSelection(brick)); this.elements.bricksOptions.appendChild(option);
                    });
                }
                toggleBrickSelection(brick) {
                    const index = selectedBricks.indexOf(brick);
                    if (index === -1) selectedBricks.push(brick); else selectedBricks.splice(index, 1);
                    this.elements.bricksTrigger.textContent = selectedBricks.length === 0 ? 'Select Brick' : selectedBricks.join(', ');
                    this.elements.bricksOptions.querySelectorAll('.custom-select-option').forEach(option => { option.classList.toggle('selected', selectedBricks.includes(option.dataset.value)); });
                    this.updateCountDisplay();
                }
                updateCountDisplay() {
                    const selectedRep = this.elements.dashboardMedicalRepsSelect.value, selectedOption = this.elements.visitOptionsSelect.value;
                    if (!selectedRep || !selectedOption) { this.elements.countDisplay.classList.add('hidden'); return; }
                    let count = 0, displayText = '';
                    const filteredGoogleDataForRep = globalGoogleData.filter(row => row['medical rep'] === selectedRep);
                    const selectedDay = this.elements.dayFilterSelect.value;
                    if (selectedOption === 'unvisited') {
                        count = filteredGoogleDataForRep.filter(row => (!visitCountsForCurrentRep[row['HCPS']] || visitCountsForCurrentRep[row['HCPS']] === 0) && (selectedBricks.length === 0 || selectedBricks.includes(row['Brick'])) && (selectedDay === '' || row[selectedDay].trim() !== '')).length;
                        displayText = `Unvisited HCPs (${selectedBricks.length > 0 ? selectedBricks.join(', ') : 'All Bricks'}) Count: `;
                    } else if (selectedOption === 'remaining') {
                        count = filteredGoogleDataForRep.filter(row => (parseInt(row['T.V']) || 0) > (visitCountsForCurrentRep[row['HCPS']] || 0) && (selectedBricks.length === 0 || selectedBricks.includes(row['Brick'])) && (selectedDay === '' || row[selectedDay].trim() !== '')).length;
                        displayText = `Remaining Visits (${selectedBricks.length > 0 ? selectedBricks.join(', ') : 'All Bricks'}) Count: `;
                    } else if (selectedOption === 'full') {
                        count = filteredGoogleDataForRep.filter(row => (selectedBricks.length === 0 || selectedBricks.includes(row['Brick'])) && (selectedDay === '' || row[selectedDay].trim() !== '')).length;
                        displayText = `Full List (${selectedBricks.length > 0 ? selectedBricks.join(', ') : 'All Bricks'}) Count: `;
                    }
                    this.elements.countDisplay.textContent = `${displayText} ${count}`; this.elements.countDisplay.classList.remove('hidden');
                }
                applyFilter() {
                    const selectedRep = this.elements.dashboardMedicalRepsSelect.value, selectedOption = this.elements.visitOptionsSelect.value, selectedDay = this.elements.dayFilterSelect.value;
                    let errorMsg = '';
                    if (!selectedRep) errorMsg += 'Please select a Medical Representative. ';
                    if (!selectedOption) errorMsg += 'Please select a display option. ';
                    this.elements.errorDisplay.textContent = errorMsg; this.elements.errorDisplay.classList.toggle('hidden', !errorMsg);
                    if (errorMsg) { this.elements.hcpTable.classList.add('hidden'); this.elements.searchContainer.classList.add('hidden'); return; }
                    const googleDataForCurrentRep = globalGoogleData.filter(row => row['medical rep'] === selectedRep);
                    if (selectedOption === 'unvisited') {
                        filteredHCPsForDashboard = googleDataForCurrentRep.filter(row => (!visitCountsForCurrentRep[row['HCPS']] || visitCountsForCurrentRep[row['HCPS']] === 0) && (selectedBricks.length === 0 || selectedBricks.includes(row['Brick'])) && (selectedDay === '' || row[selectedDay].trim() !== ''));
                    } else if (selectedOption === 'remaining') {
                        filteredHCPsForDashboard = googleDataForCurrentRep.filter(row => (parseInt(row['T.V']) || 0) > (visitCountsForCurrentRep[row['HCPS']] || 0) && (selectedBricks.length === 0 || selectedBricks.includes(row['Brick'])) && (selectedDay === '' || row[selectedDay].trim() !== ''));
                    } else {
                        filteredHCPsForDashboard = googleDataForCurrentRep.filter(row => (selectedBricks.length === 0 || selectedBricks.includes(row['Brick'])) && (selectedDay === '' || row[selectedDay].trim() !== ''));
                    }
                    this.populateHCPTable(filteredHCPsForDashboard, selectedDay); this.elements.searchContainer.classList.remove('hidden');
                }
                populateHCPTable(hcpData, selectedDay) {
                    this.elements.hcpTableBody.innerHTML = '';
                    hcpData.forEach(row => {
                        const actualVisits = visitCountsForCurrentRep[row['HCPS']] || 0, targetVisits = parseInt(row['T.V']) || 0, remainingVisits = targetVisits - actualVisits;
                        const remainingClass = remainingVisits <= 0 ? 'light-green' : (remainingVisits < targetVisits ? 'light-yellow' : 'light-red');
                        const tr = this.elements.hcpTableBody.insertRow();
                        tr.innerHTML = `<td class="sticky">${row['HCPS']}</td><td>${row['Speciality']}</td><td>${row['Class']}</td><td>${row['T.V']}</td><td class="${remainingClass}">${remainingVisits}</td><td>${row['Brick']}</td><td>${row['Address']}</td><td>${row['Mobile']}</td> <td class="${selectedDay === 'Saturday' ? 'highlight' : ''}">${row['Saturday']}</td><td class="${selectedDay === 'Sunday' ? 'highlight' : ''}">${row['Sunday']}</td><td class="${selectedDay === 'Monday' ? 'highlight' : ''}">${row['Monday']}</td><td class="${selectedDay === 'Tuesday' ? 'highlight' : ''}">${row['Tuesday']}</td><td class="${selectedDay === 'Wednesday' ? 'highlight' : ''}">${row['Wednesday']}</td><td class="${selectedDay === 'Thursday' ? 'highlight' : ''}">${row['Thursday']}</td>`;
                    });
                    this.elements.hcpTable.classList.toggle('hidden', hcpData.length === 0);
                }
                searchTable() {
                    const searchTerm = this.elements.searchBox.value.toLowerCase();
                    Array.from(this.elements.hcpTableBody.querySelectorAll('tr')).forEach(row => {
                        row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
                    });
                }
                resetDashboard() {
                    this.elements.visitOptionsSelect.selectedIndex = 0; this.elements.dayFilterSelect.selectedIndex = 0; this.elements.searchBox.value = '';
                    selectedBricks = []; this.elements.bricksTrigger.textContent = 'Select Brick'; this.elements.hcpTableBody.innerHTML = '';
                    this.elements.hcpTable.classList.add('hidden'); this.elements.errorDisplay.classList.add('hidden');
                    this.elements.countDisplay.classList.add('hidden'); this.elements.searchContainer.classList.add('hidden');
                    if (currentMedRep) this.initializeDashboardForRep(currentMedRep.name);
                }
            }
            class RequestFormManager {
                constructor() {
                    this.currentRepName = '';
                    this.elements = {
                        personalTabBtn: document.getElementById('personalTabBtn'), customerTabBtn: document.getElementById('customerTabBtn'), personalRequestTab: document.getElementById('personalRequestTab'),
                        customerRequestTab: document.getElementById('customerRequestTab'), personalNameSelect: document.getElementById("personalName"), personalAreaSelect: document.getElementById("personalArea"),
                        personalAreaContainer: document.getElementById("personalAreaContainer"), personalDateInput: document.getElementById("personalDate"), personalRequestTitleSelect: document.getElementById("personalRequestTitle"),
                        personalRequestDetailsTextarea: document.getElementById("personalRequestDetails"), submitPersonalRequestBtn: document.getElementById("submitPersonalRequestBtn"),
                        resetPersonalFormBtn: document.getElementById("resetPersonalFormBtn"), retrievePersonalRequestsBtn: document.getElementById("retrievePersonalRequestsBtn"),
                        personalRequestCountSpan: document.getElementById("personalRequestCount"), retrievedPersonalRequestsDiv: document.getElementById("retrievedPersonalRequests"),
                        personalRequestDetailsDisplayDiv: document.getElementById("personalRequestDetailsDisplay"), areaSelect: document.getElementById("area"), areaContainer: document.getElementById("areaContainer"),
                        customerTypeSelect: document.getElementById("customerType"), accountDropdown: document.getElementById("accountDropdown"), doctorDropdown: document.getElementById("doctorDropdown"),
                        customerNamesDiv: document.getElementById("customerNames"), amAccountsSelect: document.getElementById("amAccounts"), pmDoctorsSelect: document.getElementById("pmDoctors"),
                        customerNameInput: document.getElementById("customerName"), dateInput: document.getElementById("date"), requestTitleInput: document.getElementById("requestTitle"),
                        requestDetailsTextarea: document.getElementById("requestDetails"), submitCustomerRequestBtn: document.getElementById("submitCustomerRequestBtn"),
                        resetCustomerFormBtn: document.getElementById("resetCustomerFormBtn"), retrieveCustomerRequestsBtn: document.getElementById("retrieveCustomerRequestsBtn"),
                        customerRequestCountSpan: document.getElementById("customerRequestCount"), retrievedCustomerRequestsDiv: document.getElementById("retrievedCustomerRequests"),
                        customerRequestDetailsDisplayDiv: document.getElementById("customerRequestDetailsDisplay"), personalNameError: document.getElementById("personalNameError"),
                        personalAreaError: document.getElementById("personalAreaError"), personalDateError: document.getElementById("personalDateError"),
                        personalRequestTitleError: document.getElementById("personalRequestTitleError"), personalRequestDetailsError: document.getElementById("personalRequestDetailsError"),
                        areaError: document.getElementById("areaError"), customerTypeError: document.getElementById("customerTypeError"), amAccountsError: document.getElementById("amAccountsError"),
                        pmDoctorsError: document.getElementById("pmDoctorsError"), customerNameError: document.getElementById("customerNameError"), dateError: document.getElementById("dateError"),
                        requestTitleError: document.getElementById("requestTitleError"), requestDetailsError: document.getElementById("requestDetailsError"),
                    };
                    this.setupEventListeners();
                }
                setupEventListeners() {
                    this.elements.personalTabBtn.addEventListener('click', () => this.showTab('personal'));
                    this.elements.customerTabBtn.addEventListener('click', () => this.showTab('customer'));
                    this.elements.personalNameSelect.addEventListener('change', () => this.updatePersonalAreaDropdown());
                    this.elements.submitPersonalRequestBtn.addEventListener('click', () => this.submitPersonalRequest());
                    this.elements.resetPersonalFormBtn.addEventListener('click', () => this.resetPersonalForm());
                    this.elements.retrievePersonalRequestsBtn.addEventListener('click', () => this.retrievePersonalRequests());
                    this.elements.customerTypeSelect.addEventListener('change', () => this.updateAccountOrDoctorDropdown());
                    this.elements.submitCustomerRequestBtn.addEventListener('click', () => this.submitCustomerRequest());
                    this.elements.resetCustomerFormBtn.addEventListener('click', () => this.resetCustomerForm());
                    this.elements.retrieveCustomerRequestsBtn.addEventListener('click', () => this.retrieveCustomerRequests());
                }
                initialize(repName) {
                    this.currentRepName = repName; this.populatePersonalNameDropdown(); this.updateAreaDropdown();
                    this.elements.dateInput.value = formManager.getCairoDate(); this.elements.personalDateInput.value = formManager.getCairoDate();
                    this.fetchTotalPersonalRequests(); this.fetchTotalCustomerRequests();
                }
                resetForm() { this.resetPersonalForm(); this.resetCustomerForm(); }
                showTab(tabName) {
                    this.resetPersonalForm(); this.resetCustomerForm();
                    this.elements.personalRequestTab.classList.add('hidden'); this.elements.customerRequestTab.classList.add('hidden');
                    this.elements.personalTabBtn.classList.remove('active', 'personal-tab-color-active'); this.elements.customerTabBtn.classList.remove('active', 'customer-tab-color-active');
                    if (tabName === 'personal') {
                        this.elements.personalRequestTab.classList.remove('hidden'); this.elements.personalTabBtn.classList.add('active', 'personal-tab-color-active');
                    } else {
                        this.elements.customerRequestTab.classList.remove('hidden'); this.elements.customerTabBtn.classList.add('active', 'customer-tab-color-active');
                    }
                }
                populatePersonalNameDropdown() {
                    this.elements.personalNameSelect.innerHTML = '<option value="">Select Your Name</option>';
                    if (this.currentRepName) {
                        const optionPersonal = document.createElement("option"); optionPersonal.value = this.currentRepName; optionPersonal.textContent = this.currentRepName;
                        this.elements.personalNameSelect.appendChild(optionPersonal); this.elements.personalNameSelect.value = this.currentRepName;
                        this.updatePersonalAreaDropdown();
                    }
                }
                updatePersonalAreaDropdown() {
                    const personalName = this.elements.personalNameSelect.value;
                    this.elements.personalAreaSelect.innerHTML = '<option value="">Select Your Area</option>';
                    if (personalName) {
                        const areaList = medicalRepsAreas.get(personalName);
                        if (areaList) {
                            Array.from(areaList).forEach(area => { const option = document.createElement("option"); option.value = area; option.textContent = area; this.elements.personalAreaSelect.appendChild(option); });
                            this.elements.personalAreaContainer.classList.remove('hidden');
                            if (currentMedRep && currentMedRep.area) this.elements.personalAreaSelect.value = currentMedRep.area;
                        } else { this.elements.personalAreaContainer.classList.add('hidden'); }
                    } else { this.elements.personalAreaContainer.classList.add('hidden'); }
                }
                updateAreaDropdown() {
                    const medRep = this.currentRepName;
                    this.elements.areaSelect.innerHTML = '<option value="">Select an Area</option>';
                    if (medRep) {
                        const areaList = medicalRepsAreas.get(medRep);
                        if (areaList) {
                            Array.from(areaList).forEach(area => { const option = document.createElement("option"); option.value = area; option.innerText = area; this.elements.areaSelect.appendChild(option); });
                            this.elements.areaContainer.classList.remove('hidden');
                            if (currentMedRep && currentMedRep.area) this.elements.areaSelect.value = currentMedRep.area;
                        } else { this.elements.areaContainer.classList.add('hidden'); }
                    } else { this.elements.areaContainer.classList.add('hidden'); }
                }
                updateAccountOrDoctorDropdown() {
                    const customerType = this.elements.customerTypeSelect.value;
                    this.elements.accountDropdown.classList.add('hidden'); this.elements.doctorDropdown.classList.add('hidden'); this.elements.customerNamesDiv.classList.add('hidden');
                    if (customerType === 'AM Accounts') {
                        this.elements.accountDropdown.classList.remove('hidden'); this.elements.amAccountsSelect.value = '';
                        this.elements.customerNamesDiv.classList.remove('hidden'); this.elements.customerNameInput.value = '';
                    } else if (customerType === 'PM Doctors') {
                        this.elements.doctorDropdown.classList.remove('hidden'); this.elements.pmDoctorsSelect.value = '';
                        this.elements.customerNamesDiv.classList.remove('hidden'); this.elements.customerNameInput.value = '';
                    }
                }
                showError(errorElement, message) { errorElement.textContent = message; errorElement.style.display = 'block'; }
                hideError(errorElement) { errorElement.style.display = 'none'; }
                clearAllErrors() { document.querySelectorAll('#requestSection .error').forEach(el => el.style.display = 'none'); }
                async submitCustomerRequest() {
                    this.clearAllErrors();
                    const medRep = this.currentRepName, area = this.elements.areaSelect.value, customerTypeDropdown = this.elements.customerTypeSelect.value, customerName = this.elements.customerNameInput.value;
                    let selectedAccountOrDoctor = '', valid = true;
                    if (!medRep) { showRequestAlert("Medical Rep information is missing.", "error"); valid = false; }
                    if (!area) { this.showError(this.elements.areaError, "Area is required."); valid = false; }
                    if (!customerTypeDropdown) { this.showError(this.elements.customerTypeError, "Customer Type is required."); valid = false; }
                    if (customerTypeDropdown === 'AM Accounts') {
                        selectedAccountOrDoctor = this.elements.amAccountsSelect.value;
                        if (!selectedAccountOrDoctor) { this.showError(this.elements.amAccountsError, "AM Account is required."); valid = false; }
                    } else if (customerTypeDropdown === 'PM Doctors') {
                        selectedAccountOrDoctor = this.elements.pmDoctorsSelect.value;
                        if (!selectedAccountOrDoctor) { this.showError(this.elements.pmDoctorsError, "PM Doctor is required."); valid = false; }
                    }
                    if (!customerName) { this.showError(this.elements.customerNameError, "Customer Name is required."); valid = false; }
                    if (!this.elements.dateInput.value) { this.showError(this.elements.dateError, "Date is required."); valid = false; }
                    if (!this.elements.requestTitleInput.value) { this.showError(this.elements.requestTitleError, "Request Title is required."); valid = false; }
                    const commentError = formManager.validateComment(this.elements.requestDetailsTextarea.value);
                    if (commentError) { this.showError(this.elements.requestDetailsError, commentError); valid = false; }
                    if (valid) {
                        const requestData = { medRep, area, customerType: selectedAccountOrDoctor, customerName, date: this.elements.dateInput.value, requestTitle: this.elements.requestTitleInput.value, requestDetails: this.elements.requestDetailsTextarea.value, status: "Requested" };
                        try {
                            const response = await fetch(REQUESTS_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_API_KEY, 'Authorization': `Bearer ${SUPABASE_API_KEY}` }, body: JSON.stringify(requestData) });
                            if (response.ok) { showRequestAlert("Customer Request submitted successfully!", "success"); this.resetCustomerForm(); this.fetchTotalCustomerRequests(); }
                            else { const errorData = await response.json(); console.error('Error submitting customer request:', errorData); showRequestAlert("Failed to submit customer request: " + errorData.message, "error"); }
                        } catch (error) { console.error('Error:', error); showRequestAlert("An error occurred while submitting the customer request.", "error"); }
                    } else { showRequestAlert('Please fill in all required fields for Customer Request.', 'error'); }
                }
                async submitPersonalRequest() {
                    this.clearAllErrors();
                    const personalName = this.elements.personalNameSelect.value, personalArea = this.elements.personalAreaSelect.value, personalRequestTitle = this.elements.personalRequestTitleSelect.value, personalDate = this.elements.personalDateInput.value;
                    let valid = true;
                    if (!personalName) { this.showError(this.elements.personalNameError, "Name is required."); valid = false; }
                    if (!personalArea) { this.showError(this.elements.personalAreaError, "Area is required."); valid = false; }
                    if (!personalRequestTitle) { this.showError(this.elements.personalRequestTitleError, "Request Title is required."); valid = false; }
                    if (!personalDate) { this.showError(this.elements.personalDateError, "Date is required."); valid = false; }
                    const commentError = formManager.validateComment(this.elements.personalRequestDetailsTextarea.value);
                    if (commentError) { this.showError(this.elements.personalRequestDetailsError, commentError); valid = false; }
                    if (valid) {
                        const requestData = { medRep: personalName, area: personalArea, customerType: "Personal", customerName: personalName, date: personalDate, requestTitle: personalRequestTitle, requestDetails: this.elements.personalRequestDetailsTextarea.value, status: "Requested" };
                        try {
                            const response = await fetch(REQUESTS_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_API_KEY, 'Authorization': `Bearer ${SUPABASE_API_KEY}` }, body: JSON.stringify(requestData) });
                            if (response.ok) { showRequestAlert("Personal Request submitted successfully!", "success"); this.resetPersonalForm(); this.fetchTotalPersonalRequests(); }
                            else { const errorData = await response.json(); console.error('Error submitting personal request:', errorData); showRequestAlert("Failed to submit personal request: " + errorData.message, "error"); }
                        } catch (error) { console.error('Error:', error); showRequestAlert("An error occurred while submitting the personal request.", "error"); }
                    } else { showRequestAlert('Please fill in all required fields for Personal Request.', 'error'); }
                }
                resetCustomerForm() {
                    this.elements.areaSelect.innerHTML = '<option value="">Select an Area</option>'; this.elements.areaContainer.classList.add('hidden');
                    this.elements.customerTypeSelect.value = ''; this.elements.accountDropdown.classList.add('hidden'); this.elements.doctorDropdown.classList.add('hidden');
                    this.elements.customerNamesDiv.classList.add('hidden'); this.elements.customerNameInput.value = ''; this.elements.requestTitleInput.value = '';
                    this.elements.requestDetailsTextarea.value = ''; this.elements.retrievedCustomerRequestsDiv.classList.add('hidden');
                    this.elements.customerRequestDetailsDisplayDiv.innerHTML = ''; this.elements.dateInput.value = formManager.getCairoDate(); this.clearAllErrors();
                    if (this.currentRepName) this.updateAreaDropdown(); this.fetchTotalCustomerRequests();
                }
                resetPersonalForm() {
                    this.elements.personalNameSelect.value = this.currentRepName || ''; this.elements.personalAreaSelect.innerHTML = '<option value="">Select Your Area</option>';
                    this.elements.personalAreaContainer.classList.add('hidden'); this.elements.personalRequestTitleSelect.value = '';
                    this.elements.personalRequestDetailsTextarea.value = ''; this.elements.personalDateInput.value = formManager.getCairoDate();
                    this.elements.retrievedPersonalRequestsDiv.classList.add('hidden'); this.elements.personalRequestDetailsDisplayDiv.innerHTML = ''; this.clearAllErrors();
                    if (this.currentRepName) this.updatePersonalAreaDropdown(); this.fetchTotalPersonalRequests();
                }
                async retrieveCustomerRequests() {
                    const medRep = this.currentRepName, requestDetailsDisplay = this.elements.customerRequestDetailsDisplayDiv;
                    requestDetailsDisplay.innerHTML = '';
                    if (!medRep) { showRequestAlert("Medical Rep information is missing.", "error"); return; }
                    let filters = [`customerType=neq.Personal`];
                    const associatedAreas = medicalRepsAreas.get(medRep);
                    if (associatedAreas && associatedAreas.size > 0) { filters.push(`area=in.(${Array.from(associatedAreas).join(',')})`); }
                    else { showRequestAlert("No associated areas found.", "info"); this.elements.retrievedCustomerRequestsDiv.classList.add('hidden'); return; }
                    const fullQueryUrl = `${REQUESTS_URL}?${filters.join('&')}&order=date.desc`;
                    try {
                        const data = await fetchPaginatedData(fullQueryUrl, SUPABASE_API_KEY);
                        const sortedData = data.sort((a, b) => { const dateA = new Date(a.date).getTime(), dateB = new Date(b.date).getTime(); if ((a.status === "Done" || a.status === "Canceled" || a.status === "Approved" || a.status === "Rejected") && !(b.status === "Done" || b.status === "Canceled" || b.status === "Approved" || b.status === "Rejected")) return 1; if ((b.status === "Done" || b.status === "Canceled" || b.status === "Approved" || b.status === "Rejected") && !(a.status === "Done" || a.status === "Canceled" || a.status === "Approved" || a.status === "Rejected")) return -1; return dateB - dateA; });
                        if (sortedData.length > 0) {
                            sortedData.forEach(req => {
                                const note = document.createElement("div"); note.classList.add('note-box');
                                if (req.status === "Done" || req.status === "Approved") note.classList.add('note-box-done');
                                else if (req.status === "Canceled" || req.status === "Rejected") note.classList.add('note-box-canceled');
                                note.innerHTML = `<div class='note-header'>By: ${req.medRep}</div><div><strong>Area:</strong> ${req.area}</div><div><strong>Customer Type:</strong> ${req.customerType}</div><div><strong>Customer Name:</strong> ${req.customerName}</div><div><strong>Date:</strong> ${req.date}</div><div><strong>Request Title:</strong> ${req.requestTitle}</div><div><strong>Request Details:</strong> ${req.requestDetails}</div><div><strong>Status:</strong> ${req.status}</div>`;
                                requestDetailsDisplay.appendChild(note);
                            });
                            this.elements.retrievedCustomerRequestsDiv.classList.remove('hidden');
                        } else { showRequestAlert("No customer requests found for your associated areas.", "info"); this.elements.retrievedCustomerRequestsDiv.classList.add('hidden'); }
                    } catch (error) { console.error('Error fetching customer requests:', error); showRequestAlert("An error occurred while retrieving customer requests.", "error"); }
                }
                async retrievePersonalRequests() {
                    const personalName = this.elements.personalNameSelect.value, personalRequestDetailsDisplay = this.elements.personalRequestDetailsDisplayDiv;
                    personalRequestDetailsDisplay.innerHTML = '';
                    if (!personalName) { showRequestAlert("Please select your Name to retrieve personal requests.", "error"); return; }
                    const fullQueryUrl = `${REQUESTS_URL}?customerType=eq.Personal&medRep=eq.${personalName}&order=date.desc`;
                    try {
                        const data = await fetchPaginatedData(fullQueryUrl, SUPABASE_API_KEY);
                        const sortedData = data.sort((a, b) => { const dateA = new Date(a.date).getTime(), dateB = new Date(b.date).getTime(); if ((a.status === "Done" || a.status === "Canceled" || a.status === "Approved" || a.status === "Rejected") && !(b.status === "Done" || b.status === "Canceled" || b.status === "Approved" || b.status === "Rejected")) return 1; if ((b.status === "Done" || b.status === "Canceled" || b.status === "Approved" || b.status === "Rejected") && !(a.status === "Done" || a.status === "Canceled" || a.status === "Approved" || a.status === "Rejected")) return -1; return dateB - dateA; });
                        if (sortedData.length > 0) {
                            sortedData.forEach(req => {
                                const note = document.createElement("div"); note.classList.add('note-box');
                                if (req.status === "Approved") note.classList.add('note-box-done');
                                else if (req.status === "Rejected") note.classList.add('note-box-canceled');
                                note.innerHTML = `<div class='note-header'>By: ${req.medRep}</div><div><strong>Area:</strong> ${req.area}</div><div><strong>Request Type:</strong> ${req.requestTitle}</div><div><strong>Date:</strong> ${req.date}</div><div><strong>Details:</strong> ${req.requestDetails}</div><div><strong>Status:</strong> ${req.status}</div>`;
                                personalRequestDetailsDisplay.appendChild(note);
                            });
                            this.elements.retrievedPersonalRequestsDiv.classList.remove('hidden');
                        } else { showRequestAlert("No personal requests found for the selected name.", "info"); this.elements.retrievedPersonalRequestsDiv.classList.add('hidden'); }
                    } catch (error) { console.error('Error fetching personal requests:', error); showRequestAlert("An error occurred while fetching total personal requests.", "error"); }
                }
                async fetchTotalCustomerRequests() {
                    const medRep = this.currentRepName; let filters = [`customerType=neq.Personal`];
                    if (medRep) {
                        const associatedAreas = medicalRepsAreas.get(medRep);
                        if (associatedAreas && associatedAreas.size > 0) filters.push(`area=in.(${Array.from(associatedAreas).join(',')})`);
                        else { this.elements.customerRequestCountSpan.innerText = '0'; return; }
                    } else { this.elements.customerRequestCountSpan.innerText = '0'; return; }
                    const fullQueryUrl = `${REQUESTS_URL}?${filters.join('&')}`;
                    try { const data = await fetchPaginatedData(fullQueryUrl, SUPABASE_API_KEY); this.elements.customerRequestCountSpan.innerText = data.length; }
                    catch (error) { console.error('Error fetching total customer requests:', error); showRequestAlert("An error occurred while fetching total customer requests.", "error"); }
                }
                async fetchTotalPersonalRequests() {
                    const personalName = this.elements.personalNameSelect.value; let filters = [`customerType=eq.Personal`];
                    if (personalName) { filters.push(`medRep=eq.${personalName}`); } else { this.elements.personalRequestCountSpan.innerText = '0'; return; }
                    const fullQueryUrl = `${REQUESTS_URL}?${filters.join('&')}`;
                    try { const data = await fetchPaginatedData(fullQueryUrl, SUPABASE_API_KEY); this.elements.personalRequestCountSpan.innerText = data.length; }
                    catch (error) { console.error('Error fetching total personal requests:', error); showRequestAlert("An error occurred while fetching total personal requests.", "error"); }
                }
            }
            class WeeklyPlanManager {
                constructor() {
                    this.elements = {
                        loading: document.getElementById('weeklyPlanLoading'), error: document.getElementById('weeklyPlanError'), success: document.getElementById('weeklyPlanSuccess'),
                        content: document.getElementById('weeklyPlanContent'), medicalReps: document.getElementById('weeklyPlanMedicalReps'), bricks: document.getElementById('weeklyPlanBricks'),
                        dayFilter: document.getElementById('weeklyPlanDayFilter'), filterButton: document.getElementById('weeklyPlanFilterButton'), resetButton: document.getElementById('weeklyPlanResetButton'),
                        retrieveButton: document.getElementById('weeklyPlanRetrieveButton'), eventType: document.getElementById('weeklyPlanEventType'), eventNameGroup: document.getElementById('weeklyPlanEventNameGroup'),
                        eventName: document.getElementById('weeklyPlanEventName'), eventTimeGroup: document.getElementById('weeklyPlanEventTimeGroup'), eventTime: document.getElementById('weeklyPlanEventTime'),
                        hcpTable: document.getElementById('weeklyPlanHcpTable'), hcpTableBody: document.querySelector('#weeklyPlanHcpTable tbody'), statsDisplay: document.getElementById('weeklyPlanStatsDisplay'),
                        repArea: document.getElementById('weeklyPlanRepArea'), repNameArea: document.getElementById('weeklyPlanRepNameArea'), startDate: document.getElementById('weeklyPlanStartDate'),
                        endDate: document.getElementById('weeklyPlanEndDate'), amActivitiesTable: document.getElementById('weeklyPlanAmActivitiesTable'), pmActivitiesTable: document.getElementById('weeklyPlanPmActivitiesTable'),
                        submitButton: document.getElementById('weeklyPlanSubmitButton'), saturdayAm: document.getElementById('saturdayAm'), sundayAm: document.getElementById('sundayAm'),
                        mondayAm: document.getElementById('mondayAm'), tuesdayAm: document.getElementById('tuesdayAm'), wednesdayAm: document.getElementById('wednesdayAm'), thursdayAm: document.getElementById('thursdayAm'),
                        saturdayPm: document.getElementById('saturdayPm'), sundayPm: document.getElementById('sundayPm'), mondayPm: document.getElementById('mondayPm'), tuesdayPm: document.getElementById('tuesdayPm'),
                        wednesdayPm: document.getElementById('wednesdayPm'), thursdayPm: document.getElementById('thursdayPm'),
                    };
                    this.weeklyPlanData = { Saturday: { am: [], pm: [] }, Sunday: { am: [], pm: [] }, Monday: { am: [], pm: [] }, Tuesday: { am: [], pm: [] }, Wednesday: { am: [], pm: [] }, Thursday: { am: [], pm: [] } };
                    this.movedHCPs = new Set(); this.currentRepArea = ''; this.currentRepName = ''; this.visitCounts = {}; this.bricks = new Set();
                    this.setupEventListeners();
                }
                setupEventListeners() {
                    this.elements.filterButton.addEventListener('click', () => this.applyFilter());
                    this.elements.resetButton.addEventListener('click', () => this.reset());
                    this.elements.retrieveButton.addEventListener('click', () => this.retrieveWeeklyPlan());
                    this.elements.medicalReps.addEventListener('change', () => this.handleRepChange());
                    this.elements.bricks.addEventListener('change', () => this.updateStatistics());
                    this.elements.dayFilter.addEventListener('change', () => this.applyFilter());
                    this.elements.startDate.addEventListener('change', () => this.updateEndDate());
                    this.elements.eventType.addEventListener('change', () => this.handleEventTypeChange());
                    this.elements.eventTime.addEventListener('change', () => this.handleEventTimeChange());
                    this.elements.submitButton.addEventListener('click', () => this.submitWeeklyPlan());
                }
                initialize(repName) {
                    this.elements.loading.style.display = 'none'; this.elements.content.style.display = 'block'; this.currentRepName = repName;
                    this.elements.medicalReps.innerHTML = `<option value="${repName}">${repName}</option>`; this.elements.medicalReps.value = repName; this.elements.medicalReps.disabled = true;
                    this.processVisitData(); this.handleRepChange(); this.setDefaultDates();
                }
                reset() {
                    this.elements.bricks.innerHTML = '<option value="">Select a Brick</option>'; this.elements.bricks.disabled = true; this.elements.dayFilter.selectedIndex = 0;
                    this.weeklyPlanData = { Saturday: { am: [], pm: [] }, Sunday: { am: [], pm: [] }, Monday: { am: [], pm: [] }, Tuesday: { am: [], pm: [] }, Wednesday: { am: [], pm: [] }, Thursday: { am: [], pm: [] } };
                    this.movedHCPs.clear(); this.renderWeeklyPlan(); this.elements.statsDisplay.style.display = 'none'; this.elements.hcpTable.style.display = 'none';
                    this.elements.eventType.selectedIndex = 0; this.elements.eventName.value = ''; this.elements.eventNameGroup.style.display = 'none';
                    this.elements.eventTime.selectedIndex = 0; this.elements.eventTimeGroup.style.display = 'none';
                    if (this.currentRepName) this.handleRepChange(); this.setDefaultDates();
                }
                showMessage(message, type) {
                    const messageElement = type === 'success' ? this.elements.success : this.elements.error;
                    messageElement.textContent = message; messageElement.style.display = 'block'; messageElement.scrollIntoView({ behavior: 'smooth' });
                    setTimeout(() => { messageElement.style.display = 'none'; }, 5000);
                }
                processVisitData() {
                    const currentMonthStart = formManager.getCurrentMonthStart();
                    const currentMonthVisits = globalSupabaseVisits.filter(visit => formManager.getCairoDate(new Date(visit.visit_date)) >= currentMonthStart);
                    this.visitCounts = {}; currentMonthVisits.forEach(visit => { this.visitCounts[visit.hcp_name] = (this.visitCounts[visit.hcp_name] || 0) + 1; });
                }
                handleRepChange() {
                    const selectedRep = this.elements.medicalReps.value; this.currentRepName = selectedRep;
                    const filteredData = globalGoogleData.filter(row => row['medical rep'] === selectedRep);
                    const area = filteredData.length > 0 ? filteredData[0]['area'] : 'Not Found';
                    this.bricks = new Set(filteredData.map(row => row['Brick']).filter(Boolean));
                    populateSelect(this.elements.bricks, [...this.bricks]); this.currentRepArea = area;
                    this.elements.repArea.textContent = `Area: ${this.currentRepArea}`; this.elements.repNameArea.textContent = `Medical Rep: ${this.currentRepName}`;
                    this.updateStatistics(); this.elements.bricks.disabled = this.bricks.size === 0; this.applyFilter();
                }
                updateStatistics() {
                    const selectedRep = this.elements.medicalReps.value, selectedBrick = this.elements.bricks.value;
                    if (!selectedRep) { this.elements.statsDisplay.style.display = 'none'; return; }
                    const filteredData = globalGoogleData.filter(row => row['medical rep'] === selectedRep);
                    const unvisitedCount = filteredData.filter(row => { const visits = this.visitCounts[row['HCPS']] || 0, targetVisits = parseInt(row['T.V']) || 3, remainingVisits = targetVisits - visits; return remainingVisits === targetVisits && (selectedBrick === '' || row['Brick'] === selectedBrick); }).length;
                    this.elements.statsDisplay.textContent = `Unvisited HCPs in ${selectedBrick || 'total'}: ${unvisitedCount}`; this.elements.statsDisplay.style.display = 'block';
                }
                applyFilter() {
                    const selectedRep = this.elements.medicalReps.value;
                    const selectedDay = this.elements.dayFilter.value;
                    const selectedBrick = this.elements.bricks.value;

                    if (!selectedRep) {
                        this.showMessage('Please select a Medical Representative.', 'error');
                        return;
                    }

                    let filteredHCPs = globalGoogleData.filter(row => {
                        return row['medical rep'] === selectedRep &&
                               (selectedDay === '' || row[selectedDay].trim() !== '') &&
                               (selectedBrick === '' || row['Brick'] === selectedBrick) &&
                               !this.movedHCPs.has(row['HCPS']);
                    });

                    this.populateHCPTable(filteredHCPs, selectedDay);
                }

                populateHCPTable(hcpData, selectedDay) {
    this.elements.hcpTableBody.innerHTML = '';
    // Sort the data based on remaining visits
    const sortedData = hcpData.sort((a, b) => {
        const remainingA = (parseInt(a['T.V']) || 0) - (this.visitCounts[a['HCPS']] || 0);
        const remainingB = (parseInt(b['T.V']) || 0) - (this.visitCounts[b['HCPS']] || 0);
        const targetA = parseInt(a['T.V']) || 0;
        const targetB = parseInt(b['T.V']) || 0;
        if (remainingA === targetA && remainingB !== targetB) return -1;
        if (remainingB === targetB && remainingA !== targetA) return 1;
        return remainingB - remainingA;
    });

    sortedData.forEach(row => {
        const actualVisits = this.visitCounts[row['HCPS']] || 0;
        const targetVisits = parseInt(row['T.V']) || 0;
        const remainingVisits = targetVisits - actualVisits;

        // Determine the class for the Remaining column
        let remainingClass = '';
        if (remainingVisits <= 0) {
            remainingClass = 'remaining-zero-or-negative';
            if (remainingVisits < 0) {
                remainingClass += ' negative';
            }
        } else if (remainingVisits < targetVisits) {
            remainingClass = 'remaining-less';
        } else {
            remainingClass = 'remaining-equal';
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row['HCPS']}</td>
            <td>${row['Speciality']}</td>
            <td>${row['Class']}</td>
            <td>${row['T.V']}</td>
            <td class="${remainingClass}">${remainingVisits}</td>
            <td>${row['Brick']}</td>
            <td>${row['Address']}</td>
            <td>${row['Mobile']}</td>
            <td class="${selectedDay === 'Saturday' ? 'highlight' : ''}">${row['Saturday']}</td>
            <td class="${selectedDay === 'Sunday' ? 'highlight' : ''}">${row['Sunday']}</td>
            <td class="${selectedDay === 'Monday' ? 'highlight' : ''}">${row['Monday']}</td>
            <td class="${selectedDay === 'Tuesday' ? 'highlight' : ''}">${row['Tuesday']}</td>
            <td class="${selectedDay === 'Wednesday' ? 'highlight' : ''}">${row['Wednesday']}</td>
            <td class="${selectedDay === 'Thursday' ? 'highlight' : ''}">${row['Thursday']}</td>
        `;

        tr.addEventListener('click', () => {
            if (!this.elements.dayFilter.value) {
                this.showMessage('Please select a Day first.', 'error');
                return;
            }
            this.addToWeeklyPlan(row['HCPS'], row[this.elements.dayFilter.value], this.elements.dayFilter.value, row['Speciality']);
            this.elements.hcpTableBody.removeChild(tr);
        });

        this.elements.hcpTableBody.appendChild(tr);
    });

    this.elements.hcpTable.style.display = sortedData.length > 0 ? 'table' : 'none';
}
                addToWeeklyPlan(hcpName, visitTime, day, speciality) {
                    const hcpRow = globalGoogleData.find(row => row['HCPS'] === hcpName);
                    if (hcpRow) {
                        const brick = hcpRow['Brick'] || ''; const isPriority = ['Account', 'Hospital', 'Dialysis Center', 'Oncology Center'].includes(speciality);
                        if (isPriority) { this.weeklyPlanData[day].am.push({ name: hcpName, time: visitTime, speciality: speciality, brick: brick, isNew: true }); }
                        else { const plan = this.weeklyPlanData[day].pm; plan.push({ name: hcpName, time: visitTime, speciality: speciality, brick: brick, isNew: true }); this.movedHCPs.add(hcpName); }
                        this.renderWeeklyPlan();
                    }
                }
                renderWeeklyPlan() {
                    ['saturdayAm', 'sundayAm', 'mondayAm', 'tuesdayAm', 'wednesdayAm', 'thursdayAm', 'saturdayPm', 'sundayPm', 'mondayPm', 'tuesdayPm', 'wednesdayPm', 'thursdayPm'].forEach(id => { document.getElementById(id).innerHTML = ''; });
                    Object.keys(this.weeklyPlanData).forEach(day => {
                        const amCell = document.getElementById(`${day.toLowerCase()}Am`), pmCell = document.getElementById(`${day.toLowerCase()}Pm`);
                        this.weeklyPlanData[day].am.forEach(item => { const itemDiv = this.createPlanItemDiv(item, day, true); amCell.appendChild(itemDiv); this.attachRemoveEventListener(itemDiv, item, day, true); });
                        this.weeklyPlanData[day].pm.forEach(item => { const itemDiv = this.createPlanItemDiv(item, day, false); pmCell.appendChild(itemDiv); this.attachRemoveEventListener(itemDiv, item, day, false); });
                    });
                }
                attachRemoveEventListener(itemDiv, item, day, isAm) {
                    const removeButton = itemDiv.querySelector('.remove-button');
                    if (removeButton) { removeButton.addEventListener('click', (event) => { event.stopPropagation(); const isEvent = ['Meeting', 'Training', 'Event', 'Annual Leave', 'Sick Leave', 'Official Leave'].includes(item.name); this.removeFromWeeklyPlan(item.name, day, isAm, isEvent, item.brick); }); }
                }
                createPlanItemDiv(item, day, isAm) {
                    const div = document.createElement('div'); const isEvent = ['Meeting', 'Training', 'Event', 'Annual Leave', 'Sick Leave', 'Official Leave'].includes(item.name); const removeButtonClass = item.isNew ? 'remove-button' : 'remove-button hidden';
                    if (isEvent) { div.className = 'event-box'; div.innerHTML = `<strong>${item.name}</strong><br>${item.brick}<br><span class="v-t">${item.speciality}</span><span class="${removeButtonClass}">X</span>`; }
                    else { div.className = isAm ? 'Speciality-box' : 'hcp-box'; div.innerHTML = `${item.name}<br><span class="v-t">${item.time || 'N/A'}</span><br>${item.brick || 'N/A'}<span class="${removeButtonClass}">X</span>`; }
                    return div;
                }
                removeFromWeeklyPlan(hcpName, day, isAm, isEvent, eventBrick = '') {
                    let planArray = isAm ? this.weeklyPlanData[day].am : this.weeklyPlanData[day].pm;
                    let removedItemIndex = planArray.findIndex(item => item.name === hcpName && (!isEvent || item.brick === eventBrick));
                    if (removedItemIndex > -1) {
                        const [removedItem] = planArray.splice(removedItemIndex, 1); const movedKey = isEvent ? hcpName + eventBrick : hcpName;
                        this.movedHCPs.delete(movedKey); if (!isEvent) this.addHCPToTable(removedItem); this.renderWeeklyPlan();
                    }
                }
                addHCPToTable(hcpData) { if (globalGoogleData.find(row => row['HCPS'] === hcpData.name)) this.applyFilter(); }
                setDefaultDates() {
                    const nowInCairo = new Date(new Date().toLocaleString('en-US', { timeZone: 'Africa/Cairo' }));
                    const day = nowInCairo.getDay(); // 0=Sun, 6=Sat
                    let startDate = new Date(nowInCairo);

                    if (day < 4) { // Sunday (0), Monday (1), Tuesday (2), Wednesday (3)
                        // Go back to the previous Saturday
                        startDate.setDate(nowInCairo.getDate() - (day + 1));
                    } else { // Thursday (4), Friday (5), Saturday (6)
                        // Go forward to the upcoming Saturday
                        startDate.setDate(nowInCairo.getDate() + (6 - day));
                    }

                    this.elements.startDate.value = formManager.getCairoDate(startDate);
                    this.updateEndDate();
                }
                updateEndDate() {
                    const startDate = new Date(this.elements.startDate.value); const endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 5); this.elements.endDate.value = formManager.getCairoDate(endDate);
                }
                handleEventTypeChange() {
                    const show = !!this.elements.eventType.value;
                    this.elements.eventNameGroup.style.display = show ? 'flex' : 'none'; this.elements.eventTimeGroup.style.display = show ? 'flex' : 'none';
                    if (!show) { this.elements.eventName.value = ''; this.elements.eventTime.selectedIndex = 0; }
                }
                handleEventTimeChange() {
                    const eventType = this.elements.eventType.value, eventTime = this.elements.eventTime.value, eventName = this.elements.eventName.value, day = this.elements.dayFilter.value;
                    if (!day) { this.showMessage('Please select a Day first.', 'error'); this.elements.eventTime.selectedIndex = 0; return; }
                    if (!eventName) { this.showMessage('Please enter an Event Name.', 'error'); this.elements.eventTime.selectedIndex = 0; return; }
                    if (eventType && eventTime) this.addEventToSchedule(eventType, eventTime, eventName, day);
                }
                addEventToSchedule(eventType, eventTime, eventName, day) {
                    const eventEntry = { name: eventType, time: eventTime, speciality: eventTime, brick: eventName, isNew: true }; const movedKey = eventType + eventName;
                    if (eventTime === 'AM' || eventTime === 'Full Day') this.weeklyPlanData[day].am.push(eventEntry);
                    if (eventTime === 'PM' || eventTime === 'Full Day') this.weeklyPlanData[day].pm.push(eventEntry);
                    this.movedHCPs.add(movedKey); this.renderWeeklyPlan();
                    this.elements.eventType.selectedIndex = 0; this.elements.eventName.value = ''; this.elements.eventNameGroup.style.display = 'none';
                    this.elements.eventTime.selectedIndex = 0; this.elements.eventTimeGroup.style.display = 'none';
                }
                async submitWeeklyPlan() {
                    const startDate = this.elements.startDate.value, endDate = this.elements.endDate.value, selectedRep = this.elements.medicalReps.value;
                    if (!selectedRep) { this.showMessage('Please select a Medical Representative.', 'error'); return; }
                    const plansToSubmit = []; const submittedItems = new Set();
                    Object.keys(this.weeklyPlanData).forEach(day => {
                        [...this.weeklyPlanData[day].am, ...this.weeklyPlanData[day].pm].forEach(item => {
                            const isEvent = ['Meeting', 'Training', 'Event', 'Annual Leave', 'Sick Leave', 'Official Leave'].includes(item.name);
                            const itemIdentifier = isEvent ? `${item.name}-${day}-${item.speciality}-${item.brick}` : `${item.name}-${day}-${item.time}`;
                            if (!submittedItems.has(itemIdentifier)) {
                                plansToSubmit.push({ hcp_name: item.name, visit_time: item.time, visit_day: day, Speciality: item.speciality, medical_rep_name: this.currentRepName, medical_rep_area: this.currentRepArea, brick: item.brick, start_date: startDate, end_date: endDate, });
                                submittedItems.add(itemIdentifier);
                            }
                        });
                    });
                    if (plansToSubmit.length === 0) { this.showMessage('Weekly plan is empty. Nothing to submit.', 'error'); return; }
                    try {
                        await fetch(`${SUPABASE_WEEKLY_PLANS_URL}?medical_rep_name=eq.${encodeURIComponent(selectedRep)}&start_date=gte.${startDate}&end_date=lte.${endDate}`, { method: 'DELETE', headers: { 'apikey': SUPABASE_API_KEY, 'Authorization': `Bearer ${SUPABASE_API_KEY}` } });
                        const response = await fetch(SUPABASE_WEEKLY_PLANS_URL, { method: 'POST', headers: { 'apikey': SUPABASE_API_KEY, 'Authorization': `Bearer ${SUPABASE_API_KEY}`, 'Content-Type': 'application/json' }, body: JSON.stringify(plansToSubmit) });
                        if (!response.ok) throw new Error('Failed to submit plan');
                        this.showMessage('Weekly plan submitted successfully!', 'success'); setTimeout(() => this.reset(), 3000);
                    } catch (error) { console.error('Error submitting weekly plan:', error); this.showMessage('Error submitting weekly plan.', 'error'); }
                }
                async retrieveWeeklyPlan() {
                    const selectedRep = this.elements.medicalReps.value, startDate = this.elements.startDate.value, endDate = this.elements.endDate.value;
                    if (!selectedRep) { this.showMessage('Please select a Medical Representative.', 'error'); return; }
                    try {
                        const data = await fetchPaginatedData(`${SUPABASE_WEEKLY_PLANS_URL}?medical_rep_name=eq.${encodeURIComponent(selectedRep)}&start_date=gte.${startDate}&end_date=lte.${endDate}`, SUPABASE_API_KEY);
                        if (data.length === 0) { this.showMessage('No weekly plan found for the selected criteria.', 'error'); return; }
                        this.reset(); this.elements.medicalReps.value = selectedRep; this.handleRepChange();
                        this.elements.startDate.value = startDate; this.elements.endDate.value = endDate;
                        data.forEach(item => {
                            const day = item.visit_day, entry = { name: item.hcp_name, time: item.visit_time, speciality: item.Speciality, brick: item.brick, isNew: false };
                            const isEvent = ['Meeting', 'Training', 'Event', 'Annual Leave', 'Sick Leave', 'Official Leave'].includes(item.hcp_name);
                            const movedKey = isEvent ? item.hcp_name + item.brick : item.hcp_name;
                            this.movedHCPs.add(movedKey);
                            if (day && this.weeklyPlanData[day]) {
                                if (isEvent) {
                                    if (item.Speciality === 'AM' || item.Speciality === 'Full Day') this.weeklyPlanData[day].am.push(entry);
                                    if (item.Speciality === 'PM' || item.Speciality === 'Full Day') this.weeklyPlanData[day].pm.push(entry);
                                } else {
                                     const isPriority = ['Account', 'Hospital', 'Dialysis Center', 'Oncology Center'].includes(item.Speciality);
                                     if(isPriority) this.weeklyPlanData[day].am.push(entry); else this.weeklyPlanData[day].pm.push(entry);
                                }
                            }
                        });
                        this.renderWeeklyPlan(); this.applyFilter(); this.showMessage('Weekly plan retrieved successfully!', 'success');
                    } catch (error) { console.error('Error retrieving weekly plan:', error); this.showMessage('Error retrieving weekly plan.', 'error'); }
                }
            }

            const formManager = new FormManager();
            const dashboardManager = new DashboardManager();
            const requestFormManager = new RequestFormManager();
            const weeklyPlanManager = new WeeklyPlanManager();
            window.weeklyPlanManager = weeklyPlanManager;

            // Scroll to Top Button Logic
            const scrollToTopBtn = document.getElementById("scrollToTopBtn");
            const scrollableContent = document.querySelector('.main-content-scrollable');
            const scrollTarget = window.innerWidth >= 1024 ? scrollableContent : window;

            scrollTarget.onscroll = function() {
                let scrollTop = 0;
                if (window.innerWidth >= 1024) {
                    scrollTop = scrollableContent.scrollTop;
                } else {
                    scrollTop = document.body.scrollTop || document.documentElement.scrollTop;
                }
                
                if (scrollTop > 100) {
                    scrollToTopBtn.style.display = "block";
                } else {
                    scrollToTopBtn.style.display = "none";
                }
            };

            scrollToTopBtn.addEventListener("click", function() {
                if (window.innerWidth >= 1024) {
                    scrollableContent.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });

            // Initial state setup
            loadingOverlay.style.display = 'flex';
            [formSection, dashboardSection, requestSection, weeklyPlanSection].forEach(sec => sec.classList.add('hidden'));
            [crmMainTabBtn, dashboardMainTabBtn, requestMainTabBtn, weeklyPlanMainTabBtn, crmMainTabBtnMobile, dashboardMainTabBtnMobile, requestMainTabBtnMobile, weeklyPlanMainTabBtnMobile].forEach(btn => btn.disabled = true);
        });
    </script>
</body>
</html>



