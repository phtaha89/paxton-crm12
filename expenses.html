<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paxton LLC Expenses Manager</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter for a modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Supabase CDN for database interaction -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Custom styles for mobile-first responsive layout */
        :root {
            --primary-blue-light: #f8fafc;
            --primary-blue-dark: #3b82f6;
            --primary-blue-darker: #2563eb;
            --text-color-dark: #1f2937;
            --text-color-light: #64748b;
            --white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --border-radius: 0.375rem;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--primary-blue-light);
            color: var(--text-color-dark);
            font-size: 14px;
        }

        /* Mobile-first typography */
        .text-mobile-xl { font-size: 1.125rem; }
        .text-mobile-lg { font-size: 1rem; }
        .text-mobile-base { font-size: 0.875rem; }
        .text-mobile-sm { font-size: 0.75rem; }
        .text-mobile-xs { font-size: 0.625rem; }

        /* Compact spacing */
        .p-mobile { padding: 0.75rem; }
        .px-mobile { padding-left: 0.75rem; padding-right: 0.75rem; }
        .py-mobile { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .m-mobile { margin: 0.5rem; }
        .mb-mobile { margin-bottom: 0.5rem; }
        .mt-mobile { margin-top: 0.5rem; }

        /* Mobile card styles */
        .mobile-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        /* Mobile button styles */
        .mobile-btn {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
        }

        /* Mobile input styles */
        .mobile-input {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            width: 100%;
        }
        .mobile-input:focus {
            outline: none;
            ring: 2px;
            ring-color: #2563eb;
            border-color: #2563eb;
        }

        /* Mobile table styles */
        .mobile-table {
            font-size: 0.75rem;
            overflow-x: auto;
        }
        .mobile-table th,
        .mobile-table td {
            padding: 0.5rem 0.75rem;
            white-space: nowrap;
        }

        /* Role selection cards - mobile optimized */
        .role-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.25rem;
            text-align: center;
            cursor: pointer;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease-in-out;
            margin-bottom: 1rem;
        }
        .role-card:hover {
            box-shadow: 0 4px 12px 0 rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        /* Icon sizing for mobile */
        .mobile-icon {
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.75rem;
            border-radius: 50%;
        }

        /* Modal responsive adjustments */
        .mobile-modal {
            margin: 1rem;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }

        /* Grid adjustments for mobile */
        .mobile-grid {
            display: grid;
            gap: 0.75rem;
        }

        @media (min-width: 640px) {
            .mobile-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .role-card {
                margin-bottom: 0;
            }
        }

        @media (min-width: 768px) {
            .mobile-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 1rem;
            }
            .mobile-card {
                padding: 1.25rem;
            }
            .mobile-btn {
                padding: 0.625rem 1rem;
                font-size: 0.875rem;
            }
        }

        /* Responsive table scrolling */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: var(--border-radius);
            border: 1px solid #e5e7eb;
        }

        /* Status badge mobile sizing */
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            text-align: center;
            min-width: fit-content;
        }

        /* Action buttons mobile sizing */
        .action-btn {
            padding: 0.375rem;
            font-size: 0.75rem;
            border-radius: 0.25rem;
            margin: 0 0.125rem;
        }

        /* Form layout mobile adjustments */
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.375rem;
        }

        /* Header adjustments */
        .page-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        /* Container adjustments */
        .container-mobile {
            padding: 0.75rem;
        }

        @media (min-width: 640px) {
            .container-mobile {
                padding: 1rem;
            }
        }

        @media (min-width: 1024px) {
            .container-mobile {
                padding: 1.5rem;
            }
        }
        #totalExpensesBox {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    padding: 1rem;
    margin-bottom: 1rem;
}

    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container-mobile max-w-7xl mx-auto">
        <!-- Role Selection Screen -->
        <div id="roleSelection" class="max-w-2xl mx-auto">
            <div class="text-center mb-6">
                <h1 class="text-mobile-xl font-bold text-gray-900 mb-1">Expense Manager</h1>
                <p class="text-mobile-sm text-gray-500">Paxton LLC</p>
            </div>
            <div class="mobile-grid">
                <!-- Add Expense Card -->
                <div id="add-expense-card" class="role-card">
                    <div class="mobile-icon bg-blue-100">
                        <i class="fas fa-plus text-blue-600 text-lg"></i>
                    </div>
                    <h3 class="text-mobile-lg font-semibold text-gray-900 mb-1">Add Expense</h3>
                    <p class="text-mobile-sm text-gray-500">Submit new expense</p>
                </div>
                <!-- Admin Panel Card -->
                <div id="admin-panel-card" class="role-card hidden">
                    <div class="mobile-icon bg-purple-100">
                        <i class="fas fa-user-shield text-purple-600 text-lg"></i>
                    </div>
                    <h3 class="text-mobile-lg font-semibold text-gray-900 mb-1">Admin Panel</h3>
                    <p class="text-mobile-sm text-gray-500">Manage reports</p>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="hidden">
            <!-- Add Expense View -->
            <div id="addExpenseView" class="hidden">
                <div class="page-header">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-mobile-xl font-bold text-gray-900">New Expense</h2>
                        </div>
                        <button onclick="goBackToRoleSelection()" class="mobile-btn bg-gray-100 text-gray-700 hover:bg-gray-200">
                            <i class="fas fa-arrow-left mr-1"></i>Back
                        </button>
                    </div>
                </div>
                <div class="mobile-card">
                    <div class="form-group">
                        <label for="employeeNameDropdown">Employee</label>
                        <select id="employeeNameDropdown" class="mobile-input">
                            <option value="">Select Employee</option>
                        </select>
                    </div>
                    <!-- Dynamic Forms will be injected here -->
                    <div id="dynamicFormContainer"></div>
                </div>
            </div>
           <!-- Admin View -->
<div id="adminView" class="hidden">
    <div class="page-header">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-mobile-xl font-bold text-gray-900">Dashboard</h2>
                <p class="text-mobile-sm text-gray-500">Expense reports</p>
            </div>
            <button onclick="goBackToRoleSelection()" class="mobile-btn bg-gray-100 text-gray-700 hover:bg-gray-200">
                <i class="fas fa-arrow-left mr-1"></i>Back
            </button>
        </div>
    </div>
    <div class="mobile-card">
        <!-- Filters - Mobile Stack -->
        <div class="mb-4">
            <h3 class="text-mobile-lg font-medium text-gray-900 mb-3">Filters</h3>
            <div class="space-y-3">
                <div class="form-group">
                    <label for="employeeFilter">Employee</label>
                    <select id="employeeFilter" class="mobile-input">
                        <option value="all">All Employees</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="statusFilter">Status</label>
                    <select id="statusFilter" class="mobile-input">
                        <option value="all">All Statuses</option>
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="monthFilter">Month</label>
                    <select id="monthFilter" class="mobile-input">
                        <option value="all">All Months</option>
                    </select>
                </div>
            </div>
        </div>
        <!-- Total Expenses Box -->
        <div id="totalExpensesBox" class="mobile-card mb-4">
            <div class="flex justify-between items-center">
                <span class="text-mobile-lg font-medium text-gray-900">Total Expenses:</span>
                <span id="totalExpensesValue" class="text-mobile-xl font-bold text-green-600">EGP 0.00</span>
            </div>
        </div>
        <!-- Reports Table -->
        <div class="table-container">
            <table class="w-full mobile-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="text-left text-mobile-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="text-left text-mobile-xs font-medium text-gray-500 uppercase">Employee</th>
                        <th class="text-left text-mobile-xs font-medium text-gray-500 uppercase">Role</th>
                        <th class="text-left text-mobile-xs font-medium text-gray-500 uppercase">Report Type</th>
                        <th class="text-left text-mobile-xs font-medium text-gray-500 uppercase hidden sm:table-cell">Manager</th>
                        <th class="text-right text-mobile-xs font-medium text-gray-500 uppercase">Amount (EGP)</th>
                        <th class="text-center text-mobile-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="text-center text-mobile-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody id="reportsTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- All reports will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>


    <!-- Message Modal -->
    <div id="messageModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="mobile-modal bg-white rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-mobile">
                <h3 id="messageModalTitle" class="text-mobile-lg font-semibold mb-2"></h3>
                <p id="messageModalBody" class="text-mobile-sm text-gray-600 mb-4"></p>
                <div id="messageModalActions" class="flex justify-end">
                    <button id="modalPrimaryBtn" onclick="hideMessage()" class="mobile-btn bg-blue-600 text-white hover:bg-blue-700">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Details Modal -->
    <div id="reportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 hidden z-50">
        <div class="mobile-modal bg-white rounded-lg shadow-xl w-full max-w-2xl">
            <div class="p-mobile border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-mobile-lg font-semibold">Expense Report Details</h2>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div id="modalBody" class="p-mobile">
                <!-- Content will be injected by JS -->
            </div>
            <div id="modalActions" class="p-mobile border-t border-gray-200">
                <div class="flex flex-col sm:flex-row gap-2 sm:justify-end">
                    <button id="approveBtn" onclick="updateStatus('Approved')" class="mobile-btn bg-green-600 text-white hover:bg-green-700 w-full sm:w-auto">
                        <i class="fas fa-check mr-1"></i>Approve
                    </button>
                    <button id="rejectBtn" onclick="updateStatus('Rejected')" class="mobile-btn bg-red-600 text-white hover:bg-red-700 w-full sm:w-auto">
                        <i class="fas fa-times mr-1"></i>Reject
                    </button>
                    <button onclick="closeModal()" class="mobile-btn bg-gray-100 text-gray-700 hover:bg-gray-200 w-full sm:w-auto">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Print Confirmation Modal (New) -->
    <div id="printConfirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="mobile-modal bg-white rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-mobile text-center">
                <h3 class="text-mobile-lg font-semibold mb-2">Print Options</h3>
                <p class="text-mobile-sm text-gray-600 mb-4">Choose print format</p>
                <div class="space-y-2">
                    <button onclick="printReport(activeReportRow, 'single'); hidePrintConfirmationModal();" class="mobile-btn bg-blue-600 text-white hover:bg-blue-700 w-full">
                        <i class="fas fa-print mr-1"></i>Single Report
                    </button>
                    <button onclick="showMonthlyReportOptions(activeReportRow); hidePrintConfirmationModal();" class="mobile-btn bg-blue-100 text-blue-700 hover:bg-blue-200 w-full">
                        <i class="fas fa-calendar mr-1"></i>Monthly Report
                    </button>
                    <button onclick="hidePrintConfirmationModal();" class="mobile-btn bg-gray-100 text-gray-700 hover:bg-gray-200 w-full">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Monthly Report Options Modal (New) -->
    <div id="monthlyReportOptionsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="mobile-modal bg-white rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-mobile">
                <div class="flex justify-between items-center border-b pb-2 mb-3">
                    <h2 class="text-mobile-lg font-semibold">Monthly Report</h2>
                    <button onclick="hideMonthlyReportOptionsModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="space-y-3">
                    <div class="form-group">
                        <label for="monthlyReportEmployeeSelect">Employee</label>
                        <select id="monthlyReportEmployeeSelect" class="mobile-input">
                            <option value="">Select Employee</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="monthlyReportMonthSelect">Month</label>
                        <select id="monthlyReportMonthSelect" class="mobile-input">
                            <option value="">Select Month</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 pt-3 border-t space-y-2">
                    <button onclick="generateMonthlyReport();" class="mobile-btn bg-blue-600 text-white hover:bg-blue-700 w-full">
                        <i class="fas fa-file-alt mr-1"></i>Generate
                    </button>
                    <button onclick="hideMonthlyReportOptionsModal()" class="mobile-btn bg-gray-100 text-gray-700 hover:bg-gray-200 w-full">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // --- SUPABASE SETUP ---
        const SUPABASE_URL = 'https://plmevfyxpngzymvzvkzn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBsbWV2Znl4cG5nenltdnp2a3puIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NjM5NDEsImV4cCI6MjA2NjMzOTk0MX0.lUm3efHFCL3aAB-PL7H54BpnvcpbXxp1BeUzw0yjp5c';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- DOM Elements ---
        const roleSelection = document.getElementById('roleSelection');
        const mainContent = document.getElementById('mainContent');
        const addExpenseView = document.getElementById('addExpenseView');
        const adminView = document.getElementById('adminView');
        const dynamicFormContainer = document.getElementById('dynamicFormContainer');
        const reportsTableBody = document.getElementById('reportsTableBody');
        const reportModal = document.getElementById('reportModal');
        const modalBody = document.getElementById('modalBody');
        const employeeNameDropdown = document.getElementById('employeeNameDropdown');
        const repTerritoryInput = document.getElementById('repTerritory');
        const directManagerInput = document.getElementById('directManager');
        const messageModal = document.getElementById('messageModal');
        const messageModalTitle = document.getElementById('messageModalTitle');
        const messageModalBody = document.getElementById('messageModalBody');
        const messageModalActions = document.getElementById('messageModalActions');
        const employeeFilterSelect = document.getElementById('employeeFilter');
        const statusFilterSelect = document.getElementById('statusFilter');
        const monthFilterSelect = document.getElementById('monthFilter');

        // New Print Modals
        const printConfirmationModal = document.getElementById('printConfirmationModal');
        const monthlyReportOptionsModal = document.getElementById('monthlyReportOptionsModal');
        const monthlyReportEmployeeSelect = document.getElementById('monthlyReportEmployeeSelect'); // Changed from ManagerSelect
        const monthlyReportMonthSelect = document.getElementById('monthlyReportMonthSelect');

        // --- State ---
        let managerExpenseCount = 0;
        let repExpenseCount = 0;
        let activeReportRow = null; // Stores the row element for the currently selected report
        let masterlistData = []; // To store fetched user data from Supabase 'masterlist' table
        let allReportsData = []; // Cache all reports for filtering
        let loggedInUser = null; // Stores user data received from parent frame

        // --- Data Definitions ---
        const governorates = [
            "Alexandria", "Aswan", "Asyut", "Beheira", "Beni Suef", "Cairo", "Dakahlia",
            "Damietta", "Faiyum", "Gharbia", "Giza", "Ismailia", "Kafr El Sheikh", "Luxor",
            "Matrouh", "Minya", "Monufia", "New Valley", "North Sinai", "Port Said",
            "Qalyubia", "Qena", "Red Sea", "Sharqia", "Sohag", "South Sinai", "Suez"
        ];
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        // Manager and rep now use different expense types as requested
        const repExpenseTypes = ['Own Car Travel', 'Public Transportation', 'Accommodations', 'Meal', 'Toll', 'Parking', 'Others'];
        const managerExpenseTypes = ['Own Car Travel', 'Public Transportation', 'Accommodations', 'Meal', 'Toll', 'Parking', 'Team meeting', 'Others'];

        // --- UI Logic ---
        function showView(view) {
            if (roleSelection) roleSelection.classList.add('hidden');
            if (mainContent) mainContent.classList.remove('hidden');
            if (addExpenseView) addExpenseView.classList.add('hidden');
            if (adminView) adminView.classList.add('hidden');

            if (view === 'addExpense') {
                if (addExpenseView) addExpenseView.classList.remove('hidden');
                prefillAndLockForm(loggedInUser);
            } else if (view === 'admin') {
                currentUserRole = 'admin';
                if (adminView) adminView.classList.remove('hidden');
                retrieveAllReports();
            }
        }

        function goBackToRoleSelection() {
            if (mainContent) mainContent.classList.add('hidden');
            if (roleSelection) roleSelection.classList.remove('hidden');
            currentUserRole = null;
        }

        // --- Dynamic Form Logic ---
        function createManagerForm() {
            return `
                <form id="managerExpenseForm" class="space-y-3">
                    <input type="hidden" name="employeeRole" value="District Manager">
                    <!-- Tab Navigation -->
                    <div class="border-b border-gray-200 mb-4">
                        <nav class="flex space-x-2 text-mobile-sm">
                            <button id="managerAddTab" type="button" class="tab-active py-2 px-1 border-b-2 font-medium" onclick="showTab('District Manager', 'add')">
                                Submit Report
                            </button>
                            <button id="managerViewTab" type="button" class="py-2 px-1 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700" onclick="showTab('District Manager', 'view')">
                                My Reports
                            </button>
                            <button id="managerTeamTab" type="button" class="py-2 px-1 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700" onclick="showTab('District Manager', 'team')">
                                Team Reports
                            </button>
                        </nav>
                    </div>
                    <!-- Add Report Tab Content -->
                    <div id="managerAddContent">
                        <div class="mobile-grid">
                            <div class="form-group">
                                <label for="reportType">Report Type</label>
                                <select id="reportType" name="reportType" class="mobile-input" onchange="handleReportTypeChange(this)">
                                    <option value="Trip">Trip Report</option>
                                    <option value="Others">Other Expenses</option>
                                </select>
                            </div>
                        </div>
                        <!-- Trip Details -->
                        <div id="tripDetails" class="mobile-card mt-3">
                            <h3 class="text-mobile-lg font-medium text-gray-900 mb-3">Trip Information</h3>
                            <div class="mobile-grid">
                                <div class="form-group">
                                    <label for="tripPurpose">Purpose of Trip</label>
                                    <input type="text" id="tripPurpose" name="tripPurpose" class="mobile-input" placeholder="e.g., Regional Meeting" required>
                                </div>
                                <div class="form-group">
                                    <label for="travelDate">Date of Travel</label>
                                    <input type="date" id="travelDate" name="travelDate" class="mobile-input" required>
                                </div>
                                <div class="form-group">
                                    <label for="fromGovernorate">From (Governorate)</label>
                                    <select id="fromGovernorate" name="fromGovernorate" class="mobile-input" required>
                                        <option value="">Select Governorate</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="toGovernorate">To (Governorate)</label>
                                    <select id="toGovernorate" name="toGovernorate" class="mobile-input" required>
                                        <option value="">Select Governorate</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <!-- Other Expenses Date -->
                        <div id="otherDate" class="hidden mt-3 form-group">
                            <label for="otherDateInput">Date of Expense</label>
                            <input type="date" id="otherDateInput" name="otherDateInput" class="mobile-input">
                        </div>
                        <!-- Expenses Section -->
                        <div class="mt-4">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-mobile-lg font-medium text-gray-900">Expense Items</h3>
                                <button type="button" onclick="addExpense('District Manager')" class="mobile-btn bg-blue-600 text-white hover:bg-blue-700">
                                    <i class="fas fa-plus mr-1"></i>Add Item
                                </button>
                            </div>
                            <div id="managerExpensesContainer" class="space-y-2">
                                <!-- Expense items will be added here -->
                            </div>
                        </div>
                        <!-- Total -->
                        <div class="mobile-card mt-4">
                            <div class="flex justify-between items-center">
                                <span class="text-mobile-lg font-medium text-gray-900">Total Amount:</span>
                                <input type="text" id="managerTotal" readonly class="text-right text-mobile-xl font-bold bg-transparent border-none outline-none text-green-600">
                            </div>
                        </div>
                        <!-- Submit Button -->
                        <div class="flex justify-end mt-4">
                            <button type="submit" class="mobile-btn bg-blue-600 text-white hover:bg-blue-700 px-4 py-2">
                                Submit Report
                            </button>
                        </div>
                    </div>
                    <!-- View Reports Tab Content -->
                    <div id="managerViewContent" class="hidden">
                        <div class="mobile-card">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-mobile-lg font-medium text-gray-900">My Submitted Reports</h3>
                                <button onclick="retrieveMyReports('District Manager', employeeNameDropdown.value)" class="mobile-btn bg-gray-100 text-gray-700 hover:bg-gray-200" title="Refresh">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                            <div class="table-container">
                                <table class="w-full mobile-table">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="text-left text-mobile-xs font-medium text-gray-500 uppercase">Date</th>
                                            <th class="text-left text-mobile-xs font-medium text-gray-500 uppercase">Report Type</th>
                                            <th class="text-right text-mobile-xs font-medium text-gray-500 uppercase">Amount</th>
                                            <th class="text-center text-mobile-xs font-medium text-gray-500 uppercase">Status</th>
                                            <th class="text-center text-mobile-xs font-medium text-gray-500 uppercase">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="myManagerReportsTableBody" class="bg-white divide-y divide-gray-200">
                                        <!-- Reports will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- Team Reports Tab Content -->
                    <div id="managerTeamContent" class="hidden">
                        <div class="mobile-card">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-mobile-lg font-medium text-gray-900">Team Reports</h3>
                                <button onclick="retrieveMyTeamReports(employeeNameDropdown.value)" class="mobile-btn bg-gray-100 text-gray-700 hover:bg-gray-200" title="Refresh">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                            <div class="table-container">
                                <table class="w-full mobile-table">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="text-left text-mobile-xs font-medium text-gray-500 uppercase">Date</th>
                                            <th class="text-left text-mobile-xs font-medium text-gray-500 uppercase">Employee</th>
                                            <th class="text-left text-mobile-xs font-medium text-gray-500 uppercase">Report Type</th>
                                            <th class="text-right text-mobile-xs font-medium text-gray-500 uppercase">Amount</th>
                                            <th class="text-center text-mobile-xs font-medium text-gray-500 uppercase">Status</th>
                                            <th class="text-center text-mobile-xs font-medium text-gray-500 uppercase">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="myTeamReportsTableBody" class="bg-white divide-y divide-gray-200">
                                        <!-- Team reports will be loaded here -->
                                    </tbody>
                                </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </form>
            `;
        }
        
        function createMedicalRepForm() {
            return `
                <form id="medicalRepExpenseForm" class="space-y-3">
                    <input type="hidden" name="employeeRole" value="Medical Representative">
                    <!-- Tab Navigation -->
                    <div class="border-b border-gray-200 mb-4">
                        <nav class="flex space-x-2 text-mobile-sm">
                            <button id="repAddTab" type="button" class="tab-active py-2 px-1 border-b-2 font-medium" onclick="showTab('Medical Representative', 'add')">
                                Submit Log
                            </button>
                            <button id="repViewTab" type="button" class="py-2 px-1 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700" onclick="showTab('Medical Representative', 'view')">
                                My Logs
                            </button>
                        </nav>
                    </div>
                    <!-- Add Log Tab Content -->
                    <div id="repAddContent">
                        <!-- Basic Information -->
                        <div class="mobile-grid">
                            <div class="form-group">
                                <label for="repDate">Date</label>
                                <input type="date" id="repDate" name="repDate" class="mobile-input" required>
                            </div>
                            <div class="form-group">
                                <label for="directManager">Direct Manager</label>
                                <input type="text" id="directManager" name="directManager" readonly class="mobile-input bg-gray-50">
                            </div>
                            <div class="form-group">
                                <label for="repTerritory">Territory / Area</label>
                                <input type="text" id="repTerritory" name="repTerritory" readonly class="mobile-input bg-gray-50">
                            </div>
                        </div>
                        <!-- Expenses Section -->
                        <div class="mt-4">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-mobile-lg font-medium text-gray-900">Expense Items</h3>
                                <button type="button" onclick="addExpense('Medical Representative')" class="mobile-btn bg-green-600 text-white hover:bg-green-700">
                                    <i class="fas fa-plus mr-1"></i>Add Item
                                </button>
                            </div>
                            <div id="repExpensesContainer" class="space-y-2">
                                <!-- Expense items will be added here -->
                            </div>
                        </div>
                        <!-- Total -->
                        <div class="mobile-card mt-4">
                            <div class="flex justify-between items-center">
                                <span class="text-mobile-lg font-medium text-gray-900">Total Daily Expenses:</span>
                                <input type="text" id="repTotal" readonly class="text-right text-mobile-xl font-bold bg-transparent border-none outline-none text-green-600">
                            </div>
                        </div>
                        <!-- Submit Button -->
                        <div class="flex justify-end mt-4">
                            <button type="submit" class="mobile-btn bg-green-600 text-white hover:bg-green-700 px-4 py-2">
                                Submit Daily Log
                            </button>
                        </div>
                    </div>
                    <!-- View Logs Tab Content -->
                    <div id="repViewContent" class="hidden">
                        <div class="mobile-card">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-mobile-lg font-medium text-gray-900">My Submitted Logs</h3>
                                <button onclick="retrieveMyReports('Medical Representative', employeeNameDropdown.value)" class="mobile-btn bg-gray-100 text-gray-700 hover:bg-gray-200" title="Refresh">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                            <div class="table-container">
                                <table class="w-full mobile-table">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="text-left text-mobile-xs font-medium text-gray-500 uppercase">Date</th>
                                            <th class="text-left text-mobile-xs font-medium text-gray-500 uppercase">Report Type</th>
                                            <th class="text-right text-mobile-xs font-medium text-gray-500 uppercase">Amount</th>
                                            <th class="text-center text-mobile-xs font-medium text-gray-500 uppercase">Status</th>
                                            <th class="text-center text-mobile-xs font-medium text-gray-500 uppercase">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="myRepReportsTableBody" class="bg-white divide-y divide-gray-200">
                                        <!-- Reports will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </form>
            `;
        }
        
        function showTab(role, tabType) {
            const addContent = document.getElementById(role === 'District Manager' ? 'managerAddContent' : 'repAddContent');
            const viewContent = document.getElementById(role === 'District Manager' ? 'managerViewContent' : 'repViewContent');
            const teamContent = document.getElementById(role === 'District Manager' ? 'managerTeamContent' : null);
            
            const addTabBtn = document.getElementById(role === 'District Manager' ? 'managerAddTab' : 'repAddTab');
            const viewTabBtn = document.getElementById(role === 'District Manager' ? 'managerViewTab' : 'repViewTab');
            const teamTabBtn = document.getElementById(role === 'District Manager' ? 'managerTeamTab' : null);

            // Hide all content and reset all tabs
            if (addContent) addContent.classList.add('hidden');
            if (viewContent) viewContent.classList.add('hidden');
            if (teamContent) teamContent.classList.add('hidden');
            if (addTabBtn) addTabBtn.classList.remove('tab-active');
            if (viewTabBtn) viewTabBtn.classList.remove('tab-active');
            if (teamTabBtn) teamTabBtn.classList.remove('tab-active');

            if (tabType === 'add') {
                if (addContent) addContent.classList.remove('hidden');
                if (addTabBtn) addTabBtn.classList.add('tab-active');
            } else if (tabType === 'view') {
                if (viewContent) viewContent.classList.remove('hidden');
                if (viewTabBtn) viewTabBtn.classList.add('tab-active');
                if (employeeNameDropdown.value) {
                    retrieveMyReports(role, employeeNameDropdown.value);
                }
            } else if (tabType === 'team' && role === 'District Manager') {
                if (teamContent) teamContent.classList.remove('hidden');
                if (teamTabBtn) teamTabBtn.classList.add('tab-active');
                if (employeeNameDropdown.value) {
                    retrieveMyTeamReports(employeeNameDropdown.value);
                }
            }
        }

        function handleExpenseTypeChange(selectElement) {
            const row = selectElement.closest('.expense-row');
            const descriptionInput = row.querySelector('input[name^="expenseDesc"]');
            const amountInput = row.querySelector('input[name^="expenseAmount"]');

            if (!descriptionInput || !amountInput) return;
            
            // Set required based on selection
            if (selectElement.value === 'Others') {
                descriptionInput.required = true;
                descriptionInput.placeholder = 'Description (required)';
            } else {
                descriptionInput.required = false;
                descriptionInput.placeholder = 'Description (optional)';
            }
            
            // Handle 'Own Car Travel' specific logic
            if (selectElement.value === 'Own Car Travel') {
                descriptionInput.type = 'number';
                descriptionInput.placeholder = 'KM Travelled';
                amountInput.readOnly = true;
                amountInput.classList.add('bg-gray-100');
                
                descriptionInput.addEventListener('input', () => {
                    const km = parseFloat(descriptionInput.value) || 0;
                    const worth = km * 1.7; // Fixed rate per KM
                    amountInput.value = worth.toFixed(2);
                    const formId = selectElement.closest('form').id;
                    const containerId = formId === 'managerExpenseForm' ? 'managerExpensesContainer' : 'repExpensesContainer';
                    const totalId = formId === 'managerExpenseForm' ? 'managerTotal' : 'repTotal';
                    updateTotal(document.getElementById(containerId), totalId);
                });
            } else {
                // Restore default for other types
                descriptionInput.type = 'text';
                amountInput.readOnly = false;
                amountInput.classList.remove('bg-gray-100');
            }

            const formId = selectElement.closest('form').id;
            const containerId = formId === 'managerExpenseForm' ? 'managerExpensesContainer' : 'repExpensesContainer';
            const totalId = formId === 'managerExpenseForm' ? 'managerTotal' : 'repTotal';
            updateTotal(document.getElementById(containerId), totalId);
        }
        
        function addExpense(role) {
            const containerId = role === 'District Manager' ? 'managerExpensesContainer' : 'repExpensesContainer';
            const container = document.getElementById(containerId);
            const expenseTypesList = role === 'District Manager' ? managerExpenseTypes : repExpenseTypes;
            const newId = role === 'District Manager' ? ++managerExpenseCount : ++repExpenseCount;
            
            if (!container) return;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-12 gap-3 border border-gray-200 p-3 rounded-lg bg-gray-50/50 expense-row';
            div.id = `expense-row-${containerId}-${newId}`;
            const optionsHtml = expenseTypesList.map(opt => `<option>${opt}</option>`).join('');
            div.innerHTML = `
                <div class="md:col-span-4"><select name="expenseType-${newId}" required class="mobile-input" onchange="handleExpenseTypeChange(this)"><option value="">Select Expense Type</option>${optionsHtml}</select></div>
                <div class="md:col-span-5"><input type="text" name="expenseDesc-${newId}" placeholder="Description (optional)" class="mobile-input"></div>
                <div class="md:col-span-2"><input type="number" name="expenseAmount-${newId}" min="0" step="0.01" required placeholder="EGP" class="mobile-input expense-amount"></div>
                <div class="md:col-span-1 flex items-center justify-center"><button type="button" onclick="removeExpenseRow('expense-row-${containerId}-${newId}', '${containerId}')" class="p-2 text-red-500 hover:bg-red-100 rounded-full transition"><i class="fas fa-trash-alt"></i></button></div>`;
            container.appendChild(div);
            
            const selectEl = div.querySelector('select');
            const amountInput = div.querySelector('.expense-amount');
            
            if (selectEl) {
                selectEl.addEventListener('change', () => {
                    handleExpenseTypeChange(selectEl);
                });
            }
            if (amountInput) {
                amountInput.addEventListener('input', () => {
                    updateTotal(container, container.id === 'managerExpensesContainer' ? 'managerTotal' : 'repTotal');
                });
            }
        }
        
        function removeExpenseRow(rowId, containerId) {
            const rowElement = document.getElementById(rowId);
            if(rowElement) rowElement.remove();
            const container = document.getElementById(containerId);
            if (container) updateTotal(container, containerId === 'managerExpensesContainer' ? 'managerTotal' : 'repTotal');
        }

        function updateTotal(container, totalElId) {
            const amounts = container.querySelectorAll('.expense-amount');
            const total = Array.from(amounts).reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
            const totalElement = document.getElementById(totalElId);
            if (totalElement) totalElement.value = `EGP ${total.toFixed(2)}`;
        }

        function resetForm(form, container, role) {
            if (!form || !container) return;
            form.reset();
            container.innerHTML = '';
            if (role === 'District Manager') {
                managerExpenseCount = 0;
            } else {
                repExpenseCount = 0;
            }
            setDefaultDates();
        }
        
        function getStatusBadge(status) {
            if (status === 'Approved') return `<span class="status-badge bg-green-100 text-green-800">Approved</span>`;
            if (status === 'Rejected') return `<span class="status-badge bg-red-100 text-red-800">Rejected</span>`;
            return `<span class="status-badge bg-yellow-100 text-yellow-800">Pending</span>`;
        }
        
        // Helper function to get the formatted report type string
        function getReportTypeDisplayString(report) {
            const items = JSON.parse(report.items);
            const firstItem = items.length > 0 ? items[0] : null;
            const details = JSON.parse(report.details);

            if (report.role === 'District Manager') {
                if (details.reportType === 'Trip') {
                    return `Trip Report (${details.purpose})`;
                } else {
                    const firstItemType = firstItem ? firstItem.type : 'N/A';
                    const description = firstItem && firstItem.desc ? firstItem.desc : 'No description';
                    return `Other Expenses (${firstItemType === 'Others' ? description : firstItemType})`;
                }
            } else { // Medical Rep
                const firstItemType = firstItem ? firstItem.type : 'N/A';
                const description = firstItem && firstItem.desc ? firstItem.desc : 'No description';
                if (firstItemType === 'Others') {
                    return `Other Expenses (${description})`;
                } else {
                    return firstItemType;
                }
            }
        }

        // --- Message Modal Logic ---
        function showMessage(title, body, customButtons = null) {
            if (!messageModalTitle || !messageModalBody || !messageModal || !messageModalActions) {
                console.error("Message modal elements not found.");
                return;
            }
            messageModalTitle.textContent = title;
            messageModalBody.textContent = body;
            messageModal.classList.remove('hidden');
            setTimeout(() => { messageModal.classList.remove('opacity-0'); }, 10);

            messageModalActions.innerHTML = '';
            if (customButtons) {
                customButtons.forEach(btn => {
                    const buttonElement = document.createElement('button');
                    buttonElement.textContent = btn.text;
                    buttonElement.onclick = btn.onClick;
                    buttonElement.className = btn.className;
                    messageModalActions.appendChild(buttonElement);
                });
            } else {
                messageModalActions.innerHTML = `<button onclick="hideMessage()" class="mobile-btn bg-blue-600 text-white hover:bg-blue-700">OK</button>`;
            }
        }

        function hideMessage() {
            if (messageModal) {
                messageModal.classList.add('opacity-0');
                setTimeout(() => { messageModal.classList.add('hidden'); }, 300);
            }
        }

        // --- Report Details Modal Logic ---
        function showReportDetails(rowElement) {
            activeReportRow = rowElement;
            const data = rowElement.dataset;
            const items = JSON.parse(data.items);
            const details = JSON.parse(data.details);
            if (!modalBody || !reportModal) return;
            
            let reportTypeDisplay = '';
            if (data.role === 'District Manager') {
                if (details.reportType === 'Trip') {
                    reportTypeDisplay = `Trip Report (${details.purpose})`;
                } else if (details.reportType === 'Others') {
                    const firstItem = items.length > 0 ? items[0] : null;
                    const description = firstItem && firstItem.desc ? firstItem.desc : 'No description';
                    reportTypeDisplay = `Other Expenses (${description})`;
                }
            } else { // Medical Rep
                const firstItem = items.length > 0 ? items[0] : null;
                if (firstItem && firstItem.type === 'Others') {
                   const description = firstItem.desc ? firstItem.desc : 'No description';
                   reportTypeDisplay = `Other Expenses (${description})`;
                } else if (firstItem) {
                   reportTypeDisplay = firstItem.type;
                } else {
                   reportTypeDisplay = 'No Expense Items';
                }
            }

            let detailsHtml = `
                <div class="space-y-3">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-mobile-sm">
                        <div><strong class="font-bold text-gray-700">Employee:</strong> <p class="text-gray-900">${data.name}</p></div>
                        <div><strong class="font-bold text-gray-700">Role:</strong> <p class="text-gray-900">${data.role}</p></div>
                        <div><strong class="font-bold text-gray-700">Date:</strong> <p class="text-gray-900">${data.date}</p></div>
                        <div><strong class="font-bold text-gray-700">Total:</strong> <p class="text-gray-900">${parseFloat(data.total).toFixed(2)} EGP</p></div>
                        <div class="col-span-full"><strong class="font-bold text-gray-700">Report Type:</strong> <p class="text-gray-900">${reportTypeDisplay}</p></div>
                        ${data.role === 'District Manager' ?
                            (details.reportType === 'Trip' ?
                                `<div class="sm:col-span-2"><strong class="font-bold text-gray-700">Purpose:</strong> <p class="text-gray-900">${details.purpose}</p></div>
                                 <div><strong class="font-bold text-gray-700">From:</strong> <p class="text-gray-900">${details.from}</p></div>
                                 <div><strong class="font-bold text-gray-700">To:</strong> <p class="text-gray-900">${details.to}</p></div>`
                                : '')
                            :
                            `<div class="sm:col-span-2"><strong class="font-bold text-gray-700">Territory:</strong> <p class="text-gray-900">${details.territory}</p></div>
                             <div><strong class="font-bold text-gray-700">Direct Manager:</strong> <p class="text-gray-900">${details.manager}</p></div>`
                        }
                    </div>
                    <h4 class="text-mobile-lg font-semibold text-gray-700 mt-4 mb-2">Expense Items</h4>
                    <div class="table-container">
                        <table class="w-full mobile-table">
                            <thead class="bg-gray-50"><tr>
                                <th class="text-left text-mobile-xs font-medium text-gray-500 uppercase">Type</th>
                                <th class="text-left text-mobile-xs font-medium text-gray-500 uppercase">Description</th>
                                <th class="text-right text-mobile-xs font-medium text-gray-500 uppercase">Amount (EGP)</th>
                            </tr></thead>
                            <tbody class="bg-white divide-y divide-gray-200">`;
            items.forEach(item => {
                detailsHtml += `<tr class="hover:bg-gray-50">
                                <td>${item.type}</td>
                                <td>${item.desc || 'N/A'}</td>
                                <td class="text-right">${parseFloat(item.amount).toFixed(2)}</td>
                            </tr>`;
            });
            detailsHtml += `
                                <tr class="font-bold bg-gray-50">
                                    <td colspan="2" class="text-right">Total:</td>
                                    <td class="text-right">${parseFloat(data.total).toFixed(2)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>`;
            
            modalBody.innerHTML = detailsHtml;
            reportModal.classList.remove('hidden');
            setTimeout(() => {
                reportModal.classList.remove('opacity-0');
            }, 10);

            // Hide/show approve/reject buttons based on who can approve
            const approveBtn = document.getElementById('approveBtn');
            const rejectBtn = document.getElementById('rejectBtn');
            const isFromTeamReports = rowElement.closest('#myTeamReportsTableBody') !== null;
            
            const showApproveReject = loggedInUser && (loggedInUser.title === 'admin' || (loggedInUser.title === 'District Manager' && isFromTeamReports));

            if (showApproveReject) {
                approveBtn.classList.remove('hidden');
                rejectBtn.classList.remove('hidden');
            } else {
                approveBtn.classList.add('hidden');
                rejectBtn.classList.add('hidden');
            }
        }

        function closeModal() {
            if (reportModal) {
                reportModal.classList.add('opacity-0');
                setTimeout(() => {
                    reportModal.classList.add('hidden');
                    activeReportRow = null;
                }, 300);
            }
        }
        
        async function deleteReport(rowElement) {
            const reportId = rowElement.dataset.id;
            if (!reportId) {
                showMessage("Error", "Could not find report ID to delete.");
                return;
            }

            showMessage(
                "Confirm Deletion",
                "Are you sure you want to delete this report? This action cannot be undone.",
                [
                    {
                        text: "Cancel",
                        onClick: () => hideMessage(),
                        className: "mobile-btn bg-gray-100 text-gray-700 hover:bg-gray-200"
                    },
                    {
                        text: "Delete",
                        onClick: async () => {
                            try {
                                const { error } = await supabase
                                    .from('expenses')
                                    .delete()
                                    .eq('id', reportId);

                                if (error) throw error;
                                
                                // Remove row from the DOM
                                if(rowElement) rowElement.remove();
                                // Remove from cached data as well
                                allReportsData = allReportsData.filter(report => report.id != reportId);
                                showMessage("Success", "Report deleted successfully.");
                            } catch (error) {
                                console.error('Error deleting report:', error);
                                showMessage("Error", "Failed to delete report. Please try again.");
                            } finally {
                                hideMessage();
                            }
                        },
                        className: "mobile-btn bg-red-600 text-white hover:bg-red-700"
                    }
                ]
            );
        }

        // --- admin/Manager status update logic ---
        async function updateStatus(newStatus) {
    if (!activeReportRow) return;

    const reportId = activeReportRow.dataset.id;
    const oldStatus = activeReportRow.dataset.status;

    const { error } = await supabase
        .from('expenses')
        .update({ status: newStatus })
        .eq('id', reportId);

    if (error) {
        console.error('Error updating status:', error);
        showMessage("Error", "Failed to update report status.");
        return;
    }

    const statusCell = activeReportRow.querySelector('.status-cell');
    if (statusCell) {
        statusCell.innerHTML = getStatusBadge(newStatus);
    }

    activeReportRow.dataset.status = newStatus;

    // Recalculate the total for the current filter
    filterReports();

    closeModal();
    showMessage("Success", `Report status updated to '${newStatus}'.`);
}



        // --- Print Modals and Logic (New) ---
        function showPrintConfirmation(rowElement) {
            activeReportRow = rowElement; // Store the row element for later use
            if (printConfirmationModal) {
                printConfirmationModal.classList.remove('hidden');
                setTimeout(() => { printConfirmationModal.classList.remove('opacity-0'); }, 10);
            }
        }

        function hidePrintConfirmationModal() {
            if (printConfirmationModal) {
                printConfirmationModal.classList.add('opacity-0');
                setTimeout(() => { printConfirmationModal.classList.add('hidden'); }, 300);
            }
        }

        function showMonthlyReportOptions(rowElement) {
            // Pre-fill employee and month if possible from the clicked report
            if (rowElement && monthlyReportMonthSelect && monthlyReportEmployeeSelect) {
                const reportDate = new Date(rowElement.dataset.date);
                const reportMonth = (reportDate.getMonth() + 1).toString().padStart(2, '0');
                monthlyReportMonthSelect.value = reportMonth;

                const employeeName = rowElement.dataset.name;
                monthlyReportEmployeeSelect.value = employeeName;
            }

            if (monthlyReportOptionsModal) {
                monthlyReportOptionsModal.classList.remove('hidden');
                setTimeout(() => { monthlyReportOptionsModal.classList.remove('opacity-0'); }, 10);
            }
        }

        function hideMonthlyReportOptionsModal() {
            if (monthlyReportOptionsModal) {
                monthlyReportOptionsModal.classList.add('opacity-0');
                setTimeout(() => { monthlyReportOptionsModal.classList.add('hidden'); }, 300);
            }
        }

        function isDateInMonthlyReportRange(reportDate, selectedMonth, selectedYear) {
            const dayOfMonth = reportDate.getDate();
            const month = reportDate.getMonth() + 1;
            const year = reportDate.getFullYear();

            // Handle year transition (e.g., from December to January)
            let prevMonth = selectedMonth - 1;
            let prevYear = selectedYear;
            if (prevMonth === 0) {
                prevMonth = 12;
                prevYear = selectedYear - 1;
            }

            const startRange = new Date(prevYear, prevMonth - 1, 25);
            const endRange = new Date(selectedYear, selectedMonth - 1, 25);
            endRange.setHours(23, 59, 59, 999); // Include the whole day

            return reportDate >= startRange && reportDate <= endRange;
        }

        async function generateMonthlyReport() {
    const employeeName = monthlyReportEmployeeSelect.value;
    const monthValue = monthlyReportMonthSelect.value;
    if (!employeeName || !monthValue) {
        showMessage("Missing Information", "Please select both an employee and a month to generate the monthly report.");
        return;
    }
    hideMonthlyReportOptionsModal();
    showMessage("Generating Report", "Please wait while we prepare your monthly report...", null);
    try {
        const { data: reports, error } = await supabase
            .from('expenses')
            .select('*')
            .eq('employee_name', employeeName)
            .order('report_date', { ascending: true });
        if (error) throw error;

        const today = new Date();
        const currentYear = today.getFullYear();
        const selectedMonth = parseInt(monthValue);

        // Filter out reports with status "Rejected"
        const allRelevantReports = reports.filter(report => {
            const reportDate = new Date(report.report_date);
            return (
                isDateInMonthlyReportRange(reportDate, selectedMonth, currentYear) &&
                report.status !== "Rejected"
            );
        });

        if (allRelevantReports.length === 0) {
            showMessage("No Reports Found", `No reports found for ${employeeName} in the selected period.`);
            return;
        }
        let totalMonthlyExpenses = 0;
        let reportTableRows = '';

        allRelevantReports.forEach(report => {
            totalMonthlyExpenses += parseFloat(report.total_amount);
            const reportTypeDisplay = getReportTypeDisplayString(report);
            const items = JSON.parse(report.items);
            const status = report.status;
            const reportDetails = JSON.parse(report.details);
            let tripDetailsHtml = '';
            if (report.role === 'District Manager' && reportDetails.reportType === 'Trip') {
                tripDetailsHtml += `
                    <p style="margin:0.25rem 0;"><strong>Purpose:</strong> ${reportDetails.purpose}</p>
                    <p style="margin:0.25rem 0;"><strong>Trip:</strong> ${reportDetails.from} to ${reportDetails.to}</p>
                `;
            }
            let expenseItemsHtml = items.map(item => `
                <tr>
                    <td class="pr-2 align-top">${item.type}:</td>
                    <td class="pr-2 align-top">${item.desc || 'N/A'}</td>
                    <td class="text-right align-top">${parseFloat(item.amount).toFixed(2)} EGP</td>
                </tr>
            `).join('');
            reportTableRows += `
                <tr class="border-b border-gray-200">
                    <td class="py-1 px-2 align-top font-bold">${report.report_date}</td>
                    <td class="py-1 px-2 align-top">${reportTypeDisplay}</td>
                    <td class="py-1 px-2 align-top">
                        ${tripDetailsHtml}
                        <table style="width:100%; font-size: 0.7rem;">
                            ${expenseItemsHtml}
                        </table>
                    </td>
                    <td class="py-1 px-2 text-right align-top">${parseFloat(report.total_amount).toFixed(2)}</td>
                    <td class="py-1 px-2 text-center align-top">${status}</td>
                </tr>
            `;
        });
        const monthlyReportHtml = `
            <html>
                <head>
                    <title>Monthly Expense Report - ${employeeName} - ${months[selectedMonth - 1]}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Inter', sans-serif; color: #111827; margin: 0.5rem; font-size: 11px; }
                        .header { text-align: center; margin-bottom: 1rem; }
                        .header img { height: 2.5rem; margin-bottom: 0.25rem; border-radius: 50%; }
                        .header h1 { font-size: 1.2rem; font-weight: 700; color: #1e3a8a; margin: 0; }
                        .header p { font-size: 0.8rem; color: #6b7280; margin: 0.25rem 0 0 0; }
                        .report-details { margin-bottom: 0.75rem; }
                        .report-details h2 { font-size: 1rem; margin-bottom: 0.25rem; }
                        .report-details p { font-size: 0.75rem; }
                        .report-table { width: 100%; border-collapse: collapse; }
                        .report-table th, .report-table td { padding: 0.2rem; border: 1px solid #e5e7eb; }
                        .report-table th { background-color: #f1f5f9; text-align: left; }
                        .report-table tr:nth-child(even) { background-color: #f9fafb; }
                        .summary { margin-top: 0.75rem; text-align: right; font-size: 12px; font-weight: 600; }
                        .signatures { margin-top: 2rem; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; font-size: 11px; }
                        .signatures div { border-top: 1px solid #374151; padding-top: 0.25rem; }
                        @media print { .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <img src="https://i.ibb.co/ZRmVjNch/logo.jpg" alt="Paxton Logo">
                        <h1>Monthly Expense Report</h1>
                        <p>Paxton LLC</p>
                    </div>
                    <div class="report-details">
                        <h2>Employee: ${employeeName}</h2>
                        <p>Report Period: 25th ${months[selectedMonth === 1 ? 11 : selectedMonth - 2]} to 25th ${months[selectedMonth - 1]}</p>
                    </div>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Report Type</th>
                                <th>Details</th>
                                <th class="text-right">Total (EGP)</th>
                                <th class="text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportTableRows}
                        </tbody>
                    </table>
                    <div class="summary">
                        <p>Grand Total: EGP ${totalMonthlyExpenses.toFixed(2)}</p>
                    </div>
                    <div class="signatures">
                        <div>
                            <p><strong>Direct Manager</strong></p>
                            <p class="font-light text-gray-500">Signature & Date</p>
                        </div>
                        <div>
                            <p><strong>Commercial Director</strong></p>
                            <p class="font-light text-gray-500">Signature & Date</p>
                        </div>
                    </div>
                    <div class="no-print" style="text-align: center; margin-top: 2rem;">
                        <button onclick="window.print()" style="background-color: #3b82f6; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 1rem;">Print Report</button>
                    </div>
                </body>
            </html>
        `;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(monthlyReportHtml);
        printWindow.document.close();
        printWindow.focus();
        hideMessage();
    } catch (error) {
        console.error('Error generating monthly report:', error);
        showMessage("Error", "Failed to generate monthly report. Please try again.");
    }
}


        function printReport(rowElement, printType) {
            if (printType === 'single') {
                const data = rowElement.dataset;
                const items = JSON.parse(data.items);
                const details = JSON.parse(data.details);
                const statusCell = rowElement.querySelector('.status-cell');
                const status = statusCell ? statusCell.textContent.trim() : 'N/A';
                const reportTypeDisplay = getReportTypeDisplayString(data);


                let detailsHtml = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; font-size: 14px;">
                        <p><strong>Employee:</strong> ${data.name}</p>
                        <p><strong>Role:</strong> ${data.role}</p>
                        <p><strong>Date:</strong> ${data.date}</p>
                        <p><strong>Report Type:</strong> ${reportTypeDisplay}</p>
                        ${data.role === 'District Manager' && details.reportType === 'Trip' ? `<p><strong>From:</strong> ${details.from}</p>
                                                                                              <p><strong>To:</strong> ${details.to}</p>
                                                                                              <p style="grid-column: span 2;"><strong>Purpose:</strong> ${details.purpose}</p>` : ''}
                        ${data.role === 'Medical Representative' ? `<p><strong>Territory:</strong> ${details.territory}</p>
                                                   <p><strong>Direct Manager:</strong> ${details.manager}</p>` : ''}
                    </div>`;

                let itemsHtml = `
                    <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">Expense Items</h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <thead><tr style="text-align: left; background-color: #f9fafb;">
                            <th style="padding: 0.5rem; border: 1px solid #e5e7eb;">Type</th>
                            <th style="padding: 0.5rem; border: 1px solid #e5e7eb;">Description</th>
                            <th style="padding: 0.5rem; border: 1px solid #e5e7eb; text-align: right;">Amount (EGP)</th>
                        </tr></thead><tbody>`;
                items.forEach(item => {
                    itemsHtml += `<tr>
                                   <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">${item.type}</td>
                                   <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">${item.desc || 'N/A'}</td>
                                   <td style="padding: 0.5rem; border: 1px solid #e5e7eb; text-align: right;">${parseFloat(item.amount).toFixed(2)}</td>
                                 </tr>`;
                });
                itemsHtml += `
                               <tr style="font-weight: bold; background-color: #f9fafb;">
                                   <td colspan="2" style="padding: 0.5rem; border: 1px solid #e5e7eb; text-align: right;">Total:</td>
                                   <td style="padding: 0.5rem; border: 1px solid #e5e7eb; text-align: right;">${parseFloat(data.total).toFixed(2)}</td>
                               </tr></tbody></table>`;
                
                let signatureHtml = `
                    <div style="margin-top: 4rem; display: grid; grid-template-columns: 1fr 1fr; gap: 4rem; page-break-inside: avoid; font-size: 14px;">
                        <div>
                            <div style="border-top: 1px solid #374151; padding-top: 0.5rem;">
                                <p style="margin: 0;"><strong>Direct Manager</strong></p>
                                <p style="margin: 0; font-size: 0.75rem;">Signature & Date</p>
                            </div>
                        </div>
                        <div>
                            <div style="border-top: 1px solid #374151; padding-top: 0.5rem;">
                                <p style="margin: 0;"><strong>Commercial Director</strong></p>
                                <p style="margin: 0; font-size: 0.75rem;">Signature & Date</p>
                            </div>
                        </div>
                    </div>`;

                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Expense Report - ${data.name}</title>
                            <style>
                                body { font-family: 'Inter', sans-serif; color: #111827; }
                                table, th, td { border: 1px solid #e5e7eb; }
                                @media print { .no-print { display: none; } }
                            </style>
                        </head>
                        <body style="padding: 2rem;">
                            <div style="text-align: center; margin-bottom: 2rem;">
                                     <img src="https://i.ibb.co/ZRmVjNch/logo.jpg" alt="Paxton Logo" style="height: 4rem; margin: 0 auto; border-radius: 50%;">
                                     <h1 style="font-size: 1.5rem; font-weight: 700; color: #1e3a8a; margin: 0.5rem 0 0 0;">Expense Report</h1>
                                     <p style="font-size: 0.9rem; color: #6b7280;">Paxton LLC</p>
                            </div>
                            <p style="text-align: right; font-size: 14px;"><strong>Status:</strong> ${status}</p>
                            ${detailsHtml}
                            ${itemsHtml}
                            ${signatureHtml}
                            <div class="no-print" style="text-align: center; margin-top: 2rem;">
                                <button onclick="window.print()">Print Report</button>
                            </div>
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.focus();
            }
        }

        function handleReportTypeChange(selectElement) {
            const type = selectElement.value;
            const isTrip = type === 'Trip';
            
            const tripDetailsFieldset = document.getElementById('tripDetails');
            const otherDateInputDiv = document.getElementById('otherDate');
            
            if (tripDetailsFieldset) tripDetailsFieldset.classList.toggle('hidden', !isTrip);
            const tripPurpose = document.getElementById('tripPurpose');
            if (tripPurpose) tripPurpose.required = isTrip;
            const travelDate = document.getElementById('travelDate');
            if (travelDate) travelDate.required = isTrip;
            const fromGovernorate = document.getElementById('fromGovernorate');
            if (fromGovernorate) fromGovernorate.required = isTrip;
            const toGovernorate = document.getElementById('toGovernorate');
            if (toGovernorate) toGovernorate.required = isTrip;

            if (otherDateInputDiv) otherDateInputDiv.classList.toggle('hidden', isTrip);
            const otherDateInput = document.getElementById('otherDateInput');
            if (otherDateInput) otherDateInput.required = !isTrip;
            setDefaultDates();
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            const items = [];
            let total = 0;
            const expenseContainer = data.employeeRole === 'District Manager' ? document.getElementById('managerExpensesContainer') : document.getElementById('repExpensesContainer');
            const expenseRows = expenseContainer.querySelectorAll('.expense-row');

            expenseRows.forEach((row, index) => {
                const type = row.querySelector('select').value;
                const desc = row.querySelector('input[name^="expenseDesc"]').value;
                const amount = parseFloat(row.querySelector('input[name^="expenseAmount"]').value) || 0;
                
                if (type) {
                    items.push({ type: type, desc: desc, amount: amount });
                    total += amount;
                }
            });
            
            const selectedEmployeeName = employeeNameDropdown.value;
            const employeeData = masterlistData.find(u => u['medical rep'] === selectedEmployeeName || u['District Manager'] === selectedEmployeeName);
            const employeeRole = employeeData ? (employeeData['medical rep'] === selectedEmployeeName ? 'Medical Representative' : 'District Manager') : 'N/A';
            
            let directManager = 'N/A';
            let reportTypeForDb = '';
            let reportDetails;
            let reportDate;

            if (employeeRole === 'Medical Representative') {
                directManager = employeeData['District Manager'];
                // Set the report_type to the first expense item's type for medical reps
                reportTypeForDb = items.length > 0 ? items[0].type : '';
                reportDate = data.repDate;
                reportDetails = { territory: employeeData.area, manager: directManager };
            } else if (employeeRole === 'District Manager') {
                reportTypeForDb = data.reportType;
                reportDate = data.reportType === 'Trip' ? data.travelDate : data.otherDateInput;
                if (data.reportType === 'Trip') {
                    reportDetails = { reportType: 'Trip', purpose: data.tripPurpose, from: data.fromGovernorate, to: data.toGovernorate };
                } else {
                    const otherItem = items.find(item => item.type === 'Others');
                    const otherDescription = otherItem ? otherItem.desc : '';
                    reportDetails = { reportType: 'Others', date: data.otherDateInput, description: otherDescription };
                }
            }
            
            const reportData = {
                employee_name: selectedEmployeeName,
                role: employeeRole,
                report_date: reportDate,
                total_amount: total.toFixed(2),
                status: 'Pending',
                report_type: reportTypeForDb,
                details: JSON.stringify(reportDetails),
                items: JSON.stringify(items)
            };

            const { data: insertedData, error } = await supabase.from('expenses').insert([reportData]).select();
            if (error) {
                console.error('Error submitting report:', error);
                showMessage("Error", "Failed to submit report. Please try again.");
                return;
            }

            showMessage("Success", `Report submitted successfully for ${selectedEmployeeName}!`);
            renderFormForEmployee();
        }
        
        function addNewReportToTable(report, tableBody) {
            if (!tableBody) return;
            const newRow = document.createElement('tr');
            newRow.className = 'hover:bg-gray-50';
            
            const employeeRole = getEmployeeRole(report.employee_name);
            const roleBadge = employeeRole === 'District Manager' ?
                `<span class="status-badge bg-blue-100 text-blue-800">District Manager</span>` :
                `<span class="status-badge bg-green-100 text-green-800">Medical Representative</span>`;
            
            newRow.dataset.id = report.id;
            newRow.dataset.name = report.employee_name;
            newRow.dataset.role = employeeRole;
            newRow.dataset.date = report.report_date;
            newRow.dataset.total = report.total_amount;
            newRow.dataset.details = report.details;
            newRow.dataset.items = report.items;
            newRow.dataset.reportType = report.report_type;

            let managerCellContent = 'N/A';
            const employeeData = masterlistData.find(u => u['medical rep'] === report.employee_name || u['District Manager'] === report.employee_name);
            if (employeeData && employeeData['District Manager']) {
                managerCellContent = employeeData['District Manager'];
            }
            
            const reportTypeToDisplay = getReportTypeDisplayString(report);


            if (tableBody.id === 'reportsTableBody') {
                newRow.innerHTML = `
                    <td class="text-mobile-sm text-gray-900">${report.report_date}</td>
                    <td class="text-mobile-sm text-gray-900">${report.employee_name}</td>
                    <td class="text-mobile-sm text-gray-500">${roleBadge}</td>
                    <td class="text-mobile-sm text-gray-500">${reportTypeToDisplay}</td>
                    <td class="text-mobile-sm text-gray-500 hidden sm:table-cell">${managerCellContent}</td>
                    <td class="text-right text-mobile-sm text-gray-900">${parseFloat(report.total_amount).toFixed(2)}</td>
                    <td class="text-center status-cell">${getStatusBadge(report.status)}</td>
                    <td class="text-center">
                        <button onclick="showReportDetails(this.closest('tr'))" class="action-btn bg-blue-100 text-blue-600 hover:bg-blue-200"><i class="fas fa-eye"></i></button>
                        <button onclick="showPrintConfirmation(this.closest('tr'))" class="action-btn bg-green-100 text-green-600 hover:bg-green-200"><i class="fas fa-print"></i></button>
                        <button onclick="deleteReport(this.closest('tr'))" class="action-btn bg-red-100 text-red-600 hover:bg-red-200"><i class="fas fa-trash-alt"></i></button>
                    </td>`;
            } else if (tableBody.id === 'myManagerReportsTableBody') {
                newRow.innerHTML = `
                        <td class="text-mobile-sm text-gray-900">${report.report_date}</td>
                        <td class="text-mobile-sm text-gray-500">${reportTypeToDisplay}</td>
                        <td class="text-right text-mobile-sm text-gray-900">${parseFloat(report.total_amount).toFixed(2)}</td>
                        <td class="text-center status-cell">${getStatusBadge(report.status)}</td>
                        <td class="text-center">
                            <button onclick="showReportDetails(this.closest('tr'))" class="action-btn bg-blue-100 text-blue-600 hover:bg-blue-200"><i class="fas fa-eye"></i></button>
                            <button onclick="showPrintConfirmation(this.closest('tr'))" class="action-btn bg-green-100 text-green-600 hover:bg-green-200"><i class="fas fa-print"></i></button>
                        </td>`;
            } else if (tableBody.id === 'myRepReportsTableBody') {
                newRow.innerHTML = `
                        <td class="text-mobile-sm text-gray-900">${report.report_date}</td>
                        <td class="text-mobile-sm text-gray-500">${reportTypeToDisplay}</td>
                        <td class="text-right text-mobile-sm text-gray-900">${parseFloat(report.total_amount).toFixed(2)}</td>
                        <td class="text-center status-cell">${getStatusBadge(report.status)}</td>
                        <td class="text-center">
                            <button onclick="showReportDetails(this.closest('tr'))" class="action-btn bg-blue-100 text-blue-600 hover:bg-blue-200"><i class="fas fa-eye"></i></button>
                            <button onclick="showPrintConfirmation(this.closest('tr'))" class="action-btn bg-green-100 text-green-600 hover:bg-green-200"><i class="fas fa-print"></i></button>
                        </td>`;
            } else if (tableBody.id === 'myTeamReportsTableBody') {
                newRow.innerHTML = `
                        <td class="text-mobile-sm text-gray-900">${report.report_date}</td>
                        <td class="text-mobile-sm text-gray-900">${report.employee_name}</td>
                        <td class="text-mobile-sm text-gray-500">${reportTypeToDisplay}</td>
                        <td class="text-right text-mobile-sm text-gray-900">${parseFloat(report.total_amount).toFixed(2)}</td>
                        <td class="text-center status-cell">${getStatusBadge(report.status)}</td>
                        <td class="text-center">
                            <button onclick="showReportDetails(this.closest('tr'))" class="action-btn bg-blue-100 text-blue-600 hover:bg-blue-200"><i class="fas fa-eye"></i></button>
                            <button onclick="showPrintConfirmation(this.closest('tr'))" class="action-btn bg-green-100 text-green-600 hover:bg-green-200"><i class="fas fa-print"></i></button>
                        </td>`;
            }
            
            tableBody.prepend(newRow);
        }
        
        async function retrieveMyReports(role, employeeName) {
            const myReportsTableBody = document.getElementById(role === 'District Manager' ? 'myManagerReportsTableBody' : 'myRepReportsTableBody');
            
            if (!myReportsTableBody) {
                    console.error("My reports table body not found.");
                    return;
            }
            myReportsTableBody.innerHTML = '';

            try {
                const { data, error } = await supabase
                    .from('expenses')
                    .select('*')
                    .eq('employee_name', employeeName)
                    .order('report_date', { ascending: false });
                
                if (error) throw error;
                
                if (data.length === 0) {
                    myReportsTableBody.innerHTML = `<tr><td colspan="5" class="p-2 text-center text-gray-500">No reports found for this user.</td></tr>`;
                    return;
                }
                
                data.forEach(report => addNewReportToTable(report, myReportsTableBody));
            } catch (error) {
                console.error('Error retrieving reports:', error);
                showMessage("Error", "Failed to retrieve your reports. Please try again.");
            }
        }

        async function retrieveMyTeamReports(managerName) {
            const myTeamReportsTableBody = document.getElementById('myTeamReportsTableBody');
            
            if (!myTeamReportsTableBody) {
                    console.error("My team reports table body not found.");
                    return;
            }
            myTeamReportsTableBody.innerHTML = '';
            
            const reps = [...new Set(masterlistData.filter(user => user['District Manager'] === managerName).map(user => user['medical rep']))];

            if (reps.length === 0) {
                    myTeamReportsTableBody.innerHTML = '<tr><td colspan="6" class="p-2 text-center text-gray-500">No team members found.</td></tr>';
                    return;
            }

            try {
                const { data, error } = await supabase
                    .from('expenses')
                    .select('*')
                    .in('employee_name', reps)
                    .order('report_date', { ascending: false });

                if (error) throw error;
                
                if (data.length === 0) {
                    myTeamReportsTableBody.innerHTML = '<tr><td colspan="6" class="p-2 text-center text-gray-500">No reports found for your team.</td></tr>';
                    return;
                }
                
                data.forEach(report => addNewReportToTable(report, myTeamReportsTableBody));
            } catch (error) {
                console.error('Error retrieving team reports:', error);
                showMessage("Error", "Failed to retrieve your team's reports. Please try again.");
            }
        }
        
        async function retrieveAllReports() {
    try {
        const { data, error } = await supabase.from('expenses').select('*').order('report_date', { ascending: false });
        if (error) throw error;

        allReportsData = data;
        if (reportsTableBody) reportsTableBody.innerHTML = '';
        filterReports(); // This will also update the total
    } catch (error) {
        console.error('Error retrieving all reports:', error);
        showMessage("Error", "Failed to retrieve reports. Please try again.");
    }
}


        function filterReports() {
    if (!reportsTableBody) {
        console.error("Reports table body not found.");
        return;
    }
    const employeeFilter = employeeFilterSelect.value;
    const statusFilter = statusFilterSelect.value;
    const monthFilter = monthFilterSelect.value;
    reportsTableBody.innerHTML = '';

    const today = new Date();
    const currentYear = today.getFullYear();

    const filteredData = allReportsData.filter(report => {
        const reportDate = new Date(report.report_date);
        const reportMonth = (reportDate.getMonth() + 1).toString().padStart(2, '0');
        const isEmployeeMatch = employeeFilter === 'all' || report.employee_name === employeeFilter;
        const isStatusMatch = statusFilter === 'all' || report.status === statusFilter;
        const isMonthMatch = monthFilter === 'all' || isDateInMonthlyReportRange(reportDate, parseInt(monthFilter), currentYear);

        return isEmployeeMatch && isStatusMatch && isMonthMatch;
    });

    // Calculate total expenses for filtered data, excluding rejected reports
    const totalExpenses = filteredData.reduce((sum, report) =>
        report.status !== 'Rejected' ? sum + parseFloat(report.total_amount) : sum, 0);
    document.getElementById('totalExpensesValue').textContent = `EGP ${totalExpenses.toFixed(2)}`;

    filteredData.forEach(report => addNewReportToTable(report, reportsTableBody));
}


        
        // --- Initialization Functions ---
        async function fetchMasterlistFromSupabase() {
            try {
                const CHUNK_SIZE = 1000;
                let offset = 0;
                let allData = [];
                let hasMore = true;

                while (hasMore) {
                    const { data, error } = await supabase
                        .from('masterlist')
                        .select('*')
                        .range(offset, offset + CHUNK_SIZE - 1);

                    if (error) {
                        throw error;
                    }

                    if (data && data.length > 0) {
                        allData = allData.concat(data);
                        offset += CHUNK_SIZE;
                    } else {
                        hasMore = false;
                    }
                }
                
                masterlistData = allData;
                populateEmployeeDropdowns();
                populateFilters();
                setDefaultDates();
            } catch (error) {
                console.error("Error fetching masterlist:", error);
                showMessage("Error", "Could not load employee data. Please try again later.");
            }
        }

        function getEmployeeRole(employeeName) {
            const employeeData = masterlistData.find(u => u['medical rep'] === employeeName || u['District Manager'] === employeeName);
            if (employeeData) {
                if (employeeData['District Manager'] === employeeName) {
                    return 'District Manager';
                } else if (employeeData['medical rep'] === employeeName) {
                    return 'Medical Representative';
                }
            }
            return 'N/A';
        }

        function populateEmployeeDropdowns() {
            if (!employeeNameDropdown) return;
            employeeNameDropdown.innerHTML = '<option value="">Select Employee</option>';

            const managers = [...new Set(masterlistData.filter(u => u['District Manager']).map(u => u['District Manager']))].sort();
            managers.forEach(manager => {
                const managerOption = document.createElement('option');
                managerOption.value = manager;
                managerOption.textContent = manager;
                managerOption.style.fontWeight = 'bold';
                employeeNameDropdown.appendChild(managerOption);

                const reps = [...new Set(masterlistData.filter(u => u['District Manager'] === manager && u['medical rep']).map(u => u['medical rep']))].sort();
                reps.forEach(rep => {
                    const repOption = document.createElement('option');
                    repOption.value = rep;
                    repOption.textContent = `   ${rep}`;
                    employeeNameDropdown.appendChild(repOption);
                });
            });
            
            employeeNameDropdown.addEventListener('change', renderFormForEmployee);
        }

        function populateGovernorates() {
            const fromGovernorateSelect = document.getElementById('fromGovernorate');
            const toGovernorateSelect = document.getElementById('toGovernorate');
            if (fromGovernorateSelect) fromGovernorateSelect.innerHTML = '<option value="">Select a Governorate</option>';
            if (toGovernorateSelect) toGovernorateSelect.innerHTML = '<option value="">Select a Governorate</option>';
            governorates.sort().forEach(gov => {
                if (fromGovernorateSelect) fromGovernorateSelect.innerHTML += `<option value="${gov}">${gov}</option>`;
                if (toGovernorateSelect) toGovernorateSelect.innerHTML += `<option value="${gov}">${gov}</option>`;
            });
        }
        
        function populateFilters() {
            populateEmployeeFilter();
            populateMonthFilter();
            populateMonthlyReportEmployeeFilter();
        }

        function populateEmployeeFilter() {
            if (!employeeFilterSelect) return;
            employeeFilterSelect.innerHTML = '<option value="all">All Employees</option>';

            const managers = [...new Set(masterlistData.filter(u => u['District Manager']).map(u => u['District Manager']))].sort();
            managers.forEach(manager => {
                const managerOption = document.createElement('option');
                managerOption.value = manager;
                managerOption.textContent = manager;
                managerOption.style.fontWeight = 'bold';
                employeeFilterSelect.appendChild(managerOption);

                const reps = [...new Set(masterlistData.filter(u => u['District Manager'] === manager && u['medical rep']).map(u => u['medical rep']))].sort();
                reps.forEach(rep => {
                    const repOption = document.createElement('option');
                    repOption.value = rep;
                    repOption.textContent = `   ${rep}`;
                    employeeFilterSelect.appendChild(repOption);
                });
            });
        }

        function populateMonthlyReportEmployeeFilter() {
            if (!monthlyReportEmployeeSelect) return;
            monthlyReportEmployeeSelect.innerHTML = '<option value="">Select an Employee</option>';
            
            const employees = new Set();
            masterlistData.forEach(user => {
                    if (user['medical rep']) employees.add(user['medical rep']);
                    if (user['District Manager']) employees.add(user['District Manager']);
            });
            const sortedEmployees = Array.from(employees).sort();

            sortedEmployees.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                monthlyReportEmployeeSelect.appendChild(option);
            });
        }

        function populateMonthFilter() {
            if (monthFilterSelect) {
                monthFilterSelect.innerHTML = '<option value="all">All Months</option>';
                months.forEach((month, index) => {
                    const monthValue = (index + 1).toString().padStart(2, '0'); // "01", "02", etc.
                    monthFilterSelect.innerHTML += `<option value="${monthValue}">${month}</option>`;
                });
            }

            if (monthlyReportMonthSelect) {
                monthlyReportMonthSelect.innerHTML = '<option value="">Select a Month</option>'; // For monthly report modal
                months.forEach((month, index) => {
                    const monthValue = (index + 1).toString().padStart(2, '0'); // "01", "02", etc.
                    monthlyReportMonthSelect.innerHTML += `<option value="${monthValue}">${month}</option>`;
                });
                const today = new Date();
                const currentMonth = (today.getMonth() + 1).toString().padStart(2, '0');
                monthlyReportMonthSelect.value = currentMonth;
            }
        }

        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const travelDate = document.getElementById('travelDate');
            if(travelDate) travelDate.value = today;
            const otherDateInput = document.getElementById('otherDateInput');
            if(otherDateInput) otherDateInput.value = today;
            const repDate = document.getElementById('repDate');
            if(repDate) repDate.value = today;
        }

        function renderFormForEmployee() {
            const selectedEmployeeName = employeeNameDropdown.value;
            const formContainer = dynamicFormContainer;
            if (!selectedEmployeeName) {
                formContainer.innerHTML = '';
                return;
            }

            const employeeData = masterlistData.find(u => u['medical rep'] === selectedEmployeeName || u['District Manager'] === selectedEmployeeName);
            
            if (!employeeData) {
                formContainer.innerHTML = '<p class="text-red-500">Employee data not found.</p>';
                return;
            }

            const employeeRole = getEmployeeRole(selectedEmployeeName);
            
            if (employeeRole === 'District Manager') {
                formContainer.innerHTML = createManagerForm();
                document.getElementById('managerExpenseForm').addEventListener('submit', handleFormSubmit);
                populateGovernorates();
                setDefaultDates();
                addExpense('District Manager');
            } else { // Medical Representative
                formContainer.innerHTML = createMedicalRepForm();
                document.getElementById('medicalRepExpenseForm').addEventListener('submit', handleFormSubmit);
                document.getElementById('repTerritory').value = employeeData.area || '';
                document.getElementById('directManager').value = employeeData['District Manager'] || '';
                setDefaultDates();
                addExpense('Medical Representative');
            }
        }
        
        function prefillAndLockForm(user) {
            if (!user) return;
            
            if (user.title !== 'admin') {
                employeeNameDropdown.value = user.username;
                employeeNameDropdown.disabled = true;
            } else {
                employeeNameDropdown.disabled = false;
            }

            // Render the form based on the pre-filled value
            renderFormForEmployee();

            if (user.title === 'Medical Representative') {
                const repData = masterlistData.find(u => u['medical rep'] === user.username);
                if (repData) {
                    const directManager = document.getElementById('directManager');
                    const repTerritory = document.getElementById('repTerritory');
                    if (directManager) directManager.value = repData['District Manager'] || '';
                    if (repTerritory) repTerritory.value = repData.area || '';
                }
            }
        }

        // --- Event Listeners and Initialization ---
        function showRoleSelection() {
            if (mainContent) mainContent.classList.add('hidden');
            if (roleSelection) roleSelection.classList.remove('hidden');
        }

        window.addEventListener('message', event => {
            if (event.data.type === 'loggedInUser') {
                loggedInUser = event.data.user;
                if (!loggedInUser) return;
                
                const addCard = document.getElementById('add-expense-card');
                const adminCard = document.getElementById('admin-panel-card');

                if (loggedInUser.title === 'admin') {
                    if (addCard) addCard.classList.remove('hidden');
                    if (adminCard) adminCard.classList.remove('hidden');
                } else if (loggedInUser.title === 'Medical Representative' || loggedInUser.title === 'District Manager') {
                    if (addCard) addCard.classList.remove('hidden');
                    if (adminCard) adminCard.classList.add('hidden');
                } else {
                    // Fallback for unexpected roles
                    if (addCard) addCard.classList.add('hidden');
                    if (adminCard) addCard.classList.add('hidden');
                    console.error("Unknown user role:", loggedInUser.title);
                }
                
                // Show the role selection screen for all users on initial load
                showRoleSelection();
            }
        });
        
        if(employeeFilterSelect) employeeFilterSelect.addEventListener('change', filterReports);
        if (statusFilterSelect) statusFilterSelect.addEventListener('change', filterReports);
        if (monthFilterSelect) monthFilterSelect.addEventListener('change', filterReports);
        
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchMasterlistFromSupabase();

            const addExpenseCard = document.getElementById('add-expense-card');
            if(addExpenseCard) addExpenseCard.addEventListener('click', () => showView('addExpense'));
            const adminPanelCard = document.getElementById('admin-panel-card');
            if(adminPanelCard) adminPanelCard.addEventListener('click', () => showView('admin'));
        });
    </script>
</body>
</html>
