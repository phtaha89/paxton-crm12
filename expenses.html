<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paxton LLC Expenses Manager</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter for a modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Supabase CDN for database interaction -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Main container with responsive padding -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Role Selection Screen -->
        <div id="roleSelection" class="max-w-4xl mx-auto">
            <div class="text-center mb-12">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-2">Expense Management System</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Add Expense Card -->
                <div id="add-expense-card" class="bg-white rounded-xl p-8 text-center cursor-pointer shadow hover:shadow-lg transition-all duration-200 ease-in-out">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-plus text-blue-600 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Add Expense</h3>
                    <p class="text-gray-500 text-sm">Submit a new expense report or log</p>
                </div>
                <!-- Admin Panel Card -->
                <div id="admin-panel-card" class="bg-white rounded-xl p-8 text-center cursor-pointer shadow hover:shadow-lg transition-all duration-200 ease-in-out hidden">
                    <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-user-shield text-purple-600 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Admin Panel</h3>
                    <p class="text-gray-500 text-sm">Review and manage all expense reports</p>
                </div>
            </div>
        </div>
        <!-- Main Content -->
        <div id="mainContent" class="hidden">
            <!-- Add Expense View -->
            <div id="addExpenseView" class="hidden">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Add New Expense</h2>
                    </div>
                    <button onclick="goBackToRoleSelection()" class="flex items-center btn bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-all duration-200 ease-in-out">
                        <i class="fas fa-arrow-left mr-2"></i>Go Back
                    </button>
                </div>
                <div class="bg-white rounded-xl shadow p-4 sm:p-6">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Employee</label>
                        <select id="employeeNameDropdown" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-blue-600">
                            <option value="">Select Employee</option>
                        </select>
                    </div>
                    <!-- Dynamic Forms will be injected here -->
                    <div id="dynamicFormContainer"></div>
                </div>
            </div>

            <!-- Admin View -->
            <div id="adminView" class="hidden">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Expense Reports Dashboard</h2>
                        <p class="text-gray-500 text-sm sm:text-base">Review, approve, and reject expense reports.</p>
                    </div>
                    <button onclick="goBackToRoleSelection()" class="flex items-center btn bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-all duration-200 ease-in-out">
                        <i class="fas fa-arrow-left mr-2"></i>Go Back
                    </button>
                </div>
                <div class="bg-white rounded-xl shadow p-4 sm:p-6">
                    <!-- Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Employee</label>
                            <select id="employeeFilter" class="w-full text-sm px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600">
                                <option value="all">All Employees</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Status</label>
                            <select id="statusFilter" class="w-full text-sm px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600">
                                <option value="all">All Statuses</option>
                                <option value="Pending">Pending</option>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Month</label>
                            <select id="monthFilter" class="w-full text-sm px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600">
                                <option value="all">All Months</option>
                            </select>
                        </div>
                    </div>
                    <!-- Reports Table -->
                    <div class="overflow-x-auto rounded-lg shadow-sm">
                        <table class="min-w-full divide-y divide-gray-200 text-xs sm:text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
                                    <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                    <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Report Type</th>
                                    <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Manager</th>
                                    <th class="px-3 sm:px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (EGP)</th>
                                    <th class="px-3 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-3 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reportsTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- All reports will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Message Modal -->
    <div id="messageModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 id="messageModalTitle" class="text-lg font-semibold mb-3"></h3>
            <p id="messageModalBody" class="text-gray-600 mb-6"></p>
            <div id="messageModalActions" class="flex justify-end space-x-3">
                <button id="modalPrimaryBtn" onclick="hideMessage()" class="btn bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                    OK
                </button>
            </div>
        </div>
    </div>
    
    <!-- Report Details Modal -->
    <div id="reportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-semibold">Expense Report Details</h2>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div id="modalBody" class="p-4 sm:p-6">
                <!-- Content will be injected by JS -->
            </div>
            <div id="modalActions" class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                <button id="approveBtn" onclick="updateStatus('Approved')" class="btn bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                    Approve
                </button>
                <button id="rejectBtn" onclick="updateStatus('Rejected')" class="btn bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                    Reject
                </button>
                <button onclick="closeModal()" class="btn bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Print Confirmation Modal (New) -->
    <div id="printConfirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 text-center">
            <h3 class="text-lg font-semibold mb-3">Print Options</h3>
            <p class="text-gray-600 mb-6">How would you like to print this report?</p>
            <div class="flex flex-col sm:flex-row justify-center gap-3">
                <button onclick="printReport(activeReportRow, 'single'); hidePrintConfirmationModal();" class="btn bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Print Single Report</button>
                <button onclick="showMonthlyReportOptions(activeReportRow); hidePrintConfirmationModal();" class="btn bg-blue-100 text-blue-700 px-4 py-2 rounded-md hover:bg-blue-200">Print Monthly Report</button>
                <button onclick="hidePrintConfirmationModal();" class="btn bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Monthly Report Options Modal (New) -->
    <div id="monthlyReportOptionsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-xl font-semibold">Generate Monthly Report</h2>
                <button onclick="hideMonthlyReportOptionsModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="monthlyReportEmployeeSelect" class="block text-sm font-medium text-gray-700 mb-2">Select Employee</label>
                    <select id="monthlyReportEmployeeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600">
                        <option value="">Select an Employee</option>
                    </select>
                </div>
                <div>
                    <label for="monthlyReportMonthSelect" class="block text-sm font-medium text-gray-700 mb-2">Select Month</label>
                    <select id="monthlyReportMonthSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600">
                        <option value="">Select a Month</option>
                    </select>
                </div>
            </div>
            <div class="mt-6 pt-4 border-t flex justify-end space-x-3">
                <button onclick="generateMonthlyReport();" class="btn bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Generate Report</button>
                <button onclick="hideMonthlyReportOptionsModal()" class="btn bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- SUPABASE SETUP ---
        const SUPABASE_URL = 'https://plmevfyxpngzymvzvkzn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBsbWV2Znl4cG5nenltdnp2a3puIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NjM5NDEsImV4cCI6MjA2NjMzOTk0MX0.lUm3efHFCL3aAB-PL7H54BpnvcpbXxp1BeUzw0yjp5c';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- DOM Elements ---
        const roleSelection = document.getElementById('roleSelection');
        const mainContent = document.getElementById('mainContent');
        const addExpenseView = document.getElementById('addExpenseView');
        const adminView = document.getElementById('adminView');
        const dynamicFormContainer = document.getElementById('dynamicFormContainer');
        const reportsTableBody = document.getElementById('reportsTableBody');
        const reportModal = document.getElementById('reportModal');
        const modalBody = document.getElementById('modalBody');
        const employeeNameDropdown = document.getElementById('employeeNameDropdown');
        const repTerritoryInput = document.getElementById('repTerritory');
        const directManagerInput = document.getElementById('directManager');
        const messageModal = document.getElementById('messageModal');
        const messageModalTitle = document.getElementById('messageModalTitle');
        const messageModalBody = document.getElementById('messageModalBody');
        const messageModalActions = document.getElementById('messageModalActions');
        const employeeFilterSelect = document.getElementById('employeeFilter');
        const statusFilterSelect = document.getElementById('statusFilter');
        const monthFilterSelect = document.getElementById('monthFilter');

        // New Print Modals
        const printConfirmationModal = document.getElementById('printConfirmationModal');
        const monthlyReportOptionsModal = document.getElementById('monthlyReportOptionsModal');
        const monthlyReportEmployeeSelect = document.getElementById('monthlyReportEmployeeSelect');
        const monthlyReportMonthSelect = document.getElementById('monthlyReportMonthSelect');

        // --- State ---
        let managerExpenseCount = 0;
        let repExpenseCount = 0;
        let activeReportRow = null;
        let masterlistData = [];
        let allReportsData = [];
        let loggedInUser = null;

        // --- Data Definitions ---
        const governorates = [
            "Alexandria", "Aswan", "Asyut", "Beheira", "Beni Suef", "Cairo", "Dakahlia",
            "Damietta", "Faiyum", "Gharbia", "Giza", "Ismailia", "Kafr El Sheikh", "Luxor",
            "Matrouh", "Minya", "Monufia", "New Valley", "North Sinai", "Port Said",
            "Qalyubia", "Qena", "Red Sea", "Sharqia", "Sohag", "South Sinai", "Suez"
        ];
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const repExpenseTypes = ['Own Car Travel', 'Public Transportation', 'Accommodations', 'Meal', 'Toll', 'Parking', 'Others'];
        const managerExpenseTypes = ['Own Car Travel', 'Public Transportation', 'Accommodations', 'Meal', 'Toll', 'Parking', 'Team meeting', 'Others'];

        // --- UI Logic ---
        function showView(view) {
            if (roleSelection) roleSelection.classList.add('hidden');
            if (mainContent) mainContent.classList.remove('hidden');
            if (addExpenseView) addExpenseView.classList.add('hidden');
            if (adminView) adminView.classList.add('hidden');

            if (view === 'addExpense') {
                if (addExpenseView) addExpenseView.classList.remove('hidden');
                prefillAndLockForm(loggedInUser);
            } else if (view === 'admin') {
                currentUserRole = 'admin';
                if (adminView) adminView.classList.remove('hidden');
                retrieveAllReports();
            }
        }

        function goBackToRoleSelection() {
            if (mainContent) mainContent.classList.add('hidden');
            if (roleSelection) roleSelection.classList.remove('hidden');
            currentUserRole = null;
        }

        // --- Dynamic Form Logic ---
        function createManagerForm() {
            return `
                <form id="managerExpenseForm" class="space-y-6">
                    <input type="hidden" name="employeeRole" value="District Manager">
                    <!-- Tab Navigation -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="flex space-x-4 sm:space-x-8">
                            <button id="managerAddTab" type="button" class="py-2 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-600 transition-colors duration-200" onclick="showTab('District Manager', 'add')">
                                Submit Report
                            </button>
                            <button id="managerViewTab" type="button" class="py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors duration-200" onclick="showTab('District Manager', 'view')">
                                My Reports
                            </button>
                            <button id="managerTeamTab" type="button" class="py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors duration-200" onclick="showTab('District Manager', 'team')">
                                Team Reports
                            </button>
                        </nav>
                    </div>
                    <!-- Add Report Tab Content -->
                    <div id="managerAddContent">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Report Type</label>
                                <select id="reportType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600" onchange="handleReportTypeChange(this)">
                                    <option value="Trip">Trip Report</option>
                                    <option value="Others">Other Expenses</option>
                                </select>
                            </div>
                        </div>
                        <!-- Trip Details -->
                        <div id="tripDetails" class="bg-gray-50 rounded-lg p-4 mt-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Trip Information</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Purpose of Trip</label>
                                    <input type="text" id="tripPurpose" name="tripPurpose" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="e.g., Regional Meeting" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Date of Travel</label>
                                    <input type="date" id="travelDate" name="travelDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">From (Governorate)</label>
                                    <select id="fromGovernorate" name="fromGovernorate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600" required>
                                        <option value="">Select Governorate</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">To (Governorate)</label>
                                    <select id="toGovernorate" name="toGovernorate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600" required>
                                        <option value="">Select Governorate</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <!-- Other Expenses Date -->
                        <div id="otherDate" class="hidden mt-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date of Expense</label>
                            <input type="date" id="otherDateInput" name="otherDateInput" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600">
                        </div>
                        <!-- Expenses Section -->
                        <div class="mt-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-medium text-gray-900">Expense Items</h3>
                                <button type="button" onclick="addExpense('District Manager')" class="flex items-center btn bg-blue-600 text-white text-sm px-4 py-2 rounded-md hover:bg-blue-700">
                                    <i class="fas fa-plus mr-2"></i>Add Item
                                </button>
                            </div>
                            <div id="managerExpensesContainer" class="space-y-3">
                                <!-- Expense items will be added here -->
                            </div>
                        </div>
                        <!-- Total -->
                        <div class="bg-gray-50 rounded-lg p-4 mt-6">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-medium text-gray-900">Total Amount:</span>
                                <input type="text" id="managerTotal" readonly class="text-right text-xl font-bold bg-transparent border-none outline-none text-green-600 w-1/2">
                            </div>
                        </div>
                        <!-- Submit Button -->
                        <div class="flex justify-end mt-6">
                            <button type="submit" class="btn bg-blue-600 text-white px-6 py-3 rounded-md text-lg font-semibold hover:bg-blue-700">
                                Submit Report
                            </button>
                        </div>
                    </div>
                    <!-- View Reports Tab Content -->
                    <div id="managerViewContent" class="hidden">
                        <div class="bg-white rounded-lg p-4 sm:p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-lg font-medium text-gray-900">My Submitted Reports</h3>
                                <button onclick="retrieveMyReports('District Manager', employeeNameDropdown.value)" class="btn bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200 transition-all duration-200" title="Refresh">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                            <div class="overflow-x-auto rounded-lg shadow-sm">
                                <table class="min-w-full divide-y divide-gray-200 text-xs sm:text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-3 sm:px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                            <th class="px-3 sm:px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                            <th class="px-3 sm:px-6 py-3 text-right font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                            <th class="px-3 sm:px-6 py-3 text-center font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th class="px-3 sm:px-6 py-3 text-center font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="myManagerReportsTableBody" class="bg-white divide-y divide-gray-200">
                                        <!-- Reports will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- Team Reports Tab Content -->
                    <div id="managerTeamContent" class="hidden">
                        <div class="bg-white rounded-lg p-4 sm:p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-lg font-medium text-gray-900">Team Reports</h3>
                                <button onclick="retrieveMyTeamReports(employeeNameDropdown.value)" class="btn bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200 transition-all duration-200" title="Refresh">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                            <div class="overflow-x-auto rounded-lg shadow-sm">
                                <table class="min-w-full divide-y divide-gray-200 text-xs sm:text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-3 sm:px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                            <th class="px-3 sm:px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">Employee</th>
                                            <th class="px-3 sm:px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">Report Type</th>
                                            <th class="px-3 sm:px-6 py-3 text-right font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                            <th class="px-3 sm:px-6 py-3 text-center font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th class="px-3 sm:px-6 py-3 text-center font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="myTeamReportsTableBody" class="bg-white divide-y divide-gray-200">
                                        <!-- Team reports will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </form>
            `;
        }

        function createMedicalRepForm() {
            return `
                <form id="medicalRepExpenseForm" class="space-y-6">
                    <input type="hidden" name="employeeRole" value="Medical Representative">
                    <!-- Tab Navigation -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="flex space-x-4 sm:space-x-8">
                            <button id="repAddTab" type="button" class="py-2 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-600 transition-colors duration-200" onclick="showTab('Medical Representative', 'add')">
                                Submit Log
                            </button>
                            <button id="repViewTab" type="button" class="py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors duration-200" onclick="showTab('Medical Representative', 'view')">
                                My Logs
                            </button>
                        </nav>
                    </div>
                    <!-- Add Log Tab Content -->
                    <div id="repAddContent">
                        <!-- Basic Information -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                                <input type="date" id="repDate" name="repDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Direct Manager</label>
                                <input type="text" id="directManager" name="directManager" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Territory / Area</label>
                                <input type="text" id="repTerritory" name="repTerritory" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50">
                            </div>
                        </div>
                        <!-- Expenses Section -->
                        <div class="mt-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-medium text-gray-900">Expense Items</h3>
                                <button type="button" onclick="addExpense('Medical Representative')" class="flex items-center btn bg-green-600 text-white text-sm px-4 py-2 rounded-md hover:bg-green-700">
                                    <i class="fas fa-plus mr-2"></i>Add Item
                                </button>
                            </div>
                            <div id="repExpensesContainer" class="space-y-3">
                                <!-- Expense items will be added here -->
                            </div>
                        </div>
                        <!-- Total -->
                        <div class="bg-gray-50 rounded-lg p-4 mt-6">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-medium text-gray-900">Total Daily Expenses:</span>
                                <input type="text" id="repTotal" readonly class="text-right text-xl font-bold bg-transparent border-none outline-none text-green-600 w-1/2">
                            </div>
                        </div>
                        <!-- Submit Button -->
                        <div class="flex justify-end mt-6">
                            <button type="submit" class="btn bg-green-600 text-white px-6 py-3 rounded-md text-lg font-semibold hover:bg-green-700">
                                Submit Daily Log
                            </button>
                        </div>
                    </div>
                    <!-- View Logs Tab Content -->
                    <div id="repViewContent" class="hidden">
                        <div class="bg-white rounded-lg p-4 sm:p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-lg font-medium text-gray-900">My Submitted Logs</h3>
                                <button onclick="retrieveMyReports('Medical Representative', employeeNameDropdown.value)" class="btn bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200 transition-all duration-200" title="Refresh">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                            <div class="overflow-x-auto rounded-lg shadow-sm">
                                <table class="min-w-full divide-y divide-gray-200 text-xs sm:text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-3 sm:px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                            <th class="px-3 sm:px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">Report Type</th>
                                            <th class="px-3 sm:px-6 py-3 text-right font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                            <th class="px-3 sm:px-6 py-3 text-center font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th class="px-3 sm:px-6 py-3 text-center font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="myRepReportsTableBody" class="bg-white divide-y divide-gray-200">
                                        <!-- Reports will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </form>
            `;
        }
        
        function showTab(role, tabType) {
            const addContent = document.getElementById(role === 'District Manager' ? 'managerAddContent' : 'repAddContent');
            const viewContent = document.getElementById(role === 'District Manager' ? 'managerViewContent' : 'repViewContent');
            const teamContent = document.getElementById(role === 'District Manager' ? 'managerTeamContent' : null);
            
            const addTabBtn = document.getElementById(role === 'District Manager' ? 'managerAddTab' : 'repAddTab');
            const viewTabBtn = document.getElementById(role === 'District Manager' ? 'managerViewTab' : 'repViewTab');
            const teamTabBtn = document.getElementById(role === 'District Manager' ? 'managerTeamTab' : null);

            // Hide all content
            if (addContent) addContent.classList.add('hidden');
            if (viewContent) viewContent.classList.add('hidden');
            if (teamContent) teamContent.classList.add('hidden');
            
            // Remove active state from all tabs
            const allTabs = [addTabBtn, viewTabBtn, teamTabBtn].filter(Boolean);
            allTabs.forEach(tab => {
                tab.classList.remove('text-blue-600', 'border-blue-600');
                tab.classList.add('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
            });

            // Show and set active state for the selected tab
            if (tabType === 'add') {
                if (addContent) addContent.classList.remove('hidden');
                if (addTabBtn) {
                    addTabBtn.classList.add('text-blue-600', 'border-blue-600');
                    addTabBtn.classList.remove('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
                }
            } else if (tabType === 'view') {
                if (viewContent) viewContent.classList.remove('hidden');
                if (viewTabBtn) {
                    viewTabBtn.classList.add('text-blue-600', 'border-blue-600');
                    viewTabBtn.classList.remove('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
                }
                if (employeeNameDropdown.value) {
                    retrieveMyReports(role, employeeNameDropdown.value);
                }
            } else if (tabType === 'team' && role === 'District Manager') {
                if (teamContent) teamContent.classList.remove('hidden');
                if (teamTabBtn) {
                    teamTabBtn.classList.add('text-blue-600', 'border-blue-600');
                    teamTabBtn.classList.remove('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
                }
                if (employeeNameDropdown.value) {
                    retrieveMyTeamReports(employeeNameDropdown.value);
                }
            }
        }

        function handleExpenseTypeChange(selectElement) {
            const row = selectElement.closest('.expense-row');
            const descriptionInput = row.querySelector('input[name^="expenseDesc"]');
            const amountInput = row.querySelector('input[name^="expenseAmount"]');

            if (!descriptionInput || !amountInput) return;
            
            const newDescriptionInput = descriptionInput.cloneNode(true);
            descriptionInput.parentNode.replaceChild(newDescriptionInput, descriptionInput);
            
            newDescriptionInput.value = '';
            amountInput.value = '';
            newDescriptionInput.required = (selectElement.value === 'Others');
            amountInput.readOnly = false;
            amountInput.classList.remove('bg-gray-100');

            if (selectElement.value === 'Own Car Travel') {
                newDescriptionInput.type = 'number';
                newDescriptionInput.placeholder = 'KM Travelled';
                amountInput.readOnly = true;
                amountInput.classList.add('bg-gray-100');
                
                newDescriptionInput.addEventListener('input', () => {
                    const km = parseFloat(newDescriptionInput.value) || 0;
                    const worth = km * 1.7;
                    amountInput.value = worth.toFixed(2);
                    const formId = selectElement.closest('form').id;
                    const containerId = formId === 'managerExpenseForm' ? 'managerExpensesContainer' : 'repExpensesContainer';
                    const totalId = formId === 'managerExpenseForm' ? 'managerTotal' : 'repTotal';
                    updateTotal(document.getElementById(containerId), totalId);
                });
            } else {
                newDescriptionInput.type = 'text';
                newDescriptionInput.placeholder = 'Description (optional)';
            }
            const formId = selectElement.closest('form').id;
            const containerId = formId === 'managerExpenseForm' ? 'managerExpensesContainer' : 'repExpensesContainer';
            const totalId = formId === 'managerExpenseForm' ? 'managerTotal' : 'repTotal';
            updateTotal(document.getElementById(containerId), totalId);
        }
        
        function addExpense(role) {
            const containerId = role === 'District Manager' ? 'managerExpensesContainer' : 'repExpensesContainer';
            const container = document.getElementById(containerId);
            const expenseTypesList = role === 'District Manager' ? managerExpenseTypes : repExpenseTypes;
            const newId = role === 'District Manager' ? ++managerExpenseCount : ++repExpenseCount;
            
            if (!container) return;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-12 gap-3 p-3 rounded-lg bg-gray-50/50 expense-row';
            div.id = `expense-row-${containerId}-${newId}`;
            const optionsHtml = expenseTypesList.map(opt => `<option>${opt}</option>`).join('');
            div.innerHTML = `
                <div class="col-span-12 sm:col-span-4"><select name="expenseType-${newId}" required class="block w-full text-sm px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"><option value="">Select Expense Type</option>${optionsHtml}</select></div>
                <div class="col-span-12 sm:col-span-5"><input type="text" name="expenseDesc-${newId}" placeholder="Description (optional)" class="block w-full text-sm px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div>
                <div class="col-span-10 sm:col-span-2"><input type="number" name="expenseAmount-${newId}" min="0" step="0.01" required placeholder="EGP" class="block w-full text-sm px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 expense-amount"></div>
                <div class="col-span-2 sm:col-span-1 flex items-center justify-center"><button type="button" onclick="removeExpenseRow('expense-row-${containerId}-${newId}', '${containerId}')" class="p-2 text-red-500 hover:bg-red-100 rounded-full transition"><i class="fas fa-trash-alt"></i></button></div>`;
            container.appendChild(div);
            
            const selectEl = div.querySelector('select');
            const amountInput = div.querySelector('.expense-amount');
            
            if (selectEl) {
                selectEl.addEventListener('change', () => {
                    handleExpenseTypeChange(selectEl);
                });
            }
            if (amountInput) {
                amountInput.addEventListener('input', () => {
                    updateTotal(container, container.id === 'managerExpensesContainer' ? 'managerTotal' : 'repTotal');
                });
            }
        }
        
        function removeExpenseRow(rowId, containerId) {
            const rowElement = document.getElementById(rowId);
            if(rowElement) rowElement.remove();
            const container = document.getElementById(containerId);
            if (container) updateTotal(container, containerId === 'managerExpensesContainer' ? 'managerTotal' : 'repTotal');
        }

        function updateTotal(container, totalElId) {
            const amounts = container.querySelectorAll('.expense-amount');
            const total = Array.from(amounts).reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
            const totalElement = document.getElementById(totalElId);
            if (totalElement) totalElement.value = `EGP ${total.toFixed(2)}`;
        }

        function resetForm(form, container, role) {
            if (!form || !container) return;
            form.reset();
            container.innerHTML = '';
            if (role === 'District Manager') {
                managerExpenseCount = 0;
            } else {
                repExpenseCount = 0;
            }
            setDefaultDates();
        }
        
        function getStatusBadge(status) {
            if (status === 'Approved') return `<span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-0.5 rounded-full">Approved</span>`;
            if (status === 'Rejected') return `<span class="bg-red-100 text-red-800 text-xs font-medium px-2 py-0.5 rounded-full">Rejected</span>`;
            return `<span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2 py-0.5 rounded-full">Pending</span>`;
        }
        
        // --- Message Modal Logic ---
        function showMessage(title, body, customButtons = null) {
            if (!messageModalTitle || !messageModalBody || !messageModal || !messageModalActions) {
                console.error("Message modal elements not found.");
                return;
            }
            messageModalTitle.textContent = title;
            messageModalBody.textContent = body;
            messageModal.classList.remove('hidden');
            setTimeout(() => { messageModal.classList.remove('opacity-0'); }, 10);

            messageModalActions.innerHTML = '';
            if (customButtons) {
                customButtons.forEach(btn => {
                    const buttonElement = document.createElement('button');
                    buttonElement.textContent = btn.text;
                    buttonElement.onclick = btn.onClick;
                    buttonElement.className = btn.className;
                    messageModalActions.appendChild(buttonElement);
                });
            } else {
                messageModalActions.innerHTML = `<button onclick="hideMessage()" class="btn bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">OK</button>`;
            }
        }

        function hideMessage() {
            if (messageModal) {
                messageModal.classList.add('opacity-0');
                setTimeout(() => { messageModal.classList.add('hidden'); }, 300);
            }
        }

        // --- Report Details Modal Logic ---
        function showReportDetails(rowElement) {
            activeReportRow = rowElement;
            const data = rowElement.dataset;
            const items = JSON.parse(data.items);
            const details = JSON.parse(data.details);
            if (!modalBody || !reportModal) return;
            
            let detailsHtml = `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3 mb-4 text-sm sm:text-base">
                    <div><strong class="font-semibold text-gray-600 block">Employee:</strong> ${data.name}</div>
                    <div><strong class="font-semibold text-gray-600 block">Role:</strong> ${data.role}</div>
                    <div><strong class="font-semibold text-gray-600 block">Date:</strong> ${data.date}</div>
                    ${data.role === 'District Manager' ? `<div><strong class="font-semibold text-gray-600 block">Report Type:</strong> ${details.reportType}</div>
                                                        ${details.reportType === 'Trip' ? `<div><strong class="font-semibold text-gray-600 block">Trip:</strong> ${details.from} to ${details.to}</div>
                                                                                                <div class="col-span-2 sm:col-span-1"><strong class="font-semibold text-gray-600 block">Purpose:</strong> ${details.purpose}</div>` : ''}` : 
                                                        `<div><strong class="font-semibold text-gray-600 block">Territory:</strong> ${details.territory}</div>
                                                         <div class="col-span-2 sm:col-span-1"><strong class="font-semibold text-gray-600 block">Direct Manager:</strong> ${details.manager}</div>`}
                </div>`;

            let itemsHtml = `
                <h4 class="text-lg font-semibold text-gray-700 mb-3">Expense Items</h4>
                <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <table class="min-w-full text-xs sm:text-sm">
                        <thead class="bg-gray-50"><tr class="text-left font-semibold text-gray-600">
                            <th class="p-3">Type</th><th class="p-3">Description</th><th class="p-3 text-right">Amount (EGP)</th>
                        </tr></thead>
                        <tbody class="divide-y divide-gray-100">`;
            items.forEach(item => {
                itemsHtml += `<tr class="text-gray-700">
                                <td>${item.type}</td>
                                <td>${item.desc || 'N/A'}</td>
                                <td class="p-3 text-right">${parseFloat(item.amount).toFixed(2)}</td>
                            </tr>`;
            });
            itemsHtml += `
                        <tr class="bg-gray-50 font-bold">
                            <td colspan="2" class="p-3 text-right">Total:</td>
                            <td class="p-3 text-right">${parseFloat(data.total).toFixed(2)}</td>
                        </tr>
                    </tbody></table></div>`;
            
            modalBody.innerHTML = detailsHtml + itemsHtml;
            reportModal.classList.remove('hidden');
            setTimeout(() => {
                reportModal.classList.remove('opacity-0');
            }, 10);

            // Hide/show approve/reject buttons based on who can approve
            const approveBtn = document.getElementById('approveBtn');
            const rejectBtn = document.getElementById('rejectBtn');
            const isFromTeamReports = rowElement.closest('#myTeamReportsTableBody') !== null;
            
            const showApproveReject = loggedInUser && (loggedInUser.title === 'admin' || (loggedInUser.title === 'District Manager' && isFromTeamReports));

            if (showApproveReject) {
                approveBtn.classList.remove('hidden');
                rejectBtn.classList.remove('hidden');
            } else {
                approveBtn.classList.add('hidden');
                rejectBtn.classList.add('hidden');
            }
        }

        function closeModal() {
            if (reportModal) {
                reportModal.classList.add('opacity-0');
                setTimeout(() => {
                    reportModal.classList.add('hidden');
                    activeReportRow = null;
                }, 300);
            }
        }
        
        async function deleteReport(rowElement) {
            const reportId = rowElement.dataset.id;
            if (!reportId) {
                showMessage("Error", "Could not find report ID to delete.");
                return;
            }

            showMessage(
                "Confirm Deletion",
                "Are you sure you want to delete this report? This action cannot be undone.",
                [
                    {
                        text: "Cancel",
                        onClick: () => hideMessage(),
                        className: "btn bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200"
                    },
                    {
                        text: "Delete",
                        onClick: async () => {
                            try {
                                const { error } = await supabase
                                    .from('expenses')
                                    .delete()
                                    .eq('id', reportId);

                                if (error) throw error;
                                
                                // Remove row from the DOM
                                if(rowElement) rowElement.remove();
                                // Remove from cached data as well
                                allReportsData = allReportsData.filter(report => report.id != reportId);
                                showMessage("Success", "Report deleted successfully.");
                            } catch (error) {
                                console.error('Error deleting report:', error);
                                showMessage("Error", "Failed to delete report. Please try again.");
                            } finally {
                                hideMessage();
                            }
                        },
                        className: "btn bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700"
                    }
                ]
            );
        }

        // --- Admin/Manager status update logic ---
        async function updateStatus(newStatus) {
            if (activeReportRow) {
                const reportId = activeReportRow.dataset.id;
                
                const { error } = await supabase
                    .from('expenses')
                    .update({ status: newStatus })
                    .eq('id', reportId);
                    
                if (error) {
                    console.error('Error updating status:', error);
                    showMessage("Error", "Failed to update report status.");
                    return;
                }
                
                const statusCell = activeReportRow.querySelector('.status-cell');
                if (statusCell) {
                    statusCell.innerHTML = getStatusBadge(newStatus);
                }
                closeModal();
                showMessage("Success", `Report status updated to '${newStatus}'.`);
            }
        }

        // --- Print Modals and Logic (New) ---
        function showPrintConfirmation(rowElement) {
            activeReportRow = rowElement;
            if (printConfirmationModal) {
                printConfirmationModal.classList.remove('hidden');
                setTimeout(() => { printConfirmationModal.classList.remove('opacity-0'); }, 10);
            }
        }

        function hidePrintConfirmationModal() {
            if (printConfirmationModal) {
                printConfirmationModal.classList.add('opacity-0');
                setTimeout(() => { printConfirmationModal.classList.add('hidden'); }, 300);
            }
        }

        function showMonthlyReportOptions(rowElement) {
            if (rowElement && monthlyReportMonthSelect && monthlyReportEmployeeSelect) {
                const reportDate = new Date(rowElement.dataset.date);
                const reportMonth = (reportDate.getMonth() + 1).toString().padStart(2, '0');
                monthlyReportMonthSelect.value = reportMonth;

                const employeeName = rowElement.dataset.name;
                monthlyReportEmployeeSelect.value = employeeName;
            }

            if (monthlyReportOptionsModal) {
                monthlyReportOptionsModal.classList.remove('hidden');
                setTimeout(() => { monthlyReportOptionsModal.classList.remove('opacity-0'); }, 10);
            }
        }

        function hideMonthlyReportOptionsModal() {
            if (monthlyReportOptionsModal) {
                monthlyReportOptionsModal.classList.add('opacity-0');
                setTimeout(() => { monthlyReportOptionsModal.classList.add('hidden'); }, 300);
            }
        }

        async function generateMonthlyReport() {
            const employeeName = monthlyReportEmployeeSelect.value;
            const month = monthlyReportMonthSelect.value;

            if (!employeeName || !month) {
                showMessage("Missing Information", "Please select both an employee and a month to generate the monthly report.");
                return;
            }

            hideMonthlyReportOptionsModal();
            showMessage("Generating Report", "Please wait while we prepare your monthly report...", null);

            try {
                const { data: reports, error } = await supabase
                    .from('expenses')
                    .select('*')
                    .eq('employee_name', employeeName)
                    .order('report_date', { ascending: true });

                if (error) throw error;

                const allRelevantReports = reports.filter(report => {
                    const reportDate = new Date(report.report_date);
                    return (reportDate.getMonth() + 1).toString().padStart(2, '0') === month;
                }).sort((a, b) => new Date(a.report_date) - new Date(b.report_date));

                if (allRelevantReports.length === 0) {
                    showMessage("No Reports Found", `No reports found for ${employeeName} for ${months[parseInt(month) - 1]}.`);
                    return;
                }

                let totalMonthlyExpenses = 0;
                let reportTableRows = '';

                allRelevantReports.forEach(report => {
                    const employeeRole = report.role;
                    totalMonthlyExpenses += parseFloat(report.total_amount);

                    let expenseItemsHtml = '';
                    const items = JSON.parse(report.items);
                    items.forEach(item => {
                        expenseItemsHtml += `
                            <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; font-size: 14px;">
                                <span style="font-weight: 500;">${item.type}:</span>
                                <span style="flex-grow: 1; margin: 0 0.5rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.desc || 'N/A'}</span>
                                <span style="font-weight: 600;">${parseFloat(item.amount).toFixed(2)} EGP</span>
                            </div>
                        `;
                    });

                    reportTableRows += `
                        <tr style="background-color: #f9fafb;">
                            <td colspan="6" style="padding: 0.75rem; border: 1px solid #e5e7eb; font-weight: bold;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>${report.report_date} - ${report.employee_name} (${employeeRole}) - Total: ${parseFloat(report.total_amount).toFixed(2)} EGP</span>
                                    <span style="font-weight: normal; font-size: 0.8em;">Status: ${report.status}</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="6" style="padding: 0.75rem; border: 1px solid #e5e7eb;">
                                <div style="padding-left: 1rem; border-left: 2px solid #3b82f6;">
                                    ${expenseItemsHtml}
                                </div>
                            </td>
                        </tr>
                    `;
                });

                const monthlyReportHtml = `
                    <html>
                        <head>
                            <title>Monthly Expense Report - ${employeeName} - ${months[parseInt(month) - 1]}</title>
                            <style>
                                body { font-family: 'Inter', sans-serif; color: #111827; margin: 2rem; }
                                table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
                                th, td { border: 1px solid #e5e7eb; padding: 0.75rem; text-align: left; font-size: 14px; vertical-align: top; }
                                th { background-color: #f1f5f9; font-weight: 600; color: #334155; }
                                .header { text-align: center; margin-bottom: 2rem; }
                                .header img { height: 4rem; margin-bottom: 1rem; border-radius: 50%; }
                                .header h1 { font-size: 1.8rem; font-weight: 700; color: #1e3a8a; margin: 0; }
                                .header p { font-size: 1rem; color: #6b7280; margin: 0.5rem 0 0 0; }
                                .summary { margin-top: 2rem; text-align: right; font-size: 16px; font-weight: bold; }
                                @media print { .no-print { display: none; } }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <img src="https://i.ibb.co/ZRmVjNch/logo.jpg" alt="Paxton Logo">
                                <h1>Monthly Expense Report</h1>
                                <p>Paxton LLC</p>
                            </div>
                            <h2 style="font-size: 1.5rem; margin-bottom: 1rem;">Employee: ${employeeName}</h2>
                            <h3 style="font-size: 1.2rem; margin-bottom: 1.5rem;">Month: ${months[parseInt(month) - 1]}</h3>
                            
                            <table style="border: none;">
                                <tbody>
                                    ${reportTableRows}
                                </tbody>
                            </table>
                            
                            <div class="summary">
                                <p>Grand Total for ${months[parseInt(month) - 1]}: EGP ${totalMonthlyExpenses.toFixed(2)}</p>
                            </div>
                            <div style="margin-top: 4rem; display: grid; grid-template-columns: 1fr 1fr; gap: 4rem; page-break-inside: avoid; font-size: 14px;">
                                <div>
                                    <div style="border-top: 1px solid #374151; padding-top: 0.5rem;">
                                        <p style="margin: 0;"><strong>Direct Manager</strong></p>
                                        <p style="margin: 0; font-size: 0.75rem;">Signature & Date</p>
                                    </div>
                                </div>
                                <div>
                                    <div style="border-top: 1px solid #374151; padding-top: 0.5rem;">
                                        <p style="margin: 0;"><strong>Commercial Director</strong></p>
                                        <p style="margin: 0; font-size: 0.75rem;">Signature & Date</p>
                                    </div>
                                </div>
                            </div>
                            <div class="no-print" style="text-align: center; margin-top: 2rem;">
                                <button onclick="window.print()" style="background-color: #3b82f6; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 1rem;">Print Report</button>
                            </div>
                        </body>
                    </html>
                `;

                const printWindow = window.open('', '_blank');
                printWindow.document.write(monthlyReportHtml);
                printWindow.document.close();
                printWindow.focus();
                hideMessage();
            } catch (error) {
                console.error('Error generating monthly report:', error);
                showMessage("Error", "Failed to generate monthly report. Please try again.");
            }
        }

        function printReport(rowElement, printType) {
            if (printType === 'single') {
                const data = rowElement.dataset;
                const items = JSON.parse(data.items);
                const details = JSON.parse(data.details);
                const statusCell = rowElement.querySelector('.status-cell');
                const status = statusCell ? statusCell.textContent.trim() : 'N/A';

                let detailsHtml = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; font-size: 14px;">
                        <p><strong>Employee:</strong> ${data.name}</p>
                        <p><strong>Role:</strong> ${data.role}</p>
                        <p><strong>Date:</strong> ${data.date}</p>
                        ${data.role === 'District Manager' ? `<p><strong>Report Type:</strong> ${details.reportType}</p>
                                                            ${details.reportType === 'Trip' ? `<p><strong>Trip:</strong> ${details.from} to ${details.to}</p>
                                                                                                <p style="grid-column: span 2;"><strong>Purpose:</strong> ${details.purpose}</p>` : ''}` : 
                                                            `<p><strong>Territory:</strong> ${details.territory}</p>
                                                            <p><strong>Direct Manager:</strong> ${details.manager}</p>`}
                    </div>`;

                let itemsHtml = `
                    <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">Expense Items</h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <thead><tr style="text-align: left; background-color: #f9fafb;">
                            <th style="padding: 0.5rem; border: 1px solid #e5e7eb;">Type</th>
                            <th style="padding: 0.5rem; border: 1px solid #e5e7eb;">Description</th>
                            <th style="padding: 0.5rem; border: 1px solid #e5e7eb; text-align: right;">Amount (EGP)</th>
                        </tr></thead><tbody>`;
                items.forEach(item => {
                    itemsHtml += `<tr>
                                    <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">${item.type}</td>
                                    <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">${item.desc || 'N/A'}</td>
                                    <td style="padding: 0.5rem; border: 1px solid #e5e7eb; text-align: right;">${parseFloat(item.amount).toFixed(2)}</td>
                                </tr>`;
                });
                itemsHtml += `
                            <tr style="font-weight: bold; background-color: #f9fafb;">
                                <td colspan="2" style="padding: 0.5rem; border: 1px solid #e5e7eb; text-align: right;">Total:</td>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb; text-align: right;">${parseFloat(data.total).toFixed(2)}</td>
                            </tr></tbody></table>`;
                
                let signatureHtml = `
                    <div style="margin-top: 4rem; display: grid; grid-template-columns: 1fr 1fr; gap: 4rem; page-break-inside: avoid; font-size: 14px;">
                        <div>
                            <div style="border-top: 1px solid #374151; padding-top: 0.5rem;">
                                <p style="margin: 0;"><strong>Direct Manager</strong></p>
                                <p style="margin: 0; font-size: 0.75rem;">Signature & Date</p>
                            </div>
                        </div>
                        <div>
                            <div style="border-top: 1px solid #374151; padding-top: 0.5rem;">
                                <p style="margin: 0;"><strong>Commercial Director</strong></p>
                                <p style="margin: 0; font-size: 0.75rem;">Signature & Date</p>
                            </div>
                        </div>
                    </div>`;

                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Expense Report - ${data.name}</title>
                            <style>
                                body { font-family: 'Inter', sans-serif; color: #111827; }
                                table, th, td { border: 1px solid #e5e7eb; }
                                @media print { .no-print { display: none; } }
                            </style>
                        </head>
                        <body style="padding: 2rem;">
                            <div style="text-align: center; margin-bottom: 2rem;">
                                <img src="https://i.ibb.co/ZRmVjNch/logo.jpg" alt="Paxton Logo" style="height: 4rem; margin: 0 auto; border-radius: 50%;">
                                <h1 style="font-size: 1.5rem; font-weight: 700; color: #1e3a8a; margin: 0.5rem 0 0 0;">Expense Report</h1>
                                <p style="font-size: 0.9rem; color: #6b7280;">Paxton LLC</p>
                            </div>
                            <p style="text-align: right; font-size: 14px;"><strong>Status:</strong> ${status}</p>
                            ${detailsHtml}
                            ${itemsHtml}
                            ${signatureHtml}
                            <div class="no-print" style="text-align: center; margin-top: 2rem;">
                                <button onclick="window.print()">Print Report</button>
                            </div>
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.focus();
            }
        }

        function handleReportTypeChange(selectElement) {
            const type = selectElement.value;
            const isTrip = type === 'Trip';
            
            const tripDetailsFieldset = document.getElementById('tripDetails');
            const otherDateInputDiv = document.getElementById('otherDate');
            
            if (tripDetailsFieldset) tripDetailsFieldset.classList.toggle('hidden', !isTrip);
            const tripPurpose = document.getElementById('tripPurpose');
            if (tripPurpose) tripPurpose.required = isTrip;
            const travelDate = document.getElementById('travelDate');
            if (travelDate) travelDate.required = isTrip;
            const fromGovernorate = document.getElementById('fromGovernorate');
            if (fromGovernorate) fromGovernorate.required = isTrip;
            const toGovernorate = document.getElementById('toGovernorate');
            if (toGovernorate) toGovernorate.required = isTrip;

            if (otherDateInputDiv) otherDateInputDiv.classList.toggle('hidden', isTrip);
            const otherDateInput = document.getElementById('otherDateInput');
            if (otherDateInput) otherDateInput.required = !isTrip;
            setDefaultDates();
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            const items = [];
            let total = 0;
            const expenseContainer = data.employeeRole === 'District Manager' ? document.getElementById('managerExpensesContainer') : document.getElementById('repExpensesContainer');
            const expenseRows = expenseContainer.querySelectorAll('.expense-row');

            expenseRows.forEach((row, index) => {
                const type = row.querySelector('select').value;
                const desc = row.querySelector('input[name^="expenseDesc"]').value;
                const amount = parseFloat(row.querySelector('input[name^="expenseAmount"]').value) || 0;
                
                if (type) {
                    items.push({ type: type, desc: desc, amount: amount });
                    total += amount;
                }
            });
            
            const selectedEmployeeName = employeeNameDropdown.value;
            const employeeData = masterlistData.find(u => u['medical rep'] === selectedEmployeeName || u['District Manager'] === selectedEmployeeName);
            const employeeRole = employeeData ? (employeeData['medical rep'] === selectedEmployeeName ? 'Medical Representative' : 'District Manager') : 'N/A';
            
            let directManager = 'N/A';
            let reportTypeForDb = '';
            let reportDetails;
            let reportDate;

            if (employeeRole === 'Medical Representative') {
                directManager = employeeData['District Manager'];
                reportTypeForDb = items.length > 0 ? items[0].type : '';
                reportDate = data.repDate;
                reportDetails = { territory: employeeData.area, manager: directManager };
            } else if (employeeRole === 'District Manager') {
                reportTypeForDb = data.reportType;
                reportDate = data.reportType === 'Trip' ? data.travelDate : data.otherDateInput;
                if (data.reportType === 'Trip') {
                    reportDetails = { reportType: 'Trip', purpose: data.tripPurpose, from: data.fromGovernorate, to: data.toGovernorate };
                } else {
                    reportDetails = { reportType: 'Others', date: data.otherDateInput };
                }
            }
            
            const reportData = {
                employee_name: selectedEmployeeName,
                role: employeeRole,
                report_date: reportDate,
                total_amount: total.toFixed(2),
                status: 'Pending',
                report_type: reportTypeForDb,
                details: JSON.stringify(reportDetails),
                items: JSON.stringify(items)
            };

            const { data: insertedData, error } = await supabase.from('expenses').insert([reportData]).select();
            if (error) {
                console.error('Error submitting report:', error);
                showMessage("Error", "Failed to submit report. Please try again.");
                return;
            }

            showMessage("Success", `Report submitted successfully for ${selectedEmployeeName}!`);
            renderFormForEmployee();
        }
        
        function addNewReportToTable(report, tableBody) {
            if (!tableBody) return;
            const newRow = document.createElement('tr');
            newRow.className = 'hover:bg-gray-50 text-gray-700 transition-all duration-200';
            
            const employeeRole = getEmployeeRole(report.employee_name);
            const roleBadge = employeeRole === 'District Manager' ?
                `<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-0.5 rounded-full">District Manager</span>` :
                `<span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-0.5 rounded-full">Medical Representative</span>`;
            
            newRow.dataset.id = report.id;
            newRow.dataset.name = report.employee_name;
            newRow.dataset.role = employeeRole;
            newRow.dataset.date = report.report_date;
            newRow.dataset.total = report.total_amount;
            newRow.dataset.details = report.details;
            newRow.dataset.items = report.items;
            newRow.dataset.reportType = report.report_type;

            let managerCellContent = 'N/A';
            const employeeData = masterlistData.find(u => u['medical rep'] === report.employee_name || u['District Manager'] === report.employee_name);
            if (employeeData && employeeData['District Manager']) {
                managerCellContent = employeeData['District Manager'];
            }
            
            let reportTypeToDisplay = report.report_type;
            if (!reportTypeToDisplay && report.items) {
                const items = JSON.parse(report.items);
                if (items.length > 0) {
                    reportTypeToDisplay = items[0].type;
                } else {
                    reportTypeToDisplay = 'Daily Log';
                }
            } else if (!reportTypeToDisplay) {
                reportTypeToDisplay = 'Daily Log';
            }


            if (tableBody.id === 'reportsTableBody') {
                newRow.innerHTML = `
                    <td class="px-3 sm:px-6 py-4 whitespace-nowrap">${report.report_date}</td>
                    <td class="px-3 sm:px-6 py-4 whitespace-nowrap">${report.employee_name}</td>
                    <td class="px-3 sm:px-6 py-4 whitespace-nowrap">${roleBadge}</td>
                    <td class="px-3 sm:px-6 py-4 whitespace-nowrap">${reportTypeToDisplay}</td>
                    <td class="px-3 sm:px-6 py-4 whitespace-nowrap">${managerCellContent}</td>
                    <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-right">${parseFloat(report.total_amount).toFixed(2)}</td>
                    <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-center status-cell">${getStatusBadge(report.status)}</td>
                    <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="showReportDetails(this.closest('tr'))" class="text-blue-600 hover:text-blue-900 mx-1"><i class="fas fa-eye"></i></button>
                        <button onclick="showPrintConfirmation(this.closest('tr'))" class="text-green-600 hover:text-green-900 mx-1"><i class="fas fa-print"></i></button>
                        <button onclick="deleteReport(this.closest('tr'))" class="text-red-600 hover:text-red-900 mx-1"><i class="fas fa-trash-alt"></i></button>
                    </td>`;
            } else if (tableBody.id === 'myManagerReportsTableBody') {
                newRow.innerHTML = `
                        <td class="px-3 sm:px-6 py-4 whitespace-nowrap">${report.report_date}</td>
                        <td class="px-3 sm:px-6 py-4 whitespace-nowrap">${reportTypeToDisplay}</td>
                        <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-right">${parseFloat(report.total_amount).toFixed(2)}</td>
                        <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-center status-cell">${getStatusBadge(report.status)}</td>
                        <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="showReportDetails(this.closest('tr'))" class="text-blue-600 hover:text-blue-900 mx-1"><i class="fas fa-eye"></i></button>
                            <button onclick="showPrintConfirmation(this.closest('tr'))" class="text-green-600 hover:text-green-900 mx-1"><i class="fas fa-print"></i></button>
                        </td>`;
            } else if (tableBody.id === 'myRepReportsTableBody') {
                newRow.innerHTML = `
                        <td class="px-3 sm:px-6 py-4 whitespace-nowrap">${report.report_date}</td>
                        <td class="px-3 sm:px-6 py-4 whitespace-nowrap">${reportTypeToDisplay}</td>
                        <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-right">${parseFloat(report.total_amount).toFixed(2)}</td>
                        <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-center status-cell">${getStatusBadge(report.status)}</td>
                        <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="showReportDetails(this.closest('tr'))" class="text-blue-600 hover:text-blue-900 mx-1"><i class="fas fa-eye"></i></button>
                            <button onclick="showPrintConfirmation(this.closest('tr'))" class="text-green-600 hover:text-green-900 mx-1"><i class="fas fa-print"></i></button>
                        </td>`;
            } else if (tableBody.id === 'myTeamReportsTableBody') {
                newRow.innerHTML = `
                        <td class="px-3 sm:px-6 py-4 whitespace-nowrap">${report.report_date}</td>
                        <td class="px-3 sm:px-6 py-4 whitespace-nowrap">${report.employee_name}</td>
                        <td class="px-3 sm:px-6 py-4 whitespace-nowrap">${reportTypeToDisplay}</td>
                        <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-right">${parseFloat(report.total_amount).toFixed(2)}</td>
                        <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-center status-cell">${getStatusBadge(report.status)}</td>
                        <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="showReportDetails(this.closest('tr'))" class="text-blue-600 hover:text-blue-900 mx-1"><i class="fas fa-eye"></i></button>
                            <button onclick="showPrintConfirmation(this.closest('tr'))" class="text-green-600 hover:text-green-900 mx-1"><i class="fas fa-print"></i></button>
                        </td>`;
            }
            
            tableBody.prepend(newRow);
        }
        
        async function retrieveMyReports(role, employeeName) {
            const myReportsTableBody = document.getElementById(role === 'District Manager' ? 'myManagerReportsTableBody' : 'myRepReportsTableBody');
            
            if (!myReportsTableBody) {
                    console.error("My reports table body not found.");
                    return;
            }
            myReportsTableBody.innerHTML = '';

            try {
                const { data, error } = await supabase
                    .from('expenses')
                    .select('*')
                    .eq('employee_name', employeeName)
                    .order('report_date', { ascending: false });
                
                if (error) throw error;
                
                if (data.length === 0) {
                    myReportsTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">No reports found for this user.</td></tr>`;
                    return;
                }
                
                data.forEach(report => addNewReportToTable(report, myReportsTableBody));
            } catch (error) {
                console.error('Error retrieving reports:', error);
                showMessage("Error", "Failed to retrieve your reports. Please try again.");
            }
        }

        async function retrieveMyTeamReports(managerName) {
            const myTeamReportsTableBody = document.getElementById('myTeamReportsTableBody');
            
            if (!myTeamReportsTableBody) {
                    console.error("My team reports table body not found.");
                    return;
            }
            myTeamReportsTableBody.innerHTML = '';
            
            const reps = [...new Set(masterlistData.filter(user => user['District Manager'] === managerName).map(user => user['medical rep']))];

            if (reps.length === 0) {
                    myTeamReportsTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">No team members found.</td></tr>';
                    return;
            }

            try {
                const { data, error } = await supabase
                    .from('expenses')
                    .select('*')
                    .in('employee_name', reps)
                    .order('report_date', { ascending: false });

                if (error) throw error;
                
                if (data.length === 0) {
                    myTeamReportsTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">No reports found for your team.</td></tr>';
                    return;
                }
                
                data.forEach(report => addNewReportToTable(report, myTeamReportsTableBody));
            } catch (error) {
                console.error('Error retrieving team reports:', error);
                showMessage("Error", "Failed to retrieve your team's reports. Please try again.");
            }
        }
        
        async function retrieveAllReports() {
            try {
                const { data, error } = await supabase.from('expenses').select('*').order('report_date', { ascending: false });
                if (error) throw error;
                
                allReportsData = data;
                if (reportsTableBody) reportsTableBody.innerHTML = '';
                filterReports();
            } catch (error) {
                console.error('Error retrieving all reports:', error);
                showMessage("Error", "Failed to retrieve reports. Please try again.");
            }
        }

        function filterReports() {
            if (!reportsTableBody) {
                console.error("Reports table body not found.");
                return;
            }
            const employeeFilter = employeeFilterSelect.value;
            const statusFilter = statusFilterSelect.value;
            const monthFilter = monthFilterSelect.value;

            reportsTableBody.innerHTML = '';
            
            const filteredData = allReportsData.filter(report => {
                const reportDate = new Date(report.report_date);
                const reportMonth = (reportDate.getMonth() + 1).toString().padStart(2, '0');

                const isEmployeeMatch = employeeFilter === 'all' || report.employee_name === employeeFilter;
                const isStatusMatch = statusFilter === 'all' || report.status === statusFilter;
                const isMonthMatch = monthFilter === 'all' || reportMonth === monthFilter;
                
                return isEmployeeMatch && isStatusMatch && isMonthMatch;
            });
            
            filteredData.forEach(report => addNewReportToTable(report, reportsTableBody));
        }
        
        // --- Initialization Functions ---
        async function fetchMasterlistFromSupabase() {
            try {
                const CHUNK_SIZE = 1000;
                let offset = 0;
                let allData = [];
                let hasMore = true;

                while (hasMore) {
                    const { data, error } = await supabase
                        .from('masterlist')
                        .select('*')
                        .range(offset, offset + CHUNK_SIZE - 1);

                    if (error) {
                        throw error;
                    }

                    if (data && data.length > 0) {
                        allData = allData.concat(data);
                        offset += CHUNK_SIZE;
                    } else {
                        hasMore = false;
                    }
                }
                
                masterlistData = allData;
                populateEmployeeDropdowns();
                populateFilters();
                setDefaultDates();
            } catch (error) {
                console.error("Error fetching masterlist:", error);
                showMessage("Error", "Could not load employee data. Please try again later.");
            }
        }

        function getEmployeeRole(employeeName) {
            const employeeData = masterlistData.find(u => u['medical rep'] === employeeName || u['District Manager'] === employeeName);
            if (employeeData) {
                if (employeeData['District Manager'] === employeeName) {
                    return 'District Manager';
                } else if (employeeData['medical rep'] === employeeName) {
                    return 'Medical Representative';
                }
            }
            return 'N/A';
        }

        function populateEmployeeDropdowns() {
            if (!employeeNameDropdown) return;
            employeeNameDropdown.innerHTML = '<option value="">Select Employee</option>';

            const managers = [...new Set(masterlistData.filter(u => u['District Manager']).map(u => u['District Manager']))].sort();
            managers.forEach(manager => {
                const managerOption = document.createElement('option');
                managerOption.value = manager;
                managerOption.textContent = manager;
                managerOption.style.fontWeight = 'bold';
                employeeNameDropdown.appendChild(managerOption);

                const reps = [...new Set(masterlistData.filter(u => u['District Manager'] === manager && u['medical rep']).map(u => u['medical rep']))].sort();
                reps.forEach(rep => {
                    const repOption = document.createElement('option');
                    repOption.value = rep;
                    repOption.textContent = `   ${rep}`;
                    employeeNameDropdown.appendChild(repOption);
                });
            });
            
            employeeNameDropdown.addEventListener('change', renderFormForEmployee);
        }

        function populateGovernorates() {
            const fromGovernorateSelect = document.getElementById('fromGovernorate');
            const toGovernorateSelect = document.getElementById('toGovernorate');
            if (fromGovernorateSelect) fromGovernorateSelect.innerHTML = '<option value="">Select a Governorate</option>';
            if (toGovernorateSelect) toGovernorateSelect.innerHTML = '<option value="">Select a Governorate</option>';
            governorates.sort().forEach(gov => {
                if (fromGovernorateSelect) fromGovernorateSelect.innerHTML += `<option value="${gov}">${gov}</option>`;
                if (toGovernorateSelect) toGovernorateSelect.innerHTML += `<option value="${gov}">${gov}</option>`;
            });
        }
        
        function populateFilters() {
            populateEmployeeFilter();
            populateMonthFilter();
            populateMonthlyReportEmployeeFilter();
        }

        function populateEmployeeFilter() {
            if (!employeeFilterSelect) return;
            employeeFilterSelect.innerHTML = '<option value="all">All Employees</option>';

            const allEmployees = new Set();
            masterlistData.forEach(user => {
                if (user['medical rep']) allEmployees.add(user['medical rep']);
                if (user['District Manager']) allEmployees.add(user['District Manager']);
            });
            
            Array.from(allEmployees).sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                employeeFilterSelect.appendChild(option);
            });
        }

        function populateMonthlyReportEmployeeFilter() {
            if (!monthlyReportEmployeeSelect) return;
            monthlyReportEmployeeSelect.innerHTML = '<option value="">Select an Employee</option>';
            
            const employees = new Set();
            masterlistData.forEach(user => {
                if (user['medical rep']) employees.add(user['medical rep']);
                if (user['District Manager']) employees.add(user['District Manager']);
            });
            const sortedEmployees = Array.from(employees).sort();

            sortedEmployees.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                monthlyReportEmployeeSelect.appendChild(option);
            });
        }

        function populateMonthFilter() {
            if (monthFilterSelect) {
                monthFilterSelect.innerHTML = '<option value="all">All Months</option>';
                months.forEach((month, index) => {
                    const monthValue = (index + 1).toString().padStart(2, '0');
                    monthFilterSelect.innerHTML += `<option value="${monthValue}">${month}</option>`;
                });
            }

            if (monthlyReportMonthSelect) {
                monthlyReportMonthSelect.innerHTML = '<option value="">Select a Month</option>';
                months.forEach((month, index) => {
                    const monthValue = (index + 1).toString().padStart(2, '0');
                    monthlyReportMonthSelect.innerHTML += `<option value="${monthValue}">${month}</option>`;
                });
                const currentMonth = (new Date().getMonth() + 1).toString().padStart(2, '0');
                monthlyReportMonthSelect.value = currentMonth;
            }
        }

        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const travelDate = document.getElementById('travelDate');
            if(travelDate) travelDate.value = today;
            const otherDateInput = document.getElementById('otherDateInput');
            if(otherDateInput) otherDateInput.value = today;
            const repDate = document.getElementById('repDate');
            if(repDate) repDate.value = today;
        }

        function renderFormForEmployee() {
            const selectedEmployeeName = employeeNameDropdown.value;
            const formContainer = dynamicFormContainer;
            if (!selectedEmployeeName) {
                formContainer.innerHTML = '';
                return;
            }

            const employeeData = masterlistData.find(u => u['medical rep'] === selectedEmployeeName || u['District Manager'] === selectedEmployeeName);
            
            if (!employeeData) {
                formContainer.innerHTML = '<p class="text-red-500">Employee data not found.</p>';
                return;
            }

            const employeeRole = getEmployeeRole(selectedEmployeeName);
            
            if (employeeRole === 'District Manager') {
                formContainer.innerHTML = createManagerForm();
                document.getElementById('managerExpenseForm').addEventListener('submit', handleFormSubmit);
                populateGovernorates();
                setDefaultDates();
                addExpense('District Manager');
            } else { // Medical Representative
                formContainer.innerHTML = createMedicalRepForm();
                document.getElementById('medicalRepExpenseForm').addEventListener('submit', handleFormSubmit);
                document.getElementById('repTerritory').value = employeeData.area || '';
                document.getElementById('directManager').value = employeeData['District Manager'] || '';
                setDefaultDates();
                addExpense('Medical Representative');
            }
        }
        
        function prefillAndLockForm(user) {
            if (!user) return;
            
            if (user.title !== 'admin') {
                employeeNameDropdown.value = user.username;
                employeeNameDropdown.disabled = true;
            } else {
                employeeNameDropdown.disabled = false;
            }
            renderFormForEmployee();

            if (user.title === 'Medical Representative') {
                const repData = masterlistData.find(u => u['medical rep'] === user.username);
                if (repData) {
                    const directManager = document.getElementById('directManager');
                    const repTerritory = document.getElementById('repTerritory');
                    if (directManager) directManager.value = repData['District Manager'] || '';
                    if (repTerritory) repTerritory.value = repData.area || '';
                }
            }
        }

        // --- Event Listeners and Initialization ---
        function showRoleSelection() {
            if (mainContent) mainContent.classList.add('hidden');
            if (roleSelection) roleSelection.classList.remove('hidden');
        }

        window.addEventListener('message', event => {
            if (event.data.type === 'loggedInUser') {
                loggedInUser = event.data.user;
                if (!loggedInUser) return;
                
                const addCard = document.getElementById('add-expense-card');
                const adminCard = document.getElementById('admin-panel-card');

                if (loggedInUser.title === 'admin') {
                    if (addCard) addCard.classList.remove('hidden');
                    if (adminCard) adminCard.classList.remove('hidden');
                } else if (loggedInUser.title === 'Medical Representative' || loggedInUser.title === 'District Manager') {
                    if (addCard) addCard.classList.remove('hidden');
                    if (adminCard) adminCard.classList.add('hidden');
                } else {
                    if (addCard) addCard.classList.add('hidden');
                    if (adminCard) addCard.classList.add('hidden');
                    console.error("Unknown user role:", loggedInUser.title);
                }
                
                showRoleSelection();
            }
        });
        
        if(employeeFilterSelect) employeeFilterSelect.addEventListener('change', filterReports);
        if (statusFilterSelect) statusFilterSelect.addEventListener('change', filterReports);
        if (monthFilterSelect) monthFilterSelect.addEventListener('change', filterReports);
        
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchMasterlistFromSupabase();

            const addExpenseCard = document.getElementById('add-expense-card');
            if(addExpenseCard) addExpenseCard.addEventListener('click', () => showView('addExpense'));
            const adminPanelCard = document.getElementById('admin-panel-card');
            if(adminPanelCard) adminPanelCard.addEventListener('click', () => showView('admin'));
        });
    </script>
</body>
</html>
